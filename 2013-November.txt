From renaud at mancala.cbio.uct.ac.za  Fri Nov  1 12:06:23 2013
From: renaud at mancala.cbio.uct.ac.za (Renaud Gaujoux)
Date: Fri, 1 Nov 2013 13:06:23 +0200
Subject: [Rd] cat with backspace and newline characters
Message-ID: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131101/9377c900/attachment.pl>

From renaud at mancala.cbio.uct.ac.za  Fri Nov  1 12:54:51 2013
From: renaud at mancala.cbio.uct.ac.za (Renaud Gaujoux)
Date: Fri, 1 Nov 2013 13:54:51 +0200
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <CA+MmmT+nsQ+qbyzS6FwmYFbpesQpsYWi5jcdRXcTENOXSKaU-A@mail.gmail.com>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CA+MmmT+nsQ+qbyzS6FwmYFbpesQpsYWi5jcdRXcTENOXSKaU-A@mail.gmail.com>
Message-ID: <CAHavPHF0h0jnpHaHBWVsv_OD5Q5ywmYJuqqAduGF8YGZMdV57A@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131101/2669535a/attachment.pl>

From jgrn at illinois.edu  Fri Nov  1 15:17:20 2013
From: jgrn at illinois.edu (Jonathan Greenberg)
Date: Fri, 1 Nov 2013 09:17:20 -0500
Subject: [Rd] Where to drop a python script?
In-Reply-To: <52729739.4050401@gmail.com>
References: <CABG0rfvUzodJ6c22tU6E+yS_Z1NxieQE+afOAHZ4m+wvjcW2Dg@mail.gmail.com>
	<21105.23279.974154.140323@max.nulle.part>
	<5271A6F7.8070904@gmail.com> <52720032.5060702@stats.ox.ac.uk>
	<52727852.4000008@gmail.com> <52729061.4050504@stats.ox.ac.uk>
	<52729739.4050401@gmail.com>
Message-ID: <CABG0rfuOZ2HtV+PJ7nG8NEmG_sTdv2+CQ0EHn=5QmWGTewanfQ@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131101/d14d768b/attachment.pl>

From ruipbarradas at sapo.pt  Fri Nov  1 16:45:35 2013
From: ruipbarradas at sapo.pt (Rui Barradas)
Date: Fri, 01 Nov 2013 15:45:35 +0000
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
Message-ID: <5273CC9F.60802@sapo.pt>

Hello,

Can't reproduce it, there must be something with your console. I get

 > cat("abc\b")
ab> cat("abc\b\n")
ab
 >


Hope this helps,

Rui Barradas

Em 01-11-2013 11:06, Renaud Gaujoux escreveu:
> Hi,
>
> when mixing newline and backspace characters I get the following output
> (see below). In the second call, the backspace character is simply not
> applied. Is this normal behaviour?
> Thank you.
>
>> cat("abc\b")
> ab> cat("abc\b\n")
> abc
>>
>
> 	[[alternative HTML version deleted]]
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
>


From rowe at muxspace.com  Fri Nov  1 17:30:34 2013
From: rowe at muxspace.com (Brian Lee Yung Rowe)
Date: Fri, 1 Nov 2013 12:30:34 -0400
Subject: [Rd] Where to drop a python script?
In-Reply-To: <CABG0rfuOZ2HtV+PJ7nG8NEmG_sTdv2+CQ0EHn=5QmWGTewanfQ@mail.gmail.com>
References: <CABG0rfvUzodJ6c22tU6E+yS_Z1NxieQE+afOAHZ4m+wvjcW2Dg@mail.gmail.com>
	<21105.23279.974154.140323@max.nulle.part>
	<5271A6F7.8070904@gmail.com> <52720032.5060702@stats.ox.ac.uk>
	<52727852.4000008@gmail.com> <52729061.4050504@stats.ox.ac.uk>
	<52729739.4050401@gmail.com>
	<CABG0rfuOZ2HtV+PJ7nG8NEmG_sTdv2+CQ0EHn=5QmWGTewanfQ@mail.gmail.com>
Message-ID: <237165BD-9C59-43CF-8D66-A657FDB70346@muxspace.com>

If that's all you want to do, you can ignore the headache by just calling system("python -V").

Then you don't need to save any python scripts.


On Nov 1, 2013, at 10:17 AM, Jonathan Greenberg <jgrn at illinois.edu> wrote:

> This was actually the little script I was going to include (prompting me to
> ask the question): a test for the python version number.
> Save this (between the ***s) as e.g. python_version.py:
> 
> ***
> 
> import sys
> print(sys.version_info)
> 
> ***
> 
> I've done almost no python coding, so I was going to call this with a
> system("/pathto/python /pathto/python_version.py",intern=TRUE) call and
> post-process the one-line text output.
> 
> --j
> 
> 
> On Thu, Oct 31, 2013 at 12:45 PM, Paul Gilbert <pgilbert902 at gmail.com>wrote:
> 
>> 
>> 
>> On 13-10-31 01:16 PM, Prof Brian Ripley wrote:
>> 
>>> On 31/10/2013 15:33, Paul Gilbert wrote:
>>> 
>>>> 
>>>> 
>>>> On 13-10-31 03:01 AM, Prof Brian Ripley wrote:
>>>> 
>>>>> On 31/10/2013 00:40, Paul Gilbert wrote:
>>>>> 
>>>>>> The old convention was that it went in the exec/ directory, but as you
>>>>>> can see at
>>>>>> http://cran.at.r-project.org/**doc/manuals/r-devel/R-exts.**
>>>>>> html#Non_002dR-scripts-in-**packages<http://cran.at.r-project.org/doc/manuals/r-devel/R-exts.html#Non_002dR-scripts-in-packages>
>>>>>> 
>>>>>> 
>>>>>> 
>>>>>>  it can be in inst/anyName/. A minor convenience of exec/ is that the
>>>>>> directory has the same name in source and when installed, whereas
>>>>>> inst/anyName gets moved to anyName/, so debugging can be a tiny bit
>>>>>> easier with exec/.
>>>>>> 
>>>>>> Having just put a package (TSjson) on CRAN with a python script, here
>>>>>> are a few other pointers for getting it on CRAN:
>>>>>> 
>>>>>> -SystemRequirements: should indicate if a particular version of python
>>>>>> is needed, and any non-default modules that are needed. (My package
>>>>>> does
>>>>>> not work with Python 3 because some modules are not available.) Some of
>>>>>> the libraries have changed, so it could be a bit tricky to make
>>>>>> something work easily with both 2 and 3.
>>>>>> 
>>>>>> -You need a README to explain how to install Python. (If you look at or
>>>>>> use mine, please let me know if you find problems.)
>>>>>> 
>>>>> 
>>>>> Better to describe exactly what you need: installation instructions go
>>>>> stale very easily.
>>>>> 
>>>>> -The Linux and Sun CRAN test machines have Python 2 whereas winbuilder
>>>>>> has Python 3. Be prepared to explain that the package will not work on
>>>>>> one or the other.
>>>>>> 
>>>>> 
>>>>> Not true.  Linux and Solaris (sic) have both: the Solaris machines have
>>>>> 2.6 and 3.3.
>>>>> 
>>>> 
>>>> For an R package how does one go about specifying which should be used?
>>>> 
>>> 
>>> You ask the user to tell you the path or at least the command name, e.g.
>>> by an environment variable or R function argument.  Just like any other
>>> external program such as GhostScript.
>>> 
>> 
>> Yes, but since I don't have direct access to the CRAN test machines,
>> specifically, on the CRAN test machines, how do I specify to use Python 2
>> or Python 3? (That is, I think you are the user when CRAN tests are done on
>> Solaris, so I am asking you.)
>> 
>> 
>> 
>>> 
>>>> Please do not spread misinformation about machines you do
>>>>> not have any access to.
>>>>> 
>>>>> 
>>>>>> Another option to system() is pipe()
>>>>>> 
>>>>>> Paul
>>>>>> 
>>>>>> On 13-10-30 03:15 PM, Dirk Eddelbuettel wrote:
>>>>>> 
>>>>>>> 
>>>>>>> On 30 October 2013 at 13:54, Jonathan Greenberg wrote:
>>>>>>> | R-developers:
>>>>>>> |
>>>>>>> | I have a small python script that I'd like to include in an R
>>>>>>> package I'm
>>>>>>> | developing, but I'm a bit unclear about which subfolder it should go
>>>>>>> in.  R
>>>>>>> | will be calling the script via a system() call.  Thanks!
>>>>>>> 
>>>>>>> Up to you as you control the path. As "Writing R Extensions" explains,
>>>>>>> everything below the (source) directory inst/ will get installed.  I
>>>>>>> like
>>>>>>> inst/extScripts/ (or similar) as it denotes that it is an external
>>>>>>> script.
>>>>>>> 
>>>>>>> As an example, the gdata package has Perl code for xls reading/writing
>>>>>>> below a
>>>>>>> directory inst/perl/ -- and I think there are more packages doing
>>>>>>> this.
>>>>>>> 
>>>>>>> Dirk
>>>>>>> 
>>>>>>> 
>>>>>>> 
>>>>>> ______________________________**________________
>>>>>> R-devel at r-project.org mailing list
>>>>>> https://stat.ethz.ch/mailman/**listinfo/r-devel<https://stat.ethz.ch/mailman/listinfo/r-devel>
>>>>>> 
>>>>> 
>>>>> 
>>>>> 
>>> 
>>> 
>> ______________________________**________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/**listinfo/r-devel<https://stat.ethz.ch/mailman/listinfo/r-devel>
>> 
> 
> 
> 
> -- 
> Jonathan A. Greenberg, PhD
> Assistant Professor
> Global Environmental Analysis and Remote Sensing (GEARS) Laboratory
> Department of Geography and Geographic Information Science
> University of Illinois at Urbana-Champaign
> 259 Computing Applications Building, MC-150
> 605 East Springfield Avenue
> Champaign, IL  61820-6371
> Phone: 217-300-1924
> http://www.geog.illinois.edu/~jgrn/
> AIM: jgrn307, MSN: jgrn307 at hotmail.com, Gchat: jgrn307, Skype: jgrn3007
> 
> 	[[alternative HTML version deleted]]
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


From pgilbert902 at gmail.com  Fri Nov  1 18:34:36 2013
From: pgilbert902 at gmail.com (Paul Gilbert)
Date: Fri, 01 Nov 2013 13:34:36 -0400
Subject: [Rd] Where to drop a python script?
In-Reply-To: <CABG0rfuOZ2HtV+PJ7nG8NEmG_sTdv2+CQ0EHn=5QmWGTewanfQ@mail.gmail.com>
References: <CABG0rfvUzodJ6c22tU6E+yS_Z1NxieQE+afOAHZ4m+wvjcW2Dg@mail.gmail.com>	<21105.23279.974154.140323@max.nulle.part>	<5271A6F7.8070904@gmail.com>	<52720032.5060702@stats.ox.ac.uk>	<52727852.4000008@gmail.com>	<52729061.4050504@stats.ox.ac.uk>	<52729739.4050401@gmail.com>
	<CABG0rfuOZ2HtV+PJ7nG8NEmG_sTdv2+CQ0EHn=5QmWGTewanfQ@mail.gmail.com>
Message-ID: <5273E62C.9000008@gmail.com>

Jonathan

Below is a python script I have been playing with for extracing some 
system information and additional information about modules that I need 
to import in my TSjson package. My intention is to put R code in tests/ 
that will check this before going on to do other tests, but I have not 
yet done that. The reason for this is that error message are not 
especially enlightening when other tests fail because python is not 
working as needed.

Please let me know if you find improvements.

Paul
__________

def test():

     try:
         import sys
	have_sys = True
     except:
	have_sys = False

     if sys.version_info >= (3, 0): return dict( error=
	"TSjson requires Python 2. Running "+ str(sys.version_info))
     # mechanize is not (yet) available for Python 3,
     # Also, urllib2 is split into urllib.request, urllib.error in Python 3


     try:
         import urllib2
	have_urllib2 = True
     except:
	have_urllib2 = False

     try:
         import re
	have_re = True
     except:
	have_re = False

     try:
         import csv
	have_csv = True
     except:
	have_csv = False

     try:
         import mechanize
	have_mechanize = True
     except:
	have_mechanize = False

     if (have_sys & have_urllib2 & have_re & have_csv & have_mechanize):
         err = 0
     else:
	err = 1

     return dict(
          exit=err,
              have_sys=have_sys, have_urllib2=have_urllib2,
              have_re = have_re, have_csv = have_csv,
	     have_mechanize = have_mechanize)


try:
     import json
     print(json.JSONEncoder().encode(test()))
except:
     print(dict(exit=1, have_json = False))



On 13-11-01 10:17 AM, Jonathan Greenberg wrote:
> This was actually the little script I was going to include (prompting me
> to ask the question): a test for the python version number.
> Save this (between the ***s) as e.g. python_version.py:
>
> ***
>
> import sys
> print(sys.version_info)
>
> ***
>
> I've done almost no python coding, so I was going to call this with a
> system("/pathto/python /pathto/python_version.py",intern=TRUE) call and
> post-process the one-line text output.
>
> --j
>
>
> On Thu, Oct 31, 2013 at 12:45 PM, Paul Gilbert <pgilbert902 at gmail.com
> <mailto:pgilbert902 at gmail.com>> wrote:
>
>
>
>     On 13-10-31 01 <tel:13-10-31%2001>:16 PM, Prof Brian Ripley wrote:
>
>         On 31/10/2013 15:33, Paul Gilbert wrote:
>
>
>
>             On 13-10-31 03 <tel:13-10-31%2003>:01 AM, Prof Brian Ripley
>             wrote:
>
>                 On 31/10/2013 00:40, Paul Gilbert wrote:
>
>                     The old convention was that it went in the exec/
>                     directory, but as you
>                     can see at
>                     http://cran.at.r-project.org/__doc/manuals/r-devel/R-exts.__html#Non_002dR-scripts-in-__packages
>                     <http://cran.at.r-project.org/doc/manuals/r-devel/R-exts.html#Non_002dR-scripts-in-packages>
>
>
>
>                        it can be in inst/anyName/. A minor convenience
>                     of exec/ is that the
>                     directory has the same name in source and when
>                     installed, whereas
>                     inst/anyName gets moved to anyName/, so debugging
>                     can be a tiny bit
>                     easier with exec/.
>
>                     Having just put a package (TSjson) on CRAN with a
>                     python script, here
>                     are a few other pointers for getting it on CRAN:
>
>                     -SystemRequirements: should indicate if a particular
>                     version of python
>                     is needed, and any non-default modules that are
>                     needed. (My package
>                     does
>                     not work with Python 3 because some modules are not
>                     available.) Some of
>                     the libraries have changed, so it could be a bit
>                     tricky to make
>                     something work easily with both 2 and 3.
>
>                     -You need a README to explain how to install Python.
>                     (If you look at or
>                     use mine, please let me know if you find problems.)
>
>
>                 Better to describe exactly what you need: installation
>                 instructions go
>                 stale very easily.
>
>                     -The Linux and Sun CRAN test machines have Python 2
>                     whereas winbuilder
>                     has Python 3. Be prepared to explain that the
>                     package will not work on
>                     one or the other.
>
>
>                 Not true.  Linux and Solaris (sic) have both: the
>                 Solaris machines have
>                 2.6 and 3.3.
>
>
>             For an R package how does one go about specifying which
>             should be used?
>
>
>         You ask the user to tell you the path or at least the command
>         name, e.g.
>         by an environment variable or R function argument.  Just like
>         any other
>         external program such as GhostScript.
>
>
>     Yes, but since I don't have direct access to the CRAN test machines,
>     specifically, on the CRAN test machines, how do I specify to use
>     Python 2 or Python 3? (That is, I think you are the user when CRAN
>     tests are done on Solaris, so I am asking you.)
>
>
>
>
>                 Please do not spread misinformation about machines you do
>                 not have any access to.
>
>
>                     Another option to system() is pipe()
>
>                     Paul
>
>                     On 13-10-30 03 <tel:13-10-30%2003>:15 PM, Dirk
>                     Eddelbuettel wrote:
>
>
>                         On 30 October 2013 at 13:54, Jonathan Greenberg
>                         wrote:
>                         | R-developers:
>                         |
>                         | I have a small python script that I'd like to
>                         include in an R
>                         package I'm
>                         | developing, but I'm a bit unclear about which
>                         subfolder it should go
>                         in.  R
>                         | will be calling the script via a system()
>                         call.  Thanks!
>
>                         Up to you as you control the path. As "Writing R
>                         Extensions" explains,
>                         everything below the (source) directory inst/
>                         will get installed.  I
>                         like
>                         inst/extScripts/ (or similar) as it denotes that
>                         it is an external
>                         script.
>
>                         As an example, the gdata package has Perl code
>                         for xls reading/writing
>                         below a
>                         directory inst/perl/ -- and I think there are
>                         more packages doing
>                         this.
>
>                         Dirk
>
>
>
>                     ________________________________________________
>                     R-devel at r-project.org <mailto:R-devel at r-project.org>
>                     mailing list
>                     https://stat.ethz.ch/mailman/__listinfo/r-devel
>                     <https://stat.ethz.ch/mailman/listinfo/r-devel>
>
>
>
>
>
>
>     ________________________________________________
>     R-devel at r-project.org <mailto:R-devel at r-project.org> mailing list
>     https://stat.ethz.ch/mailman/__listinfo/r-devel
>     <https://stat.ethz.ch/mailman/listinfo/r-devel>
>
>
>
>
> --
> Jonathan A. Greenberg, PhD
> Assistant Professor
> Global Environmental Analysis and Remote Sensing (GEARS) Laboratory
> Department of Geography and Geographic Information Science
> University of Illinois at Urbana-Champaign
> 259 Computing Applications Building, MC-150
> 605 East Springfield Avenue
> Champaign, IL  61820-6371
> Phone: 217-300-1924
> http://www.geog.illinois.edu/~jgrn/
> AIM: jgrn307, MSN: jgrn307 at hotmail.com <mailto:jgrn307 at hotmail.com>,
> Gchat: jgrn307, Skype: jgrn3007


From hb at biostat.ucsf.edu  Sun Nov  3 05:24:03 2013
From: hb at biostat.ucsf.edu (Henrik Bengtsson)
Date: Sat, 2 Nov 2013 21:24:03 -0700
Subject: [Rd] on.exit() & sys.on.exit(): Calling them via eval() does not
	work as hoped
Message-ID: <CAFDcVCTsGqADPyf_MAiNmLKZofLpy-BkXGABXT6G5=kjotMQcw@mail.gmail.com>

Why does the following eval() call on sys.on.exit() not return what I
expect/evaluate in the proper environment?

foo <- function() {
  cat("foo()...\n");
  on.exit( message("exiting") )

  cat("sys.on.exit():\n")
  res <- sys.on.exit()
  print(res)

  cat("eval(sys.on.exit()):\n")
  expr <- quote(sys.on.exit())
  print(expr)
  res <- eval(expr)
  print(res)

  cat("foo()...done\n")
}

> foo()
foo()...
sys.on.exit():
message("exiting")
eval(sys.on.exit()):
sys.on.exit()
NULL
foo()...done
exiting

Similar problems appear when I try to "record" on.exit() expressions
via eval().  It appears that the "primitives" on.exit() and
sys.on.exit() do something rather special.  Is there a solution to
what I'm trying to do?

The reason why I'm doing this in the first place, is that I'm trying
to implement onExit(<expr>, where="replace"), onExit(<expr>,
where="last"), and onExit(<expr>, where="first").

Thanks,

Henrik


From peter.meilstrup at gmail.com  Sun Nov  3 11:16:45 2013
From: peter.meilstrup at gmail.com (Peter Meilstrup)
Date: Sun, 3 Nov 2013 02:16:45 -0800
Subject: [Rd] on.exit() & sys.on.exit(): Calling them via eval() does
 not work as hoped
In-Reply-To: <CAFDcVCTsGqADPyf_MAiNmLKZofLpy-BkXGABXT6G5=kjotMQcw@mail.gmail.com>
References: <CAFDcVCTsGqADPyf_MAiNmLKZofLpy-BkXGABXT6G5=kjotMQcw@mail.gmail.com>
Message-ID: <CAJoaRhbVstp3U_fxUH09dPFeSvuM3DU0otROWYnrYxpqwEpk-g@mail.gmail.com>

eval() tends to be able to convince normal functions of where they are
executing, but primitive functions use different methods to get their
evaluation context and aren't as easily fooled. It turns out do.call()
works better on primitive functions, and it will work for "on.exit".
However I wasn't able to get 'sys.on.exit' to work.

add_on_exit <- function(what) {
  do.call("on.exit", list(substitute(what), add=TRUE), envir=parent.frame())
}

bar <- function() {
  on.exit(print("exit 1"))
  eval(quote(on.exit(print("exit 2"), add=TRUE))) #nope
  do.call("on.exit", alist(print("exit 3"), add=TRUE))
  add_on_exit(print("exit 4"))
  cat("sys.on.exit():\n")
  x <- sys.on.exit()
  print(x)
  cat("----- exiting\n")
}

> bar()
[1] "exit 2"
sys.on.exit():
{
    print("exit 1")
    print("exit 3")
    print("exit 4")
}
----- exiting
[1] "exit 1"
[1] "exit 3"
[1] "exit 4"


On Sat, Nov 2, 2013 at 9:24 PM, Henrik Bengtsson <hb at biostat.ucsf.edu> wrote:
> Why does the following eval() call on sys.on.exit() not return what I
> expect/evaluate in the proper environment?
>
> foo <- function() {
>   cat("foo()...\n");
>   on.exit( message("exiting") )
>
>   cat("sys.on.exit():\n")
>   res <- sys.on.exit()
>   print(res)
>
>   cat("eval(sys.on.exit()):\n")
>   expr <- quote(sys.on.exit())
>   print(expr)
>   res <- eval(expr)
>   print(res)
>
>   cat("foo()...done\n")
> }
>
>> foo()
> foo()...
> sys.on.exit():
> message("exiting")
> eval(sys.on.exit()):
> sys.on.exit()
> NULL
> foo()...done
> exiting
>
> Similar problems appear when I try to "record" on.exit() expressions
> via eval().  It appears that the "primitives" on.exit() and
> sys.on.exit() do something rather special.  Is there a solution to
> what I'm trying to do?
>
> The reason why I'm doing this in the first place, is that I'm trying
> to implement onExit(<expr>, where="replace"), onExit(<expr>,
> where="last"), and onExit(<expr>, where="first").
>
> Thanks,
>
> Henrik
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


From simonqijiezhao at gmail.com  Sun Nov  3 04:35:47 2013
From: simonqijiezhao at gmail.com (Simon)
Date: Sun, 03 Nov 2013 11:35:47 +0800
Subject: [Rd] How to make an R package that uses Boost.Thread,
 qualified to be published on CRAN or shared by the most
Message-ID: <5275C493.70507@gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131103/ba4eb49d/attachment.pl>

From edd at debian.org  Sun Nov  3 14:54:36 2013
From: edd at debian.org (Dirk Eddelbuettel)
Date: Sun, 3 Nov 2013 07:54:36 -0600
Subject: [Rd] How to make an R package that uses Boost.Thread,
 qualified to be published on CRAN or shared by the most
In-Reply-To: <5275C493.70507@gmail.com>
References: <5275C493.70507@gmail.com>
Message-ID: <21110.21916.918913.999478@max.nulle.part>


On 3 November 2013 at 11:35, Simon wrote:
| Hi,
| 
| Recently, I made an R package that used the C++ library Boost.Thread (http://www.boost.org/doc/libs/1_54_0/doc/html/thread.html) for multithreading.  Previously, I have posted a question at stackoverflow (http://stackoverflow.com/questions/19651954/is-it-possible-to-build-an-r-package-which-use-rcpp-and-boost-thread-on-http), and I also asked at rcpp-devel (http://lists.r-forge.r-project.org/pipermail/rcpp-devel/2013-November/006777.html).  Dirk Eddelbuettel suggested me ask here.  After some tries on win-builder and some research on CRAN, there are still some doubts:

Thanks for posting here, and for including code.  I tried to answer both your
questions before. You are now providing more and more context which helps.
 
| 1) For my package to be accepted by CRAN, I am not so sure if it is acceptable to let users to install Boost library themselves?  If not, are there any solutions? I found there are some third party external software or libraries used by other R packages, such as OpenMP and gtk, some of which have corresponding R packages, but there are little discuss about Boost.
| 
| (I now know there are some other ways to host my package, but I think CRAN is more straight forward, though it may be stricter.)

This question is really several questions:

1a) If I write a package using library xyz, do users need xyz to compile my
    package?

    Yes of course. 

1b) If I write a package using library xyz, do _windows_ users need xyz to
    _use_ my package?

    No as CRAN provides Windows binary packages.

1c) What about the other OSs?

    It depends. If users need to compile first, then yes. But Boost is very
    standard on OS X and Linux. 

So yes, it is quite acceptable to depend on Boost.
 

| 2) As I said in my question at stackoverflow (http://stackoverflow.com/questions/19651954/is-it-possible-to-build-an-r-package-which-use-rcpp-and-boost-thread-on-http), I have tried MAKE variable BOOSTLIB on win-builder (http://win-builder.r-project.org/), It is OK for header-only Boost libraries.  I am not sure whether it is OK for separately-compiled libraries such as Boost.Thread, after many fails.  Is it possible? Are there any special variables or path for Boost.Thread?  May I suppose that it is acceptable for 1) if there are, or at least for header-only Boost libraies?

I do not know if BOOSTLIB on win-builder and CRAN also points to a library
you can use. And I cannot think of a package using it.  Maybe Uwe Ligges will
be able to help you here.

| (There are an R package called BH provides header-only Boost libraries, but BOOSTLIB make me imagine something else.)

BOOSTLIB predates the creation of our BH package by several years.  

Dirk

| 
| 
| 
| Simon
| 
| 
| 
| PS: 
| Below are the source files and results of my tries for exploring BOOSTLIB on win-builder, please forgive me use win-builder as a test machine, so I post my questions here.
| The test package is derived from command Rscript -e "Rcpp.package.skeleton()", below just lists some modifications by me.
| The outputs in 00install.out are too long to be pasted here.
| -------------------------------
| rcpp_hello_world.cpp
| -------------------------------
| #include "rcpp_hello_world.h"
| 
| #include "boost/lambda/lambda.hpp"
| #include <iostream>
| #include <iterator>
| #include <algorithm>
| #include <vector>
| 
| #include "boost/thread.hpp"
| 
| void wait(int seconds) {
|   boost::this_thread::sleep(boost::posix_time::seconds(seconds));
| }
| 
| void thread() {
|   for (int i = 0; i < 5; i++) {
|     wait(1);
|     std::cout << i << std::endl;
|   }
| }
| 
| SEXP rcpp_hello_world(){
|     using namespace Rcpp ;
|     using namespace boost::lambda;
| 
|     std::vector<int> a;
|     a.push_back(1);
|     a.push_back(2);
| //    std::for_each( a.begin(), a.end(), _1 = 1);
| 
|     boost::thread t(thread);
|     t.join();
| 
|     return wrap(a);
| }
| 
| -------------------------------
| Makevars.win (try 1: try to find if there is a file called libboost_thread*)
| -------------------------------
| ## Use the R_HOME indirection to support installations of multiple R version
| ## PKG_CXXFLAGS = `$(R_HOME)/bin/Rscript -e "Rcpp:::CxxFlags()"`
| PKG_CPPFLAGS = -I${BOOSTLIB}
| PKG_LIBS = $(shell "${R_HOME}/bin${R_ARCH_BIN}/Rscript.exe" -e "Rcpp:::LdFlags()") ${BOOSTLIB}/lib/libboost_thread*
| 
| -------------------------------
| Makevars.win (try 2: try to find something in lib)
| -------------------------------
| ## Use the R_HOME indirection to support installations of multiple R version
| ## PKG_CXXFLAGS = `$(R_HOME)/bin/Rscript -e "Rcpp:::CxxFlags()"`
| PKG_CPPFLAGS = -I${BOOSTLIB}
| PKG_LIBS = $(shell "${R_HOME}/bin${R_ARCH_BIN}/Rscript.exe" -e "Rcpp:::LdFlags()") `ls ${BOOSTLIB}/lib/*`
| 
| -------------------------------
| Makevars.win (try 3: try to find something in libs)
| -------------------------------
| ## Use the R_HOME indirection to support installations of multiple R version
| ## PKG_CXXFLAGS = `$(R_HOME)/bin/Rscript -e "Rcpp:::CxxFlags()"`
| PKG_CPPFLAGS = -I${BOOSTLIB}
| PKG_LIBS = $(shell "${R_HOME}/bin${R_ARCH_BIN}/Rscript.exe" -e "Rcpp:::LdFlags()") `ls ${BOOSTLIB}/libs/*`
| 
| -------------------------------
| Makevars.win (try 4: try to figure out what are in ${BOOSTLIB})
| -------------------------------
| ## Use the R_HOME indirection to support installations of multiple R version
| ## PKG_CXXFLAGS = `$(R_HOME)/bin/Rscript -e "Rcpp:::CxxFlags()"`
| PKG_CPPFLAGS = -I${BOOSTLIB}
| PKG_LIBS = $(shell "${R_HOME}/bin${R_ARCH_BIN}/Rscript.exe" -e "Rcpp:::LdFlags()") `ls ${BOOSTLIB}/*`
| 
| 
| 
| 	[[alternative HTML version deleted]]
| 
| ______________________________________________
| R-devel at r-project.org mailing list
| https://stat.ethz.ch/mailman/listinfo/r-devel

-- 
Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com


From nashjc at uottawa.ca  Sun Nov  3 20:15:40 2013
From: nashjc at uottawa.ca (Prof J C Nash (U30A))
Date: Sun, 03 Nov 2013 14:15:40 -0500
Subject: [Rd] Byte code compile not helpful in R3.0.2
Message-ID: <5276A0DC.2010202@uottawa.ca>

I had a bunch of examples of byte code compiles in something I was
writing. Changed to 3.0.2 and the advantage of compiler disappears. I've
looked in the NEWS file but do not see anything that suggests that the
compile is now built-in. Possibly I've just happened on a bunch of
examples where it does not help, but experiences of a year ago do not
seem to remain valid now. Just wondering if my experience was consistent
with what is expected now in 3.0.2.

John Nash


From murdoch.duncan at gmail.com  Sun Nov  3 20:22:37 2013
From: murdoch.duncan at gmail.com (Duncan Murdoch)
Date: Sun, 03 Nov 2013 14:22:37 -0500
Subject: [Rd] Byte code compile not helpful in R3.0.2
In-Reply-To: <5276A0DC.2010202@uottawa.ca>
References: <5276A0DC.2010202@uottawa.ca>
Message-ID: <5276A27D.5070106@gmail.com>

On 13-11-03 2:15 PM, Prof J C Nash (U30A) wrote:
> I had a bunch of examples of byte code compiles in something I was
> writing. Changed to 3.0.2 and the advantage of compiler disappears. I've
> looked in the NEWS file but do not see anything that suggests that the
> compile is now built-in. Possibly I've just happened on a bunch of
> examples where it does not help, but experiences of a year ago do not
> seem to remain valid now. Just wondering if my experience was consistent
> with what is expected now in 3.0.2.

Post some details, please.  Are the times in 3.0.2 like the times in 
3.0.1 with or without compiling?  Or were you comparing to some other 
version?

Duncan Murdoch


From nashjc at uottawa.ca  Sun Nov  3 20:55:01 2013
From: nashjc at uottawa.ca (Prof J C Nash (U30A))
Date: Sun, 03 Nov 2013 14:55:01 -0500
Subject: [Rd] Byte code compile not helpful in R3.0.2
In-Reply-To: <5276A27D.5070106@gmail.com>
References: <5276A0DC.2010202@uottawa.ca> <5276A27D.5070106@gmail.com>
Message-ID: <5276AA15.5040106@uottawa.ca>

My bad to not give details. I'm comparing (though not quite directly) to
results in the posting
http://rwiki.sciviews.org/doku.php?id=tips:rqcasestudy.

What prompted the query was a write up of "for" versus "while" loops,
where there was a speedup using compiler for one of these. I had the
example in a knitr file, and when I was reviewing the text before
sending it to an editor, I realized the timings no longer supported the
text. They were, as I recall, developed in R 2.15.2, and I just looked
through my VMs with different OS's to see if there is one with that
still extant, but except for a real Win7 case I have been too "good" and
updated to at least 3.0.1, where I'm getting no advantage. The Win7 case
is R 2.15.1, and there the compiler actually went slower on one run of
the code below. That may be due to antivirus running -- had not booted
that partition for quite a while.

Here is the for-while test code:

#  forwhiletime.R
library(microbenchmark)
require(compiler)

tfor <- function(n){
    for (i in 1:n) {
       xx<-exp(sin(cos(as.double(i))))
    }
    xx
}

twhile <- function(n){
    i<-0
    while (i<n) {
       i<-i+1
       xx<-exp(sin(cos(as.double(i))))
    }
    xx
}
n<-10000

timfor<-microbenchmark(tfor(n))
timwhile<-microbenchmark(twhile(n))
timfor
timwhile
cmpfun(tfor)
cmpfun(twhile)
timforc<-microbenchmark(tfor(n))
timwhilec<-microbenchmark(twhile(n))
timforc
timwhilec
looptimes<-data.frame(timfor$time, timforc$time, timwhile$time,
timwhilec$time)
colMeans(looptimes)


Actually, I'm not greatly axious about all this. Mainly I want to make
sure that I get whatever advice is to be rendered so it is correct.

Best,

JN


On 13-11-03 02:22 PM, Duncan Murdoch wrote:
> On 13-11-03 2:15 PM, Prof J C Nash (U30A) wrote:
>> I had a bunch of examples of byte code compiles in something I was
>> writing. Changed to 3.0.2 and the advantage of compiler disappears. I've
>> looked in the NEWS file but do not see anything that suggests that the
>> compile is now built-in. Possibly I've just happened on a bunch of
>> examples where it does not help, but experiences of a year ago do not
>> seem to remain valid now. Just wondering if my experience was consistent
>> with what is expected now in 3.0.2.
> 
> Post some details, please.  Are the times in 3.0.2 like the times in
> 3.0.1 with or without compiling?  Or were you comparing to some other
> version?
> 
> Duncan Murdoch
> 
> 
>


From hb at biostat.ucsf.edu  Sun Nov  3 21:46:47 2013
From: hb at biostat.ucsf.edu (Henrik Bengtsson)
Date: Sun, 3 Nov 2013 12:46:47 -0800
Subject: [Rd] Byte code compile not helpful in R3.0.2
In-Reply-To: <5276AA15.5040106@uottawa.ca>
References: <5276A0DC.2010202@uottawa.ca> <5276A27D.5070106@gmail.com>
	<5276AA15.5040106@uottawa.ca>
Message-ID: <CAFDcVCQ4JrgFc8jDJrAMkizCD=Uk=P2uQYJajjk3NY90jQtupw@mail.gmail.com>

tfor <- cmpfun(tfor)
twhile <- cmpfun(twhile)

/Henrik


On Sun, Nov 3, 2013 at 11:55 AM, Prof J C Nash (U30A) <nashjc at uottawa.ca> wrote:
> My bad to not give details. I'm comparing (though not quite directly) to
> results in the posting
> http://rwiki.sciviews.org/doku.php?id=tips:rqcasestudy.
>
> What prompted the query was a write up of "for" versus "while" loops,
> where there was a speedup using compiler for one of these. I had the
> example in a knitr file, and when I was reviewing the text before
> sending it to an editor, I realized the timings no longer supported the
> text. They were, as I recall, developed in R 2.15.2, and I just looked
> through my VMs with different OS's to see if there is one with that
> still extant, but except for a real Win7 case I have been too "good" and
> updated to at least 3.0.1, where I'm getting no advantage. The Win7 case
> is R 2.15.1, and there the compiler actually went slower on one run of
> the code below. That may be due to antivirus running -- had not booted
> that partition for quite a while.
>
> Here is the for-while test code:
>
> #  forwhiletime.R
> library(microbenchmark)
> require(compiler)
>
> tfor <- function(n){
>     for (i in 1:n) {
>        xx<-exp(sin(cos(as.double(i))))
>     }
>     xx
> }
>
> twhile <- function(n){
>     i<-0
>     while (i<n) {
>        i<-i+1
>        xx<-exp(sin(cos(as.double(i))))
>     }
>     xx
> }
> n<-10000
>
> timfor<-microbenchmark(tfor(n))
> timwhile<-microbenchmark(twhile(n))
> timfor
> timwhile
> cmpfun(tfor)
> cmpfun(twhile)
> timforc<-microbenchmark(tfor(n))
> timwhilec<-microbenchmark(twhile(n))
> timforc
> timwhilec
> looptimes<-data.frame(timfor$time, timforc$time, timwhile$time,
> timwhilec$time)
> colMeans(looptimes)
>
>
> Actually, I'm not greatly axious about all this. Mainly I want to make
> sure that I get whatever advice is to be rendered so it is correct.
>
> Best,
>
> JN
>
>
> On 13-11-03 02:22 PM, Duncan Murdoch wrote:
>> On 13-11-03 2:15 PM, Prof J C Nash (U30A) wrote:
>>> I had a bunch of examples of byte code compiles in something I was
>>> writing. Changed to 3.0.2 and the advantage of compiler disappears. I've
>>> looked in the NEWS file but do not see anything that suggests that the
>>> compile is now built-in. Possibly I've just happened on a bunch of
>>> examples where it does not help, but experiences of a year ago do not
>>> seem to remain valid now. Just wondering if my experience was consistent
>>> with what is expected now in 3.0.2.
>>
>> Post some details, please.  Are the times in 3.0.2 like the times in
>> 3.0.1 with or without compiling?  Or were you comparing to some other
>> version?
>>
>> Duncan Murdoch
>>
>>
>>
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


From hb at biostat.ucsf.edu  Sun Nov  3 22:19:37 2013
From: hb at biostat.ucsf.edu (Henrik Bengtsson)
Date: Sun, 3 Nov 2013 13:19:37 -0800
Subject: [Rd] on.exit() & sys.on.exit(): Calling them via eval() does
 not work as hoped
In-Reply-To: <CAJoaRhbVstp3U_fxUH09dPFeSvuM3DU0otROWYnrYxpqwEpk-g@mail.gmail.com>
References: <CAFDcVCTsGqADPyf_MAiNmLKZofLpy-BkXGABXT6G5=kjotMQcw@mail.gmail.com>
	<CAJoaRhbVstp3U_fxUH09dPFeSvuM3DU0otROWYnrYxpqwEpk-g@mail.gmail.com>
Message-ID: <CAFDcVCSm=3kskifjomJjoGL8d0EXa-xYdiwfiBOc0PSaLMyUOg@mail.gmail.com>

On Sun, Nov 3, 2013 at 2:16 AM, Peter Meilstrup
<peter.meilstrup at gmail.com> wrote:
> eval() tends to be able to convince normal functions of where they are
> executing, but primitive functions use different methods to get their
> evaluation context and aren't as easily fooled.

Brilliant wording :)

> It turns out do.call()
> works better on primitive functions, and it will work for "on.exit".
> However I wasn't able to get 'sys.on.exit' to work.
>
> add_on_exit <- function(what) {
>   do.call("on.exit", list(substitute(what), add=TRUE), envir=parent.frame())
> }

Interesting, but also worrying at the same time.  Since these are
undocumented(*) "features" of on.exit()/sys.on.exit() and it works for
on.exit() and not sys.on.exit(), it also means that I'm not sure if I
can rely on this do.call() workaround to not break in the future.  If
would be great to hear what the R core team thinks about this.

(*) There is a small note in help("on.exit") saying "This is a
?special? primitive function: it only evaluates the argument add.".

/Henrik

>
> bar <- function() {
>   on.exit(print("exit 1"))
>   eval(quote(on.exit(print("exit 2"), add=TRUE))) #nope
>   do.call("on.exit", alist(print("exit 3"), add=TRUE))
>   add_on_exit(print("exit 4"))
>   cat("sys.on.exit():\n")
>   x <- sys.on.exit()
>   print(x)
>   cat("----- exiting\n")
> }
>
>> bar()
> [1] "exit 2"
> sys.on.exit():
> {
>     print("exit 1")
>     print("exit 3")
>     print("exit 4")
> }
> ----- exiting
> [1] "exit 1"
> [1] "exit 3"
> [1] "exit 4"
>
>
> On Sat, Nov 2, 2013 at 9:24 PM, Henrik Bengtsson <hb at biostat.ucsf.edu> wrote:
>> Why does the following eval() call on sys.on.exit() not return what I
>> expect/evaluate in the proper environment?
>>
>> foo <- function() {
>>   cat("foo()...\n");
>>   on.exit( message("exiting") )
>>
>>   cat("sys.on.exit():\n")
>>   res <- sys.on.exit()
>>   print(res)
>>
>>   cat("eval(sys.on.exit()):\n")
>>   expr <- quote(sys.on.exit())
>>   print(expr)
>>   res <- eval(expr)
>>   print(res)
>>
>>   cat("foo()...done\n")
>> }
>>
>>> foo()
>> foo()...
>> sys.on.exit():
>> message("exiting")
>> eval(sys.on.exit()):
>> sys.on.exit()
>> NULL
>> foo()...done
>> exiting
>>
>> Similar problems appear when I try to "record" on.exit() expressions
>> via eval().  It appears that the "primitives" on.exit() and
>> sys.on.exit() do something rather special.  Is there a solution to
>> what I'm trying to do?
>>
>> The reason why I'm doing this in the first place, is that I'm trying
>> to implement onExit(<expr>, where="replace"), onExit(<expr>,
>> where="last"), and onExit(<expr>, where="first").
>>
>> Thanks,
>>
>> Henrik
>>
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel


From nashjc at uottawa.ca  Sun Nov  3 22:24:58 2013
From: nashjc at uottawa.ca (Prof J C Nash (U30A))
Date: Sun, 03 Nov 2013 16:24:58 -0500
Subject: [Rd] Byte code compile (not) helpful in R3.0.2  -- Fixed.
In-Reply-To: <CAFDcVCQ4JrgFc8jDJrAMkizCD=Uk=P2uQYJajjk3NY90jQtupw@mail.gmail.com>
References: <5276A0DC.2010202@uottawa.ca> <5276A27D.5070106@gmail.com>
	<5276AA15.5040106@uottawa.ca>
	<CAFDcVCQ4JrgFc8jDJrAMkizCD=Uk=P2uQYJajjk3NY90jQtupw@mail.gmail.com>
Message-ID: <5276BF2A.40001@uottawa.ca>

Thanks. I should not try adjusting code after some hours of proofreading.

Making that change gave a suitable time difference.

Best, JN



On 13-11-03 03:46 PM, Henrik Bengtsson wrote:
> tfor <- cmpfun(tfor)
> twhile <- cmpfun(twhile)
> 
> /Henrik
> 
> 
> On Sun, Nov 3, 2013 at 11:55 AM, Prof J C Nash (U30A) <nashjc at uottawa.ca> wrote:
>> My bad to not give details. I'm comparing (though not quite directly) to
>> results in the posting
>> http://rwiki.sciviews.org/doku.php?id=tips:rqcasestudy.
>>
>> What prompted the query was a write up of "for" versus "while" loops,
>> where there was a speedup using compiler for one of these. I had the
>> example in a knitr file, and when I was reviewing the text before
>> sending it to an editor, I realized the timings no longer supported the
>> text. They were, as I recall, developed in R 2.15.2, and I just looked
>> through my VMs with different OS's to see if there is one with that
>> still extant, but except for a real Win7 case I have been too "good" and
>> updated to at least 3.0.1, where I'm getting no advantage. The Win7 case
>> is R 2.15.1, and there the compiler actually went slower on one run of
>> the code below. That may be due to antivirus running -- had not booted
>> that partition for quite a while.
>>
>> Here is the for-while test code:
>>
>> #  forwhiletime.R
>> library(microbenchmark)
>> require(compiler)
>>
>> tfor <- function(n){
>>     for (i in 1:n) {
>>        xx<-exp(sin(cos(as.double(i))))
>>     }
>>     xx
>> }
>>
>> twhile <- function(n){
>>     i<-0
>>     while (i<n) {
>>        i<-i+1
>>        xx<-exp(sin(cos(as.double(i))))
>>     }
>>     xx
>> }
>> n<-10000
>>
>> timfor<-microbenchmark(tfor(n))
>> timwhile<-microbenchmark(twhile(n))
>> timfor
>> timwhile
>> cmpfun(tfor)
>> cmpfun(twhile)
>> timforc<-microbenchmark(tfor(n))
>> timwhilec<-microbenchmark(twhile(n))
>> timforc
>> timwhilec
>> looptimes<-data.frame(timfor$time, timforc$time, timwhile$time,
>> timwhilec$time)
>> colMeans(looptimes)
>>
>>
>> Actually, I'm not greatly axious about all this. Mainly I want to make
>> sure that I get whatever advice is to be rendered so it is correct.
>>
>> Best,
>>
>> JN
>>
>>
>> On 13-11-03 02:22 PM, Duncan Murdoch wrote:
>>> On 13-11-03 2:15 PM, Prof J C Nash (U30A) wrote:
>>>> I had a bunch of examples of byte code compiles in something I was
>>>> writing. Changed to 3.0.2 and the advantage of compiler disappears. I've
>>>> looked in the NEWS file but do not see anything that suggests that the
>>>> compile is now built-in. Possibly I've just happened on a bunch of
>>>> examples where it does not help, but experiences of a year ago do not
>>>> seem to remain valid now. Just wondering if my experience was consistent
>>>> with what is expected now in 3.0.2.
>>>
>>> Post some details, please.  Are the times in 3.0.2 like the times in
>>> 3.0.1 with or without compiling?  Or were you comparing to some other
>>> version?
>>>
>>> Duncan Murdoch
>>>
>>>
>>>
>>
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel


From hb at biostat.ucsf.edu  Sun Nov  3 22:42:08 2013
From: hb at biostat.ucsf.edu (Henrik Bengtsson)
Date: Sun, 3 Nov 2013 13:42:08 -0800
Subject: [Rd] WISHLIST: on.exit(..., add=TRUE,
	where="first") to address common use cases
Message-ID: <CAFDcVCQ1Hq63=7tXuJRRC4zQJ9hB0qg+3pzzgKhq2_CGw5SRSw@mail.gmail.com>

Before trying to submit a patch(*) to on.exit(), I'd like to check
whether there is an interest in enhancing on.exit(..., add=TRUE) such
that it is possible to specify whether the added expression should be
added before or after already recorded expression.  The default is now
to add it after, but it would often be useful to add it before
previously recorded expressions.

EXAMPLE:

foo <- function(path="work") {
  # Change working directory. Make sure to reset on exit.
  opwd <- setwd(path)
  on.exit(setwd(opwd))

  # Write to a local temporary file.  Make sure to remove it on exit.
  cat("Hello", file="local.txt")
  on.exit(file.remove("local.txt"), add=TRUE, where="first")
}

Without where="first" (i.e. using where="last" as on.exit() does now),
it all becomes unnecessarily complicated.

Comments?

(*) It seems to come down to adjusting a few lines of code to
do_onexit() [http://svn.r-project.org/R/trunk/src/main/builtin.c] to
control whether the expression should be prepended or appended to the
existing set of recorded expressions.

/Henrik


From lizhen.peng at stonybrook.edu  Sun Nov  3 22:15:31 2013
From: lizhen.peng at stonybrook.edu (Lizkitty)
Date: Sun, 3 Nov 2013 13:15:31 -0800 (PST)
Subject: [Rd] Failed to install kernlab package
Message-ID: <1383513331455-4679652.post@n4.nabble.com>

Hi everyone, 

I am trying to install kernlab package, but failed many times by now on
CentOS 6 operating system. FYI, I have no problem with this package
installation on windows platform. 

Here is the error message: 

trying URL 'http://cran.wustl.edu/src/contrib/kernlab_0.9-18.tar.gz'
Content type 'application/x-gzip' length 1069148 bytes (1.0 Mb)
opened URL
==================================================
downloaded 1.0 Mb

* installing *source* package ?kernlab? ...
** package ?kernlab? successfully unpacked and MD5 sums checked
** libs
g++ -I/n/sw/R-3.0.1_gcc-4.7.2/lib64/R/include -DNDEBUG  -I/usr/local/include   
-fpic  -g -O2  -c brweight.cpp -o brweight.o
In file included from
/n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/bits/localefwd.h:42:0,
                 from
/n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/ios:42,
                 from
/n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/ostream:40,
                 from
/n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/iostream:40,
                 from errorcode.h:43,
                 from brweight.h:43,
                 from brweight.cpp:42:
/n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/x86_64-unknown-linux-gnu/bits/c++locale.h:53:23:
error: ?uselocale? was not declared in this scope
/n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/x86_64-unknown-linux-gnu/bits/c++locale.h:53:45:
error: invalid type in declaration before ?;? token
/n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/x86_64-unknown-linux-gnu/bits/c++locale.h:
In function ?int std::__convert_from_v(__locale_struct* const&, char*, int,
const char*, ...)?:
/n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/x86_64-unknown-linux-gnu/bits/c++locale.h:76:53:
error: ?__gnu_cxx::__uselocale? cannot be used as a function
/n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/x86_64-unknown-linux-gnu/bits/c++locale.h:101:33:
error: ?__gnu_cxx::__uselocale? cannot be used as a function
make: *** [brweight.o] Error 1
ERROR: compilation failed for package ?kernlab?
* removing ?/n/home09/wang/R/x86_64-unknown-linux-gnu-library/3.0/kernlab?

The downloaded source packages are in
        ?/scratch/tmp/Rtmpt52VjR/downloaded_packages?
Warning message:
In install.packages("kernlab") :
  installation of package ?kernlab? had non-zero exit status


I found out online that many others also failed installing kernlab on linux,
but no explicit unique solutions for this problem. 
What I have tried so far are: 
1) change cran mirrors 
2) using command line directly: R CMD INSTALL kernlab_0.9-18.tar.gz, after
downloading the package 
3) reset working directory 
Unfortunately, none of these solved my problem... 

Any suggestions are highly appreciated! 



--
View this message in context: http://r.789695.n4.nabble.com/Failed-to-install-kernlab-package-tp4679652.html
Sent from the R devel mailing list archive at Nabble.com.


From michael.kane at yale.edu  Sun Nov  3 22:45:51 2013
From: michael.kane at yale.edu (Michael Kane)
Date: Sun, 3 Nov 2013 21:45:51 +0000
Subject: [Rd] R 3.1.0 and C++11
References: <21073.63553.888272.510490@max.nulle.part>
	<31E214B6DF75104E942856C2F74953CB0505C0F9@exchange>
	<21075.11278.577153.103691@max.nulle.part>
	<CAMi=pg5aRiFG7s+f4bERE6QQe+D7dH1Y_b9Q6AsH3A7Gz0M-qw@mail.gmail.com>
	<478ce69b232b57db8fa74fa93e5a646a@r-enthusiasts.com>
Message-ID: <loom.20131103T224253-737@post.gmane.org>

I'd like to echo Whit's sentiment and hopefully warm up this thread.
C++11's new features and functionality give R users low-level tools (like
threads, mutexes, futures, date-time, and atomic types) that work across
platforms and wouldn't require other external libraries like boost.

Romain, will you be taking pull requests?


From wdunlap at tibco.com  Mon Nov  4 01:31:42 2013
From: wdunlap at tibco.com (William Dunlap)
Date: Mon, 4 Nov 2013 00:31:42 +0000
Subject: [Rd] WISHLIST: on.exit(..., add=TRUE,
 where="first") to address common use cases
In-Reply-To: <CAFDcVCQ1Hq63=7tXuJRRC4zQJ9hB0qg+3pzzgKhq2_CGw5SRSw@mail.gmail.com>
References: <CAFDcVCQ1Hq63=7tXuJRRC4zQJ9hB0qg+3pzzgKhq2_CGw5SRSw@mail.gmail.com>
Message-ID: <E66794E69CFDE04D9A70842786030B933FA128DC@PA-MBX01.na.tibco.com>

I used to worry about the order of evaluation of on.exit expressions and
thought that maybe we needed named on.exit expression so you could
remove particular on.exit expressions.  However,  now I think I can almost always
avoid such considerations and make code clearer by making a new function call,
often involving a lazily evaluated expression, whenever I need a new on.exit
expression.   E.g., instead of
    f0 <- function(x, y) {
        oldWarn <- options(warn=0)
        on.exit(oldWarn)
        oldMar <- par(rep(2,4))
        on.exit(par(oldMar))
        plot(log(x), y)
    }
use
    f1 <- function(x, y) {
        suppressWarnings(
            withPar(list(mar=rep(2,4)),
                           plot(log(x), y)
            )
        )
    }
suppressWarnings already exists and withPar could be
    withPar <- function(parList, expr) {
        oldPars <- par(parList)
        on.exit(par(oldPars))
        expr
    }
    

Bill Dunlap
Spotfire, TIBCO Software
wdunlap tibco.com


> -----Original Message-----
> From: r-devel-bounces at r-project.org [mailto:r-devel-bounces at r-project.org] On Behalf
> Of Henrik Bengtsson
> Sent: Sunday, November 03, 2013 1:42 PM
> To: R-devel
> Subject: [Rd] WISHLIST: on.exit(..., add=TRUE, where="first") to address common use
> cases
> 
> Before trying to submit a patch(*) to on.exit(), I'd like to check
> whether there is an interest in enhancing on.exit(..., add=TRUE) such
> that it is possible to specify whether the added expression should be
> added before or after already recorded expression.  The default is now
> to add it after, but it would often be useful to add it before
> previously recorded expressions.
> 
> EXAMPLE:
> 
> foo <- function(path="work") {
>   # Change working directory. Make sure to reset on exit.
>   opwd <- setwd(path)
>   on.exit(setwd(opwd))
> 
>   # Write to a local temporary file.  Make sure to remove it on exit.
>   cat("Hello", file="local.txt")
>   on.exit(file.remove("local.txt"), add=TRUE, where="first")
> }
> 
> Without where="first" (i.e. using where="last" as on.exit() does now),
> it all becomes unnecessarily complicated.
> 
> Comments?
> 
> (*) It seems to come down to adjusting a few lines of code to
> do_onexit() [http://svn.r-project.org/R/trunk/src/main/builtin.c] to
> control whether the expression should be prepended or appended to the
> existing set of recorded expressions.
> 
> /Henrik
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


From simonqijiezhao at gmail.com  Mon Nov  4 02:14:33 2013
From: simonqijiezhao at gmail.com (Simon)
Date: Mon, 04 Nov 2013 09:14:33 +0800
Subject: [Rd] How to make an R package that uses Boost.Thread,
 qualified to be published on CRAN or shared by the most
In-Reply-To: <21110.21916.918913.999478@max.nulle.part>
References: <5275C493.70507@gmail.com>
	<21110.21916.918913.999478@max.nulle.part>
Message-ID: <5276F4F9.7070606@gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131104/9e7cf44e/attachment.pl>

From istazahn at gmail.com  Mon Nov  4 04:40:59 2013
From: istazahn at gmail.com (Ista Zahn)
Date: Sun, 3 Nov 2013 22:40:59 -0500
Subject: [Rd] Failed to install kernlab package
In-Reply-To: <1383513331455-4679652.post@n4.nabble.com>
References: <1383513331455-4679652.post@n4.nabble.com>
Message-ID: <CA+vqiLGdx3_xxrLgK69gTXv8Uw94=sr93XdsM62xk8-9-hosGw@mail.gmail.com>

Hi,

I can't reproduce the error with a fully updated CentOS 6 with R-core
and R-devel installed from
http://www.nic.funet.fi/pub/mirrors/fedora.redhat.com/pub/epel/6/x86_64/.
Here is the sessionInfo from my CentOS 6 system where installation of
kernlab was successful:

sessionInfo()
R version 3.0.1 (2013-05-16)
Platform: x86_64-redhat-linux-gnu (64-bit)

locale:
 [1] LC_CTYPE=en_US.utf8       LC_NUMERIC=C
 [3] LC_TIME=en_US.utf8        LC_COLLATE=en_US.utf8
 [5] LC_MONETARY=en_US.utf8    LC_MESSAGES=en_US.utf8
 [7] LC_PAPER=C                LC_NAME=C
 [9] LC_ADDRESS=C              LC_TELEPHONE=C
[11] LC_MEASUREMENT=en_US.utf8 LC_IDENTIFICATION=C

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base

loaded via a namespace (and not attached):
[1] tcltk_3.0.1 tools_3.0.1

Best,
Ista

On Sun, Nov 3, 2013 at 4:15 PM, Lizkitty <lizhen.peng at stonybrook.edu> wrote:
> Hi everyone,
>
> I am trying to install kernlab package, but failed many times by now on
> CentOS 6 operating system. FYI, I have no problem with this package
> installation on windows platform.
>
> Here is the error message:
>
> trying URL 'http://cran.wustl.edu/src/contrib/kernlab_0.9-18.tar.gz'
> Content type 'application/x-gzip' length 1069148 bytes (1.0 Mb)
> opened URL
> ==================================================
> downloaded 1.0 Mb
>
> * installing *source* package ?kernlab? ...
> ** package ?kernlab? successfully unpacked and MD5 sums checked
> ** libs
> g++ -I/n/sw/R-3.0.1_gcc-4.7.2/lib64/R/include -DNDEBUG  -I/usr/local/include
> -fpic  -g -O2  -c brweight.cpp -o brweight.o
> In file included from
> /n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/bits/localefwd.h:42:0,
>                  from
> /n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/ios:42,
>                  from
> /n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/ostream:40,
>                  from
> /n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/iostream:40,
>                  from errorcode.h:43,
>                  from brweight.h:43,
>                  from brweight.cpp:42:
> /n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/x86_64-unknown-linux-gnu/bits/c++locale.h:53:23:
> error: ?uselocale? was not declared in this scope
> /n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/x86_64-unknown-linux-gnu/bits/c++locale.h:53:45:
> error: invalid type in declaration before ?;? token
> /n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/x86_64-unknown-linux-gnu/bits/c++locale.h:
> In function ?int std::__convert_from_v(__locale_struct* const&, char*, int,
> const char*, ...)?:
> /n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/x86_64-unknown-linux-gnu/bits/c++locale.h:76:53:
> error: ?__gnu_cxx::__uselocale? cannot be used as a function
> /n/sw/gcc-4.7.2/lib/gcc/x86_64-unknown-linux-gnu/4.7.2/../../../../include/c++/4.7.2/x86_64-unknown-linux-gnu/bits/c++locale.h:101:33:
> error: ?__gnu_cxx::__uselocale? cannot be used as a function
> make: *** [brweight.o] Error 1
> ERROR: compilation failed for package ?kernlab?
> * removing ?/n/home09/wang/R/x86_64-unknown-linux-gnu-library/3.0/kernlab?
>
> The downloaded source packages are in
>         ?/scratch/tmp/Rtmpt52VjR/downloaded_packages?
> Warning message:
> In install.packages("kernlab") :
>   installation of package ?kernlab? had non-zero exit status
>
>
> I found out online that many others also failed installing kernlab on linux,
> but no explicit unique solutions for this problem.
> What I have tried so far are:
> 1) change cran mirrors
> 2) using command line directly: R CMD INSTALL kernlab_0.9-18.tar.gz, after
> downloading the package
> 3) reset working directory
> Unfortunately, none of these solved my problem...
>
> Any suggestions are highly appreciated!
>
>
>
> --
> View this message in context: http://r.789695.n4.nabble.com/Failed-to-install-kernlab-package-tp4679652.html
> Sent from the R devel mailing list archive at Nabble.com.
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


From dwinsemius at comcast.net  Mon Nov  4 08:48:00 2013
From: dwinsemius at comcast.net (David Winsemius)
Date: Sun, 3 Nov 2013 23:48:00 -0800
Subject: [Rd] Suggestion for help page for ?plotmath
Message-ID: <E35AC9CF-B60F-44F7-84C7-DD314E54889C@comcast.net>

May I suggest a minor addition to the existing help page for ?plotmath, ... immediately following:

"Note that bold, italic and bolditalic do not apply to symbols, and hence not to the Greek symbols such as mu which are displayed in the symbol font. They also do not apply to numeric constants."

Add:

"Digits entered as text will be affected by bold, italic and bolditalic."

"The paste function in plotmath does not have a 'sep' argument, and if any value other than sep="" is used with paste, that text will appear at the end of the plotted expression."

-- 
David Winsemius
Alameda, CA, USA


From romain at r-enthusiasts.com  Mon Nov  4 10:25:53 2013
From: romain at r-enthusiasts.com (Romain Francois)
Date: Mon, 04 Nov 2013 10:25:53 +0100
Subject: [Rd] R 3.1.0 and C++11
In-Reply-To: <loom.20131103T224253-737@post.gmane.org>
References: <21073.63553.888272.510490@max.nulle.part>	<31E214B6DF75104E942856C2F74953CB0505C0F9@exchange>	<21075.11278.577153.103691@max.nulle.part>	<CAMi=pg5aRiFG7s+f4bERE6QQe+D7dH1Y_b9Q6AsH3A7Gz0M-qw@mail.gmail.com>	<478ce69b232b57db8fa74fa93e5a646a@r-enthusiasts.com>
	<loom.20131103T224253-737@post.gmane.org>
Message-ID: <52776821.5020102@r-enthusiasts.com>

Le 03/11/2013 22:45, Michael Kane a ?crit :
> I'd like to echo Whit's sentiment and hopefully warm up this thread.
> C++11's new features and functionality give R users low-level tools (like
> threads, mutexes, futures, date-time, and atomic types) that work across
> platforms and wouldn't require other external libraries like boost.

+1

portability is really important. One of the points is that by giving 
means to assume a certain standard, we can write more portable code.

There has been lots of discussion about Boost.Thread, etc ... no need 
for that if you have C++11.

> Romain, will you be taking pull requests?

Yes. Definitely. I will carefully review them.
Can give you write access too.

I'm getting a good feel of what C++11 brings while developping Rcpp11. 
But I think it makes a lot of sense to write such an article with other 
people as well.

Romain

-- 
Romain Francois
Professional R Enthusiast
+33(0) 6 28 91 30 30


From Thorn.Thaler at rdls.nestle.com  Mon Nov  4 10:54:59 2013
From: Thorn.Thaler at rdls.nestle.com (Thaler,Thorn,LAUSANNE,Applied Mathematics)
Date: Mon, 4 Nov 2013 09:54:59 +0000
Subject: [Rd] ggplot2: Add '+' operator for aes (uneval) objects
Message-ID: <EDB44DA865211646A192A94DF3C6FA670F72EC53@DEMDCE0057.nestle.com>

Dear all,

Is there a reason, why there is no +-operator for aes (i.e. uneval) objects (as there is for themes and gg objects)? I had a couple of cases where such an operator would be useful, for instance to combine the result of aes and aes_string in functions. Any flaws with the following proposition:

 `+.uneval` <- function(e1, e2) {
  dup <- names(e1) %in% names(e2)
  if (any(dup)) {
    duplist <- paste(sQuote(names(e1)[dup]), collapse = ", ")
    msg <- sprintf(ngettext(length(dup),
                   "element %s occurs in both summands - second one gets precedence",
                   "elements %s occur in both summands - second one gets precedence"),
                   duplist)
    warning(msg, domain = NA)
  }
  res <- c(e1[!dup], e2)
  class(res) <- "uneval"
  res
}

Any thoughts on that?

Kind Regards,

Thorn Thaler 
NRC Lausanne
Applied Mathematics


From brian at braverock.com  Mon Nov  4 11:02:16 2013
From: brian at braverock.com (Brian G. Peterson)
Date: Mon, 04 Nov 2013 04:02:16 -0600
Subject: [Rd] ggplot2: Add '+' operator for aes (uneval) objects
In-Reply-To: <EDB44DA865211646A192A94DF3C6FA670F72EC53@DEMDCE0057.nestle.com>
References: <EDB44DA865211646A192A94DF3C6FA670F72EC53@DEMDCE0057.nestle.com>
Message-ID: <527770A8.3070907@braverock.com>

This seems like a conversation to have with the package's maintainer 
(Hadley), as suggested by the posting guide:

http://www.r-project.org/posting-guide.html
"If the question relates to a contributed package , e.g., one downloaded 
from CRAN, try contacting the package maintainer first."

and not R-devel.

Regards,

Brian

On 11/04/2013 03:54 AM, Thaler,Thorn,LAUSANNE,Applied Mathematics wrote:
> Dear all,
>
> Is there a reason, why there is no +-operator for aes (i.e. uneval) objects (as there is for themes and gg objects)? I had a couple of cases where such an operator would be useful, for instance to combine the result of aes and aes_string in functions. Any flaws with the following proposition:
>
>   `+.uneval` <- function(e1, e2) {
>    dup <- names(e1) %in% names(e2)
>    if (any(dup)) {
>      duplist <- paste(sQuote(names(e1)[dup]), collapse = ", ")
>      msg <- sprintf(ngettext(length(dup),
>                     "element %s occurs in both summands - second one gets precedence",
>                     "elements %s occur in both summands - second one gets precedence"),
>                     duplist)
>      warning(msg, domain = NA)
>    }
>    res <- c(e1[!dup], e2)
>    class(res) <- "uneval"
>    res
> }
>
> Any thoughts on that?
>
> Kind Regards,
>
> Thorn Thaler
> NRC Lausanne
> Applied Mathematics


From GregoryM at t-online.de  Mon Nov  4 22:32:54 2013
From: GregoryM at t-online.de (Martin Gregory)
Date: Mon, 04 Nov 2013 22:32:54 +0100
Subject: [Rd] Determining files opened by an R session
Message-ID: <52781286.7080808@t-online.de>

I'm using R in a regulated environment and one of the requirements is to 
be able to trace how a result is arrived at. I would like to be able to 
determine which files are opened in read or write mode by an R session, 
for example when a program uses source, sink, file, open, read.table, 
write.table or any of the other functions which can be used to read or 
write files. I'm also interested in output to graphics devices.

I've looked in the documentation but only found information relating to 
profiling. Looking through the source code it seems that much file i/o 
is done via the C functions *_open in main/connections.c but don't see 
anything there that looks like logging.

Could someone let me know if it is possible to log which files are opened?

Regards,
Martin Gregory


From gunter.berton at gene.com  Mon Nov  4 22:52:32 2013
From: gunter.berton at gene.com (Bert Gunter)
Date: Mon, 4 Nov 2013 13:52:32 -0800
Subject: [Rd] Determining files opened by an R session
In-Reply-To: <52781286.7080808@t-online.de>
References: <52781286.7080808@t-online.de>
Message-ID: <CACk-te0a8jk6KA-d3Z+QNHDNs9d9ivK9htHemCcvaZ_itsX5FQ@mail.gmail.com>

I am not sure R can do what you want (others may), but have a look at

?history

 for R's history mechanism, which keeps a record of all commands that
you have entered and so might satisfy your needs.

Note that there are various 3rd party GUI's/IDE's (e.g. RStudio) that
might be more to your liking. The CRAN web site should contain
information on at least some of them.

Cheers,
Bert

On Mon, Nov 4, 2013 at 1:32 PM, Martin Gregory <GregoryM at t-online.de> wrote:
> I'm using R in a regulated environment and one of the requirements is to be
> able to trace how a result is arrived at. I would like to be able to
> determine which files are opened in read or write mode by an R session, for
> example when a program uses source, sink, file, open, read.table,
> write.table or any of the other functions which can be used to read or write
> files. I'm also interested in output to graphics devices.
>
> I've looked in the documentation but only found information relating to
> profiling. Looking through the source code it seems that much file i/o is
> done via the C functions *_open in main/connections.c but don't see anything
> there that looks like logging.
>
> Could someone let me know if it is possible to log which files are opened?
>
> Regards,
> Martin Gregory
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel



-- 

Bert Gunter
Genentech Nonclinical Biostatistics

(650) 467-7374


From gmbecker at ucdavis.edu  Mon Nov  4 23:21:48 2013
From: gmbecker at ucdavis.edu (Gabriel Becker)
Date: Mon, 4 Nov 2013 14:21:48 -0800
Subject: [Rd] Determining files opened by an R session
In-Reply-To: <CACk-te0a8jk6KA-d3Z+QNHDNs9d9ivK9htHemCcvaZ_itsX5FQ@mail.gmail.com>
References: <52781286.7080808@t-online.de>
	<CACk-te0a8jk6KA-d3Z+QNHDNs9d9ivK9htHemCcvaZ_itsX5FQ@mail.gmail.com>
Message-ID: <CADwqtCNMhjgFWcmZaxq3CayVN83TqT3gm1uGn6tLKFfiDscsTQ@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131104/c509b23b/attachment.pl>

From murray at stokely.org  Mon Nov  4 23:31:10 2013
From: murray at stokely.org (Murray Stokely)
Date: Mon, 4 Nov 2013 14:31:10 -0800
Subject: [Rd] Determining files opened by an R session
In-Reply-To: <52781286.7080808@t-online.de>
References: <52781286.7080808@t-online.de>
Message-ID: <CAECWziJOs2sZpn8eunfcWO6dtYDYjW1JJS7WbdMqjgjpiMF42g@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131104/0529a1cc/attachment.pl>

From edd at debian.org  Mon Nov  4 23:55:27 2013
From: edd at debian.org (Dirk Eddelbuettel)
Date: Mon, 4 Nov 2013 16:55:27 -0600
Subject: [Rd] Determining files opened by an R session
In-Reply-To: <CAECWziJOs2sZpn8eunfcWO6dtYDYjW1JJS7WbdMqjgjpiMF42g@mail.gmail.com>
References: <52781286.7080808@t-online.de>
	<CAECWziJOs2sZpn8eunfcWO6dtYDYjW1JJS7WbdMqjgjpiMF42g@mail.gmail.com>
Message-ID: <21112.9695.519796.242578@max.nulle.part>


On 4 November 2013 at 14:31, Murray Stokely wrote:
| Most operating systems have tools which allow you to audit the resources
| used by a running process, for example the 'lsof' (list open files) command
| on Unix and MacOS X.  Or, for more complex dynamic tracing, the DTrace
| framework again on MacOS X or BSD Unix.

And strace is standard on Linux.
 
| Not sure what the Windows equivalent would be, or what platform you are
| using, but given the number of ways that code in packages and such may be
| accessing files in C code possibly based on environment variables or other
| configuration parameters, I would want to lean heavily on the operating
| systems tools for things like this rather than rely on parsing your R code
| looking for specific file access.

Yep.

Dirk

-- 
Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com


From renaud at mancala.cbio.uct.ac.za  Tue Nov  5 11:53:41 2013
From: renaud at mancala.cbio.uct.ac.za (Renaud Gaujoux)
Date: Tue, 5 Nov 2013 12:53:41 +0200
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
Message-ID: <CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131105/58999c31/attachment.pl>

From lebatsnok at gmail.com  Tue Nov  5 12:25:20 2013
From: lebatsnok at gmail.com (Kenn Konstabel)
Date: Tue, 5 Nov 2013 13:25:20 +0200
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
Message-ID: <CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131105/3c45013b/attachment.pl>

From ripley at stats.ox.ac.uk  Tue Nov  5 12:33:14 2013
From: ripley at stats.ox.ac.uk (Prof Brian Ripley)
Date: Tue, 05 Nov 2013 11:33:14 +0000
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
Message-ID: <5278D77A.9090303@stats.ox.ac.uk>

It is user lack-of-understanding: there is no error here.  R outputs

a
b
c
backspace
newline

How the terminal displays that is up to the terminal, which was 
unstated.  (Capture the output and look at it in a hex editor.)

For

a
b
c
backspace

a normal terminal will output the prompt and overwrite 'c'.

On 05/11/2013 10:53, Renaud Gaujoux wrote:
> Maybe it's a Linux problem:
>
>> cat("abc\b")
> ab> cat("abc\b\n")
> abc
>> sessionInfo()
> R version 3.0.2 (2013-09-25)
> Platform: x86_64-pc-linux-gnu (64-bit)
>
> locale:
>   [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C
>   [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8
>   [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8
>   [7] LC_PAPER=en_US.UTF-8       LC_NAME=C
>   [9] LC_ADDRESS=C               LC_TELEPHONE=C
> [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C
>
> attached base packages:
> [1] stats     graphics  grDevices utils     datasets  methods   base
>>
>> Sys.info()
>                                       sysname
>                                       "Linux"
>                                       release
>                           "3.11.0-12-generic"
>                                       version
> "#19-Ubuntu SMP Wed Oct 9 16:20:46 UTC 2013"
>                                      nodename
>                                       "XXXXX"
>                                       machine
>                                      "x86_64"
>                                         login
>                                      "XXXXX"
>                                          user
>                                      "XXXXX"
>                                effective_user
>                                      "XXXXX"
>>
>
>
>
>
> On 1 November 2013 19:54, Dennis Murphy <djmuser at gmail.com> wrote:
>
>> I can't reproduce the error, either:
>>
>>> cat("abc\b")
>> ab> cat("abc\b\n")
>> ab
>>>
>>> sessionInfo()
>> R version 3.0.2 (2013-09-25)
>> Platform: x86_64-w64-mingw32/x64 (64-bit)
>>
>> locale:
>> [1] LC_COLLATE=English_United States.1252
>> [2] LC_CTYPE=English_United States.1252
>> [3] LC_MONETARY=English_United States.1252
>> [4] LC_NUMERIC=C
>> [5] LC_TIME=English_United States.1252
>>
>> <package info snipped for brevity>
>>
>> Dennis
>>
>
> 	[[alternative HTML version deleted]]
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
>


-- 
Brian D. Ripley,                  ripley at stats.ox.ac.uk
Professor of Applied Statistics,  http://www.stats.ox.ac.uk/~ripley/
University of Oxford,             Tel:  +44 1865 272861 (self)
1 South Parks Road,                     +44 1865 272866 (PA)
Oxford OX1 3TG, UK                Fax:  +44 1865 272595


From g.vegayon at gmail.com  Tue Nov  5 05:00:26 2013
From: g.vegayon at gmail.com (George Vega Yon)
Date: Tue, 5 Nov 2013 02:00:26 -0200
Subject: [Rd] Dynamic list creation (SEXP in C) returns error "unimplemented
 type (29) in 'duplicate'"
Message-ID: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>

Dear R-devel,

A couple of weeks ago I started to use the R C API for package
development. Without knowing much about C, I've been able to write
some routines sucessfully... until now.

My problem consists in dynamically creating a list ("L1") of lists
using .Call, the tricky part is that each element of the "mother list"
contains two vectors (INTSXP and REALEXP types) with varying sizes;
sizes that I set while I'm looping over another list's ("L1") elements
 (input list). The steps I've follow are:

FIRST: Create the "mother list" of size "n=length(L0)" (doesn't
change) and protect it as
  PROTECT(L1=allocVector(VECEXP, length(L0)))
and filling it with vectors of length two:
  for(i=0;i<n;i++) SET_VECTOR_ELT(L1,i, allocVector(VECSXP, 2));

then, for each element of the mother list:

  for(i=0;i<n;i++) {

SECOND: By reading this post in Stackoverflow
http://stackoverflow.com/questions/7458364/growing-an-r-matrix-inside-a-c-loop/7458516#7458516
I understood that it was necesary to (1) create the "child lists" and
protecting them with PROTECT_WITH_INDEX, and (2) changing its size
using SETLENGTH (Rf_lengthgets) and REPROTECT ing the lists in order
to tell the GC that the vectors had change.

THIRD: Once my two vectors are done ("id" and "lambda"), assign them
to the i-th element of the "mother list" L1 using
  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, duplicate(id));
  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, duplicate(lambda));

and unprotecting the elements protected with index: UNPROTECT(2);

}

FOURTH: Unprotecting the "mother list" (L1) and return it to R

With small datasets this works fine, but after trying with bigger ones
R (my code) keeps failing and returning a strange error that I haven't
been able to identify (or find in the web)

  "unimplemented type (29) in 'duplicate'"

This happens right after I try to use the returned list from my
routine (trying to print it or building a data-frame).

Does anyone have an idea of what am I doing wrong?

Best regards,

PS: I didn't wanted to copy the entire function... but if you need it
I can do it.

George Vega Yon
+56 9 7 647 2552
http://ggvega.cl


From maechler at stat.math.ethz.ch  Tue Nov  5 14:22:20 2013
From: maechler at stat.math.ethz.ch (Martin Maechler)
Date: Tue, 5 Nov 2013 14:22:20 +0100
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
Message-ID: <21112.61708.698124.149056@stat.math.ethz.ch>

>>>>> Kenn Konstabel <lebatsnok at gmail.com>
>>>>>     on Tue, 5 Nov 2013 13:25:20 +0200 writes:

    > I just tried it on ubuntu but within RStudio:
    >> cat("abc\b")
    > ab
    >> cat("abc\b\n")
    > ab
    >> sessionInfo()

which --- as you allude to below --- shows that  RStudio  has changed R
in so far that it adds a '\n'  even when R, i.e.  cat()  does not.

I can understand that the RStudio programmers want to protect
their users (*) from getting funny looking output,
but I still don't like the fact that R inside RStudio is tweaked
to behave differently from regular R. 

Martin Maechler, R Core Team & ETH Zurich

--
(*) or their software from malfunctioning when the console "looks ugly"

    > R version 3.0.2 (2013-09-25) Platform: x86_64-pc-linux-gnu
    > (64-bit)

    > locale: [1] LC_CTYPE=en_US.UTF-8 LC_NUMERIC=C LC_TIME=C
    > LC_COLLATE=C [5] LC_MONETARY=C LC_MESSAGES=C LC_PAPER=C
    > LC_NAME=C [9] LC_ADDRESS=C LC_TELEPHONE=C LC_MEASUREMENT=C
    > LC_IDENTIFICATION=C

    > --------

    > On the same machine but running R in the terminal (tried
    > with GNOME terminal, Konsole, and xterm with no difference
    > )

    >> cat("abc\b")
    ab> cat("abc\b\n")
    > abc
    >> sessionInfo()
    > R version 3.0.2 (2013-09-25) Platform: x86_64-pc-linux-gnu
    > (64-bit)

    > locale: [1] LC_CTYPE=en_US.UTF-8 LC_NUMERIC=C LC_TIME=C
    > [4] LC_COLLATE=C LC_MONETARY=C LC_MESSAGES=C [7]
    > LC_PAPER=C LC_NAME=C LC_ADDRESS=C [10] LC_TELEPHONE=C
    > LC_MEASUREMENT=C LC_IDENTIFICATION=C

    > ---------


    > But then again ...

    > cat("abc\b \n")

    > ... seems to work the same way everywhere. It looks like
    > the logic in a unix terminal is that \b moves the cursor
    > backwards but does not replace or delete anything that was
    > there before.

    > Regards, Kenn





    > On Tue, Nov 5, 2013 at 12:53 PM, Renaud Gaujoux <
    > renaud at mancala.cbio.uct.ac.za> wrote:

    >> Maybe it's a Linux problem:
    >> 
    >> > cat("abc\b")
    ab> cat("abc\b\n")
    >> abc > sessionInfo() R version 3.0.2 (2013-09-25)
    >> Platform: x86_64-pc-linux-gnu (64-bit)
    >> 
    >> locale: [1] LC_CTYPE=en_US.UTF-8 LC_NUMERIC=C [3]
    >> LC_TIME=en_US.UTF-8 LC_COLLATE=en_US.UTF-8 [5]
    >> LC_MONETARY=en_US.UTF-8 LC_MESSAGES=en_US.UTF-8 [7]
    >> LC_PAPER=en_US.UTF-8 LC_NAME=C [9] LC_ADDRESS=C
    >> LC_TELEPHONE=C [11] LC_MEASUREMENT=en_US.UTF-8
    >> LC_IDENTIFICATION=C
    >> 
    >> attached base packages: [1] stats graphics grDevices
    >> utils datasets methods base
    >> >
    >> > Sys.info() sysname "Linux" release "3.11.0-12-generic"
    >> version "#19-Ubuntu SMP Wed Oct 9 16:20:46 UTC 2013"
    >> nodename "XXXXX" machine "x86_64" login "XXXXX" user
    >> "XXXXX" effective_user "XXXXX"
    >> >
    >> 
    >> 
    >> 
    >> 
    >> On 1 November 2013 19:54, Dennis Murphy
    >> <djmuser at gmail.com> wrote:
    >> 
    >> > I can't reproduce the error, either:
    >> >
    >> > > cat("abc\b") > ab> cat("abc\b\n") > ab
    >> > >
    >> > > sessionInfo() > R version 3.0.2 (2013-09-25) >
    >> Platform: x86_64-w64-mingw32/x64 (64-bit)
    >> >
    >> > locale: > [1] LC_COLLATE=English_United States.1252 >
    >> [2] LC_CTYPE=English_United States.1252 > [3]
    >> LC_MONETARY=English_United States.1252 > [4] LC_NUMERIC=C
    >> > [5] LC_TIME=English_United States.1252
    >> >
    >> > <package info snipped for brevity>
    >> >
    >> > Dennis
    >> >
    >> 
    >> [[alternative HTML version deleted]]
    >> 
    >> ______________________________________________
    >> R-devel at r-project.org mailing list
    >> https://stat.ethz.ch/mailman/listinfo/r-devel
    >> 

    > 	[[alternative HTML version deleted]]

    > ______________________________________________
    > R-devel at r-project.org mailing list
    > https://stat.ethz.ch/mailman/listinfo/r-devel


From brian at braverock.com  Tue Nov  5 14:30:14 2013
From: brian at braverock.com (Brian G. Peterson)
Date: Tue, 05 Nov 2013 07:30:14 -0600
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <21112.61708.698124.149056@stat.math.ethz.ch>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
	<21112.61708.698124.149056@stat.math.ethz.ch>
Message-ID: <5278F2E6.5070200@braverock.com>

On 11/05/2013 07:22 AM, Martin Maechler wrote:
> which --- as you allude to below --- shows that  RStudio  has changed R
> in so far that it adds a '\n'  even when R, i.e.  cat()  does not.
>
> I can understand that the RStudio programmers want to protect
> their users (*) from getting funny looking output,
> but I still don't like the fact that R inside RStudio is tweaked
> to behave differently from regular R.

No, it just suggests exactly what Prof. Ripley alluded to...

... the output of cat() will be dependent on the display terminal.

RStudio doesn't include R at all, and in fact makes use of the/any R 
binary installed via other processes.  It is not 'tweaked'.

It *does* include a 'terminal' to display the interactions with the R 
console.

Regards,

Brian

-- 
Brian G. Peterson
http://braverock.com/brian/
Ph: 773-459-4973
IM: bgpbraverock


From renaud at mancala.cbio.uct.ac.za  Tue Nov  5 14:33:14 2013
From: renaud at mancala.cbio.uct.ac.za (Renaud Gaujoux)
Date: Tue, 5 Nov 2013 15:33:14 +0200
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <5278D77A.9090303@stats.ox.ac.uk>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<5278D77A.9090303@stats.ox.ac.uk>
Message-ID: <CAHavPHEB4MmEUAkx07z-WZNwfM2waF3T1T-s9hGVQZuFqtrdng@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131105/cb59f3eb/attachment.pl>

From maechler at stat.math.ethz.ch  Tue Nov  5 14:50:04 2013
From: maechler at stat.math.ethz.ch (Martin Maechler)
Date: Tue, 5 Nov 2013 14:50:04 +0100
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <5278F2E6.5070200@braverock.com>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
	<21112.61708.698124.149056@stat.math.ethz.ch>
	<5278F2E6.5070200@braverock.com>
Message-ID: <21112.63372.152443.397235@stat.math.ethz.ch>

>>>>> Brian G Peterson <brian at braverock.com>
>>>>>     on Tue, 5 Nov 2013 07:30:14 -0600 writes:

    > On 11/05/2013 07:22 AM, Martin Maechler wrote:
    >> which --- as you allude to below --- shows that RStudio
    >> has changed R in so far that it adds a '\n' even when R,
    >> i.e.  cat() does not.
    >> 
    >> I can understand that the RStudio programmers want to
    >> protect their users (*) from getting funny looking
    >> output, but I still don't like the fact that R inside
    >> RStudio is tweaked to behave differently from regular R.

    > No, it just suggests exactly what Prof. Ripley alluded
    > to...

    > ... the output of cat() will be dependent on the display
    > terminal.

    > RStudio doesn't include R at all, and in fact makes use of
    > the/any R binary installed via other processes.  It is not
    > 'tweaked'.

    > It *does* include a 'terminal' to display the interactions
    > with the R console.

Well I know that (it does not modify R),
but I'd say that the above is just another way to say what I said:
RStudio tweaks R's output. I agree that this is much much less
problematic than changing R objects, but I'd claim that
where as the interpretation of  \b  depends on the
terminal/console (and so it is quite rarely used),
the functioning of  \n  should not depend on the platform.
RStudio users may conclude that it is a good idea to use things like
	cat("pi:", pi)
whereas they really should use something like
	cat("pi:", pi, "\n)

Martin

    > Regards,
    > Brian


From phgrosjean at sciviews.org  Tue Nov  5 17:02:19 2013
From: phgrosjean at sciviews.org (Philippe Grosjean)
Date: Tue, 5 Nov 2013 17:02:19 +0100
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <21112.61708.698124.149056@stat.math.ethz.ch>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
	<21112.61708.698124.149056@stat.math.ethz.ch>
Message-ID: <8E2469B4-2A7B-44DD-896F-F409C39F4496@sciviews.org>


On 05 Nov 2013, at 14:22, Martin Maechler <maechler at stat.math.ethz.ch> wrote:

>>>>>> Kenn Konstabel <lebatsnok at gmail.com>
>>>>>>    on Tue, 5 Nov 2013 13:25:20 +0200 writes:
> 
>> I just tried it on ubuntu but within RStudio:
>>> cat("abc\b")
>> ab
>>> cat("abc\b\n")
>> ab
>>> sessionInfo()
> 
> which --- as you allude to below --- shows that  RStudio  has changed R
> in so far that it adds a '\n'  even when R, i.e.  cat()  does not.
> 
> I can understand that the RStudio programmers want to protect
> their users (*) from getting funny looking output,
> but I still don't like the fact that R inside RStudio is tweaked
> to behave differently from regular R. 
> 
> Martin Maechler, R Core Team & ETH Zurich
> 
> --
> (*) or their software from malfunctioning when the console "looks ugly"

[?]

I agree with you Martin, but what is a "regular R"? Because on a Mac, R.app does exactly the same as RStudio:

> cat("abc\b")
ab
> cat("abc\b\n")
ab
> sessionInfo()
R version 3.0.2 (2013-09-25)
Platform: x86_64-apple-darwin10.8.0 (64-bit)

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

And this is R.app 1.62 Snow Leopard build (6558).

So, does it means that R run under R.app on Mac OS X is *not* considered as a regular R?
Best,

Philippe
 


From maechler at stat.math.ethz.ch  Tue Nov  5 17:43:16 2013
From: maechler at stat.math.ethz.ch (Martin Maechler)
Date: Tue, 5 Nov 2013 17:43:16 +0100
Subject: [Rd] [PATCH] minor suggestions for R-ints manual
In-Reply-To: <CAE3=dmcm031=PQ6Apr9JmpPfVzONaQFxKpjZvX5422zaM=XicA@mail.gmail.com>
References: <CAE3=dmcm031=PQ6Apr9JmpPfVzONaQFxKpjZvX5422zaM=XicA@mail.gmail.com>
Message-ID: <21113.8228.407363.727817@stat.math.ethz.ch>

>>>>> Scott Kostyshak <skostysh at princeton.edu>
>>>>>     on Sat, 12 Oct 2013 17:50:52 -0400 writes:

    > Attached is a patch with minor suggestions for the R-ints
    > manual at r64048. The most substantial change is the
    > following:

    >  The top layer comprises the graphics subsystems. Although
    > there is -provision for 24 subsystems, after 6 years only
    > two exist, `base' and +provision for 24 subsystems, since
    > 2001 only two exist, `base' and `grid'.

    > Is the year 2001 correct? I base it on the date of the
    > commit that introduced the "6 years" string and on the
    > date of grid 0.1.

    > Scott

I've used  "about 2001" and otherwise basically applied your patch
(after checking it).

Thank you very much for your contribution!

Martin Maechler


    > --
    > Scott Kostyshak Economics PhD Candidate Princeton
    > University x[DELETED ATTACHMENT external: R-ints.diff.txt, plain text]
    >  ______________________________________________
    > R-devel at r-project.org mailing list
    > https://stat.ethz.ch/mailman/listinfo/r-devel


From maechler at stat.math.ethz.ch  Tue Nov  5 17:53:35 2013
From: maechler at stat.math.ethz.ch (Martin Maechler)
Date: Tue, 5 Nov 2013 17:53:35 +0100
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <8E2469B4-2A7B-44DD-896F-F409C39F4496@sciviews.org>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
	<21112.61708.698124.149056@stat.math.ethz.ch>
	<8E2469B4-2A7B-44DD-896F-F409C39F4496@sciviews.org>
Message-ID: <21113.8847.603856.486049@stat.math.ethz.ch>

>>>>> "PhGr" == Philippe Grosjean <phgrosjean at sciviews.org>
>>>>>     on Tue, 5 Nov 2013 17:02:19 +0100 writes:

    PhGr> On 05 Nov 2013, at 14:22, Martin Maechler
    PhGr> <maechler at stat.math.ethz.ch> wrote:

    >>>>>>> Kenn Konstabel <lebatsnok at gmail.com> on Tue, 5 Nov
    >>>>>>> 2013 13:25:20 +0200 writes:
    >> 
    >>> I just tried it on ubuntu but within RStudio:
    >>>> cat("abc\b")
    >>> ab
    >>>> cat("abc\b\n")
    >>> ab
    >>>> sessionInfo()
    >> 
    >> which --- as you allude to below --- shows that RStudio
    >> has changed R in so far that it adds a '\n' even when R,
    >> i.e.  cat() does not.
    >> 
    >> I can understand that the RStudio programmers want to
    >> protect their users (*) from getting funny looking
    >> output, but I still don't like the fact that R inside
    >> RStudio is tweaked to behave differently from regular R.
    >> 
    >> Martin Maechler, R Core Team & ETH Zurich
    >> 
    >> --
    >> (*) or their software from malfunctioning when the
    >> console "looks ugly"

    PhGr> [?]

    PhGr> I agree with you Martin, but what is a "regular R"?
    PhGr> Because on a Mac, R.app does exactly the same as
    PhGr> RStudio:

    >> cat("abc\b")
    PhGr> ab
    >> cat("abc\b\n")
    PhGr> ab
    >> sessionInfo()
    PhGr> R version 3.0.2 (2013-09-25) Platform:
    PhGr> x86_64-apple-darwin10.8.0 (64-bit)

    PhGr> locale: [1]
    PhGr> en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

    PhGr> attached base packages: [1] stats graphics grDevices
    PhGr> utils datasets methods base

    PhGr> And this is R.app 1.62 Snow Leopard build (6558).

    PhGr> So, does it means that R run under R.app on Mac OS X
    PhGr> is *not* considered as a regular R?  

good question....  I would have said so, but maybe we should
wait for my R core colleagues for a bit.... ;-)

Martin


    PhGr> Best, Philippe


From gmbecker at ucdavis.edu  Tue Nov  5 22:12:21 2013
From: gmbecker at ucdavis.edu (Gabriel Becker)
Date: Tue, 5 Nov 2013 13:12:21 -0800
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'"
In-Reply-To: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>
References: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>
Message-ID: <CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131105/6dc19673/attachment.pl>

From ripley at stats.ox.ac.uk  Tue Nov  5 22:52:44 2013
From: ripley at stats.ox.ac.uk (Prof Brian Ripley)
Date: Tue, 05 Nov 2013 21:52:44 +0000
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'"
In-Reply-To: <CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>
References: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>
	<CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>
Message-ID: <527968AC.2060406@stats.ox.ac.uk>

On 05/11/2013 21:12, Gabriel Becker wrote:
> George,
>
> I don't see the relevance of the stackoverflow post you linked. In the
> post, the author wanted to change the length of an existing "mother list"
> (matrix, etc), while you specifically state that the length of L1 will not
> change.
>
> You say that the child lists (vectors if they are INTSXP/REALSXP) are
> variable, but that is not what the linked post was about unless I am
> completely missing something.
>
> I can't really say more without knowing the details of how the vectors are
> being created and why they cannot just have the right length from the start.
>
> As for the error, that is a weird one. I imagine it means that a SEXP
> thinks that it has a type other than ones defined in Rinternals. I can't
> speak to how that could have happened from what you posted though.

Usually it is the result of garbage collection: something which should 
have been protected and is not has been re-used.

The way to find such things is to use a valgrind-instrumented build of 
R: see 'Writing R Extensions'.  Possibly with gcorture(TRUE) to make it 
reproducible.


>
> Sorry I can't be of more help,
> ~G
>
>
>
> On Mon, Nov 4, 2013 at 8:00 PM, George Vega Yon <g.vegayon at gmail.com> wrote:
>
>> Dear R-devel,
>>
>> A couple of weeks ago I started to use the R C API for package
>> development. Without knowing much about C, I've been able to write
>> some routines sucessfully... until now.
>>
>> My problem consists in dynamically creating a list ("L1") of lists
>> using .Call, the tricky part is that each element of the "mother list"
>> contains two vectors (INTSXP and REALEXP types) with varying sizes;
>> sizes that I set while I'm looping over another list's ("L1") elements
>>   (input list). The steps I've follow are:
>>
>> FIRST: Create the "mother list" of size "n=length(L0)" (doesn't
>> change) and protect it as
>>    PROTECT(L1=allocVector(VECEXP, length(L0)))
>> and filling it with vectors of length two:
>>    for(i=0;i<n;i++) SET_VECTOR_ELT(L1,i, allocVector(VECSXP, 2));
>>
>> then, for each element of the mother list:
>>
>>    for(i=0;i<n;i++) {
>>
>> SECOND: By reading this post in Stackoverflow
>>
>> http://stackoverflow.com/questions/7458364/growing-an-r-matrix-inside-a-c-loop/7458516#7458516
>> I understood that it was necesary to (1) create the "child lists" and
>> protecting them with PROTECT_WITH_INDEX, and (2) changing its size
>> using SETLENGTH (Rf_lengthgets) and REPROTECT ing the lists in order
>> to tell the GC that the vectors had change.
>>
>> THIRD: Once my two vectors are done ("id" and "lambda"), assign them
>> to the i-th element of the "mother list" L1 using
>>    SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, duplicate(id));
>>    SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, duplicate(lambda));
>>
>> and unprotecting the elements protected with index: UNPROTECT(2);
>>
>> }
>>
>> FOURTH: Unprotecting the "mother list" (L1) and return it to R
>>
>> With small datasets this works fine, but after trying with bigger ones
>> R (my code) keeps failing and returning a strange error that I haven't
>> been able to identify (or find in the web)
>>
>>    "unimplemented type (29) in 'duplicate'"
>>
>> This happens right after I try to use the returned list from my
>> routine (trying to print it or building a data-frame).
>>
>> Does anyone have an idea of what am I doing wrong?
>>
>> Best regards,
>>
>> PS: I didn't wanted to copy the entire function... but if you need it
>> I can do it.
>>
>> George Vega Yon
>> +56 9 7 647 2552
>> http://ggvega.cl
>>
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>
>
>
>


-- 
Brian D. Ripley,                  ripley at stats.ox.ac.uk
Professor of Applied Statistics,  http://www.stats.ox.ac.uk/~ripley/
University of Oxford,             Tel:  +44 1865 272861 (self)
1 South Parks Road,                     +44 1865 272866 (PA)
Oxford OX1 3TG, UK                Fax:  +44 1865 272595


From g.vegayon at gmail.com  Tue Nov  5 22:56:13 2013
From: g.vegayon at gmail.com (George Vega Yon)
Date: Tue, 5 Nov 2013 18:56:13 -0300
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'"
In-Reply-To: <CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>
References: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>
	<CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>
Message-ID: <CAPJUxXWXFctds0veg3Ayy8bD3woWkA46Ss6JFWc_TFjRKDFTZA@mail.gmail.com>

Gabriel,

While the length (in terms of number of SEXP elements it stores) of L1
doesn't changes, the vectors within L1 do (sorry if I didn't explained
it well before).

The post was about a SEXP object that grows, in my case, every pair of
vectors in L1 (id and lambda) can change lengths, this is why I need
to reprotect them. I populate the i-th element of L1 by creating the
vectors "id" and "lambda", setting the length of these according to
some rule (that's the part where lengths change)... here is a reduced
form of my code:

//////////////////////////////////////// C
////////////////////////////////////////
const int = length(L0);
SEXP L1;
PROTECT(L1 = allocVector(VECSXP,n));
SEXP id, lambda;

// Fixing size
for(i=0;i<n;i++)
  SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));

for(i=0;i<n;i++)
{
  // Creating the "id" and "lambda" vectors. I do this in every repetition of
  // the loop.
  PROTECT_WITH_INDEX(id=allocVector(INTSXP, 4), &ipx0);
  PROTECT_WITH_INDEX(lambda=allocVector(REALSXP, 4), &ipx1);

  // ... Some other instructions where I set the value of an integer
  // z, which tells how much do the vectors have to grow ...

  REPROTECT(SET_LENGTH(id,    length(lambda) + z), ipx0);
  REPROTECT(SET_LENGTH(lambda,length(lambda) + z), ipx1);

  // ... some lines where I fill the vectors ...

  // Storing the new vectors at the i-th element of the list
  SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
  SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));

  // Unprotecting the "id" and "lambda" vectors
  UNPROTECT(2);
}

UNPROTECT(1);

return L1;
//////////////////////////////////////// C
////////////////////////////////////////

I can't set the length from the start because every pair of vectors in
L1 have different lengths, lengths that I cannot tell before starting
the loop.

Thanks for your help,

Regards,

George Vega Yon
+56 9 7 647 2552
http://ggvega.cl


2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
> George,
>
> I don't see the relevance of the stackoverflow post you linked. In the post,
> the author wanted to change the length of an existing "mother list" (matrix,
> etc), while you specifically state that the length of L1 will not change.
>
> You say that the child lists (vectors if they are INTSXP/REALSXP) are
> variable, but that is not what the linked post was about unless I am
> completely missing something.
>
> I can't really say more without knowing the details of how the vectors are
> being created and why they cannot just have the right length from the start.
>
> As for the error, that is a weird one. I imagine it means that a SEXP thinks
> that it has a type other than ones defined in Rinternals. I can't speak to
> how that could have happened from what you posted though.
>
> Sorry I can't be of more help,
> ~G
>
>
>
> On Mon, Nov 4, 2013 at 8:00 PM, George Vega Yon <g.vegayon at gmail.com> wrote:
>>
>> Dear R-devel,
>>
>> A couple of weeks ago I started to use the R C API for package
>> development. Without knowing much about C, I've been able to write
>> some routines sucessfully... until now.
>>
>> My problem consists in dynamically creating a list ("L1") of lists
>> using .Call, the tricky part is that each element of the "mother list"
>> contains two vectors (INTSXP and REALEXP types) with varying sizes;
>> sizes that I set while I'm looping over another list's ("L1") elements
>>  (input list). The steps I've follow are:
>>
>> FIRST: Create the "mother list" of size "n=length(L0)" (doesn't
>> change) and protect it as
>>   PROTECT(L1=allocVector(VECEXP, length(L0)))
>> and filling it with vectors of length two:
>>   for(i=0;i<n;i++) SET_VECTOR_ELT(L1,i, allocVector(VECSXP, 2));
>>
>> then, for each element of the mother list:
>>
>>   for(i=0;i<n;i++) {
>>
>> SECOND: By reading this post in Stackoverflow
>>
>> http://stackoverflow.com/questions/7458364/growing-an-r-matrix-inside-a-c-loop/7458516#7458516
>> I understood that it was necesary to (1) create the "child lists" and
>> protecting them with PROTECT_WITH_INDEX, and (2) changing its size
>> using SETLENGTH (Rf_lengthgets) and REPROTECT ing the lists in order
>> to tell the GC that the vectors had change.
>>
>> THIRD: Once my two vectors are done ("id" and "lambda"), assign them
>> to the i-th element of the "mother list" L1 using
>>   SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, duplicate(id));
>>   SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, duplicate(lambda));
>>
>> and unprotecting the elements protected with index: UNPROTECT(2);
>>
>> }
>>
>> FOURTH: Unprotecting the "mother list" (L1) and return it to R
>>
>> With small datasets this works fine, but after trying with bigger ones
>> R (my code) keeps failing and returning a strange error that I haven't
>> been able to identify (or find in the web)
>>
>>   "unimplemented type (29) in 'duplicate'"
>>
>> This happens right after I try to use the returned list from my
>> routine (trying to print it or building a data-frame).
>>
>> Does anyone have an idea of what am I doing wrong?
>>
>> Best regards,
>>
>> PS: I didn't wanted to copy the entire function... but if you need it
>> I can do it.
>>
>> George Vega Yon
>> +56 9 7 647 2552
>> http://ggvega.cl
>>
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel
>
>
>
>
> --
> Gabriel Becker
> Graduate Student
> Statistics Department
> University of California, Davis


From gmbecker at ucdavis.edu  Tue Nov  5 23:05:24 2013
From: gmbecker at ucdavis.edu (Gabriel Becker)
Date: Tue, 5 Nov 2013 14:05:24 -0800
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'"
In-Reply-To: <CAPJUxXWXFctds0veg3Ayy8bD3woWkA46Ss6JFWc_TFjRKDFTZA@mail.gmail.com>
References: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>
	<CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>
	<CAPJUxXWXFctds0veg3Ayy8bD3woWkA46Ss6JFWc_TFjRKDFTZA@mail.gmail.com>
Message-ID: <CADwqtCPemzpwOjuhVgVmgeHq2zEkF1ViOOzUk6NXNaP3WYvVng@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131105/115dbd4a/attachment.pl>

From pdalgd at gmail.com  Tue Nov  5 23:57:14 2013
From: pdalgd at gmail.com (peter dalgaard)
Date: Tue, 5 Nov 2013 23:57:14 +0100
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <21113.8847.603856.486049@stat.math.ethz.ch>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
	<21112.61708.698124.149056@stat.math.ethz.ch>
	<8E2469B4-2A7B-44DD-896F-F409C39F4496@sciviews.org>
	<21113.8847.603856.486049@stat.math.ethz.ch>
Message-ID: <A750360B-31A8-49EB-B21F-87EE4BA6E412@gmail.com>


On 05 Nov 2013, at 17:53 , Martin Maechler <maechler at stat.math.ethz.ch> wrote:

>>>>>> "PhGr" == Philippe Grosjean <phgrosjean at sciviews.org>
>>>>>>    on Tue, 5 Nov 2013 17:02:19 +0100 writes:
> 
>    PhGr> On 05 Nov 2013, at 14:22, Martin Maechler
>    PhGr> <maechler at stat.math.ethz.ch> wrote:
> 
>>>>>>>> Kenn Konstabel <lebatsnok at gmail.com> on Tue, 5 Nov
>>>>>>>> 2013 13:25:20 +0200 writes:
>>> 
>>>> I just tried it on ubuntu but within RStudio:
>>>>> cat("abc\b")
>>>> ab
>>>>> cat("abc\b\n")
>>>> ab
>>>>> sessionInfo()
>>> 
>>> which --- as you allude to below --- shows that RStudio
>>> has changed R in so far that it adds a '\n' even when R,
>>> i.e.  cat() does not.
>>> 
>>> I can understand that the RStudio programmers want to
>>> protect their users (*) from getting funny looking
>>> output, but I still don't like the fact that R inside
>>> RStudio is tweaked to behave differently from regular R.
>>> 
>>> Martin Maechler, R Core Team & ETH Zurich
>>> 
>>> --
>>> (*) or their software from malfunctioning when the
>>> console "looks ugly"
> 
>    PhGr> [?]
> 
>    PhGr> I agree with you Martin, but what is a "regular R"?
>    PhGr> Because on a Mac, R.app does exactly the same as
>    PhGr> RStudio:
> 
>>> cat("abc\b")
>    PhGr> ab
>>> cat("abc\b\n")
>    PhGr> ab
>>> sessionInfo()
>    PhGr> R version 3.0.2 (2013-09-25) Platform:
>    PhGr> x86_64-apple-darwin10.8.0 (64-bit)
> 
>    PhGr> locale: [1]
>    PhGr> en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
> 
>    PhGr> attached base packages: [1] stats graphics grDevices
>    PhGr> utils datasets methods base
> 
>    PhGr> And this is R.app 1.62 Snow Leopard build (6558).
> 
>    PhGr> So, does it means that R run under R.app on Mac OS X
>    PhGr> is *not* considered as a regular R?  
> 
> good question....  I would have said so, but maybe we should
> wait for my R core colleagues for a bit.... ;-)
> 

As far as I can tell, neither actually changes the output of cat(), witness

> cat("ab") ; cat("ab")
abab
>

So in a sense, it is the prompt that is tweaked to ?jump to beginning of next line, unless already at beginning of line?. I don?t recall any ?real? terminal having an escape sequence for that, but I wouldn?t put it past ESS to do something similar. 

I see your point about cat(?pi?, pi), but I would expect that the bad habit would get cured first time it was attempted to print something between it and the next prompt. I?m actually more worried/puzzled that ?\r? behaves strangely (in Rstudio, not R.app):

> cat("123");cat("\r456")
456
> cat("123\r");cat("456")
123456

People do sometimes use this pattern for displaying progress (e.g. iteration counts). 


> Martin
> 
> 
>    PhGr> Best, Philippe
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel

-- 
Peter Dalgaard, Professor,
Center for Statistics, Copenhagen Business School
Solbjerg Plads 3, 2000 Frederiksberg, Denmark
Phone: (+45)38153501
Email: pd.mes at cbs.dk  Priv: PDalgd at gmail.com


From g.vegayon at gmail.com  Wed Nov  6 00:28:05 2013
From: g.vegayon at gmail.com (George Vega Yon)
Date: Tue, 5 Nov 2013 21:28:05 -0200
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'"
In-Reply-To: <CADwqtCPemzpwOjuhVgVmgeHq2zEkF1ViOOzUk6NXNaP3WYvVng@mail.gmail.com>
References: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>
	<CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>
	<CAPJUxXWXFctds0veg3Ayy8bD3woWkA46Ss6JFWc_TFjRKDFTZA@mail.gmail.com>
	<CADwqtCPemzpwOjuhVgVmgeHq2zEkF1ViOOzUk6NXNaP3WYvVng@mail.gmail.com>
Message-ID: <CAPJUxXUfJ5Q1yJOxOMmPLFHE93rj1BzCKZkzNJxVVn4+xt0Smg@mail.gmail.com>

Either way, understanding that it may not be the best way of do it, is
there anything wrong in what I'm doing??
George Vega Yon
+56 9 7 647 2552
http://ggvega.cl


2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
> George,
>
> My point is you don't need to create them and then grow them....
>
>
> for(i=0;i<n;i++)
> {
>   // Creating the "id" and "lambda" vectors. I do this in every repetition
> of
>   // the loop.
>
>   // ... Some other instructions where I set the value of an integer
>   // z, which tells how much do the vectors have to grow ...
>
> PROTECT(id=allocVector(INTSXP, 4 +z));
> PROTECT(lambda=allocVector(REALSXP, 4 +z));
>
>
>   // ... some lines where I fill the vectors ...
>
>   // Storing the new vectors at the i-th element of the list
>   SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>   SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>
>   // Unprotecting the "id" and "lambda" vectors
>   UNPROTECT(2);
> }
>
> ~G
>
>
> On Tue, Nov 5, 2013 at 1:56 PM, George Vega Yon <g.vegayon at gmail.com> wrote:
>>
>> Gabriel,
>>
>> While the length (in terms of number of SEXP elements it stores) of L1
>> doesn't changes, the vectors within L1 do (sorry if I didn't explained
>> it well before).
>>
>> The post was about a SEXP object that grows, in my case, every pair of
>> vectors in L1 (id and lambda) can change lengths, this is why I need
>> to reprotect them. I populate the i-th element of L1 by creating the
>> vectors "id" and "lambda", setting the length of these according to
>> some rule (that's the part where lengths change)... here is a reduced
>> form of my code:
>>
>> //////////////////////////////////////// C
>> ////////////////////////////////////////
>> const int = length(L0);
>> SEXP L1;
>> PROTECT(L1 = allocVector(VECSXP,n));
>> SEXP id, lambda;
>>
>> // Fixing size
>> for(i=0;i<n;i++)
>>   SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
>>
>> for(i=0;i<n;i++)
>> {
>>   // Creating the "id" and "lambda" vectors. I do this in every repetition
>> of
>>   // the loop.
>>   PROTECT_WITH_INDEX(id=allocVector(INTSXP, 4), &ipx0);
>>   PROTECT_WITH_INDEX(lambda=allocVector(REALSXP, 4), &ipx1);
>>
>>   // ... Some other instructions where I set the value of an integer
>>   // z, which tells how much do the vectors have to grow ...
>>
>>   REPROTECT(SET_LENGTH(id,    length(lambda) + z), ipx0);
>>   REPROTECT(SET_LENGTH(lambda,length(lambda) + z), ipx1);
>>
>>   // ... some lines where I fill the vectors ...
>>
>>   // Storing the new vectors at the i-th element of the list
>>   SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>   SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>
>>   // Unprotecting the "id" and "lambda" vectors
>>   UNPROTECT(2);
>> }
>>
>> UNPROTECT(1);
>>
>> return L1;
>> //////////////////////////////////////// C
>> ////////////////////////////////////////
>>
>> I can't set the length from the start because every pair of vectors in
>> L1 have different lengths, lengths that I cannot tell before starting
>> the loop.
>>
>> Thanks for your help,
>>
>> Regards,
>>
>> George Vega Yon
>> +56 9 7 647 2552
>> http://ggvega.cl
>>
>>
>> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>> > George,
>> >
>> > I don't see the relevance of the stackoverflow post you linked. In the
>> > post,
>> > the author wanted to change the length of an existing "mother list"
>> > (matrix,
>> > etc), while you specifically state that the length of L1 will not
>> > change.
>> >
>> > You say that the child lists (vectors if they are INTSXP/REALSXP) are
>> > variable, but that is not what the linked post was about unless I am
>> > completely missing something.
>> >
>> > I can't really say more without knowing the details of how the vectors
>> > are
>> > being created and why they cannot just have the right length from the
>> > start.
>> >
>> > As for the error, that is a weird one. I imagine it means that a SEXP
>> > thinks
>> > that it has a type other than ones defined in Rinternals. I can't speak
>> > to
>> > how that could have happened from what you posted though.
>> >
>> > Sorry I can't be of more help,
>> > ~G
>> >
>> >
>> >
>> > On Mon, Nov 4, 2013 at 8:00 PM, George Vega Yon <g.vegayon at gmail.com>
>> > wrote:
>> >>
>> >> Dear R-devel,
>> >>
>> >> A couple of weeks ago I started to use the R C API for package
>> >> development. Without knowing much about C, I've been able to write
>> >> some routines sucessfully... until now.
>> >>
>> >> My problem consists in dynamically creating a list ("L1") of lists
>> >> using .Call, the tricky part is that each element of the "mother list"
>> >> contains two vectors (INTSXP and REALEXP types) with varying sizes;
>> >> sizes that I set while I'm looping over another list's ("L1") elements
>> >>  (input list). The steps I've follow are:
>> >>
>> >> FIRST: Create the "mother list" of size "n=length(L0)" (doesn't
>> >> change) and protect it as
>> >>   PROTECT(L1=allocVector(VECEXP, length(L0)))
>> >> and filling it with vectors of length two:
>> >>   for(i=0;i<n;i++) SET_VECTOR_ELT(L1,i, allocVector(VECSXP, 2));
>> >>
>> >> then, for each element of the mother list:
>> >>
>> >>   for(i=0;i<n;i++) {
>> >>
>> >> SECOND: By reading this post in Stackoverflow
>> >>
>> >>
>> >> http://stackoverflow.com/questions/7458364/growing-an-r-matrix-inside-a-c-loop/7458516#7458516
>> >> I understood that it was necesary to (1) create the "child lists" and
>> >> protecting them with PROTECT_WITH_INDEX, and (2) changing its size
>> >> using SETLENGTH (Rf_lengthgets) and REPROTECT ing the lists in order
>> >> to tell the GC that the vectors had change.
>> >>
>> >> THIRD: Once my two vectors are done ("id" and "lambda"), assign them
>> >> to the i-th element of the "mother list" L1 using
>> >>   SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, duplicate(id));
>> >>   SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, duplicate(lambda));
>> >>
>> >> and unprotecting the elements protected with index: UNPROTECT(2);
>> >>
>> >> }
>> >>
>> >> FOURTH: Unprotecting the "mother list" (L1) and return it to R
>> >>
>> >> With small datasets this works fine, but after trying with bigger ones
>> >> R (my code) keeps failing and returning a strange error that I haven't
>> >> been able to identify (or find in the web)
>> >>
>> >>   "unimplemented type (29) in 'duplicate'"
>> >>
>> >> This happens right after I try to use the returned list from my
>> >> routine (trying to print it or building a data-frame).
>> >>
>> >> Does anyone have an idea of what am I doing wrong?
>> >>
>> >> Best regards,
>> >>
>> >> PS: I didn't wanted to copy the entire function... but if you need it
>> >> I can do it.
>> >>
>> >> George Vega Yon
>> >> +56 9 7 647 2552
>> >> http://ggvega.cl
>> >>
>> >> ______________________________________________
>> >> R-devel at r-project.org mailing list
>> >> https://stat.ethz.ch/mailman/listinfo/r-devel
>> >
>> >
>> >
>> >
>> > --
>> > Gabriel Becker
>> > Graduate Student
>> > Statistics Department
>> > University of California, Davis
>
>
>
>
> --
> Gabriel Becker
> Graduate Student
> Statistics Department
> University of California, Davis


From g.vegayon at gmail.com  Wed Nov  6 00:28:53 2013
From: g.vegayon at gmail.com (George Vega Yon)
Date: Tue, 5 Nov 2013 21:28:53 -0200
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'"
In-Reply-To: <527968AC.2060406@stats.ox.ac.uk>
References: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>
	<CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>
	<527968AC.2060406@stats.ox.ac.uk>
Message-ID: <CAPJUxXV0r_iYdguAdmHk+X9dBivkibM=6KdMWK-PEir+W7-PTw@mail.gmail.com>

I'll use it and share the output with you. Thanks!
George Vega Yon
+56 9 7 647 2552
http://ggvega.cl


2013/11/5 Prof Brian Ripley <ripley at stats.ox.ac.uk>:
> On 05/11/2013 21:12, Gabriel Becker wrote:
>>
>> George,
>>
>> I don't see the relevance of the stackoverflow post you linked. In the
>> post, the author wanted to change the length of an existing "mother list"
>> (matrix, etc), while you specifically state that the length of L1 will not
>> change.
>>
>> You say that the child lists (vectors if they are INTSXP/REALSXP) are
>> variable, but that is not what the linked post was about unless I am
>> completely missing something.
>>
>> I can't really say more without knowing the details of how the vectors are
>> being created and why they cannot just have the right length from the
>> start.
>>
>> As for the error, that is a weird one. I imagine it means that a SEXP
>> thinks that it has a type other than ones defined in Rinternals. I can't
>> speak to how that could have happened from what you posted though.
>
>
> Usually it is the result of garbage collection: something which should have
> been protected and is not has been re-used.
>
> The way to find such things is to use a valgrind-instrumented build of R:
> see 'Writing R Extensions'.  Possibly with gcorture(TRUE) to make it
> reproducible.
>
>
>
>>
>> Sorry I can't be of more help,
>> ~G
>>
>>
>>
>> On Mon, Nov 4, 2013 at 8:00 PM, George Vega Yon <g.vegayon at gmail.com>
>> wrote:
>>
>>> Dear R-devel,
>>>
>>> A couple of weeks ago I started to use the R C API for package
>>> development. Without knowing much about C, I've been able to write
>>> some routines sucessfully... until now.
>>>
>>> My problem consists in dynamically creating a list ("L1") of lists
>>> using .Call, the tricky part is that each element of the "mother list"
>>> contains two vectors (INTSXP and REALEXP types) with varying sizes;
>>> sizes that I set while I'm looping over another list's ("L1") elements
>>>   (input list). The steps I've follow are:
>>>
>>> FIRST: Create the "mother list" of size "n=length(L0)" (doesn't
>>> change) and protect it as
>>>    PROTECT(L1=allocVector(VECEXP, length(L0)))
>>> and filling it with vectors of length two:
>>>    for(i=0;i<n;i++) SET_VECTOR_ELT(L1,i, allocVector(VECSXP, 2));
>>>
>>> then, for each element of the mother list:
>>>
>>>    for(i=0;i<n;i++) {
>>>
>>> SECOND: By reading this post in Stackoverflow
>>>
>>>
>>> http://stackoverflow.com/questions/7458364/growing-an-r-matrix-inside-a-c-loop/7458516#7458516
>>> I understood that it was necesary to (1) create the "child lists" and
>>> protecting them with PROTECT_WITH_INDEX, and (2) changing its size
>>> using SETLENGTH (Rf_lengthgets) and REPROTECT ing the lists in order
>>> to tell the GC that the vectors had change.
>>>
>>> THIRD: Once my two vectors are done ("id" and "lambda"), assign them
>>> to the i-th element of the "mother list" L1 using
>>>    SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, duplicate(id));
>>>    SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, duplicate(lambda));
>>>
>>> and unprotecting the elements protected with index: UNPROTECT(2);
>>>
>>> }
>>>
>>> FOURTH: Unprotecting the "mother list" (L1) and return it to R
>>>
>>> With small datasets this works fine, but after trying with bigger ones
>>> R (my code) keeps failing and returning a strange error that I haven't
>>> been able to identify (or find in the web)
>>>
>>>    "unimplemented type (29) in 'duplicate'"
>>>
>>> This happens right after I try to use the returned list from my
>>> routine (trying to print it or building a data-frame).
>>>
>>> Does anyone have an idea of what am I doing wrong?
>>>
>>> Best regards,
>>>
>>> PS: I didn't wanted to copy the entire function... but if you need it
>>> I can do it.
>>>
>>> George Vega Yon
>>> +56 9 7 647 2552
>>> http://ggvega.cl
>>>
>>> ______________________________________________
>>> R-devel at r-project.org mailing list
>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>
>>
>>
>>
>
>
> --
> Brian D. Ripley,                  ripley at stats.ox.ac.uk
> Professor of Applied Statistics,  http://www.stats.ox.ac.uk/~ripley/
> University of Oxford,             Tel:  +44 1865 272861 (self)
> 1 South Parks Road,                     +44 1865 272866 (PA)
> Oxford OX1 3TG, UK                Fax:  +44 1865 272595


From xie at yihui.name  Wed Nov  6 00:32:35 2013
From: xie at yihui.name (Yihui Xie)
Date: Tue, 5 Nov 2013 17:32:35 -0600
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <A750360B-31A8-49EB-B21F-87EE4BA6E412@gmail.com>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
	<21112.61708.698124.149056@stat.math.ethz.ch>
	<8E2469B4-2A7B-44DD-896F-F409C39F4496@sciviews.org>
	<21113.8847.603856.486049@stat.math.ethz.ch>
	<A750360B-31A8-49EB-B21F-87EE4BA6E412@gmail.com>
Message-ID: <CANROs4e=Do0ejPc7w=rOzG8zzNdhkmYWFJN=qU61JQRGnLWiPQ@mail.gmail.com>

Yes, that indeed sounds like a problem, but example(txtProgressBar),
which is based on \r, works well in the RStudio console. Anyway,
thanks for all the experiments, and (to Renaud) support.rstudio.org is
the place to report such problems.

Regards,
Yihui
--
Yihui Xie <xieyihui at gmail.com>
Web: http://yihui.name
Department of Statistics, Iowa State University
2215 Snedecor Hall, Ames, IA


On Tue, Nov 5, 2013 at 4:57 PM, peter dalgaard <pdalgd at gmail.com> wrote:
>
>
> So in a sense, it is the prompt that is tweaked to ?jump to beginning of next line, unless already at beginning of line?. I don?t recall any ?real? terminal having an escape sequence for that, but I wouldn?t put it past ESS to do something similar.
>
> I see your point about cat(?pi?, pi), but I would expect that the bad habit would get cured first time it was attempted to print something between it and the next prompt. I?m actually more worried/puzzled that ?\r? behaves strangely (in Rstudio, not R.app):
>
>> cat("123");cat("\r456")
> 456
>> cat("123\r");cat("456")
> 123456
>
> People do sometimes use this pattern for displaying progress (e.g. iteration counts).
>


From renaud at mancala.cbio.uct.ac.za  Wed Nov  6 09:47:16 2013
From: renaud at mancala.cbio.uct.ac.za (Renaud Gaujoux)
Date: Wed, 6 Nov 2013 10:47:16 +0200
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <CANROs4e=Do0ejPc7w=rOzG8zzNdhkmYWFJN=qU61JQRGnLWiPQ@mail.gmail.com>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
	<21112.61708.698124.149056@stat.math.ethz.ch>
	<8E2469B4-2A7B-44DD-896F-F409C39F4496@sciviews.org>
	<21113.8847.603856.486049@stat.math.ethz.ch>
	<A750360B-31A8-49EB-B21F-87EE4BA6E412@gmail.com>
	<CANROs4e=Do0ejPc7w=rOzG8zzNdhkmYWFJN=qU61JQRGnLWiPQ@mail.gmail.com>
Message-ID: <CAHavPHHwsSq05zhDcCVMBo6kbvgBRwetCx45H19knmRU1xs-_Q@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131106/cb44e132/attachment.pl>

From skostysh at princeton.edu  Wed Nov  6 10:07:39 2013
From: skostysh at princeton.edu (Scott Kostyshak)
Date: Wed, 6 Nov 2013 04:07:39 -0500
Subject: [Rd] [PATCH] minor suggestions for R-ints manual
In-Reply-To: <21113.8228.407363.727817@stat.math.ethz.ch>
References: <CAE3=dmcm031=PQ6Apr9JmpPfVzONaQFxKpjZvX5422zaM=XicA@mail.gmail.com>
	<21113.8228.407363.727817@stat.math.ethz.ch>
Message-ID: <CAE3=dmc6NfYmFzeJ7gRe1z67avQY6kvBEk3PraAZUtjWr42v3A@mail.gmail.com>

On Tue, Nov 5, 2013 at 11:43 AM, Martin Maechler
<maechler at stat.math.ethz.ch> wrote:
>>>>>> Scott Kostyshak <skostysh at princeton.edu>
>>>>>>     on Sat, 12 Oct 2013 17:50:52 -0400 writes:
>
>     > Attached is a patch with minor suggestions for the R-ints
>     > manual at r64048. The most substantial change is the
>     > following:
>
>     >  The top layer comprises the graphics subsystems. Although
>     > there is -provision for 24 subsystems, after 6 years only
>     > two exist, `base' and +provision for 24 subsystems, since
>     > 2001 only two exist, `base' and `grid'.
>
>     > Is the year 2001 correct? I base it on the date of the
>     > commit that introduced the "6 years" string and on the
>     > date of grid 0.1.
>
>     > Scott
>
> I've used  "about 2001" and otherwise basically applied your patch
> (after checking it).
>
> Thank you very much for your contribution!

Thank *you* Martin!

Scott

>
> Martin Maechler
>
>
>     > --
>     > Scott Kostyshak Economics PhD Candidate Princeton
>     > University x[DELETED ATTACHMENT external: R-ints.diff.txt, plain text]
>     >  ______________________________________________
>     > R-devel at r-project.org mailing list
>     > https://stat.ethz.ch/mailman/listinfo/r-devel


--
Scott Kostyshak
Economics PhD Candidate
Princeton University


From renaud at mancala.cbio.uct.ac.za  Wed Nov  6 11:26:37 2013
From: renaud at mancala.cbio.uct.ac.za (Renaud Gaujoux)
Date: Wed, 6 Nov 2013 12:26:37 +0200
Subject: [Rd] How to do package cleanup: hooks .onUnload, R_unload_mylib,
 .onDetach are not called on quit
Message-ID: <CAHavPHFAmL=_wpPLxVb8suJtst7H_WYZqZtxvWUjUmKsyM-ovA@mail.gmail.com>

Hi,

it seems that the package hooks .onLoad and its C++ pendant
R_unload_mylib are actually not called when R quits, but only when
explicitly calling detach('package:mylib', unload = TRUE).
Maybe this is platform specific, I'm on Ubuntu 13.10 - R 3.0.2 (see below).

  * is there a mechanism that a package can use to effectively do some
cleanup on standard exit, such as calling cleaning up routines of a
loaded third-party library? I tried .onDetach but it did not work
either.
  * by curiosity, in what kind of practical situation would a user
want to call detach(..., unload = TRUE)?
  * is there a reason why the hooks are not called on quit?

Thank you.

Bests,
Renaud

###
> Sys.info()

       sysname                                      release
                          version
                                     "Linux"
"3.11.0-12-generic" "#19-Ubuntu SMP Wed Oct 9 16:20:46 UTC 2013"
                                    nodename
           machine                                        login
                                     "XXXXX"
          "x86_64"                                     "renaud"
                                        user
    effective_user
                                    "renaud"
          "renaud"
> sessionInfo()
R version 3.0.2 (2013-09-25)
Platform: x86_64-pc-linux-gnu (64-bit)

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C
LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8
LC_MONETARY=en_US.UTF-8
 [6] LC_MESSAGES=en_US.UTF-8    LC_PAPER=en_US.UTF-8       LC_NAME=C
               LC_ADDRESS=C               LC_TELEPHONE=C
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base
>


From murdoch.duncan at gmail.com  Wed Nov  6 12:36:59 2013
From: murdoch.duncan at gmail.com (Duncan Murdoch)
Date: Wed, 06 Nov 2013 06:36:59 -0500
Subject: [Rd] How to do package cleanup: hooks .onUnload, R_unload_mylib,
 .onDetach are not called on quit
In-Reply-To: <CAHavPHFAmL=_wpPLxVb8suJtst7H_WYZqZtxvWUjUmKsyM-ovA@mail.gmail.com>
References: <CAHavPHFAmL=_wpPLxVb8suJtst7H_WYZqZtxvWUjUmKsyM-ovA@mail.gmail.com>
Message-ID: <527A29DB.1060303@gmail.com>

On 13-11-06 5:26 AM, Renaud Gaujoux wrote:
> Hi,
>
> it seems that the package hooks .onLoad and its C++ pendant
> R_unload_mylib are actually not called when R quits, but only when
> explicitly calling detach('package:mylib', unload = TRUE).
> Maybe this is platform specific, I'm on Ubuntu 13.10 - R 3.0.2 (see below).

No, this is by design.  See ?setHook.

>
>    * is there a mechanism that a package can use to effectively do some
> cleanup on standard exit, such as calling cleaning up routines of a
> loaded third-party library? I tried .onDetach but it did not work
> either.

Yes, you can set a finalizer.  See ?reg.finalizer.



>    * by curiosity, in what kind of practical situation would a user
> want to call detach(..., unload = TRUE)?
>    * is there a reason why the hooks are not called on quit?

They are slow to run, and are usually not needed.  Finalizers handle the 
rare cases where you really do need something to happen.

Duncan Murdoch

>
> Thank you.
>
> Bests,
> Renaud
>
> ###
>> Sys.info()
>
>         sysname                                      release
>                            version
>                                       "Linux"
> "3.11.0-12-generic" "#19-Ubuntu SMP Wed Oct 9 16:20:46 UTC 2013"
>                                      nodename
>             machine                                        login
>                                       "XXXXX"
>            "x86_64"                                     "renaud"
>                                          user
>      effective_user
>                                      "renaud"
>            "renaud"
>> sessionInfo()
> R version 3.0.2 (2013-09-25)
> Platform: x86_64-pc-linux-gnu (64-bit)
>
> locale:
>   [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C
> LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8
> LC_MONETARY=en_US.UTF-8
>   [6] LC_MESSAGES=en_US.UTF-8    LC_PAPER=en_US.UTF-8       LC_NAME=C
>                 LC_ADDRESS=C               LC_TELEPHONE=C
> [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C
>
> attached base packages:
> [1] stats     graphics  grDevices utils     datasets  methods   base
>>
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
>


From ripley at stats.ox.ac.uk  Wed Nov  6 12:54:57 2013
From: ripley at stats.ox.ac.uk (Prof Brian Ripley)
Date: Wed, 06 Nov 2013 11:54:57 +0000
Subject: [Rd] How to do package cleanup: hooks .onUnload, R_unload_mylib,
 .onDetach are not called on quit
In-Reply-To: <527A29DB.1060303@gmail.com>
References: <CAHavPHFAmL=_wpPLxVb8suJtst7H_WYZqZtxvWUjUmKsyM-ovA@mail.gmail.com>
	<527A29DB.1060303@gmail.com>
Message-ID: <527A2E11.3050407@stats.ox.ac.uk>

On 06/11/2013 11:36, Duncan Murdoch wrote:
> On 13-11-06 5:26 AM, Renaud Gaujoux wrote:
>> Hi,
>>
>> it seems that the package hooks .onLoad and its C++ pendant
>> R_unload_mylib are actually not called when R quits, but only when
>> explicitly calling detach('package:mylib', unload = TRUE).
>> Maybe this is platform specific, I'm on Ubuntu 13.10 - R 3.0.2 (see
>> below).
>
> No, this is by design.  See ?setHook.
>
>>
>>    * is there a mechanism that a package can use to effectively do some
>> cleanup on standard exit, such as calling cleaning up routines of a
>> loaded third-party library? I tried .onDetach but it did not work
>> either.
>
> Yes, you can set a finalizer.  See ?reg.finalizer.

RODBC is one example.
>
>
>
>>    * by curiosity, in what kind of practical situation would a user
>> want to call detach(..., unload = TRUE)?

An example is when you want a different version of a package.  (That 
might now work and probably will not if the package does not unload its 
DLL.)

>>    * is there a reason why the hooks are not called on quit?
>
> They are slow to run, and are usually not needed.  Finalizers handle the
> rare cases where you really do need something to happen.

Or to put it another way, the OS will do most of the unloading when it 
terminates the process, more efficiently than the process itself can. 
That includes 'unloading' DLLs and freeing memory.

>
> Duncan Murdoch
>
>>
>> Thank you.
>>
>> Bests,
>> Renaud
>>
>> ###
>>> Sys.info()
>>
>>         sysname                                      release
>>                            version
>>                                       "Linux"
>> "3.11.0-12-generic" "#19-Ubuntu SMP Wed Oct 9 16:20:46 UTC 2013"
>>                                      nodename
>>             machine                                        login
>>                                       "XXXXX"
>>            "x86_64"                                     "renaud"
>>                                          user
>>      effective_user
>>                                      "renaud"
>>            "renaud"
>>> sessionInfo()
>> R version 3.0.2 (2013-09-25)
>> Platform: x86_64-pc-linux-gnu (64-bit)
>>
>> locale:
>>   [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C
>> LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8
>> LC_MONETARY=en_US.UTF-8
>>   [6] LC_MESSAGES=en_US.UTF-8    LC_PAPER=en_US.UTF-8       LC_NAME=C
>>                 LC_ADDRESS=C               LC_TELEPHONE=C
>> [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C
>>
>> attached base packages:
>> [1] stats     graphics  grDevices utils     datasets  methods   base
>>>
>>
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


-- 
Brian D. Ripley,                  ripley at stats.ox.ac.uk
Professor of Applied Statistics,  http://www.stats.ox.ac.uk/~ripley/
University of Oxford,             Tel:  +44 1865 272861 (self)
1 South Parks Road,                     +44 1865 272866 (PA)
Oxford OX1 3TG, UK                Fax:  +44 1865 272595


From renaud at mancala.cbio.uct.ac.za  Wed Nov  6 13:34:16 2013
From: renaud at mancala.cbio.uct.ac.za (Renaud Gaujoux)
Date: Wed, 6 Nov 2013 14:34:16 +0200
Subject: [Rd] How to do package cleanup: hooks .onUnload, R_unload_mylib,
 .onDetach are not called on quit
In-Reply-To: <527A2E11.3050407@stats.ox.ac.uk>
References: <CAHavPHFAmL=_wpPLxVb8suJtst7H_WYZqZtxvWUjUmKsyM-ovA@mail.gmail.com>
	<527A29DB.1060303@gmail.com> <527A2E11.3050407@stats.ox.ac.uk>
Message-ID: <CAHavPHFyBXPpLwRxTuXYbmiHdk0M3DtsJaZ4MW2NfouD947v2Q@mail.gmail.com>

Many thanks for all responses and clarification!

It worked great by defining a dummy environment in the package
namespace and calling reg.finalizer to "attach" the cleanup function
to it.

Bests,
Renaud

On 6 November 2013 13:54, Prof Brian Ripley <ripley at stats.ox.ac.uk> wrote:
> On 06/11/2013 11:36, Duncan Murdoch wrote:
>>
>> On 13-11-06 5:26 AM, Renaud Gaujoux wrote:
>>>
>>> Hi,
>>>
>>> it seems that the package hooks .onLoad and its C++ pendant
>>> R_unload_mylib are actually not called when R quits, but only when
>>> explicitly calling detach('package:mylib', unload = TRUE).
>>> Maybe this is platform specific, I'm on Ubuntu 13.10 - R 3.0.2 (see
>>> below).
>>
>>
>> No, this is by design.  See ?setHook.
>>
>>>
>>>    * is there a mechanism that a package can use to effectively do some
>>> cleanup on standard exit, such as calling cleaning up routines of a
>>> loaded third-party library? I tried .onDetach but it did not work
>>> either.
>>
>>
>> Yes, you can set a finalizer.  See ?reg.finalizer.
>
>
> RODBC is one example.
>
>>
>>
>>
>>>    * by curiosity, in what kind of practical situation would a user
>>> want to call detach(..., unload = TRUE)?
>
>
> An example is when you want a different version of a package.  (That might
> now work and probably will not if the package does not unload its DLL.)
>
>
>>>    * is there a reason why the hooks are not called on quit?
>>
>>
>> They are slow to run, and are usually not needed.  Finalizers handle the
>> rare cases where you really do need something to happen.
>
>
> Or to put it another way, the OS will do most of the unloading when it
> terminates the process, more efficiently than the process itself can. That
> includes 'unloading' DLLs and freeing memory.
>
>
>>
>> Duncan Murdoch
>>
>>>
>>> Thank you.
>>>
>>> Bests,
>>> Renaud
>>>
>>> ###
>>>>
>>>> Sys.info()
>>>
>>>
>>>         sysname                                      release
>>>                            version
>>>                                       "Linux"
>>> "3.11.0-12-generic" "#19-Ubuntu SMP Wed Oct 9 16:20:46 UTC 2013"
>>>                                      nodename
>>>             machine                                        login
>>>                                       "XXXXX"
>>>            "x86_64"                                     "renaud"
>>>                                          user
>>>      effective_user
>>>                                      "renaud"
>>>            "renaud"
>>>>
>>>> sessionInfo()
>>>
>>> R version 3.0.2 (2013-09-25)
>>> Platform: x86_64-pc-linux-gnu (64-bit)
>>>
>>> locale:
>>>   [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C
>>> LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8
>>> LC_MONETARY=en_US.UTF-8
>>>   [6] LC_MESSAGES=en_US.UTF-8    LC_PAPER=en_US.UTF-8       LC_NAME=C
>>>                 LC_ADDRESS=C               LC_TELEPHONE=C
>>> [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C
>>>
>>> attached base packages:
>>> [1] stats     graphics  grDevices utils     datasets  methods   base
>>>>
>>>>
>>>
>>> ______________________________________________
>>> R-devel at r-project.org mailing list
>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>
>>
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel
>
>
>
> --
> Brian D. Ripley,                  ripley at stats.ox.ac.uk
> Professor of Applied Statistics,  http://www.stats.ox.ac.uk/~ripley/
> University of Oxford,             Tel:  +44 1865 272861 (self)
> 1 South Parks Road,                     +44 1865 272866 (PA)
> Oxford OX1 3TG, UK                Fax:  +44 1865 272595
>


From radford at cs.toronto.edu  Wed Nov  6 18:00:38 2013
From: radford at cs.toronto.edu (Radford Neal)
Date: Wed, 6 Nov 2013 12:00:38 -0500
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'" Dynamic list creation (SEXP in C)
 returns error
In-Reply-To: <mailman.25.1383735608.27847.r-devel@r-project.org>
References: <mailman.25.1383735608.27847.r-devel@r-project.org>
Message-ID: <20131106170038.GA30482@cs.toronto.edu>

"changing its size using SETLENGTH (Rf_lengthgets)"

NO! NO! NO!  SETLENGTH does not do the same thing as Rf_lengthgets.
You should never use SETLENGTH, which is not part of the API, and
really should not even exist.

For that matter Rf_lengthgets is also not part of the API.  I
recommend getting the length right to start with.

   Radford Neal


From g.vegayon at gmail.com  Wed Nov  6 18:40:59 2013
From: g.vegayon at gmail.com (George Vega Yon)
Date: Wed, 6 Nov 2013 14:40:59 -0300
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'" Dynamic list creation (SEXP in C)
 returns error
In-Reply-To: <20131106170038.GA30482@cs.toronto.edu>
References: <mailman.25.1383735608.27847.r-devel@r-project.org>
	<20131106170038.GA30482@cs.toronto.edu>
Message-ID: <CAPJUxXXcvh_9FmbZnR+u7oHO98xf3GdcFWbCuJDqaaXe-R+mUQ@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131106/af2da4a4/attachment.pl>

From radford at cs.toronto.edu  Wed Nov  6 19:15:25 2013
From: radford at cs.toronto.edu (Radford Neal)
Date: Wed, 6 Nov 2013 13:15:25 -0500
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'" Dynamic list creation (SEXP in C)
 returns error
In-Reply-To: <CAPJUxXXcvh_9FmbZnR+u7oHO98xf3GdcFWbCuJDqaaXe-R+mUQ@mail.gmail.com>
References: <mailman.25.1383735608.27847.r-devel@r-project.org>
	<20131106170038.GA30482@cs.toronto.edu>
	<CAPJUxXXcvh_9FmbZnR+u7oHO98xf3GdcFWbCuJDqaaXe-R+mUQ@mail.gmail.com>
Message-ID: <20131106181525.GA8938@cs.toronto.edu>

On Wed, Nov 06, 2013 at 02:40:59PM -0300, George Vega Yon wrote:
> Hi! You are right, what I actually use is SET_LENGTH... Is that ok?
> El 06/11/2013 14:00, "Radford Neal" <radford at cs.toronto.edu> escribi?:

Is SET_LENGTH a documented feature of the API?  Not that I can see.

However, it is indeed different from SETLENGTH.  Perhaps your problem
is in the following code you posted:

  REPROTECT(SET_LENGTH(id,    length(lambda) + z), ipx0);
  REPROTECT(SET_LENGTH(lambda,length(lambda) + z), ipx1);

It looks like the first line should have length(id), not length(lambda).

Your usage of REPROTECT and duplicate seems odd.  If you make the
stuff you allocate part of your original list as soon as you allocate
it, you only need to protect the original list.  And it's not clear
why you think you need to duplicate vectors.

   Radford Neal


From simon.urbanek at r-project.org  Thu Nov  7 01:41:57 2013
From: simon.urbanek at r-project.org (Simon Urbanek)
Date: Wed, 6 Nov 2013 19:41:57 -0500
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <CAHavPHHwsSq05zhDcCVMBo6kbvgBRwetCx45H19knmRU1xs-_Q@mail.gmail.com>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
	<21112.61708.698124.149056@stat.math.ethz.ch>
	<8E2469B4-2A7B-44DD-896F-F409C39F4496@sciviews.org>
	<21113.8847.603856.486049@stat.math.ethz.ch>
	<A750360B-31A8-49EB-B21F-87EE4BA6E412@gmail.com>
	<CANROs4e=Do0ejPc7w=rOzG8zzNdhkmYWFJN=qU61JQRGnLWiPQ@mail.gmail.com>
	<CAHavPHHwsSq05zhDcCVMBo6kbvgBRwetCx45H19knmRU1xs-_Q@mail.gmail.com>
Message-ID: <15FAF9D3-1BA6-48EA-8B98-1347B97256CD@r-project.org>


On Nov 6, 2013, at 3:47 AM, Renaud Gaujoux <renaud at mancala.cbio.uct.ac.za> wrote:

>> Anyway,
>> thanks for all the experiments, and (to Renaud) support.rstudio.org is
>> the place to report such problems.
>> 
> 
> Funny how the post diverged to an RStudio-related issue.
> Anyway, I posted a link to this post at support.rstudio.org:
> http://support.rstudio.org/help/discussions/problems/9242-cat-with-backspace-and-newline-characters/
> 
>> From the user point of view, the following behaviour still feels like a
> strange behaviour of the R prompt:
> 
>> cat("abc\b\b\b")
>> c
> (with the cursor now position on the 'c?)

That is not strange at all - just try adding something like Sys.sleep(2) to understand it - it?s exactly what you should expect in a typical terminal (but see below) and it?s happens with any program (try perl -e 'print STDERR "abc\b\b\b"; sleep 1;? for example).


> I don't know if there is a general official behaviour of prompt characters,
> but I think one expects the prompt to always follow whatever is printed by
> the previous R command, without corruption of the input line to be.
> 

I don?t think that there is any guaranteed behavior for anything other than ?\n?. All cat() guarantees is that this character sequence will be passed out to the console, there is no guarantee as to what effect it will actually have - that is entirely up to the front-end.

Thus your implicit assumption is that ?\b? is interpreted in some way, but it?s not - it?s simply passed on. When running on a terminal, it is interpreted by the terminal, and the standard interpretation is to move the cursor to the left by one character. If running R through any other means like a GUI, it?s entirely up to the GUI to decide whether to interpret non-ASCI characters in some way - or not.

Cheers,
Simon



> Renaud
> 
> 	[[alternative HTML version deleted]]
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
> 


From renaud at mancala.cbio.uct.ac.za  Thu Nov  7 08:35:31 2013
From: renaud at mancala.cbio.uct.ac.za (Renaud Gaujoux)
Date: Thu, 7 Nov 2013 09:35:31 +0200
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <15FAF9D3-1BA6-48EA-8B98-1347B97256CD@r-project.org>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
	<21112.61708.698124.149056@stat.math.ethz.ch>
	<8E2469B4-2A7B-44DD-896F-F409C39F4496@sciviews.org>
	<21113.8847.603856.486049@stat.math.ethz.ch>
	<A750360B-31A8-49EB-B21F-87EE4BA6E412@gmail.com>
	<CANROs4e=Do0ejPc7w=rOzG8zzNdhkmYWFJN=qU61JQRGnLWiPQ@mail.gmail.com>
	<CAHavPHHwsSq05zhDcCVMBo6kbvgBRwetCx45H19knmRU1xs-_Q@mail.gmail.com>
	<15FAF9D3-1BA6-48EA-8B98-1347B97256CD@r-project.org>
Message-ID: <CAHavPHEOdVJQH_iv3WhxZm65uoJPh+Wn1=B1Vd+O7Fdt3aQnTw@mail.gmail.com>

I agree that the handling of \b is not that strange, once one agrees
on what \b actually means, i.e. "go back one character" and not
"delete previous character".
The fact that R GUI on Mac and Windows interprets/renders it
differently shows that normality and strangeness is quite relative
though.

To make my previous response clearer, I was just wondering if the
printing of R prompt character ">" after the evaluation of an
expression could detect trailing \b from cat in stdout/stderr and
shift its position so that it is displayed after the last printed
character. For example cat("abc\b\b\b") would give

abc>
and not
a> c

But this is:
0) Again platform, front-end dependent;
1) maybe not be possible (e.g., can we actually move forward without
printing a character that would erase the previous output?)
2) maybe not even desirable;
3) certainly not worth the effort anyway!

I guess we can happily close this thread :D
Many thanks.

Bests,
Renaud


From jari.oksanen at oulu.fi  Thu Nov  7 09:28:27 2013
From: jari.oksanen at oulu.fi (Jari Oksanen)
Date: Thu, 7 Nov 2013 08:28:27 +0000
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <CAHavPHEOdVJQH_iv3WhxZm65uoJPh+Wn1=B1Vd+O7Fdt3aQnTw@mail.gmail.com>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
	<21112.61708.698124.149056@stat.math.ethz.ch>
	<8E2469B4-2A7B-44DD-896F-F409C39F4496@sciviews.org>
	<21113.8847.603856.486049@stat.math.ethz.ch>
	<A750360B-31A8-49EB-B21F-87EE4BA6E412@gmail.com>
	<CANROs4e=Do0ejPc7w=rOzG8zzNdhkmYWFJN=qU61JQRGnLWiPQ@mail.gmail.com>
	<CAHavPHHwsSq05zhDcCVMBo6kbvgBRwetCx45H19knmRU1xs-_Q@mail.gmail.com>
	<15FAF9D3-1BA6-48EA-8B98-1347B97256CD@r-project.org>
	<CAHavPHEOdVJQH_iv3WhxZm65uoJPh+Wn1=B1Vd+O7Fdt3aQnTw@mail.gmail.com>
Message-ID: <6EB98963-69B9-4CCA-B371-6EB2ABF45982@oulu.fi>


On 07/11/2013, at 09:35 AM, Renaud Gaujoux wrote:

> I agree that the handling of \b is not that strange, once one agrees
> on what \b actually means, i.e. "go back one character" and not
> "delete previous character".
> The fact that R GUI on Mac and Windows interprets/renders it
> differently shows that normality and strangeness is quite relative
> though.
> 
As a user DEC LA120 terminal I expect the following:

> cat("a\b^\n")
?
>

Everything else feels like a bug.

Cheers, Jari Oksanen


From b.rowlingson at lancaster.ac.uk  Thu Nov  7 10:13:18 2013
From: b.rowlingson at lancaster.ac.uk (Barry Rowlingson)
Date: Thu, 7 Nov 2013 09:13:18 +0000
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <3e624aa3dd724c3aa3d6221fdf0dacf5@EX-0-HT0.lancs.local>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
	<21112.61708.698124.149056@stat.math.ethz.ch>
	<8E2469B4-2A7B-44DD-896F-F409C39F4496@sciviews.org>
	<21113.8847.603856.486049@stat.math.ethz.ch>
	<A750360B-31A8-49EB-B21F-87EE4BA6E412@gmail.com>
	<CANROs4e=Do0ejPc7w=rOzG8zzNdhkmYWFJN=qU61JQRGnLWiPQ@mail.gmail.com>
	<CAHavPHHwsSq05zhDcCVMBo6kbvgBRwetCx45H19knmRU1xs-_Q@mail.gmail.com>
	<15FAF9D3-1BA6-48EA-8B98-1347B97256CD@r-project.org>
	<CAHavPHEOdVJQH_iv3WhxZm65uoJPh+Wn1=B1Vd+O7Fdt3aQnTw@mail.gmail.com>
	<3e624aa3dd724c3aa3d6221fdf0dacf5@EX-0-HT0.lancs.local>
Message-ID: <CANVKczNpi9p+c5zkZBj2vjSyVkUcb12XzTrj6+nfbesg84QNig@mail.gmail.com>

On Thu, Nov 7, 2013 at 8:28 AM, Jari Oksanen <jari.oksanen at oulu.fi> wrote:
>
> On 07/11/2013, at 09:35 AM, Renaud Gaujoux wrote:
>
>> I agree that the handling of \b is not that strange, once one agrees
>> on what \b actually means, i.e. "go back one character" and not
>> "delete previous character".

It means, to paraphrase Humpty Dumpty from Alice in Wonderland,
whatever the terminal chooses it to mean. If you want to do something
meaningful and consistent across different terminals, you use termcap
or terminfo:

 http://en.wikipedia.org/wiki/Termcap
 http://en.wikipedia.org/wiki/Terminfo

or other abstractions probably built on that (eg 'ncurses').

> As a user DEC LA120 terminal I expect the following:
>
>> cat("a\b^\n")
> ?
>>
>
> Everything else feels like a bug.

 Oh noes! I don't have a terminfo entry for my DEC LA120!

 I don't know what flavour of 'terminal' RStudio, the Windows GUI or
emacs-ess behave as and whether there's terminfo entries for them....

 Do any R packages link with termcap to do controlled screen output? Hmmmm....

Barry


From pdalgd at gmail.com  Thu Nov  7 12:12:56 2013
From: pdalgd at gmail.com (peter dalgaard)
Date: Thu, 7 Nov 2013 12:12:56 +0100
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <CANVKczNpi9p+c5zkZBj2vjSyVkUcb12XzTrj6+nfbesg84QNig@mail.gmail.com>
References: <CAHavPHGe1A7R6RxD45exQnq7zJXWatiKQ8rR7SiFJBE2RGVQDQ@mail.gmail.com>
	<CADv2QyG6Nvn+YJ46Pz5PF7FqB9Q-LnEeLE4_EAgfVgBKo+EakA@mail.gmail.com>
	<CAHavPHH7VMYxBLjJsDO_2wwS-tC=gwbHiMfXVeP4fhXPZiJwNg@mail.gmail.com>
	<CAH7sKSN6a7ObU8g7xXf+fHq0cdMeKvsr7PSsorhNZ=DP3Pf8Ow@mail.gmail.com>
	<21112.61708.698124.149056@stat.math.ethz.ch>
	<8E2469B4-2A7B-44DD-896F-F409C39F4496@sciviews.org>
	<21113.8847.603856.486049@stat.math.ethz.ch>
	<A750360B-31A8-49EB-B21F-87EE4BA6E412@gmail.com>
	<CANROs4e=Do0ejPc7w=rOzG8zzNdhkmYWFJN=qU61JQRGnLWiPQ@mail.gmail.com>
	<CAHavPHHwsSq05zhDcCVMBo6kbvgBRwetCx45H19knmRU1xs-_Q@mail.gmail.com>
	<15FAF9D3-1BA6-48EA-8B98-1347B97256CD@r-project.org>
	<CAHavPHEOdVJQH_iv3WhxZm65uoJPh+Wn1=B1Vd+O7Fdt3aQnTw@mail.gmail.com>
	<3e624aa3dd724c3aa3d6221fdf0dacf5@EX-0-HT0.lancs.local>
	<CANVKczNpi9p+c5zkZBj2vjSyVkUcb12XzTrj6+nfbesg84QNig@mail.gmail.com>
Message-ID: <6B506EB1-78CB-41A4-8DD3-D6617BC5E55D@gmail.com>


On 07 Nov 2013, at 10:13 , Barry Rowlingson <b.rowlingson at lancaster.ac.uk> wrote:

> On Thu, Nov 7, 2013 at 8:28 AM, Jari Oksanen <jari.oksanen at oulu.fi> wrote:
>> 
>> On 07/11/2013, at 09:35 AM, Renaud Gaujoux wrote:
>> 
>>> I agree that the handling of \b is not that strange, once one agrees
>>> on what \b actually means, i.e. "go back one character" and not
>>> "delete previous character".
> 
> It means, to paraphrase Humpty Dumpty from Alice in Wonderland,
> whatever the terminal chooses it to mean. If you want to do something
> meaningful and consistent across different terminals, you use termcap
> or terminfo:
> 
> http://en.wikipedia.org/wiki/Termcap
> http://en.wikipedia.org/wiki/Terminfo
> 
> or other abstractions probably built on that (eg 'ncurses').
> 
>> As a user DEC LA120 terminal I expect the following:
>> 
>>> cat("a\b^\n")
>> ?
>>> 
>> 
>> Everything else feels like a bug.
> 
> Oh noes! I don't have a terminfo entry for my DEC LA120!
> 
> I don't know what flavour of 'terminal' RStudio, the Windows GUI or
> emacs-ess behave as and whether there's terminfo entries for them....
> 
> Do any R packages link with termcap to do controlled screen output? Hmmmm....

Termcap or terminfo, make up your mind....

AFAIK, the readline library is linked to the term* databases (via ncurses, I suppose), so R-in-a-terminal is (usually) linked to them too. Insofar as there is any sanity left in building terminal interfaces, the sane thing would be to go via ncurses rather than outputting specific escape sequences. 

Of course, there is nothing keeping you from doing silly things like

options(prompt="\033[2J> ")

or

options(prompt="\033[5mI eagerly and patiently await your command, oh Master \033[0m> ")

:-{)

-pd

-- 
Peter Dalgaard, Professor
Center for Statistics, Copenhagen Business School
Solbjerg Plads 3, 2000 Frederiksberg, Denmark
Phone: (+45)38153501
Email: pd.mes at cbs.dk  Priv: PDalgd at gmail.com


From g.vegayon at gmail.com  Thu Nov  7 14:03:33 2013
From: g.vegayon at gmail.com (George Vega Yon)
Date: Thu, 7 Nov 2013 10:03:33 -0300
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'"
In-Reply-To: <CAPJUxXUfJ5Q1yJOxOMmPLFHE93rj1BzCKZkzNJxVVn4+xt0Smg@mail.gmail.com>
References: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>
	<CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>
	<CAPJUxXWXFctds0veg3Ayy8bD3woWkA46Ss6JFWc_TFjRKDFTZA@mail.gmail.com>
	<CADwqtCPemzpwOjuhVgVmgeHq2zEkF1ViOOzUk6NXNaP3WYvVng@mail.gmail.com>
	<CAPJUxXUfJ5Q1yJOxOMmPLFHE93rj1BzCKZkzNJxVVn4+xt0Smg@mail.gmail.com>
Message-ID: <CAPJUxXXF7103s06yh1BoHQbzv3Onkb1Ooj+AShZ=oykJnK=uig@mail.gmail.com>

Hi!

I didn't wanted to do this but I think that this is the easiest way
for you to understand my problem (thanks again for all the comments
that you have made). Here is a copy of the function that I'm working
on. This may be tedious to analyze, so I understand if you don't feel
keen to give it a time. Having dedicated many hours to this (as a new
user of both C and R C API), I would be very pleased to know what am I
doing wrong here.

G0 is a Nx2 matrix. The first column is a group id (can be shared with
several observations) and the second tells how many individuals are in
that group. This matrix can look something like this:

id_group  nreps
1  3
1  3
1  3
2  1
3  1
4  2
5  1
6  1
4  2
...

L0 is list of two column data.frames with different sizes. The first
column (id) are row indexes (with values 1 to N) and the second column
are real numbers. L0 can look something like this
[[1]]
id  lambda
3  0.5
15  0.3
25  0.2
[[2]]
id  lambda
15  0.8
40  0.2
...
[[N]]
id  lambda
80  1

TE0 is a int scalar in {0,1,2}

T0 is a dichotomous vector of length N that can look something like this
[1] 0 1 0 1 1 1 0 ...
[N] 1

L1 (the expected output) is a modified version of L0, that, for
instance can look something like this (note the rows marked with "*")

[[1]]
id  lambda
3  0.5
*15  0.15 (15 was in the same group of 50, so I added this new row and
divided the value of lambda by two)
25  0.2
*50  0.15
[[2]]
id  lambda
15  0.8
40  0.2
...
[[N]]
id  lambda
*80  0.333 (80 shared group id with 30 and 100, so lambda is divided by 3)
*30  0.333
*100 0.333

That said, the function is as follows

SEXP distribute_lambdas(
  SEXP G0,  // Groups ids (matrix of Nx2). First column = Group Id,
second column: Elements in the group
  SEXP L0,  // List of N two-column dataframes with different number of rows
  SEXP TE0, // Treatment effect (int scalar): ATE(0) ATT(1) ATC(2)
  SEXP T0   // Treat var (bool vector, 0/1, of size N)
)
{

  int i, j, l, m;
  const int *G = INTEGER_POINTER(PROTECT(G0 = AS_INTEGER(G0 )));
  const int *T = INTEGER_POINTER(PROTECT(T0 = AS_INTEGER(T0 )));
  const int *TE= INTEGER_POINTER(PROTECT(TE0= AS_INTEGER(TE0)));
  double *L, val;
  int *I, nlambdas, nreps;

  const int n = length(T0);

  PROTECT_INDEX pin0, pin1;
  SEXP L1;
  PROTECT(L1 = allocVector(VECSXP,n));
  SEXP id, lambda;

  // Fixing size
  for(i=0;i<n;i++)
  {
    SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
  //  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, NEW_INTEGER(100));
  //  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, NEW_NUMERIC(100));
  }

  // For over the list, i.e observations
  for(i=0;i<n;i++)
  {

    R_CheckUserInterrupt();

    // Checking if has to be analyzed.
    if (
      ((TE[0] == 1 & !T[i]) | (TE[0] == 2 & T[i])) |
      (length(VECTOR_ELT(L0,i)) != 2)
    )
    {
      SET_VECTOR_ELT(L1,i,R_NilValue);
      continue;
    }

    // Checking how many rows does the i-th data.frame has
    nlambdas = length(VECTOR_ELT(VECTOR_ELT(L0,i),0));

    // Pointing to the data.frame's origianl values
    I = INTEGER_POINTER(AS_INTEGER(PROTECT(VECTOR_ELT(VECTOR_ELT(L0,i),0))));
    L = NUMERIC_POINTER(AS_NUMERIC(PROTECT(VECTOR_ELT(VECTOR_ELT(L0,i),1))));

    // Creating a copy of the pointed values
    PROTECT_WITH_INDEX(id   = duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),0)), &pin0);
    PROTECT_WITH_INDEX(lambda=duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),1)), &pin1);

    // Over the rows of the i-th data.frame
    nreps=0;
    for(l=0;l<nlambdas;l++)
    {
      // If the current lambda id is repeated, ie ther are more individuals
      // with the same covariates, then enter.
      if (G[n+I[l]-1] > 1)
      {
        /* Changing the length of the object */
        REPROTECT(SET_LENGTH(id,    length(lambda) + G[n+I[l]-1] -1), pin0);
        REPROTECT(SET_LENGTH(lambda,length(lambda) + G[n+I[l]-1] -1), pin1);

        // Getting the new value
        val = L[l]/G[n+I[l] - 1];
        REAL(lambda)[l] = val;

        // Looping over the full set of groups
        m = -1,j = -1;
        while(m < (G[n+I[l]-1] - 1))
        {
          // Looking for individuals in the same group
          if (G[++j] != G[I[l]-1]) continue;

          // If it is the current lambda, then do not asign it
          if (j == (I[l] - 1)) continue;

          INTEGER(id)[length(id) - (G[n+I[l]-1] - 1) + ++m] = j+1;
          REAL(lambda)[length(id) - (G[n+I[l]-1] - 1) + m] = val;
        }

        nreps+=1;
      }
    }

    if (nreps)
    {
      // Replacing elements from of the list (modified)
      SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
      SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
    }
    else {
      // Setting the list with the old elements
      SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0,
        duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),0)));
      SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1,
        duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),1)));
    }

    // Unprotecting elements
    UNPROTECT(4);
  }

  Rprintf("Exito\n") ;
  UNPROTECT(4);

  return L1;
}

Thanks again in advanced.

George Vega Yon
+56 9 7 647 2552
http://ggvega.cl

2013/11/5 George Vega Yon <g.vegayon at gmail.com>:
> Either way, understanding that it may not be the best way of do it, is
> there anything wrong in what I'm doing??
> George Vega Yon
> +56 9 7 647 2552
> http://ggvega.cl
>
>
> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>> George,
>>
>> My point is you don't need to create them and then grow them....
>>
>>
>> for(i=0;i<n;i++)
>> {
>>   // Creating the "id" and "lambda" vectors. I do this in every repetition
>> of
>>   // the loop.
>>
>>   // ... Some other instructions where I set the value of an integer
>>   // z, which tells how much do the vectors have to grow ...
>>
>> PROTECT(id=allocVector(INTSXP, 4 +z));
>> PROTECT(lambda=allocVector(REALSXP, 4 +z));
>>
>>
>>   // ... some lines where I fill the vectors ...
>>
>>   // Storing the new vectors at the i-th element of the list
>>   SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>   SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>
>>   // Unprotecting the "id" and "lambda" vectors
>>   UNPROTECT(2);
>> }
>>
>> ~G
>>
>>
>> On Tue, Nov 5, 2013 at 1:56 PM, George Vega Yon <g.vegayon at gmail.com> wrote:
>>>
>>> Gabriel,
>>>
>>> While the length (in terms of number of SEXP elements it stores) of L1
>>> doesn't changes, the vectors within L1 do (sorry if I didn't explained
>>> it well before).
>>>
>>> The post was about a SEXP object that grows, in my case, every pair of
>>> vectors in L1 (id and lambda) can change lengths, this is why I need
>>> to reprotect them. I populate the i-th element of L1 by creating the
>>> vectors "id" and "lambda", setting the length of these according to
>>> some rule (that's the part where lengths change)... here is a reduced
>>> form of my code:
>>>
>>> //////////////////////////////////////// C
>>> ////////////////////////////////////////
>>> const int = length(L0);
>>> SEXP L1;
>>> PROTECT(L1 = allocVector(VECSXP,n));
>>> SEXP id, lambda;
>>>
>>> // Fixing size
>>> for(i=0;i<n;i++)
>>>   SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
>>>
>>> for(i=0;i<n;i++)
>>> {
>>>   // Creating the "id" and "lambda" vectors. I do this in every repetition
>>> of
>>>   // the loop.
>>>   PROTECT_WITH_INDEX(id=allocVector(INTSXP, 4), &ipx0);
>>>   PROTECT_WITH_INDEX(lambda=allocVector(REALSXP, 4), &ipx1);
>>>
>>>   // ... Some other instructions where I set the value of an integer
>>>   // z, which tells how much do the vectors have to grow ...
>>>
>>>   REPROTECT(SET_LENGTH(id,    length(lambda) + z), ipx0);
>>>   REPROTECT(SET_LENGTH(lambda,length(lambda) + z), ipx1);
>>>
>>>   // ... some lines where I fill the vectors ...
>>>
>>>   // Storing the new vectors at the i-th element of the list
>>>   SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>   SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>
>>>   // Unprotecting the "id" and "lambda" vectors
>>>   UNPROTECT(2);
>>> }
>>>
>>> UNPROTECT(1);
>>>
>>> return L1;
>>> //////////////////////////////////////// C
>>> ////////////////////////////////////////
>>>
>>> I can't set the length from the start because every pair of vectors in
>>> L1 have different lengths, lengths that I cannot tell before starting
>>> the loop.
>>>
>>> Thanks for your help,
>>>
>>> Regards,
>>>
>>> George Vega Yon
>>> +56 9 7 647 2552
>>> http://ggvega.cl
>>>
>>>
>>> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>>> > George,
>>> >
>>> > I don't see the relevance of the stackoverflow post you linked. In the
>>> > post,
>>> > the author wanted to change the length of an existing "mother list"
>>> > (matrix,
>>> > etc), while you specifically state that the length of L1 will not
>>> > change.
>>> >
>>> > You say that the child lists (vectors if they are INTSXP/REALSXP) are
>>> > variable, but that is not what the linked post was about unless I am
>>> > completely missing something.
>>> >
>>> > I can't really say more without knowing the details of how the vectors
>>> > are
>>> > being created and why they cannot just have the right length from the
>>> > start.
>>> >
>>> > As for the error, that is a weird one. I imagine it means that a SEXP
>>> > thinks
>>> > that it has a type other than ones defined in Rinternals. I can't speak
>>> > to
>>> > how that could have happened from what you posted though.
>>> >
>>> > Sorry I can't be of more help,
>>> > ~G
>>> >
>>> >
>>> >
>>> > On Mon, Nov 4, 2013 at 8:00 PM, George Vega Yon <g.vegayon at gmail.com>
>>> > wrote:
>>> >>
>>> >> Dear R-devel,
>>> >>
>>> >> A couple of weeks ago I started to use the R C API for package
>>> >> development. Without knowing much about C, I've been able to write
>>> >> some routines sucessfully... until now.
>>> >>
>>> >> My problem consists in dynamically creating a list ("L1") of lists
>>> >> using .Call, the tricky part is that each element of the "mother list"
>>> >> contains two vectors (INTSXP and REALEXP types) with varying sizes;
>>> >> sizes that I set while I'm looping over another list's ("L1") elements
>>> >>  (input list). The steps I've follow are:
>>> >>
>>> >> FIRST: Create the "mother list" of size "n=length(L0)" (doesn't
>>> >> change) and protect it as
>>> >>   PROTECT(L1=allocVector(VECEXP, length(L0)))
>>> >> and filling it with vectors of length two:
>>> >>   for(i=0;i<n;i++) SET_VECTOR_ELT(L1,i, allocVector(VECSXP, 2));
>>> >>
>>> >> then, for each element of the mother list:
>>> >>
>>> >>   for(i=0;i<n;i++) {
>>> >>
>>> >> SECOND: By reading this post in Stackoverflow
>>> >>
>>> >>
>>> >> http://stackoverflow.com/questions/7458364/growing-an-r-matrix-inside-a-c-loop/7458516#7458516
>>> >> I understood that it was necesary to (1) create the "child lists" and
>>> >> protecting them with PROTECT_WITH_INDEX, and (2) changing its size
>>> >> using SETLENGTH (Rf_lengthgets) and REPROTECT ing the lists in order
>>> >> to tell the GC that the vectors had change.
>>> >>
>>> >> THIRD: Once my two vectors are done ("id" and "lambda"), assign them
>>> >> to the i-th element of the "mother list" L1 using
>>> >>   SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, duplicate(id));
>>> >>   SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, duplicate(lambda));
>>> >>
>>> >> and unprotecting the elements protected with index: UNPROTECT(2);
>>> >>
>>> >> }
>>> >>
>>> >> FOURTH: Unprotecting the "mother list" (L1) and return it to R
>>> >>
>>> >> With small datasets this works fine, but after trying with bigger ones
>>> >> R (my code) keeps failing and returning a strange error that I haven't
>>> >> been able to identify (or find in the web)
>>> >>
>>> >>   "unimplemented type (29) in 'duplicate'"
>>> >>
>>> >> This happens right after I try to use the returned list from my
>>> >> routine (trying to print it or building a data-frame).
>>> >>
>>> >> Does anyone have an idea of what am I doing wrong?
>>> >>
>>> >> Best regards,
>>> >>
>>> >> PS: I didn't wanted to copy the entire function... but if you need it
>>> >> I can do it.
>>> >>
>>> >> George Vega Yon
>>> >> +56 9 7 647 2552
>>> >> http://ggvega.cl
>>> >>
>>> >> ______________________________________________
>>> >> R-devel at r-project.org mailing list
>>> >> https://stat.ethz.ch/mailman/listinfo/r-devel
>>> >
>>> >
>>> >
>>> >
>>> > --
>>> > Gabriel Becker
>>> > Graduate Student
>>> > Statistics Department
>>> > University of California, Davis
>>
>>
>>
>>
>> --
>> Gabriel Becker
>> Graduate Student
>> Statistics Department
>> University of California, Davis


From romain at r-enthusiasts.com  Thu Nov  7 14:17:39 2013
From: romain at r-enthusiasts.com (Romain Francois)
Date: Thu, 07 Nov 2013 14:17:39 +0100
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'"
In-Reply-To: <CAPJUxXXF7103s06yh1BoHQbzv3Onkb1Ooj+AShZ=oykJnK=uig@mail.gmail.com>
References: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>	<CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>	<CAPJUxXWXFctds0veg3Ayy8bD3woWkA46Ss6JFWc_TFjRKDFTZA@mail.gmail.com>	<CADwqtCPemzpwOjuhVgVmgeHq2zEkF1ViOOzUk6NXNaP3WYvVng@mail.gmail.com>	<CAPJUxXUfJ5Q1yJOxOMmPLFHE93rj1BzCKZkzNJxVVn4+xt0Smg@mail.gmail.com>
	<CAPJUxXXF7103s06yh1BoHQbzv3Onkb1Ooj+AShZ=oykJnK=uig@mail.gmail.com>
Message-ID: <527B92F3.7080706@r-enthusiasts.com>

Hello,

Any particular reason you're not using Rcpp? You would have access to 
nice abstraction instead of these MACROS all over the place.

The cost of these abstractions is close to 0.

Looping around and SET_LENGTH is going to be quite expensive. I would 
urge you to accumulate data in data structures that know how to grow 
efficiently, i.e. a std::vector and then convert that to an R vector 
when you're done with them.

Romain

Le 07/11/2013 14:03, George Vega Yon a ?crit :
> Hi!
>
> I didn't wanted to do this but I think that this is the easiest way
> for you to understand my problem (thanks again for all the comments
> that you have made). Here is a copy of the function that I'm working
> on. This may be tedious to analyze, so I understand if you don't feel
> keen to give it a time. Having dedicated many hours to this (as a new
> user of both C and R C API), I would be very pleased to know what am I
> doing wrong here.
>
> G0 is a Nx2 matrix. The first column is a group id (can be shared with
> several observations) and the second tells how many individuals are in
> that group. This matrix can look something like this:
>
> id_group  nreps
> 1  3
> 1  3
> 1  3
> 2  1
> 3  1
> 4  2
> 5  1
> 6  1
> 4  2
> ...
>
> L0 is list of two column data.frames with different sizes. The first
> column (id) are row indexes (with values 1 to N) and the second column
> are real numbers. L0 can look something like this
> [[1]]
> id  lambda
> 3  0.5
> 15  0.3
> 25  0.2
> [[2]]
> id  lambda
> 15  0.8
> 40  0.2
> ...
> [[N]]
> id  lambda
> 80  1
>
> TE0 is a int scalar in {0,1,2}
>
> T0 is a dichotomous vector of length N that can look something like this
> [1] 0 1 0 1 1 1 0 ...
> [N] 1
>
> L1 (the expected output) is a modified version of L0, that, for
> instance can look something like this (note the rows marked with "*")
>
> [[1]]
> id  lambda
> 3  0.5
> *15  0.15 (15 was in the same group of 50, so I added this new row and
> divided the value of lambda by two)
> 25  0.2
> *50  0.15
> [[2]]
> id  lambda
> 15  0.8
> 40  0.2
> ...
> [[N]]
> id  lambda
> *80  0.333 (80 shared group id with 30 and 100, so lambda is divided by 3)
> *30  0.333
> *100 0.333
>
> That said, the function is as follows
>
> SEXP distribute_lambdas(
>    SEXP G0,  // Groups ids (matrix of Nx2). First column = Group Id,
> second column: Elements in the group
>    SEXP L0,  // List of N two-column dataframes with different number of rows
>    SEXP TE0, // Treatment effect (int scalar): ATE(0) ATT(1) ATC(2)
>    SEXP T0   // Treat var (bool vector, 0/1, of size N)
> )
> {
>
>    int i, j, l, m;
>    const int *G = INTEGER_POINTER(PROTECT(G0 = AS_INTEGER(G0 )));
>    const int *T = INTEGER_POINTER(PROTECT(T0 = AS_INTEGER(T0 )));
>    const int *TE= INTEGER_POINTER(PROTECT(TE0= AS_INTEGER(TE0)));
>    double *L, val;
>    int *I, nlambdas, nreps;
>
>    const int n = length(T0);
>
>    PROTECT_INDEX pin0, pin1;
>    SEXP L1;
>    PROTECT(L1 = allocVector(VECSXP,n));
>    SEXP id, lambda;
>
>    // Fixing size
>    for(i=0;i<n;i++)
>    {
>      SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
>    //  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, NEW_INTEGER(100));
>    //  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, NEW_NUMERIC(100));
>    }
>
>    // For over the list, i.e observations
>    for(i=0;i<n;i++)
>    {
>
>      R_CheckUserInterrupt();
>
>      // Checking if has to be analyzed.
>      if (
>        ((TE[0] == 1 & !T[i]) | (TE[0] == 2 & T[i])) |
>        (length(VECTOR_ELT(L0,i)) != 2)
>      )
>      {
>        SET_VECTOR_ELT(L1,i,R_NilValue);
>        continue;
>      }
>
>      // Checking how many rows does the i-th data.frame has
>      nlambdas = length(VECTOR_ELT(VECTOR_ELT(L0,i),0));
>
>      // Pointing to the data.frame's origianl values
>      I = INTEGER_POINTER(AS_INTEGER(PROTECT(VECTOR_ELT(VECTOR_ELT(L0,i),0))));
>      L = NUMERIC_POINTER(AS_NUMERIC(PROTECT(VECTOR_ELT(VECTOR_ELT(L0,i),1))));
>
>      // Creating a copy of the pointed values
>      PROTECT_WITH_INDEX(id   = duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),0)), &pin0);
>      PROTECT_WITH_INDEX(lambda=duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),1)), &pin1);
>
>      // Over the rows of the i-th data.frame
>      nreps=0;
>      for(l=0;l<nlambdas;l++)
>      {
>        // If the current lambda id is repeated, ie ther are more individuals
>        // with the same covariates, then enter.
>        if (G[n+I[l]-1] > 1)
>        {
>          /* Changing the length of the object */
>          REPROTECT(SET_LENGTH(id,    length(lambda) + G[n+I[l]-1] -1), pin0);
>          REPROTECT(SET_LENGTH(lambda,length(lambda) + G[n+I[l]-1] -1), pin1);
>
>          // Getting the new value
>          val = L[l]/G[n+I[l] - 1];
>          REAL(lambda)[l] = val;
>
>          // Looping over the full set of groups
>          m = -1,j = -1;
>          while(m < (G[n+I[l]-1] - 1))
>          {
>            // Looking for individuals in the same group
>            if (G[++j] != G[I[l]-1]) continue;
>
>            // If it is the current lambda, then do not asign it
>            if (j == (I[l] - 1)) continue;
>
>            INTEGER(id)[length(id) - (G[n+I[l]-1] - 1) + ++m] = j+1;
>            REAL(lambda)[length(id) - (G[n+I[l]-1] - 1) + m] = val;
>          }
>
>          nreps+=1;
>        }
>      }
>
>      if (nreps)
>      {
>        // Replacing elements from of the list (modified)
>        SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>        SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>      }
>      else {
>        // Setting the list with the old elements
>        SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0,
>          duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),0)));
>        SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1,
>          duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),1)));
>      }
>
>      // Unprotecting elements
>      UNPROTECT(4);
>    }
>
>    Rprintf("Exito\n") ;
>    UNPROTECT(4);
>
>    return L1;
> }
>
> Thanks again in advanced.
>
> George Vega Yon
> +56 9 7 647 2552
> http://ggvega.cl
>
> 2013/11/5 George Vega Yon <g.vegayon at gmail.com>:
>> Either way, understanding that it may not be the best way of do it, is
>> there anything wrong in what I'm doing??
>> George Vega Yon
>> +56 9 7 647 2552
>> http://ggvega.cl
>>
>>
>> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>>> George,
>>>
>>> My point is you don't need to create them and then grow them....
>>>
>>>
>>> for(i=0;i<n;i++)
>>> {
>>>    // Creating the "id" and "lambda" vectors. I do this in every repetition
>>> of
>>>    // the loop.
>>>
>>>    // ... Some other instructions where I set the value of an integer
>>>    // z, which tells how much do the vectors have to grow ...
>>>
>>> PROTECT(id=allocVector(INTSXP, 4 +z));
>>> PROTECT(lambda=allocVector(REALSXP, 4 +z));
>>>
>>>
>>>    // ... some lines where I fill the vectors ...
>>>
>>>    // Storing the new vectors at the i-th element of the list
>>>    SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>    SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>
>>>    // Unprotecting the "id" and "lambda" vectors
>>>    UNPROTECT(2);
>>> }
>>>
>>> ~G
>>>
>>>
>>> On Tue, Nov 5, 2013 at 1:56 PM, George Vega Yon <g.vegayon at gmail.com> wrote:
>>>>
>>>> Gabriel,
>>>>
>>>> While the length (in terms of number of SEXP elements it stores) of L1
>>>> doesn't changes, the vectors within L1 do (sorry if I didn't explained
>>>> it well before).
>>>>
>>>> The post was about a SEXP object that grows, in my case, every pair of
>>>> vectors in L1 (id and lambda) can change lengths, this is why I need
>>>> to reprotect them. I populate the i-th element of L1 by creating the
>>>> vectors "id" and "lambda", setting the length of these according to
>>>> some rule (that's the part where lengths change)... here is a reduced
>>>> form of my code:
>>>>
>>>> //////////////////////////////////////// C
>>>> ////////////////////////////////////////
>>>> const int = length(L0);
>>>> SEXP L1;
>>>> PROTECT(L1 = allocVector(VECSXP,n));
>>>> SEXP id, lambda;
>>>>
>>>> // Fixing size
>>>> for(i=0;i<n;i++)
>>>>    SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
>>>>
>>>> for(i=0;i<n;i++)
>>>> {
>>>>    // Creating the "id" and "lambda" vectors. I do this in every repetition
>>>> of
>>>>    // the loop.
>>>>    PROTECT_WITH_INDEX(id=allocVector(INTSXP, 4), &ipx0);
>>>>    PROTECT_WITH_INDEX(lambda=allocVector(REALSXP, 4), &ipx1);
>>>>
>>>>    // ... Some other instructions where I set the value of an integer
>>>>    // z, which tells how much do the vectors have to grow ...
>>>>
>>>>    REPROTECT(SET_LENGTH(id,    length(lambda) + z), ipx0);
>>>>    REPROTECT(SET_LENGTH(lambda,length(lambda) + z), ipx1);
>>>>
>>>>    // ... some lines where I fill the vectors ...
>>>>
>>>>    // Storing the new vectors at the i-th element of the list
>>>>    SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>>    SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>>
>>>>    // Unprotecting the "id" and "lambda" vectors
>>>>    UNPROTECT(2);
>>>> }
>>>>
>>>> UNPROTECT(1);
>>>>
>>>> return L1;
>>>> //////////////////////////////////////// C
>>>> ////////////////////////////////////////
>>>>
>>>> I can't set the length from the start because every pair of vectors in
>>>> L1 have different lengths, lengths that I cannot tell before starting
>>>> the loop.
>>>>
>>>> Thanks for your help,
>>>>
>>>> Regards,
>>>>
>>>> George Vega Yon
>>>> +56 9 7 647 2552
>>>> http://ggvega.cl
>>>>
>>>>
>>>> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>>>>> George,
>>>>>
>>>>> I don't see the relevance of the stackoverflow post you linked. In the
>>>>> post,
>>>>> the author wanted to change the length of an existing "mother list"
>>>>> (matrix,
>>>>> etc), while you specifically state that the length of L1 will not
>>>>> change.
>>>>>
>>>>> You say that the child lists (vectors if they are INTSXP/REALSXP) are
>>>>> variable, but that is not what the linked post was about unless I am
>>>>> completely missing something.
>>>>>
>>>>> I can't really say more without knowing the details of how the vectors
>>>>> are
>>>>> being created and why they cannot just have the right length from the
>>>>> start.
>>>>>
>>>>> As for the error, that is a weird one. I imagine it means that a SEXP
>>>>> thinks
>>>>> that it has a type other than ones defined in Rinternals. I can't speak
>>>>> to
>>>>> how that could have happened from what you posted though.
>>>>>
>>>>> Sorry I can't be of more help,
>>>>> ~G
>>>>>
>>>>>
>>>>>
>>>>> On Mon, Nov 4, 2013 at 8:00 PM, George Vega Yon <g.vegayon at gmail.com>
>>>>> wrote:
>>>>>>
>>>>>> Dear R-devel,
>>>>>>
>>>>>> A couple of weeks ago I started to use the R C API for package
>>>>>> development. Without knowing much about C, I've been able to write
>>>>>> some routines sucessfully... until now.
>>>>>>
>>>>>> My problem consists in dynamically creating a list ("L1") of lists
>>>>>> using .Call, the tricky part is that each element of the "mother list"
>>>>>> contains two vectors (INTSXP and REALEXP types) with varying sizes;
>>>>>> sizes that I set while I'm looping over another list's ("L1") elements
>>>>>>   (input list). The steps I've follow are:
>>>>>>
>>>>>> FIRST: Create the "mother list" of size "n=length(L0)" (doesn't
>>>>>> change) and protect it as
>>>>>>    PROTECT(L1=allocVector(VECEXP, length(L0)))
>>>>>> and filling it with vectors of length two:
>>>>>>    for(i=0;i<n;i++) SET_VECTOR_ELT(L1,i, allocVector(VECSXP, 2));
>>>>>>
>>>>>> then, for each element of the mother list:
>>>>>>
>>>>>>    for(i=0;i<n;i++) {
>>>>>>
>>>>>> SECOND: By reading this post in Stackoverflow
>>>>>>
>>>>>>
>>>>>> http://stackoverflow.com/questions/7458364/growing-an-r-matrix-inside-a-c-loop/7458516#7458516
>>>>>> I understood that it was necesary to (1) create the "child lists" and
>>>>>> protecting them with PROTECT_WITH_INDEX, and (2) changing its size
>>>>>> using SETLENGTH (Rf_lengthgets) and REPROTECT ing the lists in order
>>>>>> to tell the GC that the vectors had change.
>>>>>>
>>>>>> THIRD: Once my two vectors are done ("id" and "lambda"), assign them
>>>>>> to the i-th element of the "mother list" L1 using
>>>>>>    SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, duplicate(id));
>>>>>>    SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, duplicate(lambda));
>>>>>>
>>>>>> and unprotecting the elements protected with index: UNPROTECT(2);
>>>>>>
>>>>>> }
>>>>>>
>>>>>> FOURTH: Unprotecting the "mother list" (L1) and return it to R
>>>>>>
>>>>>> With small datasets this works fine, but after trying with bigger ones
>>>>>> R (my code) keeps failing and returning a strange error that I haven't
>>>>>> been able to identify (or find in the web)
>>>>>>
>>>>>>    "unimplemented type (29) in 'duplicate'"
>>>>>>
>>>>>> This happens right after I try to use the returned list from my
>>>>>> routine (trying to print it or building a data-frame).
>>>>>>
>>>>>> Does anyone have an idea of what am I doing wrong?
>>>>>>
>>>>>> Best regards,
>>>>>>
>>>>>> PS: I didn't wanted to copy the entire function... but if you need it
>>>>>> I can do it.
>>>>>>
>>>>>> George Vega Yon
>>>>>> +56 9 7 647 2552
>>>>>> http://ggvega.cl
>>>>>>
>>>>>> ______________________________________________
>>>>>> R-devel at r-project.org mailing list
>>>>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>>>
>>>>>
>>>>>
>>>>>
>>>>> --
>>>>> Gabriel Becker
>>>>> Graduate Student
>>>>> Statistics Department
>>>>> University of California, Davis
>>>
>>>
>>>
>>>
>>> --
>>> Gabriel Becker
>>> Graduate Student
>>> Statistics Department
>>> University of California, Davis
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
>


-- 
Romain Francois
Professional R Enthusiast
+33(0) 6 28 91 30 30


From g.vegayon at gmail.com  Thu Nov  7 14:30:40 2013
From: g.vegayon at gmail.com (George Vega Yon)
Date: Thu, 7 Nov 2013 10:30:40 -0300
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'"
In-Reply-To: <527B92F3.7080706@r-enthusiasts.com>
References: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>
	<CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>
	<CAPJUxXWXFctds0veg3Ayy8bD3woWkA46Ss6JFWc_TFjRKDFTZA@mail.gmail.com>
	<CADwqtCPemzpwOjuhVgVmgeHq2zEkF1ViOOzUk6NXNaP3WYvVng@mail.gmail.com>
	<CAPJUxXUfJ5Q1yJOxOMmPLFHE93rj1BzCKZkzNJxVVn4+xt0Smg@mail.gmail.com>
	<CAPJUxXXF7103s06yh1BoHQbzv3Onkb1Ooj+AShZ=oykJnK=uig@mail.gmail.com>
	<527B92F3.7080706@r-enthusiasts.com>
Message-ID: <CAPJUxXW=ZEzcVUmMGctqHFQvdjXSd2X36H_LU4P4qZnju4HZUA@mail.gmail.com>

Romain,

Thanks for your quick response. I've already received that suggestion,
but, besides of haven't ever used C++, I wanted to understand first
what am I doing wrong. Still, would you give me a small example, in R
C++, of:

  - Creating a generic vector "L1" of size N
  - Creating a data.frame "D" and increasing its the number of rows of it
  - Storing the data.frame "D" in the first element of "L1"

I would be very gratefull if you can do that.

Thanks again!

George Vega Yon
+56 9 7 647 2552
http://ggvega.cl


2013/11/7 Romain Francois <romain at r-enthusiasts.com>:
> Hello,
>
> Any particular reason you're not using Rcpp? You would have access to nice
> abstraction instead of these MACROS all over the place.
>
> The cost of these abstractions is close to 0.
>
> Looping around and SET_LENGTH is going to be quite expensive. I would urge
> you to accumulate data in data structures that know how to grow efficiently,
> i.e. a std::vector and then convert that to an R vector when you're done
> with them.
>
> Romain
>
> Le 07/11/2013 14:03, George Vega Yon a ?crit :
>
>> Hi!
>>
>> I didn't wanted to do this but I think that this is the easiest way
>> for you to understand my problem (thanks again for all the comments
>> that you have made). Here is a copy of the function that I'm working
>> on. This may be tedious to analyze, so I understand if you don't feel
>> keen to give it a time. Having dedicated many hours to this (as a new
>> user of both C and R C API), I would be very pleased to know what am I
>> doing wrong here.
>>
>> G0 is a Nx2 matrix. The first column is a group id (can be shared with
>> several observations) and the second tells how many individuals are in
>> that group. This matrix can look something like this:
>>
>> id_group  nreps
>> 1  3
>> 1  3
>> 1  3
>> 2  1
>> 3  1
>> 4  2
>> 5  1
>> 6  1
>> 4  2
>> ...
>>
>> L0 is list of two column data.frames with different sizes. The first
>> column (id) are row indexes (with values 1 to N) and the second column
>> are real numbers. L0 can look something like this
>> [[1]]
>> id  lambda
>> 3  0.5
>> 15  0.3
>> 25  0.2
>> [[2]]
>> id  lambda
>> 15  0.8
>> 40  0.2
>> ...
>> [[N]]
>> id  lambda
>> 80  1
>>
>> TE0 is a int scalar in {0,1,2}
>>
>> T0 is a dichotomous vector of length N that can look something like this
>> [1] 0 1 0 1 1 1 0 ...
>> [N] 1
>>
>> L1 (the expected output) is a modified version of L0, that, for
>> instance can look something like this (note the rows marked with "*")
>>
>> [[1]]
>> id  lambda
>> 3  0.5
>> *15  0.15 (15 was in the same group of 50, so I added this new row and
>> divided the value of lambda by two)
>> 25  0.2
>> *50  0.15
>> [[2]]
>> id  lambda
>> 15  0.8
>> 40  0.2
>> ...
>> [[N]]
>> id  lambda
>> *80  0.333 (80 shared group id with 30 and 100, so lambda is divided by 3)
>> *30  0.333
>> *100 0.333
>>
>> That said, the function is as follows
>>
>> SEXP distribute_lambdas(
>>    SEXP G0,  // Groups ids (matrix of Nx2). First column = Group Id,
>> second column: Elements in the group
>>    SEXP L0,  // List of N two-column dataframes with different number of
>> rows
>>    SEXP TE0, // Treatment effect (int scalar): ATE(0) ATT(1) ATC(2)
>>    SEXP T0   // Treat var (bool vector, 0/1, of size N)
>> )
>> {
>>
>>    int i, j, l, m;
>>    const int *G = INTEGER_POINTER(PROTECT(G0 = AS_INTEGER(G0 )));
>>    const int *T = INTEGER_POINTER(PROTECT(T0 = AS_INTEGER(T0 )));
>>    const int *TE= INTEGER_POINTER(PROTECT(TE0= AS_INTEGER(TE0)));
>>    double *L, val;
>>    int *I, nlambdas, nreps;
>>
>>    const int n = length(T0);
>>
>>    PROTECT_INDEX pin0, pin1;
>>    SEXP L1;
>>    PROTECT(L1 = allocVector(VECSXP,n));
>>    SEXP id, lambda;
>>
>>    // Fixing size
>>    for(i=0;i<n;i++)
>>    {
>>      SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
>>    //  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, NEW_INTEGER(100));
>>    //  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, NEW_NUMERIC(100));
>>    }
>>
>>    // For over the list, i.e observations
>>    for(i=0;i<n;i++)
>>    {
>>
>>      R_CheckUserInterrupt();
>>
>>      // Checking if has to be analyzed.
>>      if (
>>        ((TE[0] == 1 & !T[i]) | (TE[0] == 2 & T[i])) |
>>        (length(VECTOR_ELT(L0,i)) != 2)
>>      )
>>      {
>>        SET_VECTOR_ELT(L1,i,R_NilValue);
>>        continue;
>>      }
>>
>>      // Checking how many rows does the i-th data.frame has
>>      nlambdas = length(VECTOR_ELT(VECTOR_ELT(L0,i),0));
>>
>>      // Pointing to the data.frame's origianl values
>>      I =
>> INTEGER_POINTER(AS_INTEGER(PROTECT(VECTOR_ELT(VECTOR_ELT(L0,i),0))));
>>      L =
>> NUMERIC_POINTER(AS_NUMERIC(PROTECT(VECTOR_ELT(VECTOR_ELT(L0,i),1))));
>>
>>      // Creating a copy of the pointed values
>>      PROTECT_WITH_INDEX(id   = duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),0)),
>> &pin0);
>>      PROTECT_WITH_INDEX(lambda=duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),1)),
>> &pin1);
>>
>>      // Over the rows of the i-th data.frame
>>      nreps=0;
>>      for(l=0;l<nlambdas;l++)
>>      {
>>        // If the current lambda id is repeated, ie ther are more
>> individuals
>>        // with the same covariates, then enter.
>>        if (G[n+I[l]-1] > 1)
>>        {
>>          /* Changing the length of the object */
>>          REPROTECT(SET_LENGTH(id,    length(lambda) + G[n+I[l]-1] -1),
>> pin0);
>>          REPROTECT(SET_LENGTH(lambda,length(lambda) + G[n+I[l]-1] -1),
>> pin1);
>>
>>          // Getting the new value
>>          val = L[l]/G[n+I[l] - 1];
>>          REAL(lambda)[l] = val;
>>
>>          // Looping over the full set of groups
>>          m = -1,j = -1;
>>          while(m < (G[n+I[l]-1] - 1))
>>          {
>>            // Looking for individuals in the same group
>>            if (G[++j] != G[I[l]-1]) continue;
>>
>>            // If it is the current lambda, then do not asign it
>>            if (j == (I[l] - 1)) continue;
>>
>>            INTEGER(id)[length(id) - (G[n+I[l]-1] - 1) + ++m] = j+1;
>>            REAL(lambda)[length(id) - (G[n+I[l]-1] - 1) + m] = val;
>>          }
>>
>>          nreps+=1;
>>        }
>>      }
>>
>>      if (nreps)
>>      {
>>        // Replacing elements from of the list (modified)
>>        SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>        SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>      }
>>      else {
>>        // Setting the list with the old elements
>>        SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0,
>>          duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),0)));
>>        SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1,
>>          duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),1)));
>>      }
>>
>>      // Unprotecting elements
>>      UNPROTECT(4);
>>    }
>>
>>    Rprintf("Exito\n") ;
>>    UNPROTECT(4);
>>
>>    return L1;
>> }
>>
>> Thanks again in advanced.
>>
>> George Vega Yon
>> +56 9 7 647 2552
>> http://ggvega.cl
>>
>> 2013/11/5 George Vega Yon <g.vegayon at gmail.com>:
>>>
>>> Either way, understanding that it may not be the best way of do it, is
>>> there anything wrong in what I'm doing??
>>> George Vega Yon
>>> +56 9 7 647 2552
>>> http://ggvega.cl
>>>
>>>
>>> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>>>>
>>>> George,
>>>>
>>>> My point is you don't need to create them and then grow them....
>>>>
>>>>
>>>> for(i=0;i<n;i++)
>>>> {
>>>>    // Creating the "id" and "lambda" vectors. I do this in every
>>>> repetition
>>>> of
>>>>    // the loop.
>>>>
>>>>    // ... Some other instructions where I set the value of an integer
>>>>    // z, which tells how much do the vectors have to grow ...
>>>>
>>>> PROTECT(id=allocVector(INTSXP, 4 +z));
>>>> PROTECT(lambda=allocVector(REALSXP, 4 +z));
>>>>
>>>>
>>>>    // ... some lines where I fill the vectors ...
>>>>
>>>>    // Storing the new vectors at the i-th element of the list
>>>>    SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>>    SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>>
>>>>    // Unprotecting the "id" and "lambda" vectors
>>>>    UNPROTECT(2);
>>>> }
>>>>
>>>> ~G
>>>>
>>>>
>>>> On Tue, Nov 5, 2013 at 1:56 PM, George Vega Yon <g.vegayon at gmail.com>
>>>> wrote:
>>>>>
>>>>>
>>>>> Gabriel,
>>>>>
>>>>> While the length (in terms of number of SEXP elements it stores) of L1
>>>>> doesn't changes, the vectors within L1 do (sorry if I didn't explained
>>>>> it well before).
>>>>>
>>>>> The post was about a SEXP object that grows, in my case, every pair of
>>>>> vectors in L1 (id and lambda) can change lengths, this is why I need
>>>>> to reprotect them. I populate the i-th element of L1 by creating the
>>>>> vectors "id" and "lambda", setting the length of these according to
>>>>> some rule (that's the part where lengths change)... here is a reduced
>>>>> form of my code:
>>>>>
>>>>> //////////////////////////////////////// C
>>>>> ////////////////////////////////////////
>>>>> const int = length(L0);
>>>>> SEXP L1;
>>>>> PROTECT(L1 = allocVector(VECSXP,n));
>>>>> SEXP id, lambda;
>>>>>
>>>>> // Fixing size
>>>>> for(i=0;i<n;i++)
>>>>>    SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
>>>>>
>>>>> for(i=0;i<n;i++)
>>>>> {
>>>>>    // Creating the "id" and "lambda" vectors. I do this in every
>>>>> repetition
>>>>> of
>>>>>    // the loop.
>>>>>    PROTECT_WITH_INDEX(id=allocVector(INTSXP, 4), &ipx0);
>>>>>    PROTECT_WITH_INDEX(lambda=allocVector(REALSXP, 4), &ipx1);
>>>>>
>>>>>    // ... Some other instructions where I set the value of an integer
>>>>>    // z, which tells how much do the vectors have to grow ...
>>>>>
>>>>>    REPROTECT(SET_LENGTH(id,    length(lambda) + z), ipx0);
>>>>>    REPROTECT(SET_LENGTH(lambda,length(lambda) + z), ipx1);
>>>>>
>>>>>    // ... some lines where I fill the vectors ...
>>>>>
>>>>>    // Storing the new vectors at the i-th element of the list
>>>>>    SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>>>    SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>>>
>>>>>    // Unprotecting the "id" and "lambda" vectors
>>>>>    UNPROTECT(2);
>>>>> }
>>>>>
>>>>> UNPROTECT(1);
>>>>>
>>>>> return L1;
>>>>> //////////////////////////////////////// C
>>>>> ////////////////////////////////////////
>>>>>
>>>>> I can't set the length from the start because every pair of vectors in
>>>>> L1 have different lengths, lengths that I cannot tell before starting
>>>>> the loop.
>>>>>
>>>>> Thanks for your help,
>>>>>
>>>>> Regards,
>>>>>
>>>>> George Vega Yon
>>>>> +56 9 7 647 2552
>>>>> http://ggvega.cl
>>>>>
>>>>>
>>>>> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>>>>>>
>>>>>> George,
>>>>>>
>>>>>> I don't see the relevance of the stackoverflow post you linked. In the
>>>>>> post,
>>>>>> the author wanted to change the length of an existing "mother list"
>>>>>> (matrix,
>>>>>> etc), while you specifically state that the length of L1 will not
>>>>>> change.
>>>>>>
>>>>>> You say that the child lists (vectors if they are INTSXP/REALSXP) are
>>>>>> variable, but that is not what the linked post was about unless I am
>>>>>> completely missing something.
>>>>>>
>>>>>> I can't really say more without knowing the details of how the vectors
>>>>>> are
>>>>>> being created and why they cannot just have the right length from the
>>>>>> start.
>>>>>>
>>>>>> As for the error, that is a weird one. I imagine it means that a SEXP
>>>>>> thinks
>>>>>> that it has a type other than ones defined in Rinternals. I can't
>>>>>> speak
>>>>>> to
>>>>>> how that could have happened from what you posted though.
>>>>>>
>>>>>> Sorry I can't be of more help,
>>>>>> ~G
>>>>>>
>>>>>>
>>>>>>
>>>>>> On Mon, Nov 4, 2013 at 8:00 PM, George Vega Yon <g.vegayon at gmail.com>
>>>>>> wrote:
>>>>>>>
>>>>>>>
>>>>>>> Dear R-devel,
>>>>>>>
>>>>>>> A couple of weeks ago I started to use the R C API for package
>>>>>>> development. Without knowing much about C, I've been able to write
>>>>>>> some routines sucessfully... until now.
>>>>>>>
>>>>>>> My problem consists in dynamically creating a list ("L1") of lists
>>>>>>> using .Call, the tricky part is that each element of the "mother
>>>>>>> list"
>>>>>>> contains two vectors (INTSXP and REALEXP types) with varying sizes;
>>>>>>> sizes that I set while I'm looping over another list's ("L1")
>>>>>>> elements
>>>>>>>   (input list). The steps I've follow are:
>>>>>>>
>>>>>>> FIRST: Create the "mother list" of size "n=length(L0)" (doesn't
>>>>>>> change) and protect it as
>>>>>>>    PROTECT(L1=allocVector(VECEXP, length(L0)))
>>>>>>> and filling it with vectors of length two:
>>>>>>>    for(i=0;i<n;i++) SET_VECTOR_ELT(L1,i, allocVector(VECSXP, 2));
>>>>>>>
>>>>>>> then, for each element of the mother list:
>>>>>>>
>>>>>>>    for(i=0;i<n;i++) {
>>>>>>>
>>>>>>> SECOND: By reading this post in Stackoverflow
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>> http://stackoverflow.com/questions/7458364/growing-an-r-matrix-inside-a-c-loop/7458516#7458516
>>>>>>> I understood that it was necesary to (1) create the "child lists" and
>>>>>>> protecting them with PROTECT_WITH_INDEX, and (2) changing its size
>>>>>>> using SETLENGTH (Rf_lengthgets) and REPROTECT ing the lists in order
>>>>>>> to tell the GC that the vectors had change.
>>>>>>>
>>>>>>> THIRD: Once my two vectors are done ("id" and "lambda"), assign them
>>>>>>> to the i-th element of the "mother list" L1 using
>>>>>>>    SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, duplicate(id));
>>>>>>>    SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, duplicate(lambda));
>>>>>>>
>>>>>>> and unprotecting the elements protected with index: UNPROTECT(2);
>>>>>>>
>>>>>>> }
>>>>>>>
>>>>>>> FOURTH: Unprotecting the "mother list" (L1) and return it to R
>>>>>>>
>>>>>>> With small datasets this works fine, but after trying with bigger
>>>>>>> ones
>>>>>>> R (my code) keeps failing and returning a strange error that I
>>>>>>> haven't
>>>>>>> been able to identify (or find in the web)
>>>>>>>
>>>>>>>    "unimplemented type (29) in 'duplicate'"
>>>>>>>
>>>>>>> This happens right after I try to use the returned list from my
>>>>>>> routine (trying to print it or building a data-frame).
>>>>>>>
>>>>>>> Does anyone have an idea of what am I doing wrong?
>>>>>>>
>>>>>>> Best regards,
>>>>>>>
>>>>>>> PS: I didn't wanted to copy the entire function... but if you need it
>>>>>>> I can do it.
>>>>>>>
>>>>>>> George Vega Yon
>>>>>>> +56 9 7 647 2552
>>>>>>> http://ggvega.cl
>>>>>>>
>>>>>>> ______________________________________________
>>>>>>> R-devel at r-project.org mailing list
>>>>>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>>>>
>>>>>>
>>>>>>
>>>>>>
>>>>>>
>>>>>> --
>>>>>> Gabriel Becker
>>>>>> Graduate Student
>>>>>> Statistics Department
>>>>>> University of California, Davis
>>>>
>>>>
>>>>
>>>>
>>>>
>>>> --
>>>> Gabriel Becker
>>>> Graduate Student
>>>> Statistics Department
>>>> University of California, Davis
>>
>>
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>
>
>
> --
> Romain Francois
> Professional R Enthusiast
> +33(0) 6 28 91 30 30
>
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


From romain at r-enthusiasts.com  Thu Nov  7 14:43:48 2013
From: romain at r-enthusiasts.com (Romain Francois)
Date: Thu, 07 Nov 2013 14:43:48 +0100
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'"
In-Reply-To: <CAPJUxXW=ZEzcVUmMGctqHFQvdjXSd2X36H_LU4P4qZnju4HZUA@mail.gmail.com>
References: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>
	<CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>
	<CAPJUxXWXFctds0veg3Ayy8bD3woWkA46Ss6JFWc_TFjRKDFTZA@mail.gmail.com>
	<CADwqtCPemzpwOjuhVgVmgeHq2zEkF1ViOOzUk6NXNaP3WYvVng@mail.gmail.com>
	<CAPJUxXUfJ5Q1yJOxOMmPLFHE93rj1BzCKZkzNJxVVn4+xt0Smg@mail.gmail.com>
	<CAPJUxXXF7103s06yh1BoHQbzv3Onkb1Ooj+AShZ=oykJnK=uig@mail.gmail.com>
	<527B92F3.7080706@r-enthusiasts.com>
	<CAPJUxXW=ZEzcVUmMGctqHFQvdjXSd2X36H_LU4P4qZnju4HZUA@mail.gmail.com>
Message-ID: <527B9914.7060206@r-enthusiasts.com>

Le 07/11/2013 14:30, George Vega Yon a ?crit :
> Romain,
>
> Thanks for your quick response. I've already received that suggestion,
> but, besides of haven't ever used C++, I wanted to understand first
> what am I doing wrong.

For that type of code, it is actually quite simpler to learn c++ than it 
is to learn the macros and loose typing of the R interface.

> Still, would you give me a small example, in R
> C++, of:
>
>    - Creating a generic vector "L1" of size N
>    - Creating a data.frame "D" and increasing its the number of rows of it
>    - Storing the data.frame "D" in the first element of "L1"
>
> I would be very gratefull if you can do that.

#include <Rcpp.h>
using namespace Rcpp ;

// [[Rcpp::export]]
List example(int N){
     List out(N) ;

     // let's first accumulate data in these two std::vector
     std::vector<double> x ;
     std::vector<int> y ;
     for( int i=0; i<30; i++){
         x.push_back( sqrt( i ) ) ;
         y.push_back( i ) ;
     }

     // Now let's create a data frame
     DataFrame df = DataFrame::create(
         _["x"] = x,
         _["y"] = y
         ) ;

     // storing df as the first element of out
     out[0] = df ;

     return out ;
}

You can also do it like this acknowleding what a data frame really is 
(just a list of vectors):

     List df = List::create(
         _["x"] = x,
         _["y"] = y
         ) ;
     df.attr( "class" ) = "data.frame" ;
     df.attr( "row.names") = IntegerVector::create(
         IntegerVector::get_na(), -30 ) ;


The key thing here is that we accumulate data into std::vector<double> 
and std::vector<int> which know how to grow efficiently. Looping around 
with SET_LENGTH will allocate and copy data at each iteration of the 
loop which will lead to disastrous performance.

Romain

> Thanks again!
>
> George Vega Yon
> +56 9 7 647 2552
> http://ggvega.cl
>
>
> 2013/11/7 Romain Francois <romain at r-enthusiasts.com>:
>> Hello,
>>
>> Any particular reason you're not using Rcpp? You would have access to nice
>> abstraction instead of these MACROS all over the place.
>>
>> The cost of these abstractions is close to 0.
>>
>> Looping around and SET_LENGTH is going to be quite expensive. I would urge
>> you to accumulate data in data structures that know how to grow efficiently,
>> i.e. a std::vector and then convert that to an R vector when you're done
>> with them.
>>
>> Romain
>>
>> Le 07/11/2013 14:03, George Vega Yon a ?crit :
>>
>>> Hi!
>>>
>>> I didn't wanted to do this but I think that this is the easiest way
>>> for you to understand my problem (thanks again for all the comments
>>> that you have made). Here is a copy of the function that I'm working
>>> on. This may be tedious to analyze, so I understand if you don't feel
>>> keen to give it a time. Having dedicated many hours to this (as a new
>>> user of both C and R C API), I would be very pleased to know what am I
>>> doing wrong here.
>>>
>>> G0 is a Nx2 matrix. The first column is a group id (can be shared with
>>> several observations) and the second tells how many individuals are in
>>> that group. This matrix can look something like this:
>>>
>>> id_group  nreps
>>> 1  3
>>> 1  3
>>> 1  3
>>> 2  1
>>> 3  1
>>> 4  2
>>> 5  1
>>> 6  1
>>> 4  2
>>> ...
>>>
>>> L0 is list of two column data.frames with different sizes. The first
>>> column (id) are row indexes (with values 1 to N) and the second column
>>> are real numbers. L0 can look something like this
>>> [[1]]
>>> id  lambda
>>> 3  0.5
>>> 15  0.3
>>> 25  0.2
>>> [[2]]
>>> id  lambda
>>> 15  0.8
>>> 40  0.2
>>> ...
>>> [[N]]
>>> id  lambda
>>> 80  1
>>>
>>> TE0 is a int scalar in {0,1,2}
>>>
>>> T0 is a dichotomous vector of length N that can look something like this
>>> [1] 0 1 0 1 1 1 0 ...
>>> [N] 1
>>>
>>> L1 (the expected output) is a modified version of L0, that, for
>>> instance can look something like this (note the rows marked with "*")
>>>
>>> [[1]]
>>> id  lambda
>>> 3  0.5
>>> *15  0.15 (15 was in the same group of 50, so I added this new row and
>>> divided the value of lambda by two)
>>> 25  0.2
>>> *50  0.15
>>> [[2]]
>>> id  lambda
>>> 15  0.8
>>> 40  0.2
>>> ...
>>> [[N]]
>>> id  lambda
>>> *80  0.333 (80 shared group id with 30 and 100, so lambda is divided by 3)
>>> *30  0.333
>>> *100 0.333
>>>
>>> That said, the function is as follows
>>>
>>> SEXP distribute_lambdas(
>>>     SEXP G0,  // Groups ids (matrix of Nx2). First column = Group Id,
>>> second column: Elements in the group
>>>     SEXP L0,  // List of N two-column dataframes with different number of
>>> rows
>>>     SEXP TE0, // Treatment effect (int scalar): ATE(0) ATT(1) ATC(2)
>>>     SEXP T0   // Treat var (bool vector, 0/1, of size N)
>>> )
>>> {
>>>
>>>     int i, j, l, m;
>>>     const int *G = INTEGER_POINTER(PROTECT(G0 = AS_INTEGER(G0 )));
>>>     const int *T = INTEGER_POINTER(PROTECT(T0 = AS_INTEGER(T0 )));
>>>     const int *TE= INTEGER_POINTER(PROTECT(TE0= AS_INTEGER(TE0)));
>>>     double *L, val;
>>>     int *I, nlambdas, nreps;
>>>
>>>     const int n = length(T0);
>>>
>>>     PROTECT_INDEX pin0, pin1;
>>>     SEXP L1;
>>>     PROTECT(L1 = allocVector(VECSXP,n));
>>>     SEXP id, lambda;
>>>
>>>     // Fixing size
>>>     for(i=0;i<n;i++)
>>>     {
>>>       SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
>>>     //  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, NEW_INTEGER(100));
>>>     //  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, NEW_NUMERIC(100));
>>>     }
>>>
>>>     // For over the list, i.e observations
>>>     for(i=0;i<n;i++)
>>>     {
>>>
>>>       R_CheckUserInterrupt();
>>>
>>>       // Checking if has to be analyzed.
>>>       if (
>>>         ((TE[0] == 1 & !T[i]) | (TE[0] == 2 & T[i])) |
>>>         (length(VECTOR_ELT(L0,i)) != 2)
>>>       )
>>>       {
>>>         SET_VECTOR_ELT(L1,i,R_NilValue);
>>>         continue;
>>>       }
>>>
>>>       // Checking how many rows does the i-th data.frame has
>>>       nlambdas = length(VECTOR_ELT(VECTOR_ELT(L0,i),0));
>>>
>>>       // Pointing to the data.frame's origianl values
>>>       I =
>>> INTEGER_POINTER(AS_INTEGER(PROTECT(VECTOR_ELT(VECTOR_ELT(L0,i),0))));
>>>       L =
>>> NUMERIC_POINTER(AS_NUMERIC(PROTECT(VECTOR_ELT(VECTOR_ELT(L0,i),1))));
>>>
>>>       // Creating a copy of the pointed values
>>>       PROTECT_WITH_INDEX(id   = duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),0)),
>>> &pin0);
>>>       PROTECT_WITH_INDEX(lambda=duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),1)),
>>> &pin1);
>>>
>>>       // Over the rows of the i-th data.frame
>>>       nreps=0;
>>>       for(l=0;l<nlambdas;l++)
>>>       {
>>>         // If the current lambda id is repeated, ie ther are more
>>> individuals
>>>         // with the same covariates, then enter.
>>>         if (G[n+I[l]-1] > 1)
>>>         {
>>>           /* Changing the length of the object */
>>>           REPROTECT(SET_LENGTH(id,    length(lambda) + G[n+I[l]-1] -1),
>>> pin0);
>>>           REPROTECT(SET_LENGTH(lambda,length(lambda) + G[n+I[l]-1] -1),
>>> pin1);
>>>
>>>           // Getting the new value
>>>           val = L[l]/G[n+I[l] - 1];
>>>           REAL(lambda)[l] = val;
>>>
>>>           // Looping over the full set of groups
>>>           m = -1,j = -1;
>>>           while(m < (G[n+I[l]-1] - 1))
>>>           {
>>>             // Looking for individuals in the same group
>>>             if (G[++j] != G[I[l]-1]) continue;
>>>
>>>             // If it is the current lambda, then do not asign it
>>>             if (j == (I[l] - 1)) continue;
>>>
>>>             INTEGER(id)[length(id) - (G[n+I[l]-1] - 1) + ++m] = j+1;
>>>             REAL(lambda)[length(id) - (G[n+I[l]-1] - 1) + m] = val;
>>>           }
>>>
>>>           nreps+=1;
>>>         }
>>>       }
>>>
>>>       if (nreps)
>>>       {
>>>         // Replacing elements from of the list (modified)
>>>         SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>         SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>       }
>>>       else {
>>>         // Setting the list with the old elements
>>>         SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0,
>>>           duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),0)));
>>>         SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1,
>>>           duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),1)));
>>>       }
>>>
>>>       // Unprotecting elements
>>>       UNPROTECT(4);
>>>     }
>>>
>>>     Rprintf("Exito\n") ;
>>>     UNPROTECT(4);
>>>
>>>     return L1;
>>> }
>>>
>>> Thanks again in advanced.
>>>
>>> George Vega Yon
>>> +56 9 7 647 2552
>>> http://ggvega.cl
>>>
>>> 2013/11/5 George Vega Yon <g.vegayon at gmail.com>:
>>>>
>>>> Either way, understanding that it may not be the best way of do it, is
>>>> there anything wrong in what I'm doing??
>>>> George Vega Yon
>>>> +56 9 7 647 2552
>>>> http://ggvega.cl
>>>>
>>>>
>>>> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>>>>>
>>>>> George,
>>>>>
>>>>> My point is you don't need to create them and then grow them....
>>>>>
>>>>>
>>>>> for(i=0;i<n;i++)
>>>>> {
>>>>>     // Creating the "id" and "lambda" vectors. I do this in every
>>>>> repetition
>>>>> of
>>>>>     // the loop.
>>>>>
>>>>>     // ... Some other instructions where I set the value of an integer
>>>>>     // z, which tells how much do the vectors have to grow ...
>>>>>
>>>>> PROTECT(id=allocVector(INTSXP, 4 +z));
>>>>> PROTECT(lambda=allocVector(REALSXP, 4 +z));
>>>>>
>>>>>
>>>>>     // ... some lines where I fill the vectors ...
>>>>>
>>>>>     // Storing the new vectors at the i-th element of the list
>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>>>
>>>>>     // Unprotecting the "id" and "lambda" vectors
>>>>>     UNPROTECT(2);
>>>>> }
>>>>>
>>>>> ~G
>>>>>
>>>>>
>>>>> On Tue, Nov 5, 2013 at 1:56 PM, George Vega Yon <g.vegayon at gmail.com>
>>>>> wrote:
>>>>>>
>>>>>>
>>>>>> Gabriel,
>>>>>>
>>>>>> While the length (in terms of number of SEXP elements it stores) of L1
>>>>>> doesn't changes, the vectors within L1 do (sorry if I didn't explained
>>>>>> it well before).
>>>>>>
>>>>>> The post was about a SEXP object that grows, in my case, every pair of
>>>>>> vectors in L1 (id and lambda) can change lengths, this is why I need
>>>>>> to reprotect them. I populate the i-th element of L1 by creating the
>>>>>> vectors "id" and "lambda", setting the length of these according to
>>>>>> some rule (that's the part where lengths change)... here is a reduced
>>>>>> form of my code:
>>>>>>
>>>>>> //////////////////////////////////////// C
>>>>>> ////////////////////////////////////////
>>>>>> const int = length(L0);
>>>>>> SEXP L1;
>>>>>> PROTECT(L1 = allocVector(VECSXP,n));
>>>>>> SEXP id, lambda;
>>>>>>
>>>>>> // Fixing size
>>>>>> for(i=0;i<n;i++)
>>>>>>     SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
>>>>>>
>>>>>> for(i=0;i<n;i++)
>>>>>> {
>>>>>>     // Creating the "id" and "lambda" vectors. I do this in every
>>>>>> repetition
>>>>>> of
>>>>>>     // the loop.
>>>>>>     PROTECT_WITH_INDEX(id=allocVector(INTSXP, 4), &ipx0);
>>>>>>     PROTECT_WITH_INDEX(lambda=allocVector(REALSXP, 4), &ipx1);
>>>>>>
>>>>>>     // ... Some other instructions where I set the value of an integer
>>>>>>     // z, which tells how much do the vectors have to grow ...
>>>>>>
>>>>>>     REPROTECT(SET_LENGTH(id,    length(lambda) + z), ipx0);
>>>>>>     REPROTECT(SET_LENGTH(lambda,length(lambda) + z), ipx1);
>>>>>>
>>>>>>     // ... some lines where I fill the vectors ...
>>>>>>
>>>>>>     // Storing the new vectors at the i-th element of the list
>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>>>>
>>>>>>     // Unprotecting the "id" and "lambda" vectors
>>>>>>     UNPROTECT(2);
>>>>>> }
>>>>>>
>>>>>> UNPROTECT(1);
>>>>>>
>>>>>> return L1;
>>>>>> //////////////////////////////////////// C
>>>>>> ////////////////////////////////////////
>>>>>>
>>>>>> I can't set the length from the start because every pair of vectors in
>>>>>> L1 have different lengths, lengths that I cannot tell before starting
>>>>>> the loop.
>>>>>>
>>>>>> Thanks for your help,
>>>>>>
>>>>>> Regards,
>>>>>>
>>>>>> George Vega Yon
>>>>>> +56 9 7 647 2552
>>>>>> http://ggvega.cl
>>>>>>
>>>>>>
>>>>>> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>>>>>>>
>>>>>>> George,
>>>>>>>
>>>>>>> I don't see the relevance of the stackoverflow post you linked. In the
>>>>>>> post,
>>>>>>> the author wanted to change the length of an existing "mother list"
>>>>>>> (matrix,
>>>>>>> etc), while you specifically state that the length of L1 will not
>>>>>>> change.
>>>>>>>
>>>>>>> You say that the child lists (vectors if they are INTSXP/REALSXP) are
>>>>>>> variable, but that is not what the linked post was about unless I am
>>>>>>> completely missing something.
>>>>>>>
>>>>>>> I can't really say more without knowing the details of how the vectors
>>>>>>> are
>>>>>>> being created and why they cannot just have the right length from the
>>>>>>> start.
>>>>>>>
>>>>>>> As for the error, that is a weird one. I imagine it means that a SEXP
>>>>>>> thinks
>>>>>>> that it has a type other than ones defined in Rinternals. I can't
>>>>>>> speak
>>>>>>> to
>>>>>>> how that could have happened from what you posted though.
>>>>>>>
>>>>>>> Sorry I can't be of more help,
>>>>>>> ~G
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>> On Mon, Nov 4, 2013 at 8:00 PM, George Vega Yon <g.vegayon at gmail.com>
>>>>>>> wrote:
>>>>>>>>
>>>>>>>>
>>>>>>>> Dear R-devel,
>>>>>>>>
>>>>>>>> A couple of weeks ago I started to use the R C API for package
>>>>>>>> development. Without knowing much about C, I've been able to write
>>>>>>>> some routines sucessfully... until now.
>>>>>>>>
>>>>>>>> My problem consists in dynamically creating a list ("L1") of lists
>>>>>>>> using .Call, the tricky part is that each element of the "mother
>>>>>>>> list"
>>>>>>>> contains two vectors (INTSXP and REALEXP types) with varying sizes;
>>>>>>>> sizes that I set while I'm looping over another list's ("L1")
>>>>>>>> elements
>>>>>>>>    (input list). The steps I've follow are:
>>>>>>>>
>>>>>>>> FIRST: Create the "mother list" of size "n=length(L0)" (doesn't
>>>>>>>> change) and protect it as
>>>>>>>>     PROTECT(L1=allocVector(VECEXP, length(L0)))
>>>>>>>> and filling it with vectors of length two:
>>>>>>>>     for(i=0;i<n;i++) SET_VECTOR_ELT(L1,i, allocVector(VECSXP, 2));
>>>>>>>>
>>>>>>>> then, for each element of the mother list:
>>>>>>>>
>>>>>>>>     for(i=0;i<n;i++) {
>>>>>>>>
>>>>>>>> SECOND: By reading this post in Stackoverflow
>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>> http://stackoverflow.com/questions/7458364/growing-an-r-matrix-inside-a-c-loop/7458516#7458516
>>>>>>>> I understood that it was necesary to (1) create the "child lists" and
>>>>>>>> protecting them with PROTECT_WITH_INDEX, and (2) changing its size
>>>>>>>> using SETLENGTH (Rf_lengthgets) and REPROTECT ing the lists in order
>>>>>>>> to tell the GC that the vectors had change.
>>>>>>>>
>>>>>>>> THIRD: Once my two vectors are done ("id" and "lambda"), assign them
>>>>>>>> to the i-th element of the "mother list" L1 using
>>>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, duplicate(id));
>>>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, duplicate(lambda));
>>>>>>>>
>>>>>>>> and unprotecting the elements protected with index: UNPROTECT(2);
>>>>>>>>
>>>>>>>> }
>>>>>>>>
>>>>>>>> FOURTH: Unprotecting the "mother list" (L1) and return it to R
>>>>>>>>
>>>>>>>> With small datasets this works fine, but after trying with bigger
>>>>>>>> ones
>>>>>>>> R (my code) keeps failing and returning a strange error that I
>>>>>>>> haven't
>>>>>>>> been able to identify (or find in the web)
>>>>>>>>
>>>>>>>>     "unimplemented type (29) in 'duplicate'"
>>>>>>>>
>>>>>>>> This happens right after I try to use the returned list from my
>>>>>>>> routine (trying to print it or building a data-frame).
>>>>>>>>
>>>>>>>> Does anyone have an idea of what am I doing wrong?
>>>>>>>>
>>>>>>>> Best regards,
>>>>>>>>
>>>>>>>> PS: I didn't wanted to copy the entire function... but if you need it
>>>>>>>> I can do it.
>>>>>>>>
>>>>>>>> George Vega Yon
>>>>>>>> +56 9 7 647 2552
>>>>>>>> http://ggvega.cl
>>>>>>>>
>>>>>>>> ______________________________________________
>>>>>>>> R-devel at r-project.org mailing list
>>>>>>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>> --
>>>>>>> Gabriel Becker
>>>>>>> Graduate Student
>>>>>>> Statistics Department
>>>>>>> University of California, Davis
>>>>>
>>>>>
>>>>>
>>>>>
>>>>>
>>>>> --
>>>>> Gabriel Becker
>>>>> Graduate Student
>>>>> Statistics Department
>>>>> University of California, Davis
>>>
>>>
>>> ______________________________________________
>>> R-devel at r-project.org mailing list
>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>
>>
>>
>> --
>> Romain Francois
>> Professional R Enthusiast
>> +33(0) 6 28 91 30 30
>>
>>
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel
>


-- 
Romain Francois
Professional R Enthusiast
+33(0) 6 28 91 30 30


From romain at r-enthusiasts.com  Thu Nov  7 15:46:30 2013
From: romain at r-enthusiasts.com (Romain Francois)
Date: Thu, 7 Nov 2013 15:46:30 +0100
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'"
In-Reply-To: <527B9914.7060206@r-enthusiasts.com>
References: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>	<CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>	<CAPJUxXWXFctds0veg3Ayy8bD3woWkA46Ss6JFWc_TFjRKDFTZA@mail.gmail.com>	<CADwqtCPemzpwOjuhVgVmgeHq2zEkF1ViOOzUk6NXNaP3WYvVng@mail.gmail.com>	<CAPJUxXUfJ5Q1yJOxOMmPLFHE93rj1BzCKZkzNJxVVn4+xt0Smg@mail.gmail.com>	<CAPJUxXXF7103s06yh1BoHQbzv3Onkb1Ooj+AShZ=oykJnK=uig@mail.gmail.com>	<527B92F3.7080706@r-enthusiasts.com>	<CAPJUxXW=ZEzcVUmMGctqHFQvdjXSd2X36H_LU4P4qZnju4HZUA@mail.gmail.com>
	<527B9914.7060206@r-enthusiasts.com>
Message-ID: <527BA7C6.6070804@r-enthusiasts.com>

Le 07/11/2013 14:43, Romain Francois a ?crit :
> Le 07/11/2013 14:30, George Vega Yon a ?crit :
>> Romain,
>>
>> Thanks for your quick response. I've already received that suggestion,
>> but, besides of haven't ever used C++, I wanted to understand first
>> what am I doing wrong.
>
> For that type of code, it is actually quite simpler to learn c++ than it
> is to learn the macros and loose typing of the R interface.
>
>> Still, would you give me a small example, in R
>> C++, of:
>>
>>    - Creating a generic vector "L1" of size N
>>    - Creating a data.frame "D" and increasing its the number of rows
>> of it
>>    - Storing the data.frame "D" in the first element of "L1"
>>
>> I would be very gratefull if you can do that.
>
> #include <Rcpp.h>
> using namespace Rcpp ;
>
> // [[Rcpp::export]]
> List example(int N){
>      List out(N) ;
>
>      // let's first accumulate data in these two std::vector
>      std::vector<double> x ;
>      std::vector<int> y ;
>      for( int i=0; i<30; i++){
>          x.push_back( sqrt( i ) ) ;
>          y.push_back( i ) ;
>      }
>
>      // Now let's create a data frame
>      DataFrame df = DataFrame::create(
>          _["x"] = x,
>          _["y"] = y
>          ) ;
>
>      // storing df as the first element of out
>      out[0] = df ;
>
>      return out ;
> }

Forgot to mention. You would just put the code above in a .cpp file and 
call sourceCpp on it.

sourceCpp( "file.cpp" )
example( 3 )

> You can also do it like this acknowleding what a data frame really is
> (just a list of vectors):
>
>      List df = List::create(
>          _["x"] = x,
>          _["y"] = y
>          ) ;
>      df.attr( "class" ) = "data.frame" ;
>      df.attr( "row.names") = IntegerVector::create(
>          IntegerVector::get_na(), -30 ) ;
>
>
> The key thing here is that we accumulate data into std::vector<double>
> and std::vector<int> which know how to grow efficiently. Looping around
> with SET_LENGTH will allocate and copy data at each iteration of the
> loop which will lead to disastrous performance.
>
> Romain
>
>> Thanks again!
>>
>> George Vega Yon
>> +56 9 7 647 2552
>> http://ggvega.cl
>>
>>
>> 2013/11/7 Romain Francois <romain at r-enthusiasts.com>:
>>> Hello,
>>>
>>> Any particular reason you're not using Rcpp? You would have access to
>>> nice
>>> abstraction instead of these MACROS all over the place.
>>>
>>> The cost of these abstractions is close to 0.
>>>
>>> Looping around and SET_LENGTH is going to be quite expensive. I would
>>> urge
>>> you to accumulate data in data structures that know how to grow
>>> efficiently,
>>> i.e. a std::vector and then convert that to an R vector when you're done
>>> with them.
>>>
>>> Romain
>>>
>>> Le 07/11/2013 14:03, George Vega Yon a ?crit :
>>>
>>>> Hi!
>>>>
>>>> I didn't wanted to do this but I think that this is the easiest way
>>>> for you to understand my problem (thanks again for all the comments
>>>> that you have made). Here is a copy of the function that I'm working
>>>> on. This may be tedious to analyze, so I understand if you don't feel
>>>> keen to give it a time. Having dedicated many hours to this (as a new
>>>> user of both C and R C API), I would be very pleased to know what am I
>>>> doing wrong here.
>>>>
>>>> G0 is a Nx2 matrix. The first column is a group id (can be shared with
>>>> several observations) and the second tells how many individuals are in
>>>> that group. This matrix can look something like this:
>>>>
>>>> id_group  nreps
>>>> 1  3
>>>> 1  3
>>>> 1  3
>>>> 2  1
>>>> 3  1
>>>> 4  2
>>>> 5  1
>>>> 6  1
>>>> 4  2
>>>> ...
>>>>
>>>> L0 is list of two column data.frames with different sizes. The first
>>>> column (id) are row indexes (with values 1 to N) and the second column
>>>> are real numbers. L0 can look something like this
>>>> [[1]]
>>>> id  lambda
>>>> 3  0.5
>>>> 15  0.3
>>>> 25  0.2
>>>> [[2]]
>>>> id  lambda
>>>> 15  0.8
>>>> 40  0.2
>>>> ...
>>>> [[N]]
>>>> id  lambda
>>>> 80  1
>>>>
>>>> TE0 is a int scalar in {0,1,2}
>>>>
>>>> T0 is a dichotomous vector of length N that can look something like
>>>> this
>>>> [1] 0 1 0 1 1 1 0 ...
>>>> [N] 1
>>>>
>>>> L1 (the expected output) is a modified version of L0, that, for
>>>> instance can look something like this (note the rows marked with "*")
>>>>
>>>> [[1]]
>>>> id  lambda
>>>> 3  0.5
>>>> *15  0.15 (15 was in the same group of 50, so I added this new row and
>>>> divided the value of lambda by two)
>>>> 25  0.2
>>>> *50  0.15
>>>> [[2]]
>>>> id  lambda
>>>> 15  0.8
>>>> 40  0.2
>>>> ...
>>>> [[N]]
>>>> id  lambda
>>>> *80  0.333 (80 shared group id with 30 and 100, so lambda is divided
>>>> by 3)
>>>> *30  0.333
>>>> *100 0.333
>>>>
>>>> That said, the function is as follows
>>>>
>>>> SEXP distribute_lambdas(
>>>>     SEXP G0,  // Groups ids (matrix of Nx2). First column = Group Id,
>>>> second column: Elements in the group
>>>>     SEXP L0,  // List of N two-column dataframes with different
>>>> number of
>>>> rows
>>>>     SEXP TE0, // Treatment effect (int scalar): ATE(0) ATT(1) ATC(2)
>>>>     SEXP T0   // Treat var (bool vector, 0/1, of size N)
>>>> )
>>>> {
>>>>
>>>>     int i, j, l, m;
>>>>     const int *G = INTEGER_POINTER(PROTECT(G0 = AS_INTEGER(G0 )));
>>>>     const int *T = INTEGER_POINTER(PROTECT(T0 = AS_INTEGER(T0 )));
>>>>     const int *TE= INTEGER_POINTER(PROTECT(TE0= AS_INTEGER(TE0)));
>>>>     double *L, val;
>>>>     int *I, nlambdas, nreps;
>>>>
>>>>     const int n = length(T0);
>>>>
>>>>     PROTECT_INDEX pin0, pin1;
>>>>     SEXP L1;
>>>>     PROTECT(L1 = allocVector(VECSXP,n));
>>>>     SEXP id, lambda;
>>>>
>>>>     // Fixing size
>>>>     for(i=0;i<n;i++)
>>>>     {
>>>>       SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
>>>>     //  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, NEW_INTEGER(100));
>>>>     //  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, NEW_NUMERIC(100));
>>>>     }
>>>>
>>>>     // For over the list, i.e observations
>>>>     for(i=0;i<n;i++)
>>>>     {
>>>>
>>>>       R_CheckUserInterrupt();
>>>>
>>>>       // Checking if has to be analyzed.
>>>>       if (
>>>>         ((TE[0] == 1 & !T[i]) | (TE[0] == 2 & T[i])) |
>>>>         (length(VECTOR_ELT(L0,i)) != 2)
>>>>       )
>>>>       {
>>>>         SET_VECTOR_ELT(L1,i,R_NilValue);
>>>>         continue;
>>>>       }
>>>>
>>>>       // Checking how many rows does the i-th data.frame has
>>>>       nlambdas = length(VECTOR_ELT(VECTOR_ELT(L0,i),0));
>>>>
>>>>       // Pointing to the data.frame's origianl values
>>>>       I =
>>>> INTEGER_POINTER(AS_INTEGER(PROTECT(VECTOR_ELT(VECTOR_ELT(L0,i),0))));
>>>>       L =
>>>> NUMERIC_POINTER(AS_NUMERIC(PROTECT(VECTOR_ELT(VECTOR_ELT(L0,i),1))));
>>>>
>>>>       // Creating a copy of the pointed values
>>>>       PROTECT_WITH_INDEX(id   =
>>>> duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),0)),
>>>> &pin0);
>>>>
>>>> PROTECT_WITH_INDEX(lambda=duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),1)),
>>>> &pin1);
>>>>
>>>>       // Over the rows of the i-th data.frame
>>>>       nreps=0;
>>>>       for(l=0;l<nlambdas;l++)
>>>>       {
>>>>         // If the current lambda id is repeated, ie ther are more
>>>> individuals
>>>>         // with the same covariates, then enter.
>>>>         if (G[n+I[l]-1] > 1)
>>>>         {
>>>>           /* Changing the length of the object */
>>>>           REPROTECT(SET_LENGTH(id,    length(lambda) + G[n+I[l]-1] -1),
>>>> pin0);
>>>>           REPROTECT(SET_LENGTH(lambda,length(lambda) + G[n+I[l]-1] -1),
>>>> pin1);
>>>>
>>>>           // Getting the new value
>>>>           val = L[l]/G[n+I[l] - 1];
>>>>           REAL(lambda)[l] = val;
>>>>
>>>>           // Looping over the full set of groups
>>>>           m = -1,j = -1;
>>>>           while(m < (G[n+I[l]-1] - 1))
>>>>           {
>>>>             // Looking for individuals in the same group
>>>>             if (G[++j] != G[I[l]-1]) continue;
>>>>
>>>>             // If it is the current lambda, then do not asign it
>>>>             if (j == (I[l] - 1)) continue;
>>>>
>>>>             INTEGER(id)[length(id) - (G[n+I[l]-1] - 1) + ++m] = j+1;
>>>>             REAL(lambda)[length(id) - (G[n+I[l]-1] - 1) + m] = val;
>>>>           }
>>>>
>>>>           nreps+=1;
>>>>         }
>>>>       }
>>>>
>>>>       if (nreps)
>>>>       {
>>>>         // Replacing elements from of the list (modified)
>>>>         SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>>         SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>>       }
>>>>       else {
>>>>         // Setting the list with the old elements
>>>>         SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0,
>>>>           duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),0)));
>>>>         SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1,
>>>>           duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),1)));
>>>>       }
>>>>
>>>>       // Unprotecting elements
>>>>       UNPROTECT(4);
>>>>     }
>>>>
>>>>     Rprintf("Exito\n") ;
>>>>     UNPROTECT(4);
>>>>
>>>>     return L1;
>>>> }
>>>>
>>>> Thanks again in advanced.
>>>>
>>>> George Vega Yon
>>>> +56 9 7 647 2552
>>>> http://ggvega.cl
>>>>
>>>> 2013/11/5 George Vega Yon <g.vegayon at gmail.com>:
>>>>>
>>>>> Either way, understanding that it may not be the best way of do it, is
>>>>> there anything wrong in what I'm doing??
>>>>> George Vega Yon
>>>>> +56 9 7 647 2552
>>>>> http://ggvega.cl
>>>>>
>>>>>
>>>>> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>>>>>>
>>>>>> George,
>>>>>>
>>>>>> My point is you don't need to create them and then grow them....
>>>>>>
>>>>>>
>>>>>> for(i=0;i<n;i++)
>>>>>> {
>>>>>>     // Creating the "id" and "lambda" vectors. I do this in every
>>>>>> repetition
>>>>>> of
>>>>>>     // the loop.
>>>>>>
>>>>>>     // ... Some other instructions where I set the value of an
>>>>>> integer
>>>>>>     // z, which tells how much do the vectors have to grow ...
>>>>>>
>>>>>> PROTECT(id=allocVector(INTSXP, 4 +z));
>>>>>> PROTECT(lambda=allocVector(REALSXP, 4 +z));
>>>>>>
>>>>>>
>>>>>>     // ... some lines where I fill the vectors ...
>>>>>>
>>>>>>     // Storing the new vectors at the i-th element of the list
>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>>>>
>>>>>>     // Unprotecting the "id" and "lambda" vectors
>>>>>>     UNPROTECT(2);
>>>>>> }
>>>>>>
>>>>>> ~G
>>>>>>
>>>>>>
>>>>>> On Tue, Nov 5, 2013 at 1:56 PM, George Vega Yon <g.vegayon at gmail.com>
>>>>>> wrote:
>>>>>>>
>>>>>>>
>>>>>>> Gabriel,
>>>>>>>
>>>>>>> While the length (in terms of number of SEXP elements it stores)
>>>>>>> of L1
>>>>>>> doesn't changes, the vectors within L1 do (sorry if I didn't
>>>>>>> explained
>>>>>>> it well before).
>>>>>>>
>>>>>>> The post was about a SEXP object that grows, in my case, every
>>>>>>> pair of
>>>>>>> vectors in L1 (id and lambda) can change lengths, this is why I need
>>>>>>> to reprotect them. I populate the i-th element of L1 by creating the
>>>>>>> vectors "id" and "lambda", setting the length of these according to
>>>>>>> some rule (that's the part where lengths change)... here is a
>>>>>>> reduced
>>>>>>> form of my code:
>>>>>>>
>>>>>>> //////////////////////////////////////// C
>>>>>>> ////////////////////////////////////////
>>>>>>> const int = length(L0);
>>>>>>> SEXP L1;
>>>>>>> PROTECT(L1 = allocVector(VECSXP,n));
>>>>>>> SEXP id, lambda;
>>>>>>>
>>>>>>> // Fixing size
>>>>>>> for(i=0;i<n;i++)
>>>>>>>     SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
>>>>>>>
>>>>>>> for(i=0;i<n;i++)
>>>>>>> {
>>>>>>>     // Creating the "id" and "lambda" vectors. I do this in every
>>>>>>> repetition
>>>>>>> of
>>>>>>>     // the loop.
>>>>>>>     PROTECT_WITH_INDEX(id=allocVector(INTSXP, 4), &ipx0);
>>>>>>>     PROTECT_WITH_INDEX(lambda=allocVector(REALSXP, 4), &ipx1);
>>>>>>>
>>>>>>>     // ... Some other instructions where I set the value of an
>>>>>>> integer
>>>>>>>     // z, which tells how much do the vectors have to grow ...
>>>>>>>
>>>>>>>     REPROTECT(SET_LENGTH(id,    length(lambda) + z), ipx0);
>>>>>>>     REPROTECT(SET_LENGTH(lambda,length(lambda) + z), ipx1);
>>>>>>>
>>>>>>>     // ... some lines where I fill the vectors ...
>>>>>>>
>>>>>>>     // Storing the new vectors at the i-th element of the list
>>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>>>>>
>>>>>>>     // Unprotecting the "id" and "lambda" vectors
>>>>>>>     UNPROTECT(2);
>>>>>>> }
>>>>>>>
>>>>>>> UNPROTECT(1);
>>>>>>>
>>>>>>> return L1;
>>>>>>> //////////////////////////////////////// C
>>>>>>> ////////////////////////////////////////
>>>>>>>
>>>>>>> I can't set the length from the start because every pair of
>>>>>>> vectors in
>>>>>>> L1 have different lengths, lengths that I cannot tell before
>>>>>>> starting
>>>>>>> the loop.
>>>>>>>
>>>>>>> Thanks for your help,
>>>>>>>
>>>>>>> Regards,
>>>>>>>
>>>>>>> George Vega Yon
>>>>>>> +56 9 7 647 2552
>>>>>>> http://ggvega.cl
>>>>>>>
>>>>>>>
>>>>>>> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>>>>>>>>
>>>>>>>> George,
>>>>>>>>
>>>>>>>> I don't see the relevance of the stackoverflow post you linked.
>>>>>>>> In the
>>>>>>>> post,
>>>>>>>> the author wanted to change the length of an existing "mother list"
>>>>>>>> (matrix,
>>>>>>>> etc), while you specifically state that the length of L1 will not
>>>>>>>> change.
>>>>>>>>
>>>>>>>> You say that the child lists (vectors if they are
>>>>>>>> INTSXP/REALSXP) are
>>>>>>>> variable, but that is not what the linked post was about unless
>>>>>>>> I am
>>>>>>>> completely missing something.
>>>>>>>>
>>>>>>>> I can't really say more without knowing the details of how the
>>>>>>>> vectors
>>>>>>>> are
>>>>>>>> being created and why they cannot just have the right length
>>>>>>>> from the
>>>>>>>> start.
>>>>>>>>
>>>>>>>> As for the error, that is a weird one. I imagine it means that a
>>>>>>>> SEXP
>>>>>>>> thinks
>>>>>>>> that it has a type other than ones defined in Rinternals. I can't
>>>>>>>> speak
>>>>>>>> to
>>>>>>>> how that could have happened from what you posted though.
>>>>>>>>
>>>>>>>> Sorry I can't be of more help,
>>>>>>>> ~G
>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>> On Mon, Nov 4, 2013 at 8:00 PM, George Vega Yon
>>>>>>>> <g.vegayon at gmail.com>
>>>>>>>> wrote:
>>>>>>>>>
>>>>>>>>>
>>>>>>>>> Dear R-devel,
>>>>>>>>>
>>>>>>>>> A couple of weeks ago I started to use the R C API for package
>>>>>>>>> development. Without knowing much about C, I've been able to write
>>>>>>>>> some routines sucessfully... until now.
>>>>>>>>>
>>>>>>>>> My problem consists in dynamically creating a list ("L1") of lists
>>>>>>>>> using .Call, the tricky part is that each element of the "mother
>>>>>>>>> list"
>>>>>>>>> contains two vectors (INTSXP and REALEXP types) with varying
>>>>>>>>> sizes;
>>>>>>>>> sizes that I set while I'm looping over another list's ("L1")
>>>>>>>>> elements
>>>>>>>>>    (input list). The steps I've follow are:
>>>>>>>>>
>>>>>>>>> FIRST: Create the "mother list" of size "n=length(L0)" (doesn't
>>>>>>>>> change) and protect it as
>>>>>>>>>     PROTECT(L1=allocVector(VECEXP, length(L0)))
>>>>>>>>> and filling it with vectors of length two:
>>>>>>>>>     for(i=0;i<n;i++) SET_VECTOR_ELT(L1,i, allocVector(VECSXP, 2));
>>>>>>>>>
>>>>>>>>> then, for each element of the mother list:
>>>>>>>>>
>>>>>>>>>     for(i=0;i<n;i++) {
>>>>>>>>>
>>>>>>>>> SECOND: By reading this post in Stackoverflow
>>>>>>>>>
>>>>>>>>>
>>>>>>>>>
>>>>>>>>> http://stackoverflow.com/questions/7458364/growing-an-r-matrix-inside-a-c-loop/7458516#7458516
>>>>>>>>>
>>>>>>>>> I understood that it was necesary to (1) create the "child
>>>>>>>>> lists" and
>>>>>>>>> protecting them with PROTECT_WITH_INDEX, and (2) changing its size
>>>>>>>>> using SETLENGTH (Rf_lengthgets) and REPROTECT ing the lists in
>>>>>>>>> order
>>>>>>>>> to tell the GC that the vectors had change.
>>>>>>>>>
>>>>>>>>> THIRD: Once my two vectors are done ("id" and "lambda"), assign
>>>>>>>>> them
>>>>>>>>> to the i-th element of the "mother list" L1 using
>>>>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, duplicate(id));
>>>>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, duplicate(lambda));
>>>>>>>>>
>>>>>>>>> and unprotecting the elements protected with index: UNPROTECT(2);
>>>>>>>>>
>>>>>>>>> }
>>>>>>>>>
>>>>>>>>> FOURTH: Unprotecting the "mother list" (L1) and return it to R
>>>>>>>>>
>>>>>>>>> With small datasets this works fine, but after trying with bigger
>>>>>>>>> ones
>>>>>>>>> R (my code) keeps failing and returning a strange error that I
>>>>>>>>> haven't
>>>>>>>>> been able to identify (or find in the web)
>>>>>>>>>
>>>>>>>>>     "unimplemented type (29) in 'duplicate'"
>>>>>>>>>
>>>>>>>>> This happens right after I try to use the returned list from my
>>>>>>>>> routine (trying to print it or building a data-frame).
>>>>>>>>>
>>>>>>>>> Does anyone have an idea of what am I doing wrong?
>>>>>>>>>
>>>>>>>>> Best regards,
>>>>>>>>>
>>>>>>>>> PS: I didn't wanted to copy the entire function... but if you
>>>>>>>>> need it
>>>>>>>>> I can do it.
>>>>>>>>>
>>>>>>>>> George Vega Yon
>>>>>>>>> +56 9 7 647 2552
>>>>>>>>> http://ggvega.cl
>>>>>>>>>
>>>>>>>>> ______________________________________________
>>>>>>>>> R-devel at r-project.org mailing list
>>>>>>>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>> --
>>>>>>>> Gabriel Becker
>>>>>>>> Graduate Student
>>>>>>>> Statistics Department
>>>>>>>> University of California, Davis
>>>>>>
>>>>>>
>>>>>>
>>>>>>
>>>>>>
>>>>>> --
>>>>>> Gabriel Becker
>>>>>> Graduate Student
>>>>>> Statistics Department
>>>>>> University of California, Davis
>>>>
>>>>
>>>> ______________________________________________
>>>> R-devel at r-project.org mailing list
>>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>>
>>>
>>>
>>> --
>>> Romain Francois
>>> Professional R Enthusiast
>>> +33(0) 6 28 91 30 30
>>>
>>>
>>> ______________________________________________
>>> R-devel at r-project.org mailing list
>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>
>
>


-- 
Romain Francois
Professional R Enthusiast
+33(0) 6 28 91 30 30


From nashjc at uottawa.ca  Thu Nov  7 16:12:28 2013
From: nashjc at uottawa.ca (Prof J C Nash (U30A))
Date: Thu, 07 Nov 2013 10:12:28 -0500
Subject: [Rd] cat with backspace and newline characters
In-Reply-To: <mailman.25.1383735608.27847.r-devel@r-project.org>
References: <mailman.25.1383735608.27847.r-devel@r-project.org>
Message-ID: <527BADDC.10906@uottawa.ca>

Over the years, this has been useful to me (not just in R) for many
nonlinear optimization tasks. The alternatives often clutter the screen.

> On 13-11-06 06:00 AM, r-devel-request at r-project.org wrote:

> People do sometimes use this pattern for displaying progress (e.g. iteration counts). 
>> 
>> 


As this looks like a "terminal" matter, the first level solution may be
to take a couple of examples and prepare a table of what happens on the
most used platforms, including in things like RStudio and ESS. Might be
a good issue for Rwiki, as I'm sure few of us have all the choices.

I can generally live with warning users when the iteration display may
display oddly. Perhaps others have more stringent requirements, but if
documentation is enough, we can avoid fixing something that is more or
less outside R and may be unnecessary work. And documented examples can
also show us if things are changing.

JN


From g.vegayon at gmail.com  Thu Nov  7 16:27:46 2013
From: g.vegayon at gmail.com (George Vega Yon)
Date: Thu, 7 Nov 2013 12:27:46 -0300
Subject: [Rd] Dynamic list creation (SEXP in C) returns error
 "unimplemented type (29) in 'duplicate'"
In-Reply-To: <527BA7C6.6070804@r-enthusiasts.com>
References: <CAPJUxXXWvDjAuoHBp=QZmX4BV2PScNuAUYm5VujervZ_bXeZqA@mail.gmail.com>
	<CADwqtCNS8NMWz2y+88QCG6Q9cSy9=s7aw1RsF+iEvWz6hEYZvw@mail.gmail.com>
	<CAPJUxXWXFctds0veg3Ayy8bD3woWkA46Ss6JFWc_TFjRKDFTZA@mail.gmail.com>
	<CADwqtCPemzpwOjuhVgVmgeHq2zEkF1ViOOzUk6NXNaP3WYvVng@mail.gmail.com>
	<CAPJUxXUfJ5Q1yJOxOMmPLFHE93rj1BzCKZkzNJxVVn4+xt0Smg@mail.gmail.com>
	<CAPJUxXXF7103s06yh1BoHQbzv3Onkb1Ooj+AShZ=oykJnK=uig@mail.gmail.com>
	<527B92F3.7080706@r-enthusiasts.com>
	<CAPJUxXW=ZEzcVUmMGctqHFQvdjXSd2X36H_LU4P4qZnju4HZUA@mail.gmail.com>
	<527B9914.7060206@r-enthusiasts.com>
	<527BA7C6.6070804@r-enthusiasts.com>
Message-ID: <CAPJUxXXjAo_n5M26CDsZ3+KTPDuox=ScjA_9_6cRwH_Q5JPXJg@mail.gmail.com>

Thank you very much! Just what I needed.

Too bad I never got to understand what was wrong with my original code...

Thanks again!

George Vega Yon
+56 9 7 647 2552
http://ggvega.cl


2013/11/7 Romain Francois <romain at r-enthusiasts.com>:
> Le 07/11/2013 14:43, Romain Francois a ?crit :
>
>> Le 07/11/2013 14:30, George Vega Yon a ?crit :
>>>
>>> Romain,
>>>
>>> Thanks for your quick response. I've already received that suggestion,
>>> but, besides of haven't ever used C++, I wanted to understand first
>>> what am I doing wrong.
>>
>>
>> For that type of code, it is actually quite simpler to learn c++ than it
>> is to learn the macros and loose typing of the R interface.
>>
>>> Still, would you give me a small example, in R
>>> C++, of:
>>>
>>>    - Creating a generic vector "L1" of size N
>>>    - Creating a data.frame "D" and increasing its the number of rows
>>> of it
>>>    - Storing the data.frame "D" in the first element of "L1"
>>>
>>> I would be very gratefull if you can do that.
>>
>>
>> #include <Rcpp.h>
>> using namespace Rcpp ;
>>
>> // [[Rcpp::export]]
>> List example(int N){
>>      List out(N) ;
>>
>>      // let's first accumulate data in these two std::vector
>>      std::vector<double> x ;
>>      std::vector<int> y ;
>>      for( int i=0; i<30; i++){
>>          x.push_back( sqrt( i ) ) ;
>>          y.push_back( i ) ;
>>      }
>>
>>      // Now let's create a data frame
>>      DataFrame df = DataFrame::create(
>>          _["x"] = x,
>>          _["y"] = y
>>          ) ;
>>
>>      // storing df as the first element of out
>>      out[0] = df ;
>>
>>      return out ;
>> }
>
>
> Forgot to mention. You would just put the code above in a .cpp file and call
> sourceCpp on it.
>
> sourceCpp( "file.cpp" )
> example( 3 )
>
>
>> You can also do it like this acknowleding what a data frame really is
>> (just a list of vectors):
>>
>>      List df = List::create(
>>          _["x"] = x,
>>          _["y"] = y
>>          ) ;
>>      df.attr( "class" ) = "data.frame" ;
>>      df.attr( "row.names") = IntegerVector::create(
>>          IntegerVector::get_na(), -30 ) ;
>>
>>
>> The key thing here is that we accumulate data into std::vector<double>
>> and std::vector<int> which know how to grow efficiently. Looping around
>> with SET_LENGTH will allocate and copy data at each iteration of the
>> loop which will lead to disastrous performance.
>>
>> Romain
>>
>>> Thanks again!
>>>
>>> George Vega Yon
>>> +56 9 7 647 2552
>>> http://ggvega.cl
>>>
>>>
>>> 2013/11/7 Romain Francois <romain at r-enthusiasts.com>:
>>>>
>>>> Hello,
>>>>
>>>> Any particular reason you're not using Rcpp? You would have access to
>>>> nice
>>>> abstraction instead of these MACROS all over the place.
>>>>
>>>> The cost of these abstractions is close to 0.
>>>>
>>>> Looping around and SET_LENGTH is going to be quite expensive. I would
>>>> urge
>>>> you to accumulate data in data structures that know how to grow
>>>> efficiently,
>>>> i.e. a std::vector and then convert that to an R vector when you're done
>>>> with them.
>>>>
>>>> Romain
>>>>
>>>> Le 07/11/2013 14:03, George Vega Yon a ?crit :
>>>>
>>>>> Hi!
>>>>>
>>>>> I didn't wanted to do this but I think that this is the easiest way
>>>>> for you to understand my problem (thanks again for all the comments
>>>>> that you have made). Here is a copy of the function that I'm working
>>>>> on. This may be tedious to analyze, so I understand if you don't feel
>>>>> keen to give it a time. Having dedicated many hours to this (as a new
>>>>> user of both C and R C API), I would be very pleased to know what am I
>>>>> doing wrong here.
>>>>>
>>>>> G0 is a Nx2 matrix. The first column is a group id (can be shared with
>>>>> several observations) and the second tells how many individuals are in
>>>>> that group. This matrix can look something like this:
>>>>>
>>>>> id_group  nreps
>>>>> 1  3
>>>>> 1  3
>>>>> 1  3
>>>>> 2  1
>>>>> 3  1
>>>>> 4  2
>>>>> 5  1
>>>>> 6  1
>>>>> 4  2
>>>>> ...
>>>>>
>>>>> L0 is list of two column data.frames with different sizes. The first
>>>>> column (id) are row indexes (with values 1 to N) and the second column
>>>>> are real numbers. L0 can look something like this
>>>>> [[1]]
>>>>> id  lambda
>>>>> 3  0.5
>>>>> 15  0.3
>>>>> 25  0.2
>>>>> [[2]]
>>>>> id  lambda
>>>>> 15  0.8
>>>>> 40  0.2
>>>>> ...
>>>>> [[N]]
>>>>> id  lambda
>>>>> 80  1
>>>>>
>>>>> TE0 is a int scalar in {0,1,2}
>>>>>
>>>>> T0 is a dichotomous vector of length N that can look something like
>>>>> this
>>>>> [1] 0 1 0 1 1 1 0 ...
>>>>> [N] 1
>>>>>
>>>>> L1 (the expected output) is a modified version of L0, that, for
>>>>> instance can look something like this (note the rows marked with "*")
>>>>>
>>>>> [[1]]
>>>>> id  lambda
>>>>> 3  0.5
>>>>> *15  0.15 (15 was in the same group of 50, so I added this new row and
>>>>> divided the value of lambda by two)
>>>>> 25  0.2
>>>>> *50  0.15
>>>>> [[2]]
>>>>> id  lambda
>>>>> 15  0.8
>>>>> 40  0.2
>>>>> ...
>>>>> [[N]]
>>>>> id  lambda
>>>>> *80  0.333 (80 shared group id with 30 and 100, so lambda is divided
>>>>> by 3)
>>>>> *30  0.333
>>>>> *100 0.333
>>>>>
>>>>> That said, the function is as follows
>>>>>
>>>>> SEXP distribute_lambdas(
>>>>>     SEXP G0,  // Groups ids (matrix of Nx2). First column = Group Id,
>>>>> second column: Elements in the group
>>>>>     SEXP L0,  // List of N two-column dataframes with different
>>>>> number of
>>>>> rows
>>>>>     SEXP TE0, // Treatment effect (int scalar): ATE(0) ATT(1) ATC(2)
>>>>>     SEXP T0   // Treat var (bool vector, 0/1, of size N)
>>>>> )
>>>>> {
>>>>>
>>>>>     int i, j, l, m;
>>>>>     const int *G = INTEGER_POINTER(PROTECT(G0 = AS_INTEGER(G0 )));
>>>>>     const int *T = INTEGER_POINTER(PROTECT(T0 = AS_INTEGER(T0 )));
>>>>>     const int *TE= INTEGER_POINTER(PROTECT(TE0= AS_INTEGER(TE0)));
>>>>>     double *L, val;
>>>>>     int *I, nlambdas, nreps;
>>>>>
>>>>>     const int n = length(T0);
>>>>>
>>>>>     PROTECT_INDEX pin0, pin1;
>>>>>     SEXP L1;
>>>>>     PROTECT(L1 = allocVector(VECSXP,n));
>>>>>     SEXP id, lambda;
>>>>>
>>>>>     // Fixing size
>>>>>     for(i=0;i<n;i++)
>>>>>     {
>>>>>       SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
>>>>>     //  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, NEW_INTEGER(100));
>>>>>     //  SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, NEW_NUMERIC(100));
>>>>>     }
>>>>>
>>>>>     // For over the list, i.e observations
>>>>>     for(i=0;i<n;i++)
>>>>>     {
>>>>>
>>>>>       R_CheckUserInterrupt();
>>>>>
>>>>>       // Checking if has to be analyzed.
>>>>>       if (
>>>>>         ((TE[0] == 1 & !T[i]) | (TE[0] == 2 & T[i])) |
>>>>>         (length(VECTOR_ELT(L0,i)) != 2)
>>>>>       )
>>>>>       {
>>>>>         SET_VECTOR_ELT(L1,i,R_NilValue);
>>>>>         continue;
>>>>>       }
>>>>>
>>>>>       // Checking how many rows does the i-th data.frame has
>>>>>       nlambdas = length(VECTOR_ELT(VECTOR_ELT(L0,i),0));
>>>>>
>>>>>       // Pointing to the data.frame's origianl values
>>>>>       I =
>>>>> INTEGER_POINTER(AS_INTEGER(PROTECT(VECTOR_ELT(VECTOR_ELT(L0,i),0))));
>>>>>       L =
>>>>> NUMERIC_POINTER(AS_NUMERIC(PROTECT(VECTOR_ELT(VECTOR_ELT(L0,i),1))));
>>>>>
>>>>>       // Creating a copy of the pointed values
>>>>>       PROTECT_WITH_INDEX(id   =
>>>>> duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),0)),
>>>>> &pin0);
>>>>>
>>>>> PROTECT_WITH_INDEX(lambda=duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),1)),
>>>>> &pin1);
>>>>>
>>>>>       // Over the rows of the i-th data.frame
>>>>>       nreps=0;
>>>>>       for(l=0;l<nlambdas;l++)
>>>>>       {
>>>>>         // If the current lambda id is repeated, ie ther are more
>>>>> individuals
>>>>>         // with the same covariates, then enter.
>>>>>         if (G[n+I[l]-1] > 1)
>>>>>         {
>>>>>           /* Changing the length of the object */
>>>>>           REPROTECT(SET_LENGTH(id,    length(lambda) + G[n+I[l]-1] -1),
>>>>> pin0);
>>>>>           REPROTECT(SET_LENGTH(lambda,length(lambda) + G[n+I[l]-1] -1),
>>>>> pin1);
>>>>>
>>>>>           // Getting the new value
>>>>>           val = L[l]/G[n+I[l] - 1];
>>>>>           REAL(lambda)[l] = val;
>>>>>
>>>>>           // Looping over the full set of groups
>>>>>           m = -1,j = -1;
>>>>>           while(m < (G[n+I[l]-1] - 1))
>>>>>           {
>>>>>             // Looking for individuals in the same group
>>>>>             if (G[++j] != G[I[l]-1]) continue;
>>>>>
>>>>>             // If it is the current lambda, then do not asign it
>>>>>             if (j == (I[l] - 1)) continue;
>>>>>
>>>>>             INTEGER(id)[length(id) - (G[n+I[l]-1] - 1) + ++m] = j+1;
>>>>>             REAL(lambda)[length(id) - (G[n+I[l]-1] - 1) + m] = val;
>>>>>           }
>>>>>
>>>>>           nreps+=1;
>>>>>         }
>>>>>       }
>>>>>
>>>>>       if (nreps)
>>>>>       {
>>>>>         // Replacing elements from of the list (modified)
>>>>>         SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>>>         SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>>>       }
>>>>>       else {
>>>>>         // Setting the list with the old elements
>>>>>         SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0,
>>>>>           duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),0)));
>>>>>         SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1,
>>>>>           duplicate(VECTOR_ELT(VECTOR_ELT(L0,i),1)));
>>>>>       }
>>>>>
>>>>>       // Unprotecting elements
>>>>>       UNPROTECT(4);
>>>>>     }
>>>>>
>>>>>     Rprintf("Exito\n") ;
>>>>>     UNPROTECT(4);
>>>>>
>>>>>     return L1;
>>>>> }
>>>>>
>>>>> Thanks again in advanced.
>>>>>
>>>>> George Vega Yon
>>>>> +56 9 7 647 2552
>>>>> http://ggvega.cl
>>>>>
>>>>> 2013/11/5 George Vega Yon <g.vegayon at gmail.com>:
>>>>>>
>>>>>>
>>>>>> Either way, understanding that it may not be the best way of do it, is
>>>>>> there anything wrong in what I'm doing??
>>>>>> George Vega Yon
>>>>>> +56 9 7 647 2552
>>>>>> http://ggvega.cl
>>>>>>
>>>>>>
>>>>>> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>>>>>>>
>>>>>>>
>>>>>>> George,
>>>>>>>
>>>>>>> My point is you don't need to create them and then grow them....
>>>>>>>
>>>>>>>
>>>>>>> for(i=0;i<n;i++)
>>>>>>> {
>>>>>>>     // Creating the "id" and "lambda" vectors. I do this in every
>>>>>>> repetition
>>>>>>> of
>>>>>>>     // the loop.
>>>>>>>
>>>>>>>     // ... Some other instructions where I set the value of an
>>>>>>> integer
>>>>>>>     // z, which tells how much do the vectors have to grow ...
>>>>>>>
>>>>>>> PROTECT(id=allocVector(INTSXP, 4 +z));
>>>>>>> PROTECT(lambda=allocVector(REALSXP, 4 +z));
>>>>>>>
>>>>>>>
>>>>>>>     // ... some lines where I fill the vectors ...
>>>>>>>
>>>>>>>     // Storing the new vectors at the i-th element of the list
>>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>>>>>
>>>>>>>     // Unprotecting the "id" and "lambda" vectors
>>>>>>>     UNPROTECT(2);
>>>>>>> }
>>>>>>>
>>>>>>> ~G
>>>>>>>
>>>>>>>
>>>>>>> On Tue, Nov 5, 2013 at 1:56 PM, George Vega Yon <g.vegayon at gmail.com>
>>>>>>> wrote:
>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>> Gabriel,
>>>>>>>>
>>>>>>>> While the length (in terms of number of SEXP elements it stores)
>>>>>>>> of L1
>>>>>>>> doesn't changes, the vectors within L1 do (sorry if I didn't
>>>>>>>> explained
>>>>>>>> it well before).
>>>>>>>>
>>>>>>>> The post was about a SEXP object that grows, in my case, every
>>>>>>>> pair of
>>>>>>>> vectors in L1 (id and lambda) can change lengths, this is why I need
>>>>>>>> to reprotect them. I populate the i-th element of L1 by creating the
>>>>>>>> vectors "id" and "lambda", setting the length of these according to
>>>>>>>> some rule (that's the part where lengths change)... here is a
>>>>>>>> reduced
>>>>>>>> form of my code:
>>>>>>>>
>>>>>>>> //////////////////////////////////////// C
>>>>>>>> ////////////////////////////////////////
>>>>>>>> const int = length(L0);
>>>>>>>> SEXP L1;
>>>>>>>> PROTECT(L1 = allocVector(VECSXP,n));
>>>>>>>> SEXP id, lambda;
>>>>>>>>
>>>>>>>> // Fixing size
>>>>>>>> for(i=0;i<n;i++)
>>>>>>>>     SET_VECTOR_ELT(L1, i, allocVector(VECSXP, 2));
>>>>>>>>
>>>>>>>> for(i=0;i<n;i++)
>>>>>>>> {
>>>>>>>>     // Creating the "id" and "lambda" vectors. I do this in every
>>>>>>>> repetition
>>>>>>>> of
>>>>>>>>     // the loop.
>>>>>>>>     PROTECT_WITH_INDEX(id=allocVector(INTSXP, 4), &ipx0);
>>>>>>>>     PROTECT_WITH_INDEX(lambda=allocVector(REALSXP, 4), &ipx1);
>>>>>>>>
>>>>>>>>     // ... Some other instructions where I set the value of an
>>>>>>>> integer
>>>>>>>>     // z, which tells how much do the vectors have to grow ...
>>>>>>>>
>>>>>>>>     REPROTECT(SET_LENGTH(id,    length(lambda) + z), ipx0);
>>>>>>>>     REPROTECT(SET_LENGTH(lambda,length(lambda) + z), ipx1);
>>>>>>>>
>>>>>>>>     // ... some lines where I fill the vectors ...
>>>>>>>>
>>>>>>>>     // Storing the new vectors at the i-th element of the list
>>>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1, i), 0, duplicate(id));
>>>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1, i), 1, duplicate(lambda));
>>>>>>>>
>>>>>>>>     // Unprotecting the "id" and "lambda" vectors
>>>>>>>>     UNPROTECT(2);
>>>>>>>> }
>>>>>>>>
>>>>>>>> UNPROTECT(1);
>>>>>>>>
>>>>>>>> return L1;
>>>>>>>> //////////////////////////////////////// C
>>>>>>>> ////////////////////////////////////////
>>>>>>>>
>>>>>>>> I can't set the length from the start because every pair of
>>>>>>>> vectors in
>>>>>>>> L1 have different lengths, lengths that I cannot tell before
>>>>>>>> starting
>>>>>>>> the loop.
>>>>>>>>
>>>>>>>> Thanks for your help,
>>>>>>>>
>>>>>>>> Regards,
>>>>>>>>
>>>>>>>> George Vega Yon
>>>>>>>> +56 9 7 647 2552
>>>>>>>> http://ggvega.cl
>>>>>>>>
>>>>>>>>
>>>>>>>> 2013/11/5 Gabriel Becker <gmbecker at ucdavis.edu>:
>>>>>>>>>
>>>>>>>>>
>>>>>>>>> George,
>>>>>>>>>
>>>>>>>>> I don't see the relevance of the stackoverflow post you linked.
>>>>>>>>> In the
>>>>>>>>> post,
>>>>>>>>> the author wanted to change the length of an existing "mother list"
>>>>>>>>> (matrix,
>>>>>>>>> etc), while you specifically state that the length of L1 will not
>>>>>>>>> change.
>>>>>>>>>
>>>>>>>>> You say that the child lists (vectors if they are
>>>>>>>>> INTSXP/REALSXP) are
>>>>>>>>> variable, but that is not what the linked post was about unless
>>>>>>>>> I am
>>>>>>>>> completely missing something.
>>>>>>>>>
>>>>>>>>> I can't really say more without knowing the details of how the
>>>>>>>>> vectors
>>>>>>>>> are
>>>>>>>>> being created and why they cannot just have the right length
>>>>>>>>> from the
>>>>>>>>> start.
>>>>>>>>>
>>>>>>>>> As for the error, that is a weird one. I imagine it means that a
>>>>>>>>> SEXP
>>>>>>>>> thinks
>>>>>>>>> that it has a type other than ones defined in Rinternals. I can't
>>>>>>>>> speak
>>>>>>>>> to
>>>>>>>>> how that could have happened from what you posted though.
>>>>>>>>>
>>>>>>>>> Sorry I can't be of more help,
>>>>>>>>> ~G
>>>>>>>>>
>>>>>>>>>
>>>>>>>>>
>>>>>>>>> On Mon, Nov 4, 2013 at 8:00 PM, George Vega Yon
>>>>>>>>> <g.vegayon at gmail.com>
>>>>>>>>> wrote:
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>> Dear R-devel,
>>>>>>>>>>
>>>>>>>>>> A couple of weeks ago I started to use the R C API for package
>>>>>>>>>> development. Without knowing much about C, I've been able to write
>>>>>>>>>> some routines sucessfully... until now.
>>>>>>>>>>
>>>>>>>>>> My problem consists in dynamically creating a list ("L1") of lists
>>>>>>>>>> using .Call, the tricky part is that each element of the "mother
>>>>>>>>>> list"
>>>>>>>>>> contains two vectors (INTSXP and REALEXP types) with varying
>>>>>>>>>> sizes;
>>>>>>>>>> sizes that I set while I'm looping over another list's ("L1")
>>>>>>>>>> elements
>>>>>>>>>>    (input list). The steps I've follow are:
>>>>>>>>>>
>>>>>>>>>> FIRST: Create the "mother list" of size "n=length(L0)" (doesn't
>>>>>>>>>> change) and protect it as
>>>>>>>>>>     PROTECT(L1=allocVector(VECEXP, length(L0)))
>>>>>>>>>> and filling it with vectors of length two:
>>>>>>>>>>     for(i=0;i<n;i++) SET_VECTOR_ELT(L1,i, allocVector(VECSXP, 2));
>>>>>>>>>>
>>>>>>>>>> then, for each element of the mother list:
>>>>>>>>>>
>>>>>>>>>>     for(i=0;i<n;i++) {
>>>>>>>>>>
>>>>>>>>>> SECOND: By reading this post in Stackoverflow
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>> http://stackoverflow.com/questions/7458364/growing-an-r-matrix-inside-a-c-loop/7458516#7458516
>>>>>>>>>>
>>>>>>>>>> I understood that it was necesary to (1) create the "child
>>>>>>>>>> lists" and
>>>>>>>>>> protecting them with PROTECT_WITH_INDEX, and (2) changing its size
>>>>>>>>>> using SETLENGTH (Rf_lengthgets) and REPROTECT ing the lists in
>>>>>>>>>> order
>>>>>>>>>> to tell the GC that the vectors had change.
>>>>>>>>>>
>>>>>>>>>> THIRD: Once my two vectors are done ("id" and "lambda"), assign
>>>>>>>>>> them
>>>>>>>>>> to the i-th element of the "mother list" L1 using
>>>>>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1,i), 0, duplicate(id));
>>>>>>>>>>     SET_VECTOR_ELT(VECTOR_ELT(L1,i), 1, duplicate(lambda));
>>>>>>>>>>
>>>>>>>>>> and unprotecting the elements protected with index: UNPROTECT(2);
>>>>>>>>>>
>>>>>>>>>> }
>>>>>>>>>>
>>>>>>>>>> FOURTH: Unprotecting the "mother list" (L1) and return it to R
>>>>>>>>>>
>>>>>>>>>> With small datasets this works fine, but after trying with bigger
>>>>>>>>>> ones
>>>>>>>>>> R (my code) keeps failing and returning a strange error that I
>>>>>>>>>> haven't
>>>>>>>>>> been able to identify (or find in the web)
>>>>>>>>>>
>>>>>>>>>>     "unimplemented type (29) in 'duplicate'"
>>>>>>>>>>
>>>>>>>>>> This happens right after I try to use the returned list from my
>>>>>>>>>> routine (trying to print it or building a data-frame).
>>>>>>>>>>
>>>>>>>>>> Does anyone have an idea of what am I doing wrong?
>>>>>>>>>>
>>>>>>>>>> Best regards,
>>>>>>>>>>
>>>>>>>>>> PS: I didn't wanted to copy the entire function... but if you
>>>>>>>>>> need it
>>>>>>>>>> I can do it.
>>>>>>>>>>
>>>>>>>>>> George Vega Yon
>>>>>>>>>> +56 9 7 647 2552
>>>>>>>>>> http://ggvega.cl
>>>>>>>>>>
>>>>>>>>>> ______________________________________________
>>>>>>>>>> R-devel at r-project.org mailing list
>>>>>>>>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>>>>>>>
>>>>>>>>>
>>>>>>>>>
>>>>>>>>>
>>>>>>>>>
>>>>>>>>>
>>>>>>>>> --
>>>>>>>>> Gabriel Becker
>>>>>>>>> Graduate Student
>>>>>>>>> Statistics Department
>>>>>>>>> University of California, Davis
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>> --
>>>>>>> Gabriel Becker
>>>>>>> Graduate Student
>>>>>>> Statistics Department
>>>>>>> University of California, Davis
>>>>>
>>>>>
>>>>>
>>>>> ______________________________________________
>>>>> R-devel at r-project.org mailing list
>>>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>>>
>>>>
>>>>
>>>> --
>>>> Romain Francois
>>>> Professional R Enthusiast
>>>> +33(0) 6 28 91 30 30
>>>>
>>>>
>>>> ______________________________________________
>>>> R-devel at r-project.org mailing list
>>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>
>>>
>>
>>
>
>
> --
> Romain Francois
> Professional R Enthusiast
> +33(0) 6 28 91 30 30
>


From wdunlap at tibco.com  Thu Nov  7 22:32:46 2013
From: wdunlap at tibco.com (William Dunlap)
Date: Thu, 7 Nov 2013 21:32:46 +0000
Subject: [Rd] R interface to C API Rf_logspace_{add,sub}?
Message-ID: <E66794E69CFDE04D9A70842786030B933FA137FC@PA-MBX01.na.tibco.com>

Is there an R-language interface to the R API C-language functions Rf_logspace_add()
and Rf_logspace_sub()?   I don't see one but I may not looking under the
right name.

Various packages have functions which do that same sort
of thing (log(exp(x)+exp(y)) and log(exp(x)-exp(y)) without unnecessary
floating point errors).  They have names like
    matrixStats::logSumExp(lx, na.rm=FALSE, ...) (the ... is ignored by the function)
    sna::logSub(x,y), logSum(x), logMean(x)
    BTYD::addLogs(loga, logb) and subLogs(loga, logb)
Googling for logSumExp (the Python name) indicates that many know this as "LSE"
(the "Log-Sum-Exp trick").

I've seen several instances in R-help recently where user code could be
made more accurate if these were available.  They can be written in pure
R code, but would be slower because they would require something like
pmin() and pmax() to work.  I think they belong in the same package as log1p()
and expm1().  I think the add and subtraction versions are the most useful
and the sum version would be very nice to have.

Bill Dunlap
Spotfire, TIBCO Software
wdunlap tibco.com


From szehnder at uni-bonn.de  Fri Nov  8 10:51:24 2013
From: szehnder at uni-bonn.de (Simon Zehnder)
Date: Fri, 8 Nov 2013 10:51:24 +0100
Subject: [Rd] R CMD INSTALL - problem with working directory
Message-ID: <0F3BFD85-4E89-43ED-8F25-6013EFE75630@uni-bonn.de>

Dear R-Devels,

I installed on my Mac OS X 10.9 system several R-3.0.2 versions, differing by the compiler used to build R. I can load them via my environment-modules. 

Now, what I want to have is for each version an own working directory such that .RData and .Rhistory are not loaded from a different version. I did that by adding setwd(?~/Library/R/R-gcc") to my Rprofile.site. This works fine, when I call R and work inside of it. 

Though when testing my own packages, I need R CMD INSTALL and this does not work when not called from the set working directory, i.e. for the example above ~/Library/R/R-gcc. If I am not in this directory I get the well-known issue

Warning: invalid package ?pkg/?
Error: ERROR: no packages specified

Instead, calling R CMD INSTALL from ~/Library/R/R-gcc works fine. 

I checked the permissions on ~/Library/R/R-gcc in R. These seem to be fine to me:

system("ls -hFGlxo /Users/simonzehnder/Library/R/R-gcc")
total 0
drwxr-xr-x  7 simonzehnder   238B Nov  8 10:37 library/

R CMD INSTALL seems to need a working directory that equals the actual working directory. Is there a workaround, that makes things work for me?

Best

Simon


From ripley at stats.ox.ac.uk  Fri Nov  8 21:39:40 2013
From: ripley at stats.ox.ac.uk (Prof Brian Ripley)
Date: Fri, 08 Nov 2013 20:39:40 +0000
Subject: [Rd] CRAN package 5000
Message-ID: <527D4C0C.6000400@stats.ox.ac.uk>

Package 'quint' brought the number of packages on CRAN (for all 
platforms: some are Windows-only or non-Windows only) to 5000 a few 
minutes ago: see http://cran.r-project.org/web/packages/index.html .

-- 
Brian D. Ripley,                  ripley at stats.ox.ac.uk
Professor of Applied Statistics,  http://www.stats.ox.ac.uk/~ripley/
University of Oxford,             Tel:  +44 1865 272861 (self)
1 South Parks Road,                     +44 1865 272866 (PA)
Oxford OX1 3TG, UK                Fax:  +44 1865 272595


From david at revolutionanalytics.com  Fri Nov  8 21:46:32 2013
From: david at revolutionanalytics.com (David Smith)
Date: Fri, 8 Nov 2013 12:46:32 -0800
Subject: [Rd] CRAN package 5000
In-Reply-To: <527D4C0C.6000400@stats.ox.ac.uk>
References: <527D4C0C.6000400@stats.ox.ac.uk>
Message-ID: <CABgvEC_6deMOi7afth06EiDVmespA3wtj=Q0fL-5X-di2FatpA@mail.gmail.com>

Congratulations, that's quite a milestone! Many thanks to you and the
other CRAN volunteers for reviewing, responding to, and approving all
of these contributions, and for maintaining the CRAN infrastructure
itself.

# David
-- 
David M Smith <david at revolutionanalytics.com>
VP of Marketing, Revolution Analytics  http://blog.revolutionanalytics.com
Tel: +1 (650) 646-9523 (Seattle WA, USA)
Twitter: @revodavid
We're hiring! www.revolutionanalytics.com/careers


On Fri, Nov 8, 2013 at 12:39 PM, Prof Brian Ripley
<ripley at stats.ox.ac.uk> wrote:
> Package 'quint' brought the number of packages on CRAN (for all platforms:
> some are Windows-only or non-Windows only) to 5000 a few minutes ago: see
> http://cran.r-project.org/web/packages/index.html .
>
> --
> Brian D. Ripley,                  ripley at stats.ox.ac.uk
> Professor of Applied Statistics,  http://www.stats.ox.ac.uk/~ripley/
> University of Oxford,             Tel:  +44 1865 272861 (self)
> 1 South Parks Road,                     +44 1865 272866 (PA)
> Oxford OX1 3TG, UK                Fax:  +44 1865 272595
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


From hb at biostat.ucsf.edu  Fri Nov  8 22:58:52 2013
From: hb at biostat.ucsf.edu (Henrik Bengtsson)
Date: Fri, 8 Nov 2013 13:58:52 -0800
Subject: [Rd] Milestone: 5000 packages on CRAN
In-Reply-To: <CAFDcVCTP+_baXBgPzk3Vz4VfMq-w0QeK-ShgZY0hR6izLtKONQ@mail.gmail.com>
References: <CAFDcVCTP+_baXBgPzk3Vz4VfMq-w0QeK-ShgZY0hR6izLtKONQ@mail.gmail.com>
Message-ID: <CAFDcVCRWHc9SWLjrrSYLHWc47OGf4YW12Niaaf-JrkcuD5OCTg@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131108/45f4ac90/attachment.pl>

From wdunlap at tibco.com  Sat Nov  9 01:43:54 2013
From: wdunlap at tibco.com (William Dunlap)
Date: Sat, 9 Nov 2013 00:43:54 +0000
Subject: [Rd] Milestone: 5000 packages on CRAN
In-Reply-To: <CAFDcVCRWHc9SWLjrrSYLHWc47OGf4YW12Niaaf-JrkcuD5OCTg@mail.gmail.com>
References: <CAFDcVCTP+_baXBgPzk3Vz4VfMq-w0QeK-ShgZY0hR6izLtKONQ@mail.gmail.com>
	<CAFDcVCRWHc9SWLjrrSYLHWc47OGf4YW12Niaaf-JrkcuD5OCTg@mail.gmail.com>
Message-ID: <E66794E69CFDE04D9A70842786030B933FA13B5F@PA-MBX01.na.tibco.com>

> "Currently, the CRAN package repository features 5001 available packages."
> 
> Going from 4000 to 5000 packages took 14.5 months - that's one new package
> every 10.5 hours. Behind every package there are real people. These
> user-contributed packages are maintained by ~2900 people [2] - that's 350
> new maintainers and many more contributors. More people to thank than ever
> before - don't forget about them, e.g. cite properly when publishing.

Congratulations!

I have often wondered about the natural history of R packages: how often they
are created and shared, how long they are used, how many people use them,
how long they are maintained, etc.  The usage numbers are hard to get, but the
"Last modified" dates in the CRAN archives do give some information on how
often new packages are shared and how long they are maintained.

Here are some summaries of derived from those dates.  The code to get the
data and calculate (and plot) the summaries follows.

> newPkgsByYear

1997-01-01 1998-01-01 1999-01-01 2000-01-01 
         2         12         56         41 
2001-01-01 2002-01-01 2003-01-01 2004-01-01 
        65         66        101        144 
2005-01-01 2006-01-01 2007-01-01 2008-01-01 
       209        280        329        374 
2009-01-01 2010-01-01 2011-01-01 2012-01-01 
       502        546        702        809 
2013-01-01 
       439
> table(nUpdatesSinceSep2011) # number of recent updates (not including original submission)
nUpdatesSinceSep2011
   0    1    2    3    4    5    6    7    8    9 
2079  963  528  332  238  166   75   79   50   43 
  10   11   12   13   14   15   16   17   18   19 
  23   22   13   14    8    9   12    5    4    1 
  20   21   22   24   26   27   31   32   34 
   1    3    1    2    1    2    1    1    1

The code I used is:

library(XML)
getArchiveList <- function(site = "http://cran.r-project.org/src/contrib/Archive/") {
    retval <- readHTMLTable(site, stringsAsFactors=FALSE)[[1]]
    retval <- retval[!is.na(retval$Name) & grepl("/$", retval$Name), ]
    retval$Name <- gsub("/$", "", retval$Name)
    retval$"Last modified" <- as.Date(retval$"Last modified", format="%d-%b-%Y")
    retval
}
getArchiveEntry <- function(Name, site = "http://cran.r-project.org/src/contrib/Archive/") {
    retval <- readHTMLTable(paste0(site, Name), stringsAsFactors=FALSE)[[1]]
    retval <- retval[!is.na(retval$Name) & retval$Name != "Parent Directory", ]
    retval$"Last modified" <- as.Date(retval$"Last modified", format="%d-%b-%Y")
    retval
}

al <- getArchiveList()
# The next may bog down the CRAN archive server - do not do it often
# ae <- lapply(structure(al$Name, names=al$Name),
#              function(Name)tryCatch(getArchiveEntry(Name),
#                                     error=function(e)data.frame(Name=character(), "Last Modified" = as.Date(character()))))

initialSubmissionDate <- as.Date(vapply(ae, function(e)min(e[["Last modified"]]), 0), origin=as.Date("1970-01-01"))
lastSubmissionDate <- as.Date(vapply(ae, function(e)max(e[["Last modified"]]), 0), origin=as.Date("1970-01-01"))

mths <- seq(as.Date("1997-10-01"), as.Date("2014-01-01"), by="months")
yrs <- seq(as.Date("1997-01-01"), as.Date("2014-01-01"), by="years")

par(ask=TRUE)

newPkgsByMonth <-  table(cut(initialSubmissionDate, mths))
newPkgsByYear <-  table(cut(initialSubmissionDate, yrs))
plot(mths[-1], newPkgsByMonth, log="y", ylab="# New Pkgs", main="New packages by month") # number of additions each month

yearsOfMaintainanceActivity <- as.numeric(lastSubmissionDate - initialSubmissionDate, units="days")/365.25
hist(yearsOfMaintainanceActivity, xlab="Years", main="Maintainance Duration")

newPkgsByYear
table(floor(yearsOfMaintainanceActivity))

nUpdatesSinceSep2011 <- vapply(ae, function(e){
    Lm <- e[["Last modified"]]
    sum(Lm >= as.Date("2011-09-01") & Lm != min(Lm))}, 0L)
table(nUpdatesSinceSep2011) # number of recent updates (not including original submission)

Bill Dunlap
Spotfire, TIBCO Software
wdunlap tibco.com


> -----Original Message-----
> From: r-devel-bounces at r-project.org [mailto:r-devel-bounces at r-project.org] On Behalf
> Of Henrik Bengtsson
> Sent: Friday, November 08, 2013 1:59 PM
> To: R Development Mailing List
> Subject: [Rd] Milestone: 5000 packages on CRAN
> 
> Here we go again...
> 
> Today (2011-11-08) on The Comprehensive R Archive Network (CRAN) [1]:
> 
> "Currently, the CRAN package repository features 5001 available packages."
> 
> Going from 4000 to 5000 packages took 14.5 months - that's one new package
> every 10.5 hours. Behind every package there are real people. These
> user-contributed packages are maintained by ~2900 people [2] - that's 350
> new maintainers and many more contributors. More people to thank than ever
> before - don't forget about them, e.g. cite properly when publishing.
> 
> Milestones:
> 
> 2013-11-08: 5000 packages [this post]
> 2012-08-23: 4000 packages [7]
> 2011-05-12: 3000 packages [6]
> 2009-10-04: 2000 packages [5]
> 2007-04-12: 1000 packages [4]
> 2004-10-01: 500 packages [3,4]
> 2003-04-01: 250 packages [3,4]
> 
> [1] http://cran.r-project.org/web/packages/
> [2] http://cran.r-project.org/web/checks/check_summary_by_maintainer.html
> [3] Private data.
> [4] https://stat.ethz.ch/pipermail/r-devel/2007-April/045359.html
> [5] https://stat.ethz.ch/pipermail/r-devel/2009-October/055049.html
> [6] https://stat.ethz.ch/pipermail/r-devel/2011-May/061002.html
> [7] https://stat.ethz.ch/pipermail/r-devel/2012-August/064675.html
> 
> /Henrik
> 
> PS. These data are for CRAN only. There are more packages elsewhere, e.g.
> R-Forge, Bioconductor, Github etc.
> 
> 	[[alternative HTML version deleted]]
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


From spencer.graves at prodsyse.com  Sat Nov  9 03:13:49 2013
From: spencer.graves at prodsyse.com (Spencer Graves)
Date: Fri, 8 Nov 2013 18:13:49 -0800
Subject: [Rd] Milestone: 5000 packages on CRAN
In-Reply-To: <E66794E69CFDE04D9A70842786030B933FA13B5F@PA-MBX01.na.tibco.com>
References: <CAFDcVCTP+_baXBgPzk3Vz4VfMq-w0QeK-ShgZY0hR6izLtKONQ@mail.gmail.com>	<CAFDcVCRWHc9SWLjrrSYLHWc47OGf4YW12Niaaf-JrkcuD5OCTg@mail.gmail.com>
	<E66794E69CFDE04D9A70842786030B933FA13B5F@PA-MBX01.na.tibco.com>
Message-ID: <527D9A5D.6040406@prodsyse.com>

       CRAN size has grown almost exponentially at least since 2001.  R 
history was discussed by John Fox (2009) Aspects of the Social 
Organization and Trajectory of the R Project, R Journal 
(http://journal.r-project.org/archive/2009-2/RJournal_2009-2_Fox.pdf). 
Below please find his data plus 5 additional points I added and R script 
I used to fit a models.


       I won't defend the models fit in the script below.  However, 
unless CRAN management changes dramatically in the next 5 years, it 
seems likely that CRAN will have 10,000 packages some time in 2018.


       By the way, if you don't already use the sos package routinely, I 
encourage you to consider it.  For me, it's by far the fastest 
literature search for anything statistical.  In a very few minutes, I 
get an Excel file with a summary by package of the matches to almost any 
combination of search terms.  (Shameless plug by the lead author of the 
package ;-)


       Best Wishes,
       Spencer Graves


date    packages
2001-06-21    110
2001-12-17    129
2002-06-12    162
2003-05-27    219
2003-11-16    273
2004-06-05    357
2004-10-12    406
2005-06-18    548
2005-12-16    647
2006-05-31    739
2006-12-12    911
2007-04-12    1000
2007-11-16    1300
2008-03-18    1427
2008-10-18    1614
2009-09-17    1952
2012-06-12    3786
2012-11-01    4082
2012-12-14    4210
2013-10-28    4960
2013-11-08    5000

library(gdata)

(CRANfile <- dir(pattern='s\\.xls$'))
#readLines(CRANfile)
str(CRANhist. <- read.xls(CRANfile, stringsAsFactors=FALSE,
                            header=TRUE))
tail(CRANhist., 11)
CRANhist <- CRANhist.[1:20, 1:2]

(dt. <- as.Date(CRANhist$date))
CRANhist$date <- dt.

(day1 <- min(CRANhist$date)) # 2001-06-21
str(ddate <- CRANhist$date-day1)
# difftime in days

CRANhist$CRANdays <- as.numeric(ddate)
(growth <- lm(log(packages)~CRANdays, CRANhist))

CRANhist$pred <- exp(predict(growth))
plot(packages~date, CRANhist, log='y')
lines(pred~date, CRANhist, pch='.')

fitLogLogis <- nls(log(packages) ~ a+b*CRANdays + log(1+exp(d+b*CRANdays)),
                    CRANhist, start=c(a=4.9, b=0.0009, d=0))
# Error ... singular gradient

library(drc)
CRANlogLogis <- drm(packages~CRANdays, data=CRANhist, fct=LL.3())
plot(CRANlogLogis, log='y') # very poor through 2005

CRANlogLogis. <- drm(log(packages)~CRANdays, data=CRANhist, fct=LL.3())
plot(CRANlogLogis., log='y') # terrible:  far worse than CRANlogLogis

CRANlogLogis4 <- drm(packages~CRANdays, data=CRANhist, fct=LL.4())
plot(CRANlogLogis4, log='y') # poor for 2001 but great otherwise

CRANlogLogis4. <- drm(log(packages)~CRANdays, data=CRANhist, fct=LL.4())
plot(CRANlogLogis4., log='y') # best I've found so far.
abline(h=c(4200, 8400))

sapply(CRANhist, range)
pred.dTimes <- seq(0, 6000, 100)
CRANpred <- predict(CRANlogLogis4., data.frame(CRANdays=pred.dTimes))
data.frame(Date=as.Date(day1+pred.dTimes), nPkgs=exp(CRANpred))

plot(day1+pred.dTimes, exp(CRANpred), type='l', log='y')
points(packages~date, CRANhist)

pred.dTimes <- seq(0, 10000, 100)
CRANpred <- predict(CRANlogLogis4., data.frame(CRANdays=pred.dTimes))

plot(day1+pred.dTimes, exp(CRANpred), type='l', log='y')
points(packages~date, CRANhist)
abline(h=c(4200, 8400))
abline(v=as.Date('2012-12-14'))
abline(v=as.Date('2017-09-30'))

#########################

abline(h=20000)
abline(h=70000)

pred.dTimes <- seq(0, 1000000, 10000)
CRANpred <- predict(CRANlogLogis4., data.frame(CRANdays=pred.dTimes))
plot(day1+pred.dTimes, exp(CRANpred), type='l', log='y')
points(packages~date, CRANhist)


On 11/8/2013 4:43 PM, William Dunlap wrote:
>> "Currently, the CRAN package repository features 5001 available packages."
>>
>> Going from 4000 to 5000 packages took 14.5 months - that's one new package
>> every 10.5 hours. Behind every package there are real people. These
>> user-contributed packages are maintained by ~2900 people [2] - that's 350
>> new maintainers and many more contributors. More people to thank than ever
>> before - don't forget about them, e.g. cite properly when publishing.
> Congratulations!
>
> I have often wondered about the natural history of R packages: how often they
> are created and shared, how long they are used, how many people use them,
> how long they are maintained, etc.  The usage numbers are hard to get, but the
> "Last modified" dates in the CRAN archives do give some information on how
> often new packages are shared and how long they are maintained.
>
> Here are some summaries of derived from those dates.  The code to get the
> data and calculate (and plot) the summaries follows.
>
>> newPkgsByYear
> 1997-01-01 1998-01-01 1999-01-01 2000-01-01
>           2         12         56         41
> 2001-01-01 2002-01-01 2003-01-01 2004-01-01
>          65         66        101        144
> 2005-01-01 2006-01-01 2007-01-01 2008-01-01
>         209        280        329        374
> 2009-01-01 2010-01-01 2011-01-01 2012-01-01
>         502        546        702        809
> 2013-01-01
>         439
>> table(nUpdatesSinceSep2011) # number of recent updates (not including original submission)
> nUpdatesSinceSep2011
>     0    1    2    3    4    5    6    7    8    9
> 2079  963  528  332  238  166   75   79   50   43
>    10   11   12   13   14   15   16   17   18   19
>    23   22   13   14    8    9   12    5    4    1
>    20   21   22   24   26   27   31   32   34
>     1    3    1    2    1    2    1    1    1
>
> The code I used is:
>
> library(XML)
> getArchiveList <- function(site = "http://cran.r-project.org/src/contrib/Archive/") {
>      retval <- readHTMLTable(site, stringsAsFactors=FALSE)[[1]]
>      retval <- retval[!is.na(retval$Name) & grepl("/$", retval$Name), ]
>      retval$Name <- gsub("/$", "", retval$Name)
>      retval$"Last modified" <- as.Date(retval$"Last modified", format="%d-%b-%Y")
>      retval
> }
> getArchiveEntry <- function(Name, site = "http://cran.r-project.org/src/contrib/Archive/") {
>      retval <- readHTMLTable(paste0(site, Name), stringsAsFactors=FALSE)[[1]]
>      retval <- retval[!is.na(retval$Name) & retval$Name != "Parent Directory", ]
>      retval$"Last modified" <- as.Date(retval$"Last modified", format="%d-%b-%Y")
>      retval
> }
>
> al <- getArchiveList()
> # The next may bog down the CRAN archive server - do not do it often
> # ae <- lapply(structure(al$Name, names=al$Name),
> #              function(Name)tryCatch(getArchiveEntry(Name),
> #                                     error=function(e)data.frame(Name=character(), "Last Modified" = as.Date(character()))))
>
> initialSubmissionDate <- as.Date(vapply(ae, function(e)min(e[["Last modified"]]), 0), origin=as.Date("1970-01-01"))
> lastSubmissionDate <- as.Date(vapply(ae, function(e)max(e[["Last modified"]]), 0), origin=as.Date("1970-01-01"))
>
> mths <- seq(as.Date("1997-10-01"), as.Date("2014-01-01"), by="months")
> yrs <- seq(as.Date("1997-01-01"), as.Date("2014-01-01"), by="years")
>
> par(ask=TRUE)
>
> newPkgsByMonth <-  table(cut(initialSubmissionDate, mths))
> newPkgsByYear <-  table(cut(initialSubmissionDate, yrs))
> plot(mths[-1], newPkgsByMonth, log="y", ylab="# New Pkgs", main="New packages by month") # number of additions each month
>
> yearsOfMaintainanceActivity <- as.numeric(lastSubmissionDate - initialSubmissionDate, units="days")/365.25
> hist(yearsOfMaintainanceActivity, xlab="Years", main="Maintainance Duration")
>
> newPkgsByYear
> table(floor(yearsOfMaintainanceActivity))
>
> nUpdatesSinceSep2011 <- vapply(ae, function(e){
>      Lm <- e[["Last modified"]]
>      sum(Lm >= as.Date("2011-09-01") & Lm != min(Lm))}, 0L)
> table(nUpdatesSinceSep2011) # number of recent updates (not including original submission)
>
> Bill Dunlap
> Spotfire, TIBCO Software
> wdunlap tibco.com
>
>
>> -----Original Message-----
>> From: r-devel-bounces at r-project.org [mailto:r-devel-bounces at r-project.org] On Behalf
>> Of Henrik Bengtsson
>> Sent: Friday, November 08, 2013 1:59 PM
>> To: R Development Mailing List
>> Subject: [Rd] Milestone: 5000 packages on CRAN
>>
>> Here we go again...
>>
>> Today (2011-11-08) on The Comprehensive R Archive Network (CRAN) [1]:
>>
>> "Currently, the CRAN package repository features 5001 available packages."
>>
>> Going from 4000 to 5000 packages took 14.5 months - that's one new package
>> every 10.5 hours. Behind every package there are real people. These
>> user-contributed packages are maintained by ~2900 people [2] - that's 350
>> new maintainers and many more contributors. More people to thank than ever
>> before - don't forget about them, e.g. cite properly when publishing.
>>
>> Milestones:
>>
>> 2013-11-08: 5000 packages [this post]
>> 2012-08-23: 4000 packages [7]
>> 2011-05-12: 3000 packages [6]
>> 2009-10-04: 2000 packages [5]
>> 2007-04-12: 1000 packages [4]
>> 2004-10-01: 500 packages [3,4]
>> 2003-04-01: 250 packages [3,4]
>>
>> [1] http://cran.r-project.org/web/packages/
>> [2] http://cran.r-project.org/web/checks/check_summary_by_maintainer.html
>> [3] Private data.
>> [4] https://stat.ethz.ch/pipermail/r-devel/2007-April/045359.html
>> [5] https://stat.ethz.ch/pipermail/r-devel/2009-October/055049.html
>> [6] https://stat.ethz.ch/pipermail/r-devel/2011-May/061002.html
>> [7] https://stat.ethz.ch/pipermail/r-devel/2012-August/064675.html
>>
>> /Henrik
>>
>> PS. These data are for CRAN only. There are more packages elsewhere, e.g.
>> R-Forge, Bioconductor, Github etc.
>>
>> 	[[alternative HTML version deleted]]
>>
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


-- 
Spencer Graves, PE, PhD
President and Chief Technology Officer
Structure Inspection and Monitoring, Inc.
751 Emerson Ct.
San Jos?, CA 95126
ph:  408-655-4567
web:  www.structuremonitoring.com


From jennifer.s.lyon at gmail.com  Sat Nov  9 15:34:59 2013
From: jennifer.s.lyon at gmail.com (Jennifer Lyon)
Date: Sat, 9 Nov 2013 07:34:59 -0700
Subject: [Rd] typo in help page for log1p
Message-ID: <CAKstpn6gFkWBqabbmwCbYB+4gewqna+s_OpJOvPas7kL8SQyqg@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131109/cdd8e268/attachment.pl>

From ligges at statistik.tu-dortmund.de  Sat Nov  9 16:36:54 2013
From: ligges at statistik.tu-dortmund.de (Uwe Ligges)
Date: Sat, 09 Nov 2013 16:36:54 +0100
Subject: [Rd] typo in help page for log1p
In-Reply-To: <CAKstpn6gFkWBqabbmwCbYB+4gewqna+s_OpJOvPas7kL8SQyqg@mail.gmail.com>
References: <CAKstpn6gFkWBqabbmwCbYB+4gewqna+s_OpJOvPas7kL8SQyqg@mail.gmail.com>
Message-ID: <527E5696.8080000@statistik.tu-dortmund.de>



On 09.11.2013 15:34, Jennifer Lyon wrote:
> There is a small typo in the Source section of the help page
> for log1p:
>
> Source:
>
>       'log1p' and 'expm1' may be taken from the operating system, but if
>       not available there are based on the Fortran subroutine 'dlnrel'
>
> there -> they

Thanks, fixed,
Uwe Ligges

>
> Jen
>
>> sessionInfo()
> R version 3.0.2 (2013-09-25)
> Platform: x86_64-unknown-linux-gnu (64-bit)
>
> locale:
>   [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C
>   [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8
>   [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8
>   [7] LC_PAPER=en_US.UTF-8       LC_NAME=C
>   [9] LC_ADDRESS=C               LC_TELEPHONE=C
> [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C
>
> attached base packages:
> [1] stats     graphics  grDevices utils     datasets  methods   base
>
> loaded via a namespace (and not attached):
> [1] tools_3.0.2
>
> 	[[alternative HTML version deleted]]
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
>


From stausland.johnsen at iln.uio.no  Sat Nov  9 18:07:56 2013
From: stausland.johnsen at iln.uio.no (Sverre Stausland)
Date: Sat, 9 Nov 2013 18:07:56 +0100
Subject: [Rd] Support writing UTF-8 output in Windows
Message-ID: <CACtaF7xhmkyuALWyB3LZqEwBAwDwO6J5z5YM6ThQQ=0MuNZY6A@mail.gmail.com>

As recently discussed on Stack Overflow, R for Mac OS and Ubuntu (so
probably all Unix systems) can correctly write files with UTF-8
encoding, but R for Windows cannot:

http://stackoverflow.com/questions/19877676/write-utf-8-files-from-r

I strongly suggest that R for Windows should support this feature in
upcoming versions.

Sverre


From murdoch.duncan at gmail.com  Sat Nov  9 21:04:03 2013
From: murdoch.duncan at gmail.com (Duncan Murdoch)
Date: Sat, 09 Nov 2013 15:04:03 -0500
Subject: [Rd] Support writing UTF-8 output in Windows
In-Reply-To: <CACtaF7xhmkyuALWyB3LZqEwBAwDwO6J5z5YM6ThQQ=0MuNZY6A@mail.gmail.com>
References: <CACtaF7xhmkyuALWyB3LZqEwBAwDwO6J5z5YM6ThQQ=0MuNZY6A@mail.gmail.com>
Message-ID: <527E9533.4070609@gmail.com>

On 13-11-09 12:07 PM, Sverre Stausland wrote:
> As recently discussed on Stack Overflow, R for Mac OS and Ubuntu (so
> probably all Unix systems) can correctly write files with UTF-8
> encoding, but R for Windows cannot:

That's not an accurate description of the problem.  Some functions in R 
convert values to the native encoding, but not all do.

> http://stackoverflow.com/questions/19877676/write-utf-8-files-from-r
>
> I strongly suggest that R for Windows should support this feature in
> upcoming versions.

It's not trivial to do.  When R was written, and perhaps still on some 
obscure platforms, there wasn't any way to do that--Windows didn't 
support UTF-8 then, just Microsoft's version of UCS-2 and a variety of 
other more limited encodings.  Unix platforms didn't support UCS-2.  So 
internally R keeps many things in the native encoding.

If you decide to rewrite R from scratch now, I'd suggest that you handle 
things differently.  If you'd rather not rewrite it yourself, then I 
don't know how you will convince someone else to take on that job.

You might find it easier to convince Microsoft to add a UTF-8 locale, so 
then the native encoding would be UTF-8, and the problem would go away.

Duncan Murdoch


From bbolker at gmail.com  Sun Nov 10 00:58:50 2013
From: bbolker at gmail.com (Ben Bolker)
Date: Sat, 9 Nov 2013 23:58:50 +0000
Subject: [Rd] Support writing UTF-8 output in Windows
References: <CACtaF7xhmkyuALWyB3LZqEwBAwDwO6J5z5YM6ThQQ=0MuNZY6A@mail.gmail.com>
	<527E9533.4070609@gmail.com>
Message-ID: <loom.20131110T005635-798@post.gmane.org>

Duncan Murdoch <murdoch.duncan <at> gmail.com> writes:

> 
> On 13-11-09 12:07 PM, Sverre Stausland wrote:
> > As recently discussed on Stack Overflow, R for Mac OS and Ubuntu (so
> > probably all Unix systems) can correctly write files with UTF-8
> > encoding, but R for Windows cannot:
> 
> That's not an accurate description of the problem.  Some functions in R 
> convert values to the native encoding, but not all do.
> 
> > http://stackoverflow.com/questions/19877676/write-utf-8-files-from-r
> >
> > I strongly suggest that R for Windows should support this feature in
> > upcoming versions.
> 
> It's not trivial to do.  When R was written, and perhaps still on some 
> obscure platforms, there wasn't any way to do that--Windows didn't 
> support UTF-8 then, just Microsoft's version of UCS-2 and a variety of 
> other more limited encodings.  Unix platforms didn't support UCS-2.  So 
> internally R keeps many things in the native encoding.
> 
> If you decide to rewrite R from scratch now, I'd suggest that you handle 
> things differently.  If you'd rather not rewrite it yourself, then I 
> don't know how you will convince someone else to take on that job.
> 
> You might find it easier to convince Microsoft to add a UTF-8 locale, so 
> then the native encoding would be UTF-8, and the problem would go away.
> 
> Duncan Murdoch

  Would it be fairer / more productive to say/ask: 

* it would be nice if write.table could write files in UTF-8 encoding
* is there any documentation already available about which R functions
_do_ handle UTF-8 output on Windows, and how they do it?  
* could they be used as models for adapting write.table to write files
in UTF-8 encoding on Windows?

  i.e., instead of "convert R to output UTF-8 universally on Windows",
"figure out how to make write.table output UTF-8 on Windows, or
suggest a workaround" ?

  Ben Bolker


From phgrosjean at sciviews.org  Sun Nov 10 09:56:51 2013
From: phgrosjean at sciviews.org (Philippe Grosjean)
Date: Sun, 10 Nov 2013 09:56:51 +0100
Subject: [Rd] Support writing UTF-8 output in Windows
In-Reply-To: <loom.20131110T005635-798@post.gmane.org>
References: <CACtaF7xhmkyuALWyB3LZqEwBAwDwO6J5z5YM6ThQQ=0MuNZY6A@mail.gmail.com>
	<527E9533.4070609@gmail.com>
	<loom.20131110T005635-798@post.gmane.org>
Message-ID: <D257F940-B984-48C3-9E45-C5C86D53DAA1@sciviews.org>

To continue this discussion with constructive propositions, here is a page that provides useful tracks for using UTF-8 on Windows: http://www.utf8everywhere.org (second half of the page).

On 10 Nov 2013, at 00:58, Ben Bolker <bbolker at gmail.com> wrote:

> Duncan Murdoch <murdoch.duncan <at> gmail.com> writes:
> 
>> 
>> On 13-11-09 12:07 PM, Sverre Stausland wrote:
>>> As recently discussed on Stack Overflow, R for Mac OS and Ubuntu (so
>>> probably all Unix systems) can correctly write files with UTF-8
>>> encoding, but R for Windows cannot:
>> 
>> That's not an accurate description of the problem.  Some functions in R 
>> convert values to the native encoding, but not all do.
>> 
>>> http://stackoverflow.com/questions/19877676/write-utf-8-files-from-r
>>> 
>>> I strongly suggest that R for Windows should support this feature in
>>> upcoming versions.
>> 
>> It's not trivial to do.  When R was written, and perhaps still on some 
>> obscure platforms, there wasn't any way to do that--Windows didn't 
>> support UTF-8 then, just Microsoft's version of UCS-2 and a variety of 
>> other more limited encodings.  Unix platforms didn't support UCS-2.  So 
>> internally R keeps many things in the native encoding.
>> 
>> If you decide to rewrite R from scratch now, I'd suggest that you handle 
>> things differently.  If you'd rather not rewrite it yourself, then I 
>> don't know how you will convince someone else to take on that job.
>> 
>> You might find it easier to convince Microsoft to add a UTF-8 locale, so 
>> then the native encoding would be UTF-8, and the problem would go away.
>> 
>> Duncan Murdoch

I can easily understand this is a huge work? and that R Core Team is not ready to endorse it (now? alone?). However, I am not happy at all to read such kind of sarkastic answer from someone belonging to the R Core Team. This is a serious problem in R under Windows and it would make life a lot more easier to everyone if R could be UTF-8 compliant an *all* supported platforms/OSes.

Philippe Grosjean 


> 
>  Would it be fairer / more productive to say/ask: 
> 
> * it would be nice if write.table could write files in UTF-8 encoding
> * is there any documentation already available about which R functions
> _do_ handle UTF-8 output on Windows, and how they do it?  
> * could they be used as models for adapting write.table to write files
> in UTF-8 encoding on Windows?
> 
>  i.e., instead of "convert R to output UTF-8 universally on Windows",
> "figure out how to make write.table output UTF-8 on Windows, or
> suggest a workaround" ?
> 
>  Ben Bolker
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
> 


From murdoch.duncan at gmail.com  Sun Nov 10 12:39:01 2013
From: murdoch.duncan at gmail.com (Duncan Murdoch)
Date: Sun, 10 Nov 2013 06:39:01 -0500
Subject: [Rd] Support writing UTF-8 output in Windows
In-Reply-To: <loom.20131110T005635-798@post.gmane.org>
References: <CACtaF7xhmkyuALWyB3LZqEwBAwDwO6J5z5YM6ThQQ=0MuNZY6A@mail.gmail.com>	<527E9533.4070609@gmail.com>
	<loom.20131110T005635-798@post.gmane.org>
Message-ID: <527F7055.7090707@gmail.com>

On 13-11-09 6:58 PM, Ben Bolker wrote:
> Duncan Murdoch <murdoch.duncan <at> gmail.com> writes:
>
>>
>> On 13-11-09 12:07 PM, Sverre Stausland wrote:
>>> As recently discussed on Stack Overflow, R for Mac OS and Ubuntu (so
>>> probably all Unix systems) can correctly write files with UTF-8
>>> encoding, but R for Windows cannot:
>>
>> That's not an accurate description of the problem.  Some functions in R
>> convert values to the native encoding, but not all do.
>>
>>> http://stackoverflow.com/questions/19877676/write-utf-8-files-from-r
>>>
>>> I strongly suggest that R for Windows should support this feature in
>>> upcoming versions.
>>
>> It's not trivial to do.  When R was written, and perhaps still on some
>> obscure platforms, there wasn't any way to do that--Windows didn't
>> support UTF-8 then, just Microsoft's version of UCS-2 and a variety of
>> other more limited encodings.  Unix platforms didn't support UCS-2.  So
>> internally R keeps many things in the native encoding.
>>
>> If you decide to rewrite R from scratch now, I'd suggest that you handle
>> things differently.  If you'd rather not rewrite it yourself, then I
>> don't know how you will convince someone else to take on that job.
>>
>> You might find it easier to convince Microsoft to add a UTF-8 locale, so
>> then the native encoding would be UTF-8, and the problem would go away.
>>
>> Duncan Murdoch
>
>    Would it be fairer / more productive to say/ask:
>
> * it would be nice if write.table could write files in UTF-8 encoding

I agree.  A couple of months ago I investigated the fact that read.table 
could not read UTF-8 files if the characters could not be converted to 
the local encoding.  (E.g. reading Russian characters in an English 
locale seemed to be impossible.)  readLines() can read them, but 
read.table converted them to the native encoding and that killed them.

This is probably fixable, but it requires low level changes to a very 
commonly used function, so it's likely to break something somewhere.

I haven't looked closely at write.table, but I suspect the problem there 
is with format(). Connections know their encoding, but format() converts 
to the native encoding.

> * is there any documentation already available about which R functions
> _do_ handle UTF-8 output on Windows, and how they do it?

I don't think so.  In general, functions that convert to the native 
encoding break UTF-8 on Windows, because the native encoding is often 
Latin1 or some other encoding that doesn't cover all the characters in 
UTF-8.  If you look through the source you can work out which ones those 
are, but it's not easy.

> * could they be used as models for adapting write.table to write files
> in UTF-8 encoding on Windows?
>
>    i.e., instead of "convert R to output UTF-8 universally on Windows",
> "figure out how to make write.table output UTF-8 on Windows, or
> suggest a workaround" ?

I imagine if I (or someone else) attempt to get read.table working in 
this situation then I'd try to get write.table working too.

Duncan Murdoch


From stausland.johnsen at iln.uio.no  Sun Nov 10 13:31:54 2013
From: stausland.johnsen at iln.uio.no (Sverre Stausland)
Date: Sun, 10 Nov 2013 13:31:54 +0100
Subject: [Rd] Support writing UTF-8 output in Windows
In-Reply-To: <527E9533.4070609@gmail.com>
References: <CACtaF7xhmkyuALWyB3LZqEwBAwDwO6J5z5YM6ThQQ=0MuNZY6A@mail.gmail.com>
	<527E9533.4070609@gmail.com>
Message-ID: <CACtaF7wX8JcAhovaxnyvJVqJFBEeOcS6THzN7AEfP7_kv4U7eQ@mail.gmail.com>

My e-mail was intended as a typical "feature request", and I couldn't
find any more suitable place for that than the r-devel mailing list. I
am not a programmer, so I don't have the skills to write this into R's
source code myself.

The incentive is nevertheless clear enough. I believe a software
program in 2013 which imports, manipulates, and exports text in
various formats (text files, picture files, postscript files, etc.)
would normally be expected to support UTF-8. It might not be trivial
to implement as R is written now, but the expectation will still be
there. So I still believe it would be a good idea if R soon would be
able to support UTF-8.

I'm not quite able to piece together from the information you gave
what the underlying issues are. What I read is:
(1) Some R functions convert characters to the native encoding.
(2) Windows did not support UTF-8 when R was first written.
(3) Unix did not support UCS-2 when R was first written.

I'm guessing here that the implications are:
(1) R's write.table() converts characters to a native encoding.
(2) The native encoding in Windows 7 is not UTF-8.
(3) The native encoding in Unix systems is UTF-8.
But this is just guesswork.

PS. A related issue:
http://stackoverflow.com/questions/19881553/using-unicode-inside-rs-expression-command

Sverre


From murdoch.duncan at gmail.com  Sun Nov 10 13:49:22 2013
From: murdoch.duncan at gmail.com (Duncan Murdoch)
Date: Sun, 10 Nov 2013 07:49:22 -0500
Subject: [Rd] Support writing UTF-8 output in Windows
In-Reply-To: <CACtaF7wX8JcAhovaxnyvJVqJFBEeOcS6THzN7AEfP7_kv4U7eQ@mail.gmail.com>
References: <CACtaF7xhmkyuALWyB3LZqEwBAwDwO6J5z5YM6ThQQ=0MuNZY6A@mail.gmail.com>	<527E9533.4070609@gmail.com>
	<CACtaF7wX8JcAhovaxnyvJVqJFBEeOcS6THzN7AEfP7_kv4U7eQ@mail.gmail.com>
Message-ID: <527F80D2.5030504@gmail.com>

On 13-11-10 7:31 AM, Sverre Stausland wrote:
> My e-mail was intended as a typical "feature request", and I couldn't
> find any more suitable place for that than the r-devel mailing list. I
> am not a programmer, so I don't have the skills to write this into R's
> source code myself.
>
> The incentive is nevertheless clear enough. I believe a software
> program in 2013 which imports, manipulates, and exports text in
> various formats (text files, picture files, postscript files, etc.)
> would normally be expected to support UTF-8. It might not be trivial
> to implement as R is written now, but the expectation will still be
> there. So I still believe it would be a good idea if R soon would be
> able to support UTF-8.

R does support UTF-8.  It all works smoothly in a UTF-8 locale, not so 
smoothly if you have your computer set up to use a different 8 bit encoding.
>
> I'm not quite able to piece together from the information you gave
> what the underlying issues are. What I read is:
> (1) Some R functions convert characters to the native encoding.
> (2) Windows did not support UTF-8 when R was first written.
> (3) Unix did not support UCS-2 when R was first written.
>
> I'm guessing here that the implications are:
> (1) R's write.table() converts characters to a native encoding.
> (2) The native encoding in Windows 7 is not UTF-8.
> (3) The native encoding in Unix systems is UTF-8.

You got it right for the first 4.  Regarding (2) in your second list, 
that's right, and in fact UTF-8 is not supported as a native encoding.
And point (3) is optional, though UTF-8 is the dominant encoding nowadays.

The easiest solution is for you to switch to a Unix variant and set it 
up to use UTF-8 as the native encoding.

Next easiest would be for Microsoft to add UTF-8 as a code page.

Most difficult would be for R to handle UTF-8 properly on systems with 
limited support for it.

We probably will add small changes that let you work around the Windows 
problems, but they won't be very satisfactory to anyone.  I don't think 
we will make the big changes that would make R look like "a software 
program in 2013", since it would be so much work, and there's such an 
easy workaround.

Duncan Murdoch

> But this is just guesswork.


>
> PS. A related issue:
> http://stackoverflow.com/questions/19881553/using-unicode-inside-rs-expression-command
>
> Sverre
>


From stausland.johnsen at iln.uio.no  Sun Nov 10 20:41:22 2013
From: stausland.johnsen at iln.uio.no (Sverre Stausland)
Date: Sun, 10 Nov 2013 20:41:22 +0100
Subject: [Rd] Support writing UTF-8 output in Windows
In-Reply-To: <527F80D2.5030504@gmail.com>
References: <CACtaF7xhmkyuALWyB3LZqEwBAwDwO6J5z5YM6ThQQ=0MuNZY6A@mail.gmail.com>
	<527E9533.4070609@gmail.com>
	<CACtaF7wX8JcAhovaxnyvJVqJFBEeOcS6THzN7AEfP7_kv4U7eQ@mail.gmail.com>
	<527F80D2.5030504@gmail.com>
Message-ID: <CACtaF7zaHqPuQKib6t8TRyvxAjMpD7tdFeom8dUPGhE2irq4Fg@mail.gmail.com>

With respect to your comment (sorry, the e-mail you wrote that in
didn't get to my inbox):

>> I don't think so.  In general, functions that convert to the native
>> encoding break UTF-8 on Windows, because the native encoding is often
>> Latin1 or some other encoding that doesn't cover all the characters in
>> UTF-8.

As I understand it, the native encoding in Windows is UTF-18, not Latin1:
http://msdn.microsoft.com/en-us/library/dd374081.aspx

And UTF-18 is a superset of UTF-8, isn't it?

Sverre

On Sun, Nov 10, 2013 at 1:49 PM, Duncan Murdoch
<murdoch.duncan at gmail.com> wrote:
> On 13-11-10 7:31 AM, Sverre Stausland wrote:
>>
>> My e-mail was intended as a typical "feature request", and I couldn't
>> find any more suitable place for that than the r-devel mailing list. I
>> am not a programmer, so I don't have the skills to write this into R's
>> source code myself.
>>
>> The incentive is nevertheless clear enough. I believe a software
>> program in 2013 which imports, manipulates, and exports text in
>> various formats (text files, picture files, postscript files, etc.)
>> would normally be expected to support UTF-8. It might not be trivial
>> to implement as R is written now, but the expectation will still be
>> there. So I still believe it would be a good idea if R soon would be
>> able to support UTF-8.
>
>
> R does support UTF-8.  It all works smoothly in a UTF-8 locale, not so
> smoothly if you have your computer set up to use a different 8 bit encoding.
>
>>
>> I'm not quite able to piece together from the information you gave
>> what the underlying issues are. What I read is:
>> (1) Some R functions convert characters to the native encoding.
>> (2) Windows did not support UTF-8 when R was first written.
>> (3) Unix did not support UCS-2 when R was first written.
>>
>> I'm guessing here that the implications are:
>> (1) R's write.table() converts characters to a native encoding.
>> (2) The native encoding in Windows 7 is not UTF-8.
>> (3) The native encoding in Unix systems is UTF-8.
>
>
> You got it right for the first 4.  Regarding (2) in your second list, that's
> right, and in fact UTF-8 is not supported as a native encoding.
> And point (3) is optional, though UTF-8 is the dominant encoding nowadays.
>
> The easiest solution is for you to switch to a Unix variant and set it up to
> use UTF-8 as the native encoding.
>
> Next easiest would be for Microsoft to add UTF-8 as a code page.
>
> Most difficult would be for R to handle UTF-8 properly on systems with
> limited support for it.
>
> We probably will add small changes that let you work around the Windows
> problems, but they won't be very satisfactory to anyone.  I don't think we
> will make the big changes that would make R look like "a software program in
> 2013", since it would be so much work, and there's such an easy workaround.
>
> Duncan Murdoch
>
>
>> But this is just guesswork.
>
>
>
>>
>> PS. A related issue:
>>
>> http://stackoverflow.com/questions/19881553/using-unicode-inside-rs-expression-command
>>
>> Sverre
>>
>


From stausland.johnsen at iln.uio.no  Sun Nov 10 20:41:52 2013
From: stausland.johnsen at iln.uio.no (Sverre Stausland)
Date: Sun, 10 Nov 2013 20:41:52 +0100
Subject: [Rd] Support writing UTF-8 output in Windows
In-Reply-To: <CACtaF7zaHqPuQKib6t8TRyvxAjMpD7tdFeom8dUPGhE2irq4Fg@mail.gmail.com>
References: <CACtaF7xhmkyuALWyB3LZqEwBAwDwO6J5z5YM6ThQQ=0MuNZY6A@mail.gmail.com>
	<527E9533.4070609@gmail.com>
	<CACtaF7wX8JcAhovaxnyvJVqJFBEeOcS6THzN7AEfP7_kv4U7eQ@mail.gmail.com>
	<527F80D2.5030504@gmail.com>
	<CACtaF7zaHqPuQKib6t8TRyvxAjMpD7tdFeom8dUPGhE2irq4Fg@mail.gmail.com>
Message-ID: <CACtaF7zL0z_yYCGAN4jfy2moewaTR-im-NQeCXDMwtZQmUsY9Q@mail.gmail.com>

By UTF-18 I meant UTF-16, obviously.

On Sun, Nov 10, 2013 at 8:41 PM, Sverre Stausland
<stausland.johnsen at iln.uio.no> wrote:
> With respect to your comment (sorry, the e-mail you wrote that in
> didn't get to my inbox):
>
>>> I don't think so.  In general, functions that convert to the native
>>> encoding break UTF-8 on Windows, because the native encoding is often
>>> Latin1 or some other encoding that doesn't cover all the characters in
>>> UTF-8.
>
> As I understand it, the native encoding in Windows is UTF-18, not Latin1:
> http://msdn.microsoft.com/en-us/library/dd374081.aspx
>
> And UTF-18 is a superset of UTF-8, isn't it?
>
> Sverre
>
> On Sun, Nov 10, 2013 at 1:49 PM, Duncan Murdoch
> <murdoch.duncan at gmail.com> wrote:
>> On 13-11-10 7:31 AM, Sverre Stausland wrote:
>>>
>>> My e-mail was intended as a typical "feature request", and I couldn't
>>> find any more suitable place for that than the r-devel mailing list. I
>>> am not a programmer, so I don't have the skills to write this into R's
>>> source code myself.
>>>
>>> The incentive is nevertheless clear enough. I believe a software
>>> program in 2013 which imports, manipulates, and exports text in
>>> various formats (text files, picture files, postscript files, etc.)
>>> would normally be expected to support UTF-8. It might not be trivial
>>> to implement as R is written now, but the expectation will still be
>>> there. So I still believe it would be a good idea if R soon would be
>>> able to support UTF-8.
>>
>>
>> R does support UTF-8.  It all works smoothly in a UTF-8 locale, not so
>> smoothly if you have your computer set up to use a different 8 bit encoding.
>>
>>>
>>> I'm not quite able to piece together from the information you gave
>>> what the underlying issues are. What I read is:
>>> (1) Some R functions convert characters to the native encoding.
>>> (2) Windows did not support UTF-8 when R was first written.
>>> (3) Unix did not support UCS-2 when R was first written.
>>>
>>> I'm guessing here that the implications are:
>>> (1) R's write.table() converts characters to a native encoding.
>>> (2) The native encoding in Windows 7 is not UTF-8.
>>> (3) The native encoding in Unix systems is UTF-8.
>>
>>
>> You got it right for the first 4.  Regarding (2) in your second list, that's
>> right, and in fact UTF-8 is not supported as a native encoding.
>> And point (3) is optional, though UTF-8 is the dominant encoding nowadays.
>>
>> The easiest solution is for you to switch to a Unix variant and set it up to
>> use UTF-8 as the native encoding.
>>
>> Next easiest would be for Microsoft to add UTF-8 as a code page.
>>
>> Most difficult would be for R to handle UTF-8 properly on systems with
>> limited support for it.
>>
>> We probably will add small changes that let you work around the Windows
>> problems, but they won't be very satisfactory to anyone.  I don't think we
>> will make the big changes that would make R look like "a software program in
>> 2013", since it would be so much work, and there's such an easy workaround.
>>
>> Duncan Murdoch
>>
>>
>>> But this is just guesswork.
>>
>>
>>
>>>
>>> PS. A related issue:
>>>
>>> http://stackoverflow.com/questions/19881553/using-unicode-inside-rs-expression-command
>>>
>>> Sverre
>>>
>>


From phgrosjean at sciviews.org  Sun Nov 10 22:00:16 2013
From: phgrosjean at sciviews.org (Philippe Grosjean)
Date: Sun, 10 Nov 2013 22:00:16 +0100
Subject: [Rd] Support writing UTF-8 output in Windows
In-Reply-To: <527F80D2.5030504@gmail.com>
References: <CACtaF7xhmkyuALWyB3LZqEwBAwDwO6J5z5YM6ThQQ=0MuNZY6A@mail.gmail.com>	<527E9533.4070609@gmail.com>
	<CACtaF7wX8JcAhovaxnyvJVqJFBEeOcS6THzN7AEfP7_kv4U7eQ@mail.gmail.com>
	<527F80D2.5030504@gmail.com>
Message-ID: <A8F729B6-AB7F-4826-B01B-FDFC35F61DB2@sciviews.org>

Here is a quick (and largely untested, apart from the toy example) hack that should read and write UTF-8 encoded CSV files on Window. It is *not* the best solution, which should use proper C-level code. But it could help a bit in your case.
Best,

Philippe Grosjean


read.tableUTF8 <- function (file, ...)
{
	if (l10n_info()$`UTF-8`) {
		read.table(file = file, fileEncoding = "UTF-8", ...)
	} else {
		res <- read.table(file = file, ...) # Read in default encoding
		## For each character variable, change encoding to 'UTF-8'
		## For each factor, change encoding to 'UTF-8'
		as.data.frame(lapply(res, function (x) switch(data.class(x),
			character = {Encoding(x) <- "UTF-8"; x},
			factor = {Encoding(levels(x)) <- "UTF-8"; x},
			x))
		)
	}
}

write.tableUTF8 <- function (x, file = "", ...)
{
	if (l10n_info()$`UTF-8`) {
		write.table(x = x, file = file, fileEncoding = "UTF-8", ...)
	} else {
		## Change encoding to "bytes"  and save it like that
		x <- lapply(x, function (x) {
			if (is.character(x)) {
				Encoding(x) <- "bytes"
			} else if (is.factor(x)) {
				Encoding(levels(x)) <- "bytes"
			}
			x
		})
		write.table(x = x, file = file, ...)
	}
}

fact <- factor(c("\u0444", "\u220F", "\u2030"))
char <- c("\u2202x", "\u2202y", "\u2202z")
dfr <- data.frame(x = 1:3, f = fact, s = I(char))
dfr

write.tableUTF8(dfr, file = "testUTF8.txt")
dfr2 <- read.tableUTF8("testUTF8.txt")
dfr2$s <- I(as.character(dfr2$s))
dfr2

identical(dfr$f, dfr2$f)
identical(dfr$s, dfr2$s)


From murdoch.duncan at gmail.com  Sun Nov 10 22:13:17 2013
From: murdoch.duncan at gmail.com (Duncan Murdoch)
Date: Sun, 10 Nov 2013 16:13:17 -0500
Subject: [Rd] Support writing UTF-8 output in Windows
In-Reply-To: <CACtaF7zaHqPuQKib6t8TRyvxAjMpD7tdFeom8dUPGhE2irq4Fg@mail.gmail.com>
References: <CACtaF7xhmkyuALWyB3LZqEwBAwDwO6J5z5YM6ThQQ=0MuNZY6A@mail.gmail.com>	<527E9533.4070609@gmail.com>	<CACtaF7wX8JcAhovaxnyvJVqJFBEeOcS6THzN7AEfP7_kv4U7eQ@mail.gmail.com>	<527F80D2.5030504@gmail.com>
	<CACtaF7zaHqPuQKib6t8TRyvxAjMpD7tdFeom8dUPGhE2irq4Fg@mail.gmail.com>
Message-ID: <527FF6ED.9010206@gmail.com>

On 13-11-10 2:41 PM, Sverre Stausland wrote:
> With respect to your comment (sorry, the e-mail you wrote that in
> didn't get to my inbox):
>
>>> I don't think so.  In general, functions that convert to the native
>>> encoding break UTF-8 on Windows, because the native encoding is often
>>> Latin1 or some other encoding that doesn't cover all the characters in
>>> UTF-8.
>
> As I understand it, the native encoding in Windows is UTF-18, not Latin1:
> http://msdn.microsoft.com/en-us/library/dd374081.aspx
>
> And UTF-18 is a superset of UTF-8, isn't it?

UTF-16 is not an 8-bit compatible encoding.  You can't store a UTF-16 
string in a C null-terminated char* string, it needs a different type of 
storage.

Because of this, Windows uses wide 16 bit characters in many cases 
internally, but converts to 8 bit characters with an encoding depending 
on the locale.  At the time they invented this convention, UTF-8 didn't 
exist (it was invented in 1993, the year Microsoft released Windows NT 
using UCS-2 encodings), but there's no real reason they couldn't have 
added a new locale that defaults to UTF-8 as the 8 bit encoding.

R on the other hand didn't choose to use UTF-16 as its internal encoding 
because at the time it was written, Unix systems didn't properly support 
it.  They generally used 8 bit encodings, and because of its roots, that 
made sense for R too.

Duncan Murdoch

>
> Sverre
>
> On Sun, Nov 10, 2013 at 1:49 PM, Duncan Murdoch
> <murdoch.duncan at gmail.com> wrote:
>> On 13-11-10 7:31 AM, Sverre Stausland wrote:
>>>
>>> My e-mail was intended as a typical "feature request", and I couldn't
>>> find any more suitable place for that than the r-devel mailing list. I
>>> am not a programmer, so I don't have the skills to write this into R's
>>> source code myself.
>>>
>>> The incentive is nevertheless clear enough. I believe a software
>>> program in 2013 which imports, manipulates, and exports text in
>>> various formats (text files, picture files, postscript files, etc.)
>>> would normally be expected to support UTF-8. It might not be trivial
>>> to implement as R is written now, but the expectation will still be
>>> there. So I still believe it would be a good idea if R soon would be
>>> able to support UTF-8.
>>
>>
>> R does support UTF-8.  It all works smoothly in a UTF-8 locale, not so
>> smoothly if you have your computer set up to use a different 8 bit encoding.
>>
>>>
>>> I'm not quite able to piece together from the information you gave
>>> what the underlying issues are. What I read is:
>>> (1) Some R functions convert characters to the native encoding.
>>> (2) Windows did not support UTF-8 when R was first written.
>>> (3) Unix did not support UCS-2 when R was first written.
>>>
>>> I'm guessing here that the implications are:
>>> (1) R's write.table() converts characters to a native encoding.
>>> (2) The native encoding in Windows 7 is not UTF-8.
>>> (3) The native encoding in Unix systems is UTF-8.
>>
>>
>> You got it right for the first 4.  Regarding (2) in your second list, that's
>> right, and in fact UTF-8 is not supported as a native encoding.
>> And point (3) is optional, though UTF-8 is the dominant encoding nowadays.
>>
>> The easiest solution is for you to switch to a Unix variant and set it up to
>> use UTF-8 as the native encoding.
>>
>> Next easiest would be for Microsoft to add UTF-8 as a code page.
>>
>> Most difficult would be for R to handle UTF-8 properly on systems with
>> limited support for it.
>>
>> We probably will add small changes that let you work around the Windows
>> problems, but they won't be very satisfactory to anyone.  I don't think we
>> will make the big changes that would make R look like "a software program in
>> 2013", since it would be so much work, and there's such an easy workaround.
>>
>> Duncan Murdoch
>>
>>
>>> But this is just guesswork.
>>
>>
>>
>>>
>>> PS. A related issue:
>>>
>>> http://stackoverflow.com/questions/19881553/using-unicode-inside-rs-expression-command
>>>
>>> Sverre
>>>
>>


From nigel.delaney at outlook.com  Sun Nov 10 22:32:50 2013
From: nigel.delaney at outlook.com (Nigel Delaney)
Date: Sun, 10 Nov 2013 16:32:50 -0500
Subject: [Rd] Embedded R Fails When Run on LSF Queue System
Message-ID: <BAY176-W4686BF21116D18A83FEBE5E5FC0@phx.gbl>

Hi,

I had a quick question I was hoping someone might be able to answer, as my journey through the source code so far has not been very profitable. I have a command line program that embeds R, and the program works just fine when run from the command line. However, when I run the program as a job in the LSF cluster at my institute, the following error occurs:

Fatal error: you must specify '--save', '--no-save' or '--vanilla'

This is confusing becasue I believe I have set this by changing the startup parameters so that the no-save option is in use. I initialize R with the following collection of function calls:

1-Rf_initialize_R
2-R_SetParams
3-setup_Rmainloop

At step 2 I pass in a structure that specifies the no-save option (as well as interactive=true, verbose=false), so I would expect it to be okay, but I still receive this error. Again, not at the terminal but only when run as a separate process.

I gathered from this thread that someone else has experienced this (https://stat.ethz.ch/pipermail/r-help/2008-March/155935.html), but am not sure how best to rectify it as I believe I have already changed the setting.

Does anyone know what a good solution or work around might be?

Thanks for any help,
Nigel 		 	   		  

From edd at debian.org  Mon Nov 11 02:49:44 2013
From: edd at debian.org (Dirk Eddelbuettel)
Date: Sun, 10 Nov 2013 19:49:44 -0600
Subject: [Rd] Embedded R Fails When Run on LSF Queue System
In-Reply-To: <BAY176-W4686BF21116D18A83FEBE5E5FC0@phx.gbl>
References: <BAY176-W4686BF21116D18A83FEBE5E5FC0@phx.gbl>
Message-ID: <21120.14264.657609.673673@max.nulle.part>


On 10 November 2013 at 16:32, Nigel Delaney wrote:
| I had a quick question I was hoping someone might be able to answer, as my journey through the source code so far has not been very profitable. I have a command line program that embeds R, and the program works just fine when run from the command line. However, when I run the program as a job in the LSF cluster at my institute, the following error occurs:
| 
| Fatal error: you must specify '--save', '--no-save' or '--vanilla'
| 
| This is confusing becasue I believe I have set this by changing the startup parameters so that the no-save option is in use. I initialize R with the following collection of function calls:
| 
| 1-Rf_initialize_R
| 2-R_SetParams
| 3-setup_Rmainloop
| 
| At step 2 I pass in a structure that specifies the no-save option (as well as interactive=true, verbose=false), so I would expect it to be okay, but I still receive this error. Again, not at the terminal but only when run as a separate process.
| 
| I gathered from this thread that someone else has experienced this (https://stat.ethz.ch/pipermail/r-help/2008-March/155935.html), but am not sure how best to rectify it as I believe I have already changed the setting.
| 
| Does anyone know what a good solution or work around might be?

As a first approximation, when the manual tells you do something a certain
way, you are in fact better off doing it that way.

I stand behind two projects embedding R: littler (with Jeff Horner), and
RInside (with Romain Francois).  Both do this explicitly.  From littler.c:

	char *R_argv[] = {(char*)programName, "--gui=none", "--no-restore", "--no-save", "--no-readline", "--silent", "", ""};
	char *R_argv_opt[] = {"--vanilla", "--slave"};
	int R_argc = (sizeof(R_argv) - sizeof(R_argv_opt) ) / sizeof(R_argv[0]);

        [...]
        /* some logic to add R_argv_opt parts to R_argv omitted (/
        [...]

	Rf_initEmbeddedR(R_argc, R_argv);	/* Initialize the embedded R interpreter */

Hope this helps,  Dirk

-- 
Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com


From edd at debian.org  Mon Nov 11 03:33:55 2013
From: edd at debian.org (Dirk Eddelbuettel)
Date: Sun, 10 Nov 2013 20:33:55 -0600
Subject: [Rd] Embedded R Fails When Run on LSF Queue System
In-Reply-To: <BAY404-EAS314A9EF4CC4090675818BF6E5FF0@phx.gbl>
References: <BAY176-W4686BF21116D18A83FEBE5E5FC0@phx.gbl>
	<21120.14264.657609.673673@max.nulle.part>
	<BAY404-EAS314A9EF4CC4090675818BF6E5FF0@phx.gbl>
Message-ID: <21120.16915.796106.939233@max.nulle.part>


On 10 November 2013 at 21:13, Nigel Delaney wrote:
| Thanks Dirk.  I'll confess I am mostly trying to follow the practices
| outlined in the writing R-extensions manual and books by Chambers and
| Gentleman, but  have found some conflicting advice on the internet in
| various places, and am also trying to build off a previously existing code
| base (that at least worked on some
| operating-systems/architectures/scenarios, but seems to break when I move
| the program around to any new type of environment).  Will definitely
| re-write that bit.

I had it easier :)   When we started littler, Jeff had already worked out all
embedding kinks via his rApache project.  RInside is a port / rewrite of the
same logic to C++ from the C used in littler.

| Sincere thanks again.  Out of curiosity, can I ask one more question since I
| gather you have much more expertise than myself?  The extension manual has a
| somewhat obscure, to me at least, section on threading issues (8.1.5).  My
| understanding is that because the R_CStackStart is a single value, if R is
| called from multiple threads (even if never simultaneously), it is
| essentially best to just disable the stack check rather than try to re-write
| this value each time, which I gather might need to be done (and simply
| increasing the stack size of the calling thread will not help).  Is this the
| approach you have taken in your projects?  Or do you think this is also a
| bad idea?

Yep. Just a set a big fat mutex before you start multithreading, never ever
call anything that could touch R, thne release the mutex when you're done and
continue single-threaded.  I know of no other sane way.

Dirk

-- 
Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com


From nigel.delaney at outlook.com  Mon Nov 11 03:13:32 2013
From: nigel.delaney at outlook.com (Nigel Delaney)
Date: Sun, 10 Nov 2013 21:13:32 -0500
Subject: [Rd] Embedded R Fails When Run on LSF Queue System
In-Reply-To: <21120.14264.657609.673673@max.nulle.part>
References: <BAY176-W4686BF21116D18A83FEBE5E5FC0@phx.gbl>
	<21120.14264.657609.673673@max.nulle.part>
Message-ID: <BAY404-EAS314A9EF4CC4090675818BF6E5FF0@phx.gbl>

Thanks Dirk.  I'll confess I am mostly trying to follow the practices
outlined in the writing R-extensions manual and books by Chambers and
Gentleman, but  have found some conflicting advice on the internet in
various places, and am also trying to build off a previously existing code
base (that at least worked on some
operating-systems/architectures/scenarios, but seems to break when I move
the program around to any new type of environment).  Will definitely
re-write that bit.

Sincere thanks again.  Out of curiosity, can I ask one more question since I
gather you have much more expertise than myself?  The extension manual has a
somewhat obscure, to me at least, section on threading issues (8.1.5).  My
understanding is that because the R_CStackStart is a single value, if R is
called from multiple threads (even if never simultaneously), it is
essentially best to just disable the stack check rather than try to re-write
this value each time, which I gather might need to be done (and simply
increasing the stack size of the calling thread will not help).  Is this the
approach you have taken in your projects?  Or do you think this is also a
bad idea?

-----Original Message-----
From: Dirk Eddelbuettel [mailto:edd at debian.org] 
Sent: Sunday, November 10, 2013 8:50 PM
To: Nigel Delaney
Cc: r-devel at r-project.org
Subject: Re: [Rd] Embedded R Fails When Run on LSF Queue System


On 10 November 2013 at 16:32, Nigel Delaney wrote:
| I had a quick question I was hoping someone might be able to answer, as my
journey through the source code so far has not been very profitable. I have
a command line program that embeds R, and the program works just fine when
run from the command line. However, when I run the program as a job in the
LSF cluster at my institute, the following error occurs:
| 
| Fatal error: you must specify '--save', '--no-save' or '--vanilla'
| 
| This is confusing becasue I believe I have set this by changing the
startup parameters so that the no-save option is in use. I initialize R with
the following collection of function calls:
| 
| 1-Rf_initialize_R
| 2-R_SetParams
| 3-setup_Rmainloop
| 
| At step 2 I pass in a structure that specifies the no-save option (as well
as interactive=true, verbose=false), so I would expect it to be okay, but I
still receive this error. Again, not at the terminal but only when run as a
separate process.
| 
| I gathered from this thread that someone else has experienced this
(https://stat.ethz.ch/pipermail/r-help/2008-March/155935.html), but am not
sure how best to rectify it as I believe I have already changed the setting.
| 
| Does anyone know what a good solution or work around might be?

As a first approximation, when the manual tells you do something a certain
way, you are in fact better off doing it that way.

I stand behind two projects embedding R: littler (with Jeff Horner), and
RInside (with Romain Francois).  Both do this explicitly.  From littler.c:

	char *R_argv[] = {(char*)programName, "--gui=none", "--no-restore",
"--no-save", "--no-readline", "--silent", "", ""};
	char *R_argv_opt[] = {"--vanilla", "--slave"};
	int R_argc = (sizeof(R_argv) - sizeof(R_argv_opt) ) /
sizeof(R_argv[0]);

        [...]
        /* some logic to add R_argv_opt parts to R_argv omitted (/
        [...]

	Rf_initEmbeddedR(R_argc, R_argv);	/* Initialize the embedded R
interpreter */

Hope this helps,  Dirk

--
Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com


From hb at biostat.ucsf.edu  Mon Nov 11 13:31:38 2013
From: hb at biostat.ucsf.edu (Henrik Bengtsson)
Date: Mon, 11 Nov 2013 04:31:38 -0800
Subject: [Rd] SUGGESTION: Environment variable R_MAX_MC_CORES for maximum
	number of cores
Message-ID: <CAFDcVCRyjSFdH2B0cosqqfsXj021ZdgxnFjSqT-t8=BQsdhJAQ@mail.gmail.com>

I like to propose a unified/standard system environment variable that
specifies the maximum number of cores an R session should use, e.g.
R_MAX_MC_CORES.  This could then be used to *guide* multicore
implementations on the number of cores to use.  This is different from
parallel::detectCores().

ENVIRONMENT VARIABLE:
library(parallel)
mc.cores <- as.integer(Sys.getenv("R_MAX_MC_CORES", 1L))
res <- mclapply(1:10, FUN=fib, mc.cores=mc.cores)

R OPTION:
Analogously to several other env.var./options, R_MAX_MC_CORES could
set an option on startup for convenience, e.g.
options(max.mc.cores=as.integer(Sys.getenv("R_MAX_MC_CORES", 1L)))

R COMMAND-LINE OPTION:
One could also imagine a command-line option for R/Rscript that sets this, e.g.
Rscript --max.mc.cores=3 batch.R

EXAMPLE OF USAGE:
This would for instance simplify multicore processing on PBS cluster,
where the PBS job script can be:

Rscript --max.mc.cores=$PBS_NUM_PPN batch.R

such that R and the 'batch.R' script does not have to be aware of
settings/variables specific to PBS (or whatever cluster system is
used).

Finally, getOption("max.mc.cores", 1L) could possibly also be the new
default for the 'mc.cores' argument in 'parallel' functions.


/Henrik


From karl.forner at gmail.com  Mon Nov 11 18:40:56 2013
From: karl.forner at gmail.com (Karl Forner)
Date: Mon, 11 Nov 2013 18:40:56 +0100
Subject: [Rd] problem using rJava with parallel::mclapply
Message-ID: <CAMd4_Ac0=DvjjChhQ2SHxYeA3YNUKhsz7+vjZ=+VDtTR5ojJ6Q@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131111/c8f02026/attachment.pl>

From MEC at stowers.org  Mon Nov 11 18:48:05 2013
From: MEC at stowers.org (Cook, Malcolm)
Date: Mon, 11 Nov 2013 17:48:05 +0000
Subject: [Rd] problem using rJava with parallel::mclapply
In-Reply-To: <CAMd4_Ac0=DvjjChhQ2SHxYeA3YNUKhsz7+vjZ=+VDtTR5ojJ6Q@mail.gmail.com>
References: <CAMd4_Ac0=DvjjChhQ2SHxYeA3YNUKhsz7+vjZ=+VDtTR5ojJ6Q@mail.gmail.com>
Message-ID: <D4772401B9D976478C0895769BE3E792C25800@MBSRV02.sgc.loc>

Karl,

I have the following notes to self that may be pertinent:

options(java.parameters=
         ## Must preceed `library(XLConnect)` in order to prevent "Java
         ## requested System.exit(130), closing R." which happens when
         ## rJava quits R upon trapping INT (control-c), as is done by
         ## XLConnect (and playwith?), below. (c.f.:
         ## https://www.rforge.net/bugzilla/show_bug.cgi?id=237)
         "-Xrs")


~Malcolm



 >-----Original Message-----
 >From: r-devel-bounces at r-project.org [mailto:r-devel-bounces at r-project.org] On Behalf Of Karl Forner
 >Sent: Monday, November 11, 2013 11:41 AM
 >To: r-devel at r-project.org
 >Cc: Martin Studer
 >Subject: [Rd] problem using rJava with parallel::mclapply
 >
 >Dear all,
 >
 >I got an issue trying to parse excel files in parallel using XLConnect, the
 >process hangs forever.
 >Martin Studer, the maintainer of XLConnect kindly investigated the issue,
 >identified rJava as a possible cause of the problem:
 >
 >This does not work (hangs):
 >library(parallel)
 >require(rJava)
 >.jinit()
 >res <- mclapply(1:2, function(i) {
 >      J("java.lang.Runtime")$getRuntime()$gc()
 >      1
 >  }, mc.cores = 2)
 >
 >but this works:
 >library(parallel)
 >res <- mclapply(1:2, function(i) {
 >  require(rJava)
 >  .jinit()
 >  J("java.lang.Runtime")$getRuntime()$gc()
 >  1
 >}, mc.cores = 2)
 >
 >To cite Martin, it seems to work with mclapply when the JVM process is
 >initialized after forking.
 >
 >Is this a bug or a limitation of rJava ?
 >Or is there a good practice for rJava clients to avoid this problem ?
 >
 >Best,
 >Karl
 >
 >P.S.
 >> sessionInfo()
 >R version 3.0.1 (2013-05-16)
 >Platform: x86_64-unknown-linux-gnu (64-bit)
 >
 >locale:
 > [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C
 > [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8
 > [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8
 > [7] LC_PAPER=C                 LC_NAME=C
 > [9] LC_ADDRESS=C               LC_TELEPHONE=C
 >[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C
 >
 >attached base packages:
 >[1] stats     graphics  grDevices utils     datasets  methods   base
 >
 >loaded via a namespace (and not attached):
 >[1] tools_3.0.1
 >
 >	[[alternative HTML version deleted]]
 >
 >______________________________________________
 >R-devel at r-project.org mailing list
 >https://stat.ethz.ch/mailman/listinfo/r-devel


From maechler at stat.math.ethz.ch  Mon Nov 11 19:03:50 2013
From: maechler at stat.math.ethz.ch (Martin Maechler)
Date: Mon, 11 Nov 2013 19:03:50 +0100
Subject: [Rd] R interface to C API Rf_logspace_{add,sub}?
In-Reply-To: <E66794E69CFDE04D9A70842786030B933FA137FC@PA-MBX01.na.tibco.com>
References: <E66794E69CFDE04D9A70842786030B933FA137FC@PA-MBX01.na.tibco.com>
Message-ID: <21121.7174.740446.94975@stat.math.ethz.ch>

>>>>> William Dunlap <wdunlap at tibco.com>
>>>>>     on Thu, 7 Nov 2013 21:32:46 +0000 writes:

    > Is there an R-language interface to the R API C-language
    > functions Rf_logspace_add() and Rf_logspace_sub()?  I
    > don't see one but I may not looking under the right name.

    > Various packages have functions which do that same sort of
    > thing (log(exp(x)+exp(y)) and log(exp(x)-exp(y)) without
    > unnecessary floating point errors).  They have names like
    > matrixStats::logSumExp(lx, na.rm=FALSE, ...) (the ... is
    > ignored by the function) sna::logSub(x,y), logSum(x),
    > logMean(x) BTYD::addLogs(loga, logb) and subLogs(loga,
    > logb) Googling for logSumExp (the Python name) indicates
    > that many know this as "LSE" (the "Log-Sum-Exp trick").

    > I've seen several instances in R-help recently where user
    > code could be made more accurate if these were available.
    > They can be written in pure R code, but would be slower
    > because they would require something like pmin() and
    > pmax() to work.  I think they belong in the same package
    > as log1p() and expm1().  I think the add and subtraction
    > versions are the most useful and the sum version would be
    > very nice to have.

I agree.... As a matter of fact,
Marius Hofert and I have been using pure R "vectorized", i.e.,
working on a *matrix* argument, returning a vector,
versions of these in our package 'copula' 
 (--> copula/R/special-func.R ), 
not exported though,
however somewhat documented and explained on page 49 of

 M Hofert, M M?chler, AJ McNeil (2013)
 Archimedean Copulas in High Dimensions:
 Estimators and Numerical Challenges Motivated by Financial Applications
 Journal de la Soci?t? Fran?aise de Statistique 154 (1), 25-63

p.49 is also attached.

The clue is that the  lssum() function is really an n-term
generalization of logspace_add() and logspace_sub()
by being able to specifying the *signs* and lsum() is a special
case with all signs being +1.

Before jumping ahead and providing a faster R interface in
"base" (or rather "utils" ?), I think we should think twice
before embarking on a 2-argument version only rather than a
vectorized version as our lsum() and lssum() provide.

Martin Maechler, ETH Zurich


-------------- next part --------------
A non-text attachment was scrubbed...
Name: HoMaMcN2013-p49.pdf
Type: application/pdf
Size: 117551 bytes
Desc: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131111/bc142e21/attachment.pdf>
-------------- next part --------------



    > Bill Dunlap Spotfire, TIBCO Software wdunlap tibco.com

From karl.forner at gmail.com  Mon Nov 11 19:08:55 2013
From: karl.forner at gmail.com (Karl Forner)
Date: Mon, 11 Nov 2013 19:08:55 +0100
Subject: [Rd] problem using rJava with parallel::mclapply
In-Reply-To: <D4772401B9D976478C0895769BE3E792C25800@MBSRV02.sgc.loc>
References: <CAMd4_Ac0=DvjjChhQ2SHxYeA3YNUKhsz7+vjZ=+VDtTR5ojJ6Q@mail.gmail.com>
	<D4772401B9D976478C0895769BE3E792C25800@MBSRV02.sgc.loc>
Message-ID: <CAMd4_AfpPj=fLgo1ZADBDQYwC=LV+um4+dVVzyqE8pCmnQ6+fg@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131111/94125088/attachment.pl>

From simon.urbanek at r-project.org  Tue Nov 12 03:20:31 2013
From: simon.urbanek at r-project.org (Simon Urbanek)
Date: Mon, 11 Nov 2013 21:20:31 -0500
Subject: [Rd] problem using rJava with parallel::mclapply
In-Reply-To: <CAMd4_Ac0=DvjjChhQ2SHxYeA3YNUKhsz7+vjZ=+VDtTR5ojJ6Q@mail.gmail.com>
References: <CAMd4_Ac0=DvjjChhQ2SHxYeA3YNUKhsz7+vjZ=+VDtTR5ojJ6Q@mail.gmail.com>
Message-ID: <2EEA1904-0556-4D37-9492-A54D77EF3B52@r-project.org>


On Nov 11, 2013, at 12:40 PM, Karl Forner <karl.forner at gmail.com> wrote:

> Dear all,
> 
> I got an issue trying to parse excel files in parallel using XLConnect, the
> process hangs forever.
> Martin Studer, the maintainer of XLConnect kindly investigated the issue,
> identified rJava as a possible cause of the problem:
> 
> This does not work (hangs):
> library(parallel)
> require(rJava)
> .jinit()
> res <- mclapply(1:2, function(i) {
>      J("java.lang.Runtime")$getRuntime()$gc()
>      1
>  }, mc.cores = 2)
> 
> but this works:
> library(parallel)
> res <- mclapply(1:2, function(i) {
>  require(rJava)
>  .jinit()
>  J("java.lang.Runtime")$getRuntime()$gc()
>  1
> }, mc.cores = 2)
> 
> To cite Martin, it seems to work with mclapply when the JVM process is
> initialized after forking.
> 
> Is this a bug or a limitation of rJava ?

It?s a limitation of the Java runtime - you cannot fork a JVM. This is true for most libraries that use long-lived threads or any kind if UI (see the warnings in mcfork).

Cheers,
Simon



> Or is there a good practice for rJava clients to avoid this problem ?
> 
> Best,
> Karl
> 
> P.S.
>> sessionInfo()
> R version 3.0.1 (2013-05-16)
> Platform: x86_64-unknown-linux-gnu (64-bit)
> 
> locale:
> [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C
> [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8
> [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8
> [7] LC_PAPER=C                 LC_NAME=C
> [9] LC_ADDRESS=C               LC_TELEPHONE=C
> [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C
> 
> attached base packages:
> [1] stats     graphics  grDevices utils     datasets  methods   base
> 
> loaded via a namespace (and not attached):
> [1] tools_3.0.1
> 
> 	[[alternative HTML version deleted]]
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
> 


From kirill.mueller at ivt.baug.ethz.ch  Wed Nov 13 11:38:27 2013
From: kirill.mueller at ivt.baug.ethz.ch (=?ISO-8859-1?Q?Kirill_M=FCller?=)
Date: Wed, 13 Nov 2013 11:38:27 +0100
Subject: [Rd] Trouble running Rtools31 on Wine
Message-ID: <528356A3.7000201@ivt.baug.ethz.ch>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131113/160710d9/attachment.pl>

From pranav.waila at gmail.com  Fri Nov 15 10:49:24 2013
From: pranav.waila at gmail.com (pranav.waila)
Date: Fri, 15 Nov 2013 01:49:24 -0800 (PST)
Subject: [Rd] R CMD SHLIB error bad value (core2) for -mtune= switch
In-Reply-To: <38EB87B9-8458-4587-A592-2AF275CE5A6E@comcast.net>
References: <1349996161811-4645928.post@n4.nabble.com>
	<50789295.5020905@stats.ox.ac.uk>
	<1351015109937-4647182.post@n4.nabble.com>
	<38EB87B9-8458-4587-A592-2AF275CE5A6E@comcast.net>
Message-ID: <1384508964363-4680510.post@n4.nabble.com>

I am getting the following error. Please help if the problem is resolved:

$ make
      0 [main] make 10092 stdio_init: couldn't make stderr distinct from
stdout
R CMD SHLIB src/C/util.c src/C/factor_model_util.c src/C/pagerank.c
src/C/hierarchical.c src/C/factor_model_multicontext.c src/C/fact
or_model_util2.cpp -o lib/c_funcs.so
Segmentation fault



-----
Pranav Waila
pranav.waila at gmail.com
Research Scholar
DST - Centre for Interdisciplinary Mathematical Sciences
Faculty of Science
Banaras Hindu University,Varanasi-221005
--
View this message in context: http://r.789695.n4.nabble.com/R-CMD-SHLIB-error-bad-value-core2-for-mtune-switch-tp4645928p4680510.html
Sent from the R devel mailing list archive at Nabble.com.


From szehnder at uni-bonn.de  Fri Nov 15 12:36:58 2013
From: szehnder at uni-bonn.de (Simon Zehnder)
Date: Fri, 15 Nov 2013 12:36:58 +0100
Subject: [Rd] R CMD SHLIB error bad value (core2) for -mtune= switch
In-Reply-To: <1384508964363-4680510.post@n4.nabble.com>
References: <1349996161811-4645928.post@n4.nabble.com>
	<50789295.5020905@stats.ox.ac.uk>
	<1351015109937-4647182.post@n4.nabble.com>
	<38EB87B9-8458-4587-A592-2AF275CE5A6E@comcast.net>
	<1384508964363-4680510.post@n4.nabble.com>
Message-ID: <C005E255-2835-494F-8D13-CFC3C770C39B@uni-bonn.de>

No information has been given, where this error occurred. What were you doing?

Simon 
On 15 Nov 2013, at 10:49, pranav.waila <pranav.waila at gmail.com> wrote:

> I am getting the following error. Please help if the problem is resolved:
> 
> $ make
>      0 [main] make 10092 stdio_init: couldn't make stderr distinct from
> stdout
> R CMD SHLIB src/C/util.c src/C/factor_model_util.c src/C/pagerank.c
> src/C/hierarchical.c src/C/factor_model_multicontext.c src/C/fact
> or_model_util2.cpp -o lib/c_funcs.so
> Segmentation fault
> 
> 
> 
> -----
> Pranav Waila
> pranav.waila at gmail.com
> Research Scholar
> DST - Centre for Interdisciplinary Mathematical Sciences
> Faculty of Science
> Banaras Hindu University,Varanasi-221005
> --
> View this message in context: http://r.789695.n4.nabble.com/R-CMD-SHLIB-error-bad-value-core2-for-mtune-switch-tp4645928p4680510.html
> Sent from the R devel mailing list archive at Nabble.com.
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


From murdoch.duncan at gmail.com  Fri Nov 15 13:05:49 2013
From: murdoch.duncan at gmail.com (Duncan Murdoch)
Date: Fri, 15 Nov 2013 07:05:49 -0500
Subject: [Rd] Trouble running Rtools31 on Wine
In-Reply-To: <528356A3.7000201@ivt.baug.ethz.ch>
References: <528356A3.7000201@ivt.baug.ethz.ch>
Message-ID: <52860E1D.20009@gmail.com>

On 13-11-13 5:38 AM, Kirill M?ller wrote:
> Hi
>
> An attempt to use R and Rtools in Wine fails, see the bug report to Wine:
>
> http://bugs.winehq.org/show_bug.cgi?id=34865
>
> The people there say that Rtools uses an outdated Cygwin DLL with a
> custom patch. Is there any chance we can upgrade our Cygwin DLL to a
> supported upstream version? Thanks.

Rtools doesn't use any special Cygwin dlls.  The one in the current 
distribution is rather old, so if it doesn't work in Wine, just go to 
the Cygwin site and install a newer Cygwin version.  (Not sure if this 
is easy in Wine, but you could do it on a Windows machine, and copy the 
files over.)

Duncan Murdoch


From romain at r-enthusiasts.com  Sat Nov 16 11:02:21 2013
From: romain at r-enthusiasts.com (Romain Francois)
Date: Sat, 16 Nov 2013 11:02:21 +0100
Subject: [Rd] Linking to native routines in other packages
Message-ID: <528742AD.1090804@r-enthusiasts.com>

Hello,

I'm currently working on making Rcpp use the feature described here more:
http://cran.r-project.org/doc/manuals/R-exts.html#Linking-to-native-routines-in-other-packages

To give more context, Rcpp has for a long time built what we called "the 
Rcpp user library", i.e. a library we could link against user the 
linker. We were then producing appropriate linker flag with 
Rcpp:::LdFlags(), ...

Now, I'm moving away from this and the intention is that a package using 
Rcpp would only have to use

LinkingTo: Rcpp

This sets the -I flag as before to find headers from Rcpp, but this also 
now takes advantage of what is described in writing R extensions:
http://cran.r-project.org/doc/manuals/R-exts.html#Linking-to-native-routines-in-other-packages

I'm doing this in a way that, when we are not compiling Rcpp, for 
example the "type2name" function is defined in Rcpp's headers as an 
inline function that grabs the registered function from Rcpp.

inline const char* type2name(SEXP x){
         typedef const char* (*Fun)(SEXP) ;
         static Fun fun = GET_(Fun) R_GetCCallable( "Rcpp", "type2name") ;
         return fun(x) ;
     }


This works great.


Now for the question. The documentation says:

"It must also specify ?Imports? or ?Depends? of those packages, for they 
have to be loaded prior to this one (so the path to their compiled code 
has been registered)."

Indeed if I don't have Depends or Imports, the R_init_Rcpp is not 
called, and so the function is not registered.

But now if I do Depends: Rcpp or Imports: Rcpp for the sole purpose of 
this LinkingTo mechanism, I'm getting

* checking dependencies in R code ... NOTE
Namespace in Imports field not imported from: ?Rcpp?
   All declared Imports should be used.
See the information on DESCRIPTION files in the chapter ?Creating R
packages? of the ?Writing R Extensions? manual.

It would be simple enough to require of our users that they have 
Imports: Rcpp and import(Rcpp) or less in their NAMESPACE, but I was 
wondering if we could make this more transparent, i.e. having LinkingTo: 
Rcpp mean loading Rcpp.

I'm also curious about this sentence from the doc:

"In the future R may provide some automated tools to simplify exporting 
larger numbers of routines."

Is there a draft of something ?

Romain



For details on how we will be using LinkingTo. Please see:

https://github.com/RcppCore/Rcpp/blob/master/inst/include/Rcpp/routines.h

where depending
- when we are compiling Rcpp, we just have a declaration of the 
function, which is then defined in any of our .cpp files.
- when we are using Rcpp from another package, we are retrieving the 
function

https://github.com/RcppCore/Rcpp/blob/master/src/Rcpp_init.cpp

where the functions are registered with the RCPP_REGISTER macro.

This way of using it moves all the logic to the package exposing its 
functions. I find this nicer to use than other tactics I've seen, such 
as the sub technique from Matrix ...

-- 
Romain Francois
Professional R Enthusiast
+33(0) 6 28 91 30 30


From romain at r-enthusiasts.com  Sat Nov 16 11:13:10 2013
From: romain at r-enthusiasts.com (Romain Francois)
Date: Sat, 16 Nov 2013 11:13:10 +0100
Subject: [Rd] Linking to native routines in other packages
In-Reply-To: <528742AD.1090804@r-enthusiasts.com>
References: <528742AD.1090804@r-enthusiasts.com>
Message-ID: <52874536.8050103@r-enthusiasts.com>

Le 16/11/2013 11:02, Romain Francois a ?crit :
> Hello,
>
> I'm currently working on making Rcpp use the feature described here more:
> http://cran.r-project.org/doc/manuals/R-exts.html#Linking-to-native-routines-in-other-packages
>
>
> To give more context, Rcpp has for a long time built what we called "the
> Rcpp user library", i.e. a library we could link against user the
> linker. We were then producing appropriate linker flag with
> Rcpp:::LdFlags(), ...
>
> Now, I'm moving away from this and the intention is that a package using
> Rcpp would only have to use
>
> LinkingTo: Rcpp
>
> This sets the -I flag as before to find headers from Rcpp, but this also
> now takes advantage of what is described in writing R extensions:
> http://cran.r-project.org/doc/manuals/R-exts.html#Linking-to-native-routines-in-other-packages
>
>
> I'm doing this in a way that, when we are not compiling Rcpp, for
> example the "type2name" function is defined in Rcpp's headers as an
> inline function that grabs the registered function from Rcpp.
>
> inline const char* type2name(SEXP x){
>          typedef const char* (*Fun)(SEXP) ;
>          static Fun fun = GET_(Fun) R_GetCCallable( "Rcpp", "type2name") ;
>          return fun(x) ;
>      }
>
>
> This works great.
>
>
> Now for the question. The documentation says:
>
> "It must also specify ?Imports? or ?Depends? of those packages, for they
> have to be loaded prior to this one (so the path to their compiled code
> has been registered)."
>
> Indeed if I don't have Depends or Imports, the R_init_Rcpp is not
> called, and so the function is not registered.
>
> But now if I do Depends: Rcpp or Imports: Rcpp for the sole purpose of
> this LinkingTo mechanism, I'm getting
>
> * checking dependencies in R code ... NOTE
> Namespace in Imports field not imported from: ?Rcpp?
>    All declared Imports should be used.
> See the information on DESCRIPTION files in the chapter ?Creating R
> packages? of the ?Writing R Extensions? manual.
>
> It would be simple enough to require of our users that they have
> Imports: Rcpp and import(Rcpp) or less in their NAMESPACE, but I was
> wondering if we could make this more transparent, i.e. having LinkingTo:
> Rcpp mean loading Rcpp.
>
> I'm also curious about this sentence from the doc:
>
> "In the future R may provide some automated tools to simplify exporting
> larger numbers of routines."
>
> Is there a draft of something ?
>
> Romain
>
>
>
> For details on how we will be using LinkingTo. Please see:
>
> https://github.com/RcppCore/Rcpp/blob/master/inst/include/Rcpp/routines.h
>
> where depending
> - when we are compiling Rcpp, we just have a declaration of the
> function, which is then defined in any of our .cpp files.
> - when we are using Rcpp from another package, we are retrieving the
> function
>
> https://github.com/RcppCore/Rcpp/blob/master/src/Rcpp_init.cpp
>
> where the functions are registered with the RCPP_REGISTER macro.
>
> This way of using it moves all the logic to the package exposing its
> functions. I find this nicer to use than other tactics I've seen, such
> as the sub technique from Matrix ...

Typo alert. Of course here I meant the "stub" technique.

Romain

-- 
Romain Francois
Professional R Enthusiast
+33(0) 6 28 91 30 30


From romain at r-enthusiasts.com  Sat Nov 16 14:30:18 2013
From: romain at r-enthusiasts.com (Romain Francois)
Date: Sat, 16 Nov 2013 14:30:18 +0100
Subject: [Rd] serialization for external pointers
Message-ID: <5287736A.6000407@r-enthusiasts.com>

Hello,

Are there any recipe to handle serialization / deserialization of 
external pointers.

I'm thinking about something similar in spirit to the way we handle 
finalization of external pointers.

Currently, if we create an external pointer, save the session, quit R, 
then load the session, we get a null pointer.

One way I'm thinking of is to have an environment in the "protected" 
part of the xp, then have an active binding there, since apparently 
active bindings:
  - are "get" during serialization
  - lose their active ness when reloaded:

$ R
[...]
 > f <- local( {
+     x <- 1
+     function(v) {
+        if (missing(v))
+            cat("get\n")
+        else {
+            cat("set\n")
+            x <<- v
+        }
+        x
+     }
+ })
 > makeActiveBinding("fred", f, .GlobalEnv)
 > bindingIsActive("fred", .GlobalEnv)
[1] TRUE
 >
 > q("yes")
get
get


romain at naxos /tmp $ R
[..]
 > fred
[1] 1
 > bindingIsActive("fred", .GlobalEnv)
[1] FALSE

Is this possible ? Is there any other hook to handle serialization, 
unserialization of external pointers ?

Romain

-- 
Romain Francois
Professional R Enthusiast
+33(0) 6 28 91 30 30


From romain at r-enthusiasts.com  Sat Nov 16 15:12:22 2013
From: romain at r-enthusiasts.com (Romain Francois)
Date: Sat, 16 Nov 2013 15:12:22 +0100
Subject: [Rd] serialization for external pointers
In-Reply-To: <5287736A.6000407@r-enthusiasts.com>
References: <5287736A.6000407@r-enthusiasts.com>
Message-ID: <52877D46.5090202@r-enthusiasts.com>

Le 16/11/2013 14:30, Romain Francois a ?crit :
> Hello,
>
> Are there any recipe to handle serialization / deserialization of
> external pointers.
>
> I'm thinking about something similar in spirit to the way we handle
> finalization of external pointers.
>
> Currently, if we create an external pointer, save the session, quit R,
> then load the session, we get a null pointer.
>
> One way I'm thinking of is to have an environment in the "protected"
> part of the xp, then have an active binding there, since apparently
> active bindings:
>   - are "get" during serialization
>   - lose their active ness when reloaded:

This will not work. Apparently the active feature is kept on other 
environments:

$ R
[...]
 > f <- local( {
+     x <- 1
+     function(v) {
+        if (missing(v))
+            cat("get\n")
+        else {
+            cat("set\n")
+            x <<- v
+        }
+        x
+     }
+ })
 > makeActiveBinding("fred", f, .GlobalEnv)
 > bindingIsActive("fred", .GlobalEnv)
[1] TRUE
 >
 > e <- new.env()
 > makeActiveBinding("fred", f, e)
 > bindingIsActive("fred", e)
[1] TRUE
 >
 > q()
Save workspace image? [y/n/c]: y
get
get

Then:

$ R
[...]
 > e
<environment: 0x104c56f78>
 > bindingIsActive("fred", .GlobalEnv)
[1] FALSE
 > bindingIsActive("fred", e)
[1] TRUE

Is this the expected behavior ?

-- 
Romain Francois
Professional R Enthusiast
+33(0) 6 28 91 30 30


From simon.urbanek at r-project.org  Sun Nov 17 04:09:48 2013
From: simon.urbanek at r-project.org (Simon Urbanek)
Date: Sat, 16 Nov 2013 22:09:48 -0500
Subject: [Rd] serialization for external pointers
In-Reply-To: <5287736A.6000407@r-enthusiasts.com>
References: <5287736A.6000407@r-enthusiasts.com>
Message-ID: <865E17BF-9ABD-47D7-ADC4-1D4384BC09FC@r-project.org>

On Nov 16, 2013, at 8:30 AM, Romain Francois <romain at r-enthusiasts.com> wrote:

> Hello,
> 
> Are there any recipe to handle serialization / deserialization of external pointers.
> 
> I'm thinking about something similar in spirit to the way we handle finalization of external pointers.
> 

See refhook in serialize/unserialize.


> Currently, if we create an external pointer, save the session, quit R, then load the session, we get a null pointer.
> 

Saving the session is a different story than serialization, because it also involves loading the right code in addition to the data and you cannot use refhooks. I recall discussing this with Luke a few years ago, and the main problem is that R has no way of knowing what is needed to call the particular hooks, because the package is not even loaded, so it cannot install hooks. AFAIR the net result was that the proper way to do it is to handle the NULL pointer code when you first access the pointer  to restore the object based on additional info that you store in the object. E.g. , in rJava we store the Java serialization of the object so it can be restored on first use of the new session.

One piece that is still missing it the ability to set a hook to update the save object on save() - since we don?t necessarily want to add the extra information every time the object is created or the serialization may become stale over time. That would still be very useful to add ?

Cheers,
Simon


> One way I'm thinking of is to have an environment in the "protected" part of the xp, then have an active binding there, since apparently active bindings:
> - are "get" during serialization
> - lose their active ness when reloaded:
> 
> $ R
> [...]
> > f <- local( {
> +     x <- 1
> +     function(v) {
> +        if (missing(v))
> +            cat("get\n")
> +        else {
> +            cat("set\n")
> +            x <<- v
> +        }
> +        x
> +     }
> + })
> > makeActiveBinding("fred", f, .GlobalEnv)
> > bindingIsActive("fred", .GlobalEnv)
> [1] TRUE
> >
> > q("yes")
> get
> get
> 
> 
> romain at naxos /tmp $ R
> [..]
> > fred
> [1] 1
> > bindingIsActive("fred", .GlobalEnv)
> [1] FALSE
> 
> Is this possible ? Is there any other hook to handle serialization, unserialization of external pointers ?
> 
> Romain
> 
> -- 
> Romain Francois
> Professional R Enthusiast
> +33(0) 6 28 91 30 30
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
> 


From dtenenba at fhcrc.org  Wed Nov 20 23:41:36 2013
From: dtenenba at fhcrc.org (Dan Tenenbaum)
Date: Wed, 20 Nov 2013 14:41:36 -0800 (PST)
Subject: [Rd] "size of shared memory region" messages show up with Rtools
 3.1.0.1939
In-Reply-To: <1854432961.2387466.1384987234265.JavaMail.root@fhcrc.org>
Message-ID: <679148289.2387491.1384987296459.JavaMail.root@fhcrc.org>

Hi,

After installing Rtools 3.1.0.1939 into c:\rtools31, when I call any (most?) of the commands in c:\rtools31\bin, I see strange messages printed to stderr. Example:

C:\Rtools31>bin\tar
      0 [main] tar 6084 shared_info::initialize: size of shared memory region changed from 27984 to 21136
bin/tar: You must specify one of the `-Acdtrux' options
Try `bin/tar --help' or `bin/tar --usage' for more information.


Sometimes I see quite a few of these just from running a single command.

Can this be fixed?

Thanks,
Dan


From dtenenba at fhcrc.org  Wed Nov 20 23:49:24 2013
From: dtenenba at fhcrc.org (Dan Tenenbaum)
Date: Wed, 20 Nov 2013 14:49:24 -0800 (PST)
Subject: [Rd] "size of shared memory region" messages show up with
 Rtools 3.1.0.1939
In-Reply-To: <679148289.2387491.1384987296459.JavaMail.root@fhcrc.org>
Message-ID: <430459591.2387601.1384987764285.JavaMail.root@fhcrc.org>



----- Original Message -----
> From: "Dan Tenenbaum" <dtenenba at fhcrc.org>
> To: "R-devel" <r-devel at r-project.org>
> Sent: Wednesday, November 20, 2013 2:41:36 PM
> Subject: [Rd] "size of shared memory region" messages show up with Rtools 3.1.0.1939
> 
> Hi,
> 
> After installing Rtools 3.1.0.1939 into c:\rtools31, when I call any
> (most?) of the commands in c:\rtools31\bin, I see strange messages
> printed to stderr. Example:
> 
> C:\Rtools31>bin\tar
>       0 [main] tar 6084 shared_info::initialize: size of shared
>       memory region changed from 27984 to 21136
> bin/tar: You must specify one of the `-Acdtrux' options
> Try `bin/tar --help' or `bin/tar --usage' for more information.
> 
> 
> Sometimes I see quite a few of these just from running a single
> command.
> 

It seems this is more than cosmetic; simple commands seem to fail:

E:\sandbox>cp c:\Users\biocbuild\Downloads\iClusterPlus_0.99.8.2.tar.gz .
      1 [main] cp 3348 shared_info::initialize: size of shared memory region changed from 27984 to 21136
15001297 [main] cp 3348 c:\Rtools31\bin\cp.exe: *** fatal error - add_item ("\??\c:\Rtools 31", "/", ...) failed, errno 1
Stack trace:
Frame     Function  Args

I am reverting back to my previous version of Rtools for now, till I hear that this has been addressed.

Thanks,
Dan



> Can this be fixed?
> 
> Thanks,
> Dan
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
>


From dtenenba at fhcrc.org  Thu Nov 21 00:13:18 2013
From: dtenenba at fhcrc.org (Dan Tenenbaum)
Date: Wed, 20 Nov 2013 15:13:18 -0800 (PST)
Subject: [Rd] "size of shared memory region" messages show up with
 Rtools 3.1.0.1939
In-Reply-To: <430459591.2387601.1384987764285.JavaMail.root@fhcrc.org>
Message-ID: <1810767108.2388038.1384989198126.JavaMail.root@fhcrc.org>



----- Original Message -----
> From: "Dan Tenenbaum" <dtenenba at fhcrc.org>
> To: "R-devel" <r-devel at r-project.org>
> Sent: Wednesday, November 20, 2013 2:49:24 PM
> Subject: Re: [Rd] "size of shared memory region" messages show up with Rtools 3.1.0.1939
> 
> 
> 
> ----- Original Message -----
> > From: "Dan Tenenbaum" <dtenenba at fhcrc.org>
> > To: "R-devel" <r-devel at r-project.org>
> > Sent: Wednesday, November 20, 2013 2:41:36 PM
> > Subject: [Rd] "size of shared memory region" messages show up with
> > Rtools 3.1.0.1939
> > 
> > Hi,
> > 
> > After installing Rtools 3.1.0.1939 into c:\rtools31, when I call
> > any
> > (most?) of the commands in c:\rtools31\bin, I see strange messages
> > printed to stderr. Example:
> > 
> > C:\Rtools31>bin\tar
> >       0 [main] tar 6084 shared_info::initialize: size of shared
> >       memory region changed from 27984 to 21136
> > bin/tar: You must specify one of the `-Acdtrux' options
> > Try `bin/tar --help' or `bin/tar --usage' for more information.
> > 
> > 
> > Sometimes I see quite a few of these just from running a single
> > command.
> > 
> 
> It seems this is more than cosmetic; simple commands seem to fail:
> 
> E:\sandbox>cp
> c:\Users\biocbuild\Downloads\iClusterPlus_0.99.8.2.tar.gz .
>       1 [main] cp 3348 shared_info::initialize: size of shared memory
>       region changed from 27984 to 21136
> 15001297 [main] cp 3348 c:\Rtools31\bin\cp.exe: *** fatal error -
> add_item ("\??\c:\Rtools 31", "/", ...) failed, errno 1
> Stack trace:
> Frame     Function  Args
> 
> I am reverting back to my previous version of Rtools for now, till I
> hear that this has been addressed.
> 

Rebooting the machine seems to have cleared up the problem. I'm now running version 3.1.0.1939 without any issues.
Dan


> Thanks,
> Dan
> 
> 
> 
> > Can this be fixed?
> > 
> > Thanks,
> > Dan
> > 
> > ______________________________________________
> > R-devel at r-project.org mailing list
> > https://stat.ethz.ch/mailman/listinfo/r-devel
> >
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
>


From skostysh at princeton.edu  Thu Nov 21 07:17:50 2013
From: skostysh at princeton.edu (Scott Kostyshak)
Date: Thu, 21 Nov 2013 01:17:50 -0500
Subject: [Rd] [PATCH] suggestions for R-lang manual
Message-ID: <CAE3=dmefQSwG-AELeZmZFHi90VaknXUtEgfsVQgxii7J0Z75cg@mail.gmail.com>

Attached is a patch with suggestions for the R-lang manual at r64277.

Below are a few comments (some are implemented in the patch):

In the section "Objects", there is a table introduced by "The
following table describes the possible values returned by typeof". One
of the results is "any". Can "any" be returned by "typeof()" ?

Regarding the "Recycling rules" section,

-One exception is that when adding vectors to matrices, a warning is not
-given if the lengths are incompatible.
- at c Is that a bug?
-

was this a bug that was fixed? I see the following behavior:

> myvec <- 1:3
> mymat <- matrix(1:12, ncol=2)
> myvec <- 1:5
> myvec + mymat
     [,1] [,2]
[1,]    2    9
[2,]    4   11
[3,]    6   13
[4,]    8   15
[5,]   10   12
[6,]    7   14
Warning message:
In myvec + mymat :
  longer object length is not a multiple of shorter object length
>

Regarding

-The arguments in the call to the generic are rematched with the
-arguments for the method using the standard argument matching mechanism.
-The first argument, i.e.@: the object, will have been evaluated.
-

this information is duplicated. See a few paragraphs up "When the
method is invoked it is called..."

Scott


--
Scott Kostyshak
Economics PhD Candidate
Princeton University
-------------- next part --------------
Index: trunk/doc/manual/R-lang.texi
===================================================================
--- trunk/doc/manual/R-lang.texi	(revision 64277)
+++ trunk/doc/manual/R-lang.texi	(working copy)
@@ -1064,7 +1064,7 @@
 @cindex function
 @cindex function arguments
 Function calls can have @emph{tagged} (or @emph{named}) arguments, as in
- at code{plot(x, y, pch = 3)} arguments without tags are known as
+ at code{plot(x, y, pch = 3)}.  Arguments without tags are known as
 @emph{positional} since the function must distinguish their meaning from
 their sequential positions among the arguments of the call, e.g., that
 @code{x} denotes the abscissa variable and @code{y} the ordinate.  The
@@ -1308,10 +1308,10 @@
 ignored.  If @var{value1} has any type other than a logical or a numeric
 vector an error is signalled.
 
-If/else statements can be used to avoid numeric problems such as taking
-the logarithm of a negative number.  Because if/else statements are the
-same as other statements you can assign the value of them.  The two
-examples below are equivalent.
+ at code{if}/@code{else} statements can be used to avoid numeric problems
+such as taking the logarithm of a negative number.  Because
+ at code{if}/@code{else} statements are the same as other statements you
+can assign the value of them.  The two examples below are equivalent.
 
 @example
 > if( any(x <= 0) ) y <- log(1+x) else y <- log(x)
@@ -1327,7 +1327,7 @@
 compound statement wrapped in braces, putting the @code{else} on the
 same line as the closing brace that marks the end of the statement.
 
-If/else statements can be nested.
+ at code{if}/@code{else} statements can be nested.
 
 @example
 if ( @var{statement1} ) @{
@@ -1342,7 +1342,7 @@
 
 One of the even numbered statements will be evaluated and the resulting
 value returned.  If the optional @code{else} clause is omitted and all
-the odd numbered @var{statement}'s evaluate to @code{FALSE} no statement
+the odd numbered @var{statement}s evaluate to @code{FALSE} no statement
 will be evaluated and @code{NULL} is returned.
 
 The odd numbered @var{statement}s are evaluated, in order, until one
@@ -1378,7 +1378,7 @@
 of the loop (if there is one) is then executed.  No statement below
 @code{next} in the current loop is evaluated.
 
-The value returned by a loop statement statement is always @code{NULL}
+The value returned by a loop statement is always @code{NULL}
 and is returned invisibly.
 
 @node repeat, while, Looping, Control structures
@@ -1451,7 +1451,7 @@
 where the elements of @var{list} may be named.  First, @var{statement}
 is evaluated and the result, @var{value}, obtained.  If @var{value} is a
 number between 1 and the length of @var{list} then the corresponding
-element @var{list} is evaluated and the result returned.  If @var{value}
+element of @var{list} is evaluated and the result returned.  If @var{value}
 is too large or too small @code{NULL} is returned.
 
 @example
@@ -1530,10 +1530,6 @@
 As from @R{} 1.4.0, any arithmetic operation involving a zero-length
 vector has a zero-length result.
 
-One exception is that when adding vectors to matrices, a warning is not
-given if the lengths are incompatible.
- at c Is that a bug?
-
 @node Propagation of names, Dimensional attributes, Recycling rules, Elementary arithmetic operations
 @subsection Propagation of names
 @cindex name
@@ -1842,7 +1838,7 @@
 matching.
 
 The most important example of a class method for @code{[} is that used
-for data frames.  It is not be described in detail here (see the help
+for data frames.  It is not described in detail here (see the help
 page for @code{[.data.frame}, but in broad terms, if two indices are
 supplied (even if one is empty) it creates matrix-like indexing for a
 structure that is basically a list of vectors of the same length.  If a
@@ -1865,7 +1861,7 @@
 @example
 x[3:5] <- 13:15
 @end example
-The result of this commands is as if the following had been executed
+The result of this command is as if the following had been executed
 @example
 `*tmp*` <- x
 x <- "[<-"(`*tmp*`, 3:5, value=13:15)
@@ -2246,7 +2242,7 @@
 this is not given a name it is referred to as an
 @cindex function, anonymous
 anonymous
-function. Anonymous functions are most frequently used as arguments
+function. Anonymous functions are most frequently used as arguments to
 other functions such as the @code{apply} family or @code{outer}.
 
 Here is a simple function: @code{echo <- function(x) print(x)}.  So
@@ -2455,7 +2451,7 @@
 The process of filling the value slot of a promise by
 @cindex evaluation
 evaluating the
-contents of the expression slot in the promises environment is called
+contents of the expression slot in the promise's environment is called
 @emph{forcing} the promise.  A promise will only be forced once, the
 value slot content being used directly later on.
 
@@ -2697,10 +2693,10 @@
 functions and types that will be discussed elsewhere.
 
 The class system is facilitated through the @code{class} attribute.
-This attribute is a list of class names.  So to create an object of
-class @code{"foo"} one simply attaches a class attribute with the string
- at samp{"foo"} in it.  Thus, virtually anything can be turned in to an
-object of class @code{"foo"}.
+This attribute is a character vector of class names.  So to create an
+object of class @code{"foo"} one simply attaches a class attribute with
+the string @samp{"foo"} in it.  Thus, virtually anything can be turned
+in to an object of class @code{"foo"}.
 
 The object system makes use of
 @cindex function, generic
@@ -2826,7 +2822,7 @@
 existing systems since the user is only responsible for dealing with the
 new representation and not with any of the existing representations.
 
-The bulk of the uses of this methodology are to provided specialized
+The bulk of the uses of this methodology are to provide specialized
 printing for objects of different types; there are about 40 methods for
 @code{print}.
 
@@ -2952,10 +2948,6 @@
 Any arguments to the generic that were evaluated prior to the call to
 @code{UseMethod} remain evaluated.
 
-The arguments in the call to the generic are rematched with the
-arguments for the method using the standard argument matching mechanism.
-The first argument, i.e.@: the object, will have been evaluated.
-
 If the first argument to @code{UseMethod} is not supplied it is assumed
 to be the name of the current function.  If two arguments are supplied
 to @code{UseMethod} then the first is the name of the method and the
@@ -2963,7 +2955,7 @@
 evaluated so that the required method can be determined.  In this case
 the first argument in the call to the generic is not evaluated and is
 discarded.  There is no way to change the other arguments in the call to
-the method these remain as they were in the call to the generic.  This
+the method; these remain as they were in the call to the generic.  This
 is in contrast to @code{NextMethod} where the arguments in the call to
 the next method can be altered.
 
@@ -3405,7 +3397,7 @@
 
 This looks straightforward, but one will discover that the y label
 becomes an ugly @code{c(...)} expression.  It happens because the rules
-of lazy evaluation causes the evaluation of the @code{ylab} expression
+of lazy evaluation cause the evaluation of the @code{ylab} expression
 to happen @emph{after} @code{y} has been modified.  The solution is to
 force @code{ylab} to be evaluated first, i.e.,
 
@@ -3975,7 +3967,7 @@
 @section Error options
 
 There are a number of @code{options} variables that can be used to
-control how @R{} handles errors and warnings.  The are listed in the
+control how @R{} handles errors and warnings.  They are listed in the
 table below.
 
 @table @samp
@@ -4414,8 +4406,8 @@
 
 @cindex identifier
 Identifiers consist of a sequence of letters, digits, the period
-(@samp{.}) and the underscore.  They must not start with a digit nor
-underscore, nor with a period followed by a digit.
+(@samp{.}) and the underscore.  They must not start with a digit or
+an underscore, or with a period followed by a digit.
 
 The definition of a letter depends on the current locale: the precise
 set of characters allowed is given by the C expression @code{(isalnum(c)
@@ -4542,7 +4534,7 @@
 @node Indexing tokens,  , Grouping, Tokens
 @subsection Indexing tokens
 
-Indexing of arrays and vectors performed using the single and double
+Indexing of arrays and vectors is performed using the single and double
 brackets, @samp{[]} and @samp{[[]]}.  Also, indexing tagged lists
 may be done using the @samp{$} operator.
 
@@ -4611,7 +4603,7 @@
 @node Infix and prefix operators, Index constructions, Function calls (expressions), Expressions
 @subsection Infix and prefix operators
 
-The order of precedence (highest first) of the operators are
+The order of precedence (highest first) of the operators is
 
 @example
 ::
@@ -4664,7 +4656,7 @@
 Notice that the
 @cindex assignment
 assignment symbols are operators just like the arithmetic, relational,
-and logical ones.  Any expressions is allowed also on the target side of
+and logical ones.  Any expression is allowed also on the target side of
 an assignment, as far as the parser is concerned (@code{2 + 2 <- 5} is a
 valid expression as far as the parser is concerned.  The evaluator will
 object, though).  Similar comments apply to the model formula operator.

From Jean-Michel.Perraud at csiro.au  Thu Nov 21 07:39:34 2013
From: Jean-Michel.Perraud at csiro.au (Jean-Michel.Perraud at csiro.au)
Date: Thu, 21 Nov 2013 06:39:34 +0000
Subject: [Rd] Running R embedded in an mpiexec spawned process - Fatal
 error: you must specify '--save', '--no-save' or '--vanilla'
Message-ID: <9657E5F32D0E5F4599B08172DA6CE8810C95F119@exmbx02-cdc.nexus.csiro.au>

I'd like someone familiar with the R options initialization to comment on a difference of behavior within/without mpiexec

I have a (.NET) application with embedded R that is proven to run in a single process:

    ./Sample1.exe

on a Debian Linux with R 3.0.2

Running the same code with mpiexec, it fails at the R engine initialization:

    mpiexec -n 1 ./Sample1.exe
    Fatal error: you must specify '--save', '--no-save' or '--vanilla'
    -------------------------------------------------------------------------

The behavior is actually reproducible with the straight R 
    mpiexec -n 1 R
    Fatal error: you must specify '--save', '--no-save' or '--vanilla'
    -------------------------------------------------------------------------
The following is working:
    mpiexec -n 1 R --no-save

However in my Sample1 application, I do set up R init options that should be suitable AFAIK:

            rEngine = REngine.CreateInstance("RDotNet");
            StartupParameter rStartParams = new StartupParameter
            {
                Quiet = true,
                SaveAction = StartupSaveAction.NoSave,
                Slave = false,
                Interactive = true,
                Verbose = false,
                LoadInitFile = true,
                LoadSiteFile = true,
                RestoreAction = StartupRestoreAction.NoRestore,
                NoRenviron = false
            };
            rEngine.Initialize(rStartParams); // calls the R API R_SetParams, then setup_Rmainloop


I gather that the following is hit in src/R-3.0.2/src/unix/system.c, in the function Rf_initialize_R:

    if (!R_Interactive && Rp->SaveAction != SA_SAVE &&
	Rp->SaveAction != SA_NOSAVE)
	R_Suicide(_("you must specify '--save', '--no-save' or '--vanilla'"));

I don't understand why it would complain if spawned by mpiexec and fine otherwise. 

I do not have a suitable debugging environment to step through a R with debug symbols, and no stack trace is given as console output.
As an aside, the same code (barring platform specifics) works on Windows.

Thanks





From ripley at stats.ox.ac.uk  Thu Nov 21 08:17:19 2013
From: ripley at stats.ox.ac.uk (Prof Brian Ripley)
Date: Thu, 21 Nov 2013 07:17:19 +0000
Subject: [Rd] Running R embedded in an mpiexec spawned process - Fatal
 error: you must specify '--save', '--no-save' or '--vanilla'
In-Reply-To: <9657E5F32D0E5F4599B08172DA6CE8810C95F119@exmbx02-cdc.nexus.csiro.au>
References: <9657E5F32D0E5F4599B08172DA6CE8810C95F119@exmbx02-cdc.nexus.csiro.au>
Message-ID: <528DB37F.9090508@stats.ox.ac.uk>

On 21/11/2013 06:39, Jean-Michel.Perraud at csiro.au wrote:
> I'd like someone familiar with the R options initialization to comment on a difference of behavior within/without mpiexec

> I have a (.NET) application with embedded R that is proven to run in a single process:
>
>      ./Sample1.exe
>
> on a Debian Linux with R 3.0.2
>
> Running the same code with mpiexec, it fails at the R engine initialization:
>
>      mpiexec -n 1 ./Sample1.exe
>      Fatal error: you must specify '--save', '--no-save' or '--vanilla'
>      -------------------------------------------------------------------------
>
> The behavior is actually reproducible with the straight R
>      mpiexec -n 1 R
>      Fatal error: you must specify '--save', '--no-save' or '--vanilla'
>      -------------------------------------------------------------------------
> The following is working:
>      mpiexec -n 1 R --no-save
>
> However in my Sample1 application, I do set up R init options that should be suitable AFAIK:
>
>              rEngine = REngine.CreateInstance("RDotNet");
>              StartupParameter rStartParams = new StartupParameter
>              {
>                  Quiet = true,
>                  SaveAction = StartupSaveAction.NoSave,
>                  Slave = false,
>                  Interactive = true,
>                  Verbose = false,
>                  LoadInitFile = true,
>                  LoadSiteFile = true,
>                  RestoreAction = StartupRestoreAction.NoRestore,
>                  NoRenviron = false
>              };
>              rEngine.Initialize(rStartParams); // calls the R API R_SetParams, then setup_Rmainloop
>
>
> I gather that the following is hit in src/R-3.0.2/src/unix/system.c, in the function Rf_initialize_R:
>
>      if (!R_Interactive && Rp->SaveAction != SA_SAVE &&
> 	Rp->SaveAction != SA_NOSAVE)
> 	R_Suicide(_("you must specify '--save', '--no-save' or '--vanilla'"));
>
> I don't understand why it would complain if spawned by mpiexec and fine otherwise.

Most likely because the way you are running R is considered to be batch 
use, and R_Interactive is false.  You've mixed up two scenarios here: 
one an embedded use where we don't have all the code, and mpiexec.  In 
the mpiexec case, it is likely that stdin is not a ptty.

> I do not have a suitable debugging environment to step through a R with debug symbols, and no stack trace is given as console output.
> As an aside, the same code (barring platform specifics) works on Windows.

Deciding if Rterm is interactive is clearly done differently on an OS 
without pttys.


-- 
Brian D. Ripley,                  ripley at stats.ox.ac.uk
Professor of Applied Statistics,  http://www.stats.ox.ac.uk/~ripley/
University of Oxford,             Tel:  +44 1865 272861 (self)
1 South Parks Road,                     +44 1865 272866 (PA)
Oxford OX1 3TG, UK                Fax:  +44 1865 272595


From gmbecker at ucdavis.edu  Thu Nov 21 08:29:16 2013
From: gmbecker at ucdavis.edu (Gabriel Becker)
Date: Wed, 20 Nov 2013 23:29:16 -0800
Subject: [Rd] Running R embedded in an mpiexec spawned process - Fatal
 error: you must specify '--save', '--no-save' or '--vanilla'
In-Reply-To: <9657E5F32D0E5F4599B08172DA6CE8810C95F119@exmbx02-cdc.nexus.csiro.au>
References: <9657E5F32D0E5F4599B08172DA6CE8810C95F119@exmbx02-cdc.nexus.csiro.au>
Message-ID: <CADwqtCN=64AGKc7n4Q=wdQ0EVN-=9v=4ENoMkdJWPJyazdwFkg@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131120/6815ac49/attachment.pl>

From ripley at stats.ox.ac.uk  Thu Nov 21 09:58:28 2013
From: ripley at stats.ox.ac.uk (Prof Brian Ripley)
Date: Thu, 21 Nov 2013 08:58:28 +0000
Subject: [Rd] Running R embedded in an mpiexec spawned process - Fatal
 error: you must specify '--save', '--no-save' or '--vanilla'
In-Reply-To: <528DB37F.9090508@stats.ox.ac.uk>
References: <9657E5F32D0E5F4599B08172DA6CE8810C95F119@exmbx02-cdc.nexus.csiro.au>
	<528DB37F.9090508@stats.ox.ac.uk>
Message-ID: <528DCB34.7030502@stats.ox.ac.uk>

You can test my guess by

mpiexec -n 1 R --interactive

Works for me ....


On 21/11/2013 07:17, Prof Brian Ripley wrote:
> On 21/11/2013 06:39, Jean-Michel.Perraud at csiro.au wrote:
>> I'd like someone familiar with the R options initialization to comment
>> on a difference of behavior within/without mpiexec
>
>> I have a (.NET) application with embedded R that is proven to run in a
>> single process:
>>
>>      ./Sample1.exe
>>
>> on a Debian Linux with R 3.0.2
>>
>> Running the same code with mpiexec, it fails at the R engine
>> initialization:
>>
>>      mpiexec -n 1 ./Sample1.exe
>>      Fatal error: you must specify '--save', '--no-save' or '--vanilla'
>>
>> -------------------------------------------------------------------------
>>
>> The behavior is actually reproducible with the straight R
>>      mpiexec -n 1 R
>>      Fatal error: you must specify '--save', '--no-save' or '--vanilla'
>>
>> -------------------------------------------------------------------------
>> The following is working:
>>      mpiexec -n 1 R --no-save
>>
>> However in my Sample1 application, I do set up R init options that
>> should be suitable AFAIK:
>>
>>              rEngine = REngine.CreateInstance("RDotNet");
>>              StartupParameter rStartParams = new StartupParameter
>>              {
>>                  Quiet = true,
>>                  SaveAction = StartupSaveAction.NoSave,
>>                  Slave = false,
>>                  Interactive = true,
>>                  Verbose = false,
>>                  LoadInitFile = true,
>>                  LoadSiteFile = true,
>>                  RestoreAction = StartupRestoreAction.NoRestore,
>>                  NoRenviron = false
>>              };
>>              rEngine.Initialize(rStartParams); // calls the R API
>> R_SetParams, then setup_Rmainloop
>>
>>
>> I gather that the following is hit in src/R-3.0.2/src/unix/system.c,
>> in the function Rf_initialize_R:
>>
>>      if (!R_Interactive && Rp->SaveAction != SA_SAVE &&
>>     Rp->SaveAction != SA_NOSAVE)
>>     R_Suicide(_("you must specify '--save', '--no-save' or
>> '--vanilla'"));
>>
>> I don't understand why it would complain if spawned by mpiexec and
>> fine otherwise.
>
> Most likely because the way you are running R is considered to be batch
> use, and R_Interactive is false.  You've mixed up two scenarios here:
> one an embedded use where we don't have all the code, and mpiexec.  In
> the mpiexec case, it is likely that stdin is not a ptty.
>
>> I do not have a suitable debugging environment to step through a R
>> with debug symbols, and no stack trace is given as console output.
>> As an aside, the same code (barring platform specifics) works on Windows.
>
> Deciding if Rterm is interactive is clearly done differently on an OS
> without pttys.
>
>


-- 
Brian D. Ripley,                  ripley at stats.ox.ac.uk
Professor of Applied Statistics,  http://www.stats.ox.ac.uk/~ripley/
University of Oxford,             Tel:  +44 1865 272861 (self)
1 South Parks Road,                     +44 1865 272866 (PA)
Oxford OX1 3TG, UK                Fax:  +44 1865 272595


From Jean-Michel.Perraud at csiro.au  Thu Nov 21 11:39:10 2013
From: Jean-Michel.Perraud at csiro.au (Jean-Michel.Perraud at csiro.au)
Date: Thu, 21 Nov 2013 10:39:10 +0000
Subject: [Rd] Running R embedded in an mpiexec spawned process - Fatal
 error: you must specify '--save', '--no-save' or '--vanilla'
In-Reply-To: <CADwqtCN=64AGKc7n4Q=wdQ0EVN-=9v=4ENoMkdJWPJyazdwFkg@mail.gmail.com>
References: <9657E5F32D0E5F4599B08172DA6CE8810C95F119@exmbx02-cdc.nexus.csiro.au>,
	<CADwqtCN=64AGKc7n4Q=wdQ0EVN-=9v=4ENoMkdJWPJyazdwFkg@mail.gmail.com>
Message-ID: <9657E5F32D0E5F4599B08172DA6CE8810C95F1F7@exmbx02-cdc.nexus.csiro.au>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131121/7c4be73d/attachment.pl>

From danp at metrumrg.com  Thu Nov 21 17:23:23 2013
From: danp at metrumrg.com (Daniel Polhamus)
Date: Thu, 21 Nov 2013 11:23:23 -0500
Subject: [Rd] R CMD check (v-3.0.2) not loading $R_CHECK_ENVIRON
Message-ID: <CAGJuTd-DdG8Qi-d0T-FsuKu=c93p=mELvFMXQF4-pzCU53EuSw@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131121/48858056/attachment.pl>

From edd at debian.org  Thu Nov 21 17:57:08 2013
From: edd at debian.org (Dirk Eddelbuettel)
Date: Thu, 21 Nov 2013 10:57:08 -0600
Subject: [Rd] R CMD check (v-3.0.2) not loading $R_CHECK_ENVIRON
In-Reply-To: <CAGJuTd-DdG8Qi-d0T-FsuKu=c93p=mELvFMXQF4-pzCU53EuSw@mail.gmail.com>
References: <CAGJuTd-DdG8Qi-d0T-FsuKu=c93p=mELvFMXQF4-pzCU53EuSw@mail.gmail.com>
Message-ID: <21134.15204.190737.936995@max.nulle.part>


On 21 November 2013 at 11:23, Daniel Polhamus wrote:
| Hi all,
| 
| I'm trying to check a package using R CMD check --as-cran <package>.  When
| I do so, the check fails upon not finding the dependencies which I have
| installed in a non-standard location.  Per the manual, I created
| ~/.R/check.Renviron :

Who is '~' here?  You, or root?

| $ cat ~/.R/check.Renviron
| R_LIBS=/usr/lib64/R/library:/usr/lib64/R/var
| R_LIBS_SITE=/usr/lib64/R/library:/usr/lib64/R/var

/usr/lib64/R/var ?  Really?   You mix system directories with user-controlled
ones?  Interesting surprises may come your way...

| No luck.  I tried explicitly pointing R_CHECK_ENVIRON to
| ~/.R/check.Renviron:
| 
| $ echo $R_CHECK_ENVIRON
| /root/.R/check.Renviron
| 
| Still no luck.  Finally, I just set R_LIBS globally (which, was empty)
| before running the check and the dependencies are then found.  Just wanted
| to be sure I'm not missing something before creating a bug report.
| 
| This is on Ubuntu 10.04 with R-3.0.2, as root.

Never ever run R as root.  

If you want to write to /usr/local/lib/R/site-library (as you may want to and
should), either change the permissions, or better still add yourself and
colleagues to the group owning the directory and/or make the directory
group-owned by a group on the system (our choice at work). R 3.0.2 now
reflects these permission so you can all write there jointly.

That said, this all works here, but I run R as me and never ever as root:

   edd at max:~$ tail -4 .R/check.Renviron
   # edd Apr 2003  Allow local install in /usr/local, also add a directory for
   #               Debian packaged CRAN packages, and finally the default dir 
   # edd Jul 2007  Now use R_LIBS_SITE, not R_LIBS
   R_LIBS_SITE=${R_LIBS_SITE-'/usr/local/lib/R/site-library:/usr/lib/R/site-library:/usr/lib/R/library'}
   edd at max:~$ 

The question would have been quite appropriate for r-sig-debian (which also
acts as "r-sig-ubuntu").

Lastly: Ubuntu 10.04. Really?  I find 12.04 too old.  

Dirk

 
| Many thanks...
| 
| -- 
| Daniel G Polhamus, PhD
| Metrum Research Group, LLC
| 
| 	[[alternative HTML version deleted]]
| 
| ______________________________________________
| R-devel at r-project.org mailing list
| https://stat.ethz.ch/mailman/listinfo/r-devel

-- 
Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com


From danp at metrumrg.com  Thu Nov 21 19:34:02 2013
From: danp at metrumrg.com (Daniel Polhamus)
Date: Thu, 21 Nov 2013 13:34:02 -0500
Subject: [Rd] R CMD check (v-3.0.2) not loading $R_CHECK_ENVIRON
In-Reply-To: <21134.15204.190737.936995@max.nulle.part>
References: <CAGJuTd-DdG8Qi-d0T-FsuKu=c93p=mELvFMXQF4-pzCU53EuSw@mail.gmail.com>
	<21134.15204.190737.936995@max.nulle.part>
Message-ID: <CAGJuTd-FJ66CE97E6EupPQ9xORaZfAAahN=iFq2o07nAdMgd4A@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131121/752d7efb/attachment.pl>

From edd at debian.org  Thu Nov 21 19:52:55 2013
From: edd at debian.org (Dirk Eddelbuettel)
Date: Thu, 21 Nov 2013 12:52:55 -0600
Subject: [Rd] R CMD check (v-3.0.2) not loading $R_CHECK_ENVIRON
In-Reply-To: <CAGJuTd-FJ66CE97E6EupPQ9xORaZfAAahN=iFq2o07nAdMgd4A@mail.gmail.com>
References: <CAGJuTd-DdG8Qi-d0T-FsuKu=c93p=mELvFMXQF4-pzCU53EuSw@mail.gmail.com>
	<21134.15204.190737.936995@max.nulle.part>
	<CAGJuTd-FJ66CE97E6EupPQ9xORaZfAAahN=iFq2o07nAdMgd4A@mail.gmail.com>
Message-ID: <21134.22151.870207.630512@max.nulle.part>


On 21 November 2013 at 13:34, Daniel Polhamus wrote:
| Dirk,
| Thanks for the advice on general usage. ?For context, these builds occur on
| Amazon AMI's with ephemeral instances, R is never updated by users (hence the
| careless placement of a user controlled library in a system library). ?
| ??
| You indicate that R CMD check should behave as specified in the manual if
| running as me, not root. ?This didn't solve the problem, it still fails to
| load the R_SITE_LIBS from the check.Renviron file. ? Furthermore, I just
| tested this on my local machine (OS/X 10.9, again with R-3.0.2) and I'm seeing
| identical behavior. ?
| 
| The check passes without a problem after setting R_LIBS (perhaps not necessary)
| and R_SITE_LIBS globally ($ export R_SITE_LIBS=<path>).
| 
| I suspect that if I install dependencies into /usr/local/lib/R/site-library (or
| any place in the default .libPaths) as you suggest, the check will pass -- but
| I am installing OFF the default path for a good reason.

If R comes from the package(s) we provide, try editing / sed'ing
/etc/R/Renviron.site directly.  That may work better than the per-user
settings.

The help(Startup) page is very long and detailed but should eventually help
you to get there.  

Note though that these things do change over time, so you may want to glance
at the NEWS file as well. I only started to use ~/.R/check.Renviron within
the last few years.

Cheers, Dirk

| 
| Dan
| 
| 
| 
| On Thu, Nov 21, 2013 at 11:57 AM, Dirk Eddelbuettel <edd at debian.org> wrote:
| 
| 
|     On 21 November 2013 at 11:23, Daniel Polhamus wrote:
|     | Hi all,
|     |
|     | I'm trying to check a package using R CMD check --as-cran <package>.
|     ?When
|     | I do so, the check fails upon not finding the dependencies which I have
|     | installed in a non-standard location. ?Per the manual, I created
|     | ~/.R/check.Renviron :
| 
|     Who is '~' here? ?You, or root?
| 
|     | $ cat ~/.R/check.Renviron
|     | R_LIBS=/usr/lib64/R/library:/usr/lib64/R/var
|     | R_LIBS_SITE=/usr/lib64/R/library:/usr/lib64/R/var
| 
|     /usr/lib64/R/var ? ?Really? ? You mix system directories with
|     user-controlled
|     ones? ?Interesting surprises may come your way...
| 
|     | No luck. ?I tried explicitly pointing R_CHECK_ENVIRON to
|     | ~/.R/check.Renviron:
|     |
|     | $ echo $R_CHECK_ENVIRON
|     | /root/.R/check.Renviron
|     |
|     | Still no luck. ?Finally, I just set R_LIBS globally (which, was empty)
|     | before running the check and the dependencies are then found. ?Just
|     wanted
|     | to be sure I'm not missing something before creating a bug report.
|     |
|     | This is on Ubuntu 10.04 with R-3.0.2, as root.
| 
|     Never ever run R as root.
| 
|     If you want to write to /usr/local/lib/R/site-library (as you may want to
|     and
|     should), either change the permissions, or better still add yourself and
|     colleagues to the group owning the directory and/or make the directory
|     group-owned by a group on the system (our choice at work). R 3.0.2 now
|     reflects these permission so you can all write there jointly.
| 
|     That said, this all works here, but I run R as me and never ever as root:
| 
|     ? ?edd at max:~$ tail -4 .R/check.Renviron
|     ? ?# edd Apr 2003 ?Allow local install in /usr/local, also add a
|     directory for
|     ? ?# ? ? ? ? ? ? ? Debian packaged CRAN packages, and finally the
|     default dir
|     ? ?# edd Jul 2007 ?Now use R_LIBS_SITE, not R_LIBS
|     ? ?R_LIBS_SITE=${R_LIBS_SITE-'/usr/local/lib/R/site-library:/usr/lib/R/
|     site-library:/usr/lib/R/library'}
|     ? ?edd at max:~$
| 
|     The question would have been quite appropriate for r-sig-debian (which also
|     acts as "r-sig-ubuntu").
| 
|     Lastly: Ubuntu 10.04. Really? ?I find 12.04 too old.
| 
|     Dirk
| 
| 
|     | Many thanks...
|     |
|     | --
|     | Daniel G Polhamus, PhD
|     | Metrum Research Group, LLC
|     |
|     | ? ? ? [[alternative HTML version deleted]]
|     |
|     | ______________________________________________
|     | R-devel at r-project.org mailing list
|     | https://stat.ethz.ch/mailman/listinfo/r-devel
|    
|     --
|     Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com
| 
| 
| 
| 
| --
| Daniel G Polhamus, PhD
| Metrum Research Group, LLC
| 2 Tunxis Rd, Suite 112
| Tariffville, CT 06081
| (888) 308-7049 ext 403

-- 
Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com


From dtenenba at fhcrc.org  Fri Nov 22 20:51:49 2013
From: dtenenba at fhcrc.org (Dan Tenenbaum)
Date: Fri, 22 Nov 2013 11:51:49 -0800 (PST)
Subject: [Rd] tar binary in RTools 3.1.0.1939 has problems with tar.bz2 files
In-Reply-To: <826842250.2428541.1385149200210.JavaMail.root@fhcrc.org>
Message-ID: <1017678963.2428946.1385149909419.JavaMail.root@fhcrc.org>

Hi,

With Rtools 3.1.0.1936 I can create and extract from .tar.bz2 files:

(first directory in %PATH% is c:\rtools31.1936\bin)

E:\>tar jcvf tmp.tar.bz2 tmp
tmp/
tmp/foo.txt

E:\>tar jtvf tmp.tar.bz2
drwxr-xr-x 4294967295/4294967295 0 2013-11-22 11:35 tmp/
-rw-r--r-- 4294967295/4294967295 3 2013-11-22 11:35 tmp/foo.txt

E:\>mkdir ex

E:\>cd ex

E:\ex>tar jxvf ..\tmp.tar.bz2
tmp/
tmp/foo.txt

E:\ex>cd ..

E:\>rm -rf ex

...but this fails when using the tar binary in Rtools 3.1.0.1939. The following lines are run with c:\rtools31.1939 as the first directory in %PATH% (and there is only one Rtools installation referenced in %PATH% in both these examples):

E:\>tar jcvf tmp.tar.bz2 tmp
tmp/
tmp/foo.txt

E:\>tar jtvf tmp.tar.bz2

E:\>mkdir ex

E:\>cd ex

E:\ex>tar jxvf ..\tmp.tar.bz2

E:\ex>ls

E:\ex>

Can this be fixed?
Thanks,
Dan


From murdoch.duncan at gmail.com  Fri Nov 22 22:00:04 2013
From: murdoch.duncan at gmail.com (Duncan Murdoch)
Date: Fri, 22 Nov 2013 16:00:04 -0500
Subject: [Rd] tar binary in RTools 3.1.0.1939 has problems with tar.bz2
 files
In-Reply-To: <1017678963.2428946.1385149909419.JavaMail.root@fhcrc.org>
References: <1017678963.2428946.1385149909419.JavaMail.root@fhcrc.org>
Message-ID: <528FC5D4.9020608@gmail.com>

On 22/11/2013 2:51 PM, Dan Tenenbaum wrote:
> Hi,
>
> With Rtools 3.1.0.1936 I can create and extract from .tar.bz2 files:
>
> (first directory in %PATH% is c:\rtools31.1936\bin)
>
> E:\>tar jcvf tmp.tar.bz2 tmp
> tmp/
> tmp/foo.txt
>
> E:\>tar jtvf tmp.tar.bz2
> drwxr-xr-x 4294967295/4294967295 0 2013-11-22 11:35 tmp/
> -rw-r--r-- 4294967295/4294967295 3 2013-11-22 11:35 tmp/foo.txt
>
> E:\>mkdir ex
>
> E:\>cd ex
>
> E:\ex>tar jxvf ..\tmp.tar.bz2
> tmp/
> tmp/foo.txt
>
> E:\ex>cd ..
>
> E:\>rm -rf ex
>
> ...but this fails when using the tar binary in Rtools 3.1.0.1939. The following lines are run with c:\rtools31.1939 as the first directory in %PATH% (and there is only one Rtools installation referenced in %PATH% in both these examples):
>
> E:\>tar jcvf tmp.tar.bz2 tmp
> tmp/
> tmp/foo.txt
>
> E:\>tar jtvf tmp.tar.bz2
>
> E:\>mkdir ex
>
> E:\>cd ex
>
> E:\ex>tar jxvf ..\tmp.tar.bz2
>
> E:\ex>ls
>
> E:\ex>
>
> Can this be fixed?

The tar.exe is identical in those two versions of Rtools, just the 
Cygwin DLLs (and a few other utilities) changed.  So I suspect this is 
something else, or perhaps a bug in the new Cygwin DLLs -- but the old 
Cygwin DLLs don't work on Win 8.1.

Some things you could try:

Just use the old Rtools.

Use the Cygwin tar.exe (available from Cygwin) instead of ours.  At the 
time we made our custom tar.exe, the Cygwin one would not support 
Windows drive specs, but perhaps the current one does.

Use something else, e.g. bzip to decompress, then tar to get from the tar.

Duncan Murdoch


From dtenenba at fhcrc.org  Fri Nov 22 22:10:31 2013
From: dtenenba at fhcrc.org (Dan Tenenbaum)
Date: Fri, 22 Nov 2013 13:10:31 -0800 (PST)
Subject: [Rd] tar binary in RTools 3.1.0.1939 has problems with tar.bz2
 files
In-Reply-To: <528FC5D4.9020608@gmail.com>
Message-ID: <1361285312.2432052.1385154630999.JavaMail.root@fhcrc.org>



----- Original Message -----
> From: "Duncan Murdoch" <murdoch.duncan at gmail.com>
> To: "Dan Tenenbaum" <dtenenba at fhcrc.org>, "R-devel" <r-devel at r-project.org>
> Sent: Friday, November 22, 2013 1:00:04 PM
> Subject: Re: [Rd] tar binary in RTools 3.1.0.1939 has problems with tar.bz2 files
> 
> On 22/11/2013 2:51 PM, Dan Tenenbaum wrote:
> > Hi,
> >
> > With Rtools 3.1.0.1936 I can create and extract from .tar.bz2
> > files:
> >
> > (first directory in %PATH% is c:\rtools31.1936\bin)
> >
> > E:\>tar jcvf tmp.tar.bz2 tmp
> > tmp/
> > tmp/foo.txt
> >
> > E:\>tar jtvf tmp.tar.bz2
> > drwxr-xr-x 4294967295/4294967295 0 2013-11-22 11:35 tmp/
> > -rw-r--r-- 4294967295/4294967295 3 2013-11-22 11:35 tmp/foo.txt
> >
> > E:\>mkdir ex
> >
> > E:\>cd ex
> >
> > E:\ex>tar jxvf ..\tmp.tar.bz2
> > tmp/
> > tmp/foo.txt
> >
> > E:\ex>cd ..
> >
> > E:\>rm -rf ex
> >
> > ...but this fails when using the tar binary in Rtools 3.1.0.1939.
> > The following lines are run with c:\rtools31.1939 as the first
> > directory in %PATH% (and there is only one Rtools installation
> > referenced in %PATH% in both these examples):
> >
> > E:\>tar jcvf tmp.tar.bz2 tmp
> > tmp/
> > tmp/foo.txt
> >
> > E:\>tar jtvf tmp.tar.bz2
> >
> > E:\>mkdir ex
> >
> > E:\>cd ex
> >
> > E:\ex>tar jxvf ..\tmp.tar.bz2
> >
> > E:\ex>ls
> >
> > E:\ex>
> >
> > Can this be fixed?
> 
> The tar.exe is identical in those two versions of Rtools, just the
> Cygwin DLLs (and a few other utilities) changed.  So I suspect this
> is
> something else, or perhaps a bug in the new Cygwin DLLs -- but the
> old
> Cygwin DLLs don't work on Win 8.1.

Do you know which version of the cygwin dll's was used to produce this tar.exe? I can try and report this to the cygwin people if I have the appropriate information.

> 
> Some things you could try:
> 
> Just use the old Rtools.
> 

I'll probably do this for now, but I will want to be able to keep moving forward as necessary.

> Use the Cygwin tar.exe (available from Cygwin) instead of ours.  At
> the
> time we made our custom tar.exe, the Cygwin one would not support
> Windows drive specs, but perhaps the current one does.
> 

So if I understand correctly, the way to do this would be to simply remove or rename the tar.exe in rtools so that the cygwin one shows up first in the PATH, right? I do not want to move cygwin's tar.exe into the rtools\bin directory because it was probably built against a different DLL.

> Use something else, e.g. bzip to decompress, then tar to get from the
> tar.
> 

Sure, but this problem arose in the context of a bioconductor package that was expecting (reasonably) that system("tar jxf ...") would work, and as a result the package would not build. This could conceivably happen again in other contexts so I'd rather not work around it each time.

Thanks!
Dan


> Duncan Murdoch
>


From skyebend at skyeome.net  Fri Nov 22 22:43:25 2013
From: skyebend at skyeome.net (Skye Bender-deMoll)
Date: Fri, 22 Nov 2013 13:43:25 -0800
Subject: [Rd] what is the correct way to force a copy of an object?
Message-ID: <528FCFFD.10307@skyeome.net>

Dear R-devs,

I'm working on a package where we have a function that modifies an 
Object via .Call  to a C function. Unfortunately in some situations this 
counterintuitive modifies a previously made copy of the object passed to 
the function.  For example, if I first make an assignment to "copy" the 
object,

b<-a

and then modify 'a' , the value of 'b' will be modified as well.  I 
understand that this is probably due to lazy evaluation--the copy of 'a' 
is not made until the 'a' or 'b' instance is further modified. Peeking 
at 'a' and 'b' using .Internal(inspect(a)) seems to confirm this.  But 
for some reason our function is not triggering the copy.

We have been able to kludge it to force a copy and behave as expected by 
making a slight modification to the object before passing it to .Call:

modificationFun <- function(x){
   x$ForceCopy<-NULL
   x<-.Call("do_the_mod_in_c_R", package='mypackage')
   invisible(x)
}


What is the correct way to force the copy to occur to avoid 
inadvertently modifying both instances of the object?  Neither force() 
or eval() seem to do this.

Would it be faster to call duplicate(x) inside the C function instead of 
forcing the copy at the R level?

thanks for your help,
  -skye


From kevinushey at gmail.com  Sat Nov 23 00:00:44 2013
From: kevinushey at gmail.com (Kevin Ushey)
Date: Fri, 22 Nov 2013 15:00:44 -0800
Subject: [Rd] what is the correct way to force a copy of an object?
In-Reply-To: <528FCFFD.10307@skyeome.net>
References: <528FCFFD.10307@skyeome.net>
Message-ID: <CAJXgQP2-XLy=MBhg46s2fxkpJExim-HiuNwF-Cpja3p5atr_qw@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131122/10856825/attachment.pl>

From murdoch.duncan at gmail.com  Sat Nov 23 00:41:06 2013
From: murdoch.duncan at gmail.com (Duncan Murdoch)
Date: Fri, 22 Nov 2013 18:41:06 -0500
Subject: [Rd] what is the correct way to force a copy of an object?
In-Reply-To: <528FCFFD.10307@skyeome.net>
References: <528FCFFD.10307@skyeome.net>
Message-ID: <528FEB92.1050904@gmail.com>

On 13-11-22 4:43 PM, Skye Bender-deMoll wrote:
> Dear R-devs,
>
> I'm working on a package where we have a function that modifies an
> Object via .Call  to a C function. Unfortunately in some situations this
> counterintuitive modifies a previously made copy of the object passed to
> the function.  For example, if I first make an assignment to "copy" the
> object,
>
> b<-a
>
> and then modify 'a' , the value of 'b' will be modified as well.  I
> understand that this is probably due to lazy evaluation--the copy of 'a'
> is not made until the 'a' or 'b' instance is further modified. Peeking
> at 'a' and 'b' using .Internal(inspect(a)) seems to confirm this.  But
> for some reason our function is not triggering the copy.

No, lazy evaluation is a higher level concept.  Your problem is that you 
are modifying something without guaranteeing nobody else is using it.
>
> We have been able to kludge it to force a copy and behave as expected by
> making a slight modification to the object before passing it to .Call:
>
> modificationFun <- function(x){
>     x$ForceCopy<-NULL
>     x<-.Call("do_the_mod_in_c_R", package='mypackage')
>     invisible(x)
> }

That's not the right way to fix this.
>
>
> What is the correct way to force the copy to occur to avoid
> inadvertently modifying both instances of the object?  Neither force()
> or eval() seem to do this.
>
> Would it be faster to call duplicate(x) inside the C function instead of
> forcing the copy at the R level?

duplicate(x) at the C level is the only way to do this.  You can look at 
NAMED(x) to decide if this is necessary, or just do it unconditionally.

Duncan Murdoch

>
> thanks for your help,
>    -skye
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
>


From murdoch.duncan at gmail.com  Sat Nov 23 14:02:43 2013
From: murdoch.duncan at gmail.com (Duncan Murdoch)
Date: Sat, 23 Nov 2013 08:02:43 -0500
Subject: [Rd] tar binary in RTools 3.1.0.1939 has problems with tar.bz2
 files
In-Reply-To: <1361285312.2432052.1385154630999.JavaMail.root@fhcrc.org>
References: <1361285312.2432052.1385154630999.JavaMail.root@fhcrc.org>
Message-ID: <5290A773.7040808@gmail.com>

On 13-11-22 4:10 PM, Dan Tenenbaum wrote:
>
>
> ----- Original Message -----
>> From: "Duncan Murdoch" <murdoch.duncan at gmail.com>
>> To: "Dan Tenenbaum" <dtenenba at fhcrc.org>, "R-devel" <r-devel at r-project.org>
>> Sent: Friday, November 22, 2013 1:00:04 PM
>> Subject: Re: [Rd] tar binary in RTools 3.1.0.1939 has problems with tar.bz2 files
>>
>> On 22/11/2013 2:51 PM, Dan Tenenbaum wrote:
>>> Hi,
>>>
>>> With Rtools 3.1.0.1936 I can create and extract from .tar.bz2
>>> files:
>>>
>>> (first directory in %PATH% is c:\rtools31.1936\bin)
>>>
>>> E:\>tar jcvf tmp.tar.bz2 tmp
>>> tmp/
>>> tmp/foo.txt
>>>
>>> E:\>tar jtvf tmp.tar.bz2
>>> drwxr-xr-x 4294967295/4294967295 0 2013-11-22 11:35 tmp/
>>> -rw-r--r-- 4294967295/4294967295 3 2013-11-22 11:35 tmp/foo.txt
>>>
>>> E:\>mkdir ex
>>>
>>> E:\>cd ex
>>>
>>> E:\ex>tar jxvf ..\tmp.tar.bz2
>>> tmp/
>>> tmp/foo.txt
>>>
>>> E:\ex>cd ..
>>>
>>> E:\>rm -rf ex
>>>
>>> ...but this fails when using the tar binary in Rtools 3.1.0.1939.
>>> The following lines are run with c:\rtools31.1939 as the first
>>> directory in %PATH% (and there is only one Rtools installation
>>> referenced in %PATH% in both these examples):
>>>
>>> E:\>tar jcvf tmp.tar.bz2 tmp
>>> tmp/
>>> tmp/foo.txt
>>>
>>> E:\>tar jtvf tmp.tar.bz2
>>>
>>> E:\>mkdir ex
>>>
>>> E:\>cd ex
>>>
>>> E:\ex>tar jxvf ..\tmp.tar.bz2
>>>
>>> E:\ex>ls
>>>
>>> E:\ex>
>>>
>>> Can this be fixed?
>>
>> The tar.exe is identical in those two versions of Rtools, just the
>> Cygwin DLLs (and a few other utilities) changed.  So I suspect this
>> is
>> something else, or perhaps a bug in the new Cygwin DLLs -- but the
>> old
>> Cygwin DLLs don't work on Win 8.1.
>
> Do you know which version of the cygwin dll's was used to produce this tar.exe? I can try and report this to the cygwin people if I have the appropriate information.

No.

>
>>
>> Some things you could try:
>>
>> Just use the old Rtools.
>>
>
> I'll probably do this for now, but I will want to be able to keep moving forward as necessary.
>
>> Use the Cygwin tar.exe (available from Cygwin) instead of ours.  At
>> the
>> time we made our custom tar.exe, the Cygwin one would not support
>> Windows drive specs, but perhaps the current one does.
>>
>
> So if I understand correctly, the way to do this would be to simply remove or rename the tar.exe in rtools so that the cygwin one shows up first in the PATH, right? I do not want to move cygwin's tar.exe into the rtools\bin directory because it was probably built against a different DLL.

If you have Cygwin installed and the Rtools versions of the Cygwin DLLs 
are on your path, that could cause this.  You should not mix versions of 
Cygwin DLLs on the same system.  Use the Rtools ones, or the ones in the 
Cygwin installation, but not both.  I suspect that the utilities in 
Rtools won't work with older Cygwin DLLs, but I've never tried that, and 
it could be your problem if you haven't updated Cygwin as recently as 
you updated Rtools.

Cygwin claims that newer versions of their DLLs will always work against 
older exes compiled against them, and in my experience that is usually 
(but not always) true.  They don't claim new exes will work with old DLLs.

Duncan Murdoch


>> Use something else, e.g. bzip to decompress, then tar to get from the
>> tar.
>>
>
> Sure, but this problem arose in the context of a bioconductor package that was expecting (reasonably) that system("tar jxf ...") would work, and as a result the package would not build. This could conceivably happen again in other contexts so I'd rather not work around it each time.
>
> Thanks!
> Dan
>
>
>> Duncan Murdoch
>>


From gmbecker at ucdavis.edu  Sat Nov 23 20:23:03 2013
From: gmbecker at ucdavis.edu (Gabriel Becker)
Date: Sat, 23 Nov 2013 11:23:03 -0800
Subject: [Rd] [Bioc-devel] package citations
In-Reply-To: <CAC2h7us3nzsnTdhK1nLUci+5zJ9afYSOU2Qar22taF8WTso1og@mail.gmail.com>
References: <CAC2h7us3nzsnTdhK1nLUci+5zJ9afYSOU2Qar22taF8WTso1og@mail.gmail.com>
Message-ID: <CADwqtCO3+VTn5Pz2Hc-ZtS0k95oRejSOY7rae=vg8UsTzTAyLA@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131123/9838416f/attachment.pl>

From matthieu.stigler at gmail.com  Mon Nov 25 22:05:06 2013
From: matthieu.stigler at gmail.com (Matthieu Stigler)
Date: Mon, 25 Nov 2013 22:05:06 +0100
Subject: [Rd] 00Index and white space: specify in doc more than 1 space
	needed?
Message-ID: <CAEYvigLnbJZ0aWCyAZsDFFJS9Dj+6J+W6AB9v7UZ47_iVSRRFA@mail.gmail.com>

Dear R-devel list

I noticed while checking a package that the demo/00Index file needs
more than one space between the name and a description, a requirement
which is not very clear from reading the manual:
"[give a] name and a description separated by white space"

I realized this point had been already raised a few years ago, but
remained unanswered. Maybe this point is still valid and the
documentation could be updated?
https://stat.ethz.ch/pipermail/r-devel/2007-September/046811.html

Best regards

Matthieu


From htl10 at users.sourceforge.net  Tue Nov 26 12:51:24 2013
From: htl10 at users.sourceforge.net (Hin-Tak Leung)
Date: Tue, 26 Nov 2013 11:51:24 +0000
Subject: [Rd] freetype 2.5.1 and mono 3.2.5 (was Re: new bugs and new
 bundles Re: R/Sweave/cairo/freetype bug fix.)
In-Reply-To: <5225B120.8050406@users.sourceforge.net>
References: <1371134413.44971.YahooMailClassic@web172306.mail.ir2.yahoo.com>
	<5225B120.8050406@users.sourceforge.net>
Message-ID: <52948B3C.8020801@users.sourceforge.net>

The freetype people fixed the 2nd set of issues with system fonts shipped with 
Mac OS X, and released 2.5.1 almost immediately after that. So there are
new bundles under http://sourceforge.net/projects/outmodedbonsai/files/R/ .

Just a reminder that the official R binaries for windows/mac OS X are statically 
linked with rather dated versions of freetype with a few known issues. This 
affects the cairo-based functionalities in R. So a rebuild is needed.

Most unix users should just upgrade their system's libfreetype, and 
dynamic-linking should take care of the rest.

Also the routine upgrade of mono 3.2 5. It is, as usual, slightly adapted to
run Illumina GenomeStudio and ...-like workloads on Linux and Mac OS X better.

Hin-Tak Leung wrote:
> The most up-to-date version of freetype (2.5.0.1) have problems with at least
> two of the system fonts shipped with Mac OS X. So the "p1" in "2.5.0.1p1":
>
> cairo-1.12.16+freetype-2.5.0.1p1_macosx.tar.bz2
> cairo-1.12.16+freetype-2.5.0.1p1_windows.tar.bz2
>
> means "2.5.0.1" + 274207eb9a0e3bb20edf30e9a62e25120d5d15e5 (the fix for one of
> the problems). There might be p2 bundles if 2.5.1 doesn't come out soon enough
> with fixes for the rest of the problems.
>
> http://sourceforge.net/projects/outmodedbonsai/files/R/
>
> Just so we are clear, if freetype have problem with a system font, fontconfig
> has problem with a system font, and cairo and R etc.
>
> Unix users should just upgrade. I'll get round to build R 2.15.3 (or 2.15.x) for
> windows and Mac OS X at some stage, but if somebody want to beat me to it,
> please feel free to do so.


From dusa.adrian at gmail.com  Tue Nov 26 17:12:08 2013
From: dusa.adrian at gmail.com (=?UTF-8?B?QWRyaWFuIER1xZ9h?=)
Date: Tue, 26 Nov 2013 18:12:08 +0200
Subject: [Rd] dynamic lists at C level
Message-ID: <CAJ=0CtCn-GKHZ6VhNxuVbHF0oSpVrSYN_7Yy6swOHi4x1-25Hw@mail.gmail.com>

Dear R-devel,

I am trying to do something similar to dynamic length lists in R, but
at C level.

In R, that would be rather trivial:
- determine the length of the list
- create the list object
- store the values for each component
- access value components by using "[["

At C level, for a single component where I need to store a vector of
length 5, I do:

int *p_result;
SEXP my_list = PROTECT(allocVector(VECSXP, 1));
SEXP result = SET_VECTOR_ELT(my_list, 0, allocVector(INTSXP, 5));
p_result = INTEGER(result);


The number "1" (the length of "my_list") is dynamic, however.
Is there a web reference where I could do some further reading on this topic?

Thank you,
Adrian

-- 
Adrian Dusa
Romanian Social Data Archive
1, Schitu Magureanu Bd.
050025 Bucharest sector 5
Romania
Tel.:+40 21 3126618 \
        +40 21 3120210 / int.101
Fax: +40 21 3158391


From edd at debian.org  Tue Nov 26 17:43:13 2013
From: edd at debian.org (Dirk Eddelbuettel)
Date: Tue, 26 Nov 2013 10:43:13 -0600
Subject: [Rd] dynamic lists at C level
In-Reply-To: <CAJ=0CtCn-GKHZ6VhNxuVbHF0oSpVrSYN_7Yy6swOHi4x1-25Hw@mail.gmail.com>
References: <CAJ=0CtCn-GKHZ6VhNxuVbHF0oSpVrSYN_7Yy6swOHi4x1-25Hw@mail.gmail.com>
Message-ID: <21140.53153.880034.556888@max.nulle.part>


Hi Adrian,

On 26 November 2013 at 18:12, Adrian Du?a wrote:
| Dear R-devel,
| 
| I am trying to do something similar to dynamic length lists in R, but
| at C level.
| 
| In R, that would be rather trivial:
| - determine the length of the list
| - create the list object
| - store the values for each component
| - access value components by using "[["
| 
| At C level, for a single component where I need to store a vector of
| length 5, I do:
| 
| int *p_result;
| SEXP my_list = PROTECT(allocVector(VECSXP, 1));
| SEXP result = SET_VECTOR_ELT(my_list, 0, allocVector(INTSXP, 5));
| p_result = INTEGER(result);
| 
| 
| The number "1" (the length of "my_list") is dynamic, however.
| Is there a web reference where I could do some further reading on this topic?

If you are open to C++, there is a fair amount of documentation for Rcpp
which some of us find easier.   

Turing-equivalence does of course hold, and all we do here can also be done
at the C level given that we use the same 'SEXP foo(SEXP a, SEXP b, ...)'
interface -- while hiding most of it.

Here is a simple case where we define a creator function on the fly, compile,
link and load it and then have it creates lists of length 2 and 4, respectively:

R> library(Rcpp)
R> cppFunction("List adrian(int n) { return List(n); } ")
R> adrian(2)
[[1]]
NULL

[[2]]
NULL

R> adrian(4)
[[1]]
NULL

[[2]]
NULL

[[3]]
NULL

[[4]]
NULL

R> 

Hope this helps,  Dirk


-- 
Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com


From dusa.adrian at gmail.com  Tue Nov 26 17:57:16 2013
From: dusa.adrian at gmail.com (=?UTF-8?B?QWRyaWFuIER1xZ9h?=)
Date: Tue, 26 Nov 2013 18:57:16 +0200
Subject: [Rd] dynamic lists at C level
In-Reply-To: <21140.53153.880034.556888@max.nulle.part>
References: <CAJ=0CtCn-GKHZ6VhNxuVbHF0oSpVrSYN_7Yy6swOHi4x1-25Hw@mail.gmail.com>
	<21140.53153.880034.556888@max.nulle.part>
Message-ID: <CAJ=0CtC=OMdefDWh67amdupD5q0xWWnU_4qfTXmGJKUQECiyMg@mail.gmail.com>

Hi Dirk,

Thanks for your reply, at some point I did consider the possibility of
using Rcpp, but at that time I had already wrote a considerable amount
of regular C code.

Now I am only trying to extend that code a little, translating
everything in Rcpp would probably consume more time (although I agree
it might be easier to use).

I read the "Writing R Extensions" manual, I could only find how to
handle with R lists in C (section 5.9.6 Handling lists), but I could
not find how to <create> a list in C, and access its components, and
this is basically where I got stuck.

Best,
Adrian

On Tue, Nov 26, 2013 at 6:43 PM, Dirk Eddelbuettel <edd at debian.org> wrote:
>
> Hi Adrian,
>
> On 26 November 2013 at 18:12, Adrian Du?a wrote:
> | Dear R-devel,
> |
> | I am trying to do something similar to dynamic length lists in R, but
> | at C level.
> |
> | In R, that would be rather trivial:
> | - determine the length of the list
> | - create the list object
> | - store the values for each component
> | - access value components by using "[["
> |
> | At C level, for a single component where I need to store a vector of
> | length 5, I do:
> |
> | int *p_result;
> | SEXP my_list = PROTECT(allocVector(VECSXP, 1));
> | SEXP result = SET_VECTOR_ELT(my_list, 0, allocVector(INTSXP, 5));
> | p_result = INTEGER(result);
> |
> |
> | The number "1" (the length of "my_list") is dynamic, however.
> | Is there a web reference where I could do some further reading on this topic?
>
> If you are open to C++, there is a fair amount of documentation for Rcpp
> which some of us find easier.
>
> Turing-equivalence does of course hold, and all we do here can also be done
> at the C level given that we use the same 'SEXP foo(SEXP a, SEXP b, ...)'
> interface -- while hiding most of it.
>
> Here is a simple case where we define a creator function on the fly, compile,
> link and load it and then have it creates lists of length 2 and 4, respectively:
>
> R> library(Rcpp)
> R> cppFunction("List adrian(int n) { return List(n); } ")
> R> adrian(2)
> [[1]]
> NULL
>
> [[2]]
> NULL
>
> R> adrian(4)
> [[1]]
> NULL
>
> [[2]]
> NULL
>
> [[3]]
> NULL
>
> [[4]]
> NULL
>
> R>
>
> Hope this helps,  Dirk
>
>
> --
> Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com



-- 
Adrian Dusa
Romanian Social Data Archive
1, Schitu Magureanu Bd.
050025 Bucharest sector 5
Romania
Tel.:+40 21 3126618 \
        +40 21 3120210 / int.101
Fax: +40 21 3158391


From csardi.gabor at gmail.com  Tue Nov 26 18:05:20 2013
From: csardi.gabor at gmail.com (=?ISO-8859-1?B?R+Fib3IgQ3PhcmRp?=)
Date: Tue, 26 Nov 2013 12:05:20 -0500
Subject: [Rd] dynamic lists at C level
In-Reply-To: <CAJ=0CtC=OMdefDWh67amdupD5q0xWWnU_4qfTXmGJKUQECiyMg@mail.gmail.com>
References: <CAJ=0CtCn-GKHZ6VhNxuVbHF0oSpVrSYN_7Yy6swOHi4x1-25Hw@mail.gmail.com>
	<21140.53153.880034.556888@max.nulle.part>
	<CAJ=0CtC=OMdefDWh67amdupD5q0xWWnU_4qfTXmGJKUQECiyMg@mail.gmail.com>
Message-ID: <CABtg=K=+cCEa32S=FoxyU_Ayfx_Z3M6aNgb0aLi=vnGeAOfp-Q@mail.gmail.com>

On Tue, Nov 26, 2013 at 11:57 AM, Adrian Du?a <dusa.adrian at gmail.com> wrote:
[...]
> I read the "Writing R Extensions" manual, I could only find how to
> handle with R lists in C (section 5.9.6 Handling lists), but I could
> not find how to <create> a list in C, and access its components, and
> this is basically where I got stuck.

Create a new list with NEW_LIST(), set elements with SET_VECTOR_ELT(),
query elements with VECTOR_ELT().

Search 'Writing R Extensions', and the R source code itself, and/or
the source code of packages (authored by people you can trust, not my
packages, please :), for the details.

Gabor

[...]


From edd at debian.org  Tue Nov 26 18:19:02 2013
From: edd at debian.org (Dirk Eddelbuettel)
Date: Tue, 26 Nov 2013 11:19:02 -0600
Subject: [Rd] dynamic lists at C level
In-Reply-To: <CAJ=0CtC=OMdefDWh67amdupD5q0xWWnU_4qfTXmGJKUQECiyMg@mail.gmail.com>
References: <CAJ=0CtCn-GKHZ6VhNxuVbHF0oSpVrSYN_7Yy6swOHi4x1-25Hw@mail.gmail.com>
	<21140.53153.880034.556888@max.nulle.part>
	<CAJ=0CtC=OMdefDWh67amdupD5q0xWWnU_4qfTXmGJKUQECiyMg@mail.gmail.com>
Message-ID: <21140.55302.347287.625675@max.nulle.part>


Hi Adrian,

On 26 November 2013 at 18:57, Adrian Du?a wrote:
| Thanks for your reply, at some point I did consider the possibility of
| using Rcpp, but at that time I had already wrote a considerable amount
| of regular C code.
| 
| Now I am only trying to extend that code a little, translating
| everything in Rcpp would probably consume more time (although I agree
| it might be easier to use).

Well there is no need to translate a single line. C++ works happily with your
C code.  But instead of creating the list in C (which you had difficulty
with) you would create it in C++.

| I read the "Writing R Extensions" manual, I could only find how to
| handle with R lists in C (section 5.9.6 Handling lists), but I could
| not find how to <create> a list in C, and access its components, and
| this is basically where I got stuck.

Gabor gave you a good pointer.  Grep'ing through existing packages is often a
good idea.  If you can stomach reading other people's code ;-)

Dirk

-- 
Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com


From csardi.gabor at gmail.com  Tue Nov 26 18:28:38 2013
From: csardi.gabor at gmail.com (=?ISO-8859-1?B?R+Fib3IgQ3PhcmRp?=)
Date: Tue, 26 Nov 2013 12:28:38 -0500
Subject: [Rd] dynamic lists at C level
In-Reply-To: <21140.55302.347287.625675@max.nulle.part>
References: <CAJ=0CtCn-GKHZ6VhNxuVbHF0oSpVrSYN_7Yy6swOHi4x1-25Hw@mail.gmail.com>
	<21140.53153.880034.556888@max.nulle.part>
	<CAJ=0CtC=OMdefDWh67amdupD5q0xWWnU_4qfTXmGJKUQECiyMg@mail.gmail.com>
	<21140.55302.347287.625675@max.nulle.part>
Message-ID: <CABtg=KmXFBYNakxJc5UpD5vdokTFkXkptUE44BhwouFORgJUTw@mail.gmail.com>

On Tue, Nov 26, 2013 at 12:19 PM, Dirk Eddelbuettel <edd at debian.org> wrote:
[...]
> Grep'ing through existing packages is often a
> good idea.  If you can stomach reading other people's code ;-)

My experience is that you can learn at least as much from other
people's code as from textbooks. Unless you are god, of course. :)

Just choose wisely whose code you are reading. :)

But this is getting a bit off-topic here. To be (slightly) on-topic: I
would start checking out code from packages maintained by R-core
members.

Gabor

[...]


From dusa.adrian at gmail.com  Tue Nov 26 19:15:08 2013
From: dusa.adrian at gmail.com (=?UTF-8?B?QWRyaWFuIER1xZ9h?=)
Date: Tue, 26 Nov 2013 20:15:08 +0200
Subject: [Rd] dynamic lists at C level
In-Reply-To: <CABtg=KmXFBYNakxJc5UpD5vdokTFkXkptUE44BhwouFORgJUTw@mail.gmail.com>
References: <CAJ=0CtCn-GKHZ6VhNxuVbHF0oSpVrSYN_7Yy6swOHi4x1-25Hw@mail.gmail.com>
	<21140.53153.880034.556888@max.nulle.part>
	<CAJ=0CtC=OMdefDWh67amdupD5q0xWWnU_4qfTXmGJKUQECiyMg@mail.gmail.com>
	<21140.55302.347287.625675@max.nulle.part>
	<CABtg=KmXFBYNakxJc5UpD5vdokTFkXkptUE44BhwouFORgJUTw@mail.gmail.com>
Message-ID: <CAJ=0CtBMCSXDosi4VYwvwajtqBJn45PODzaOEupOQV31bCwuBg@mail.gmail.com>

Thank you both, will then start from here.
I didn't know that Rcpp could be fed with the C code, that's good to know...!

Best wishes,
Adrian

On Tue, Nov 26, 2013 at 7:28 PM, G?bor Cs?rdi <csardi.gabor at gmail.com> wrote:
> On Tue, Nov 26, 2013 at 12:19 PM, Dirk Eddelbuettel <edd at debian.org> wrote:
> [...]
>> Grep'ing through existing packages is often a
>> good idea.  If you can stomach reading other people's code ;-)
>
> My experience is that you can learn at least as much from other
> people's code as from textbooks. Unless you are god, of course. :)
>
> Just choose wisely whose code you are reading. :)
>
> But this is getting a bit off-topic here. To be (slightly) on-topic: I
> would start checking out code from packages maintained by R-core
> members.
>
> Gabor
>
> [...]



-- 
Adrian Dusa
Romanian Social Data Archive
1, Schitu Magureanu Bd.
050025 Bucharest sector 5
Romania
Tel.:+40 21 3126618 \
        +40 21 3120210 / int.101
Fax: +40 21 3158391


From lg390 at cam.ac.uk  Wed Nov 27 00:03:22 2013
From: lg390 at cam.ac.uk (Laurent Gatto)
Date: Tue, 26 Nov 2013 23:03:22 +0000
Subject: [Rd] Blank lines in DESCRIPTION
Message-ID: <87eh6222bp.fsf@cam.ac.uk>


Dear R-devel list,

I would like to enquire about the existence of blank lines in the
DESCRIPTION file.

Testing different possibilities with tools:::.read_description suggests
that starting or ending with blank lines is acceptable while blank lines
in the middle of the file get caught by

out <- tryCatch(read.dcf(dfile, keep.white = .keep_white_description_fields), 
        error = function(e) stop(gettextf("file '%s' is not in valid DCF format", 
            dfile), domain = NA, call. = FALSE))
if (nrow(out) != 1) 
    stop("contains a blank line", call. = FALSE)

and produce the error. 

However, the following news item from [1] seems to suggest that it
should not fail in case of such incorrect blank lines.

R CMD check no longer fails with an error if a ?DESCRIPTION? file incorrectly contains a blank line. (Reported by Bill Dunlap.)

This has come up here [2], when github-specific information is appended
to a DESCRIPTION file that ends with a blank line.

Thank you very much in advance.

Best wishes,

Laurent

[1] http://cran.r-project.org/bin/windows/base/old/2.15.3/NEWS.R-2.15.3.html
[2] https://github.com/hadley/devtools/issues/383


From simon.urbanek at r-project.org  Wed Nov 27 05:06:24 2013
From: simon.urbanek at r-project.org (Simon Urbanek)
Date: Tue, 26 Nov 2013 23:06:24 -0500
Subject: [Rd] Blank lines in DESCRIPTION
In-Reply-To: <87eh6222bp.fsf@cam.ac.uk>
References: <87eh6222bp.fsf@cam.ac.uk>
Message-ID: <8478DC28-2761-42A6-835E-26799B092155@r-project.org>

Laurent,

blank lines between records are not allowed in DESCRIPTION, because they separate paragraphs in DCF and a package must consist of a single paragraph. This properly is used by R for multi-package DCF files where each paragraph defines one package. Blank lines at the end may be tolerated, because there is no second paragraph in that case. If you look at the commit you quote (r60495), it specifically adds an error if there is more than one paragraph.

Cheers,
Simon


On Nov 26, 2013, at 6:03 PM, Laurent Gatto <lg390 at cam.ac.uk> wrote:

> Dear R-devel list,
> 
> I would like to enquire about the existence of blank lines in the
> DESCRIPTION file.
> 
> Testing different possibilities with tools:::.read_description suggests
> that starting or ending with blank lines is acceptable while blank lines
> in the middle of the file get caught by
> 
> out <- tryCatch(read.dcf(dfile, keep.white = .keep_white_description_fields), 
>        error = function(e) stop(gettextf("file '%s' is not in valid DCF format", 
>            dfile), domain = NA, call. = FALSE))
> if (nrow(out) != 1) 
>    stop("contains a blank line", call. = FALSE)
> 
> and produce the error. 
> 
> However, the following news item from [1] seems to suggest that it
> should not fail in case of such incorrect blank lines.
> 
> R CMD check no longer fails with an error if a ?DESCRIPTION? file incorrectly contains a blank line. (Reported by Bill Dunlap.)
> 
> This has come up here [2], when github-specific information is appended
> to a DESCRIPTION file that ends with a blank line.
> 
> Thank you very much in advance.
> 
> Best wishes,
> 
> Laurent
> 
> [1] http://cran.r-project.org/bin/windows/base/old/2.15.3/NEWS.R-2.15.3.html
> [2] https://github.com/hadley/devtools/issues/383
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


From lg390 at cam.ac.uk  Wed Nov 27 10:42:18 2013
From: lg390 at cam.ac.uk (Laurent Gatto)
Date: Wed, 27 Nov 2013 09:42:18 +0000
Subject: [Rd] Blank lines in DESCRIPTION
In-Reply-To: <8478DC28-2761-42A6-835E-26799B092155@r-project.org>
References: <87eh6222bp.fsf@cam.ac.uk>
	<8478DC28-2761-42A6-835E-26799B092155@r-project.org>
Message-ID: <877gbu18qt.fsf@cam.ac.uk>


> Laurent,
>
> blank lines between records are not allowed in DESCRIPTION, because
> they separate paragraphs in DCF and a package must consist of a single
> paragraph. This properly is used by R for multi-package DCF files
> where each paragraph defines one package. Blank lines at the end may
> be tolerated, because there is no second paragraph in that case. If
> you look at the commit you quote (r60495), it specifically adds an
> error if there is more than one paragraph.

Thank you very much for the clarification - makes perfect sense now!

Laurent

> Cheers,
> Simon
>
>
> On Nov 26, 2013, at 6:03 PM, Laurent Gatto <lg390 at cam.ac.uk> wrote:
>
>> Dear R-devel list,
>> 
>> I would like to enquire about the existence of blank lines in the
>> DESCRIPTION file.
>> 
>> Testing different possibilities with tools:::.read_description suggests
>> that starting or ending with blank lines is acceptable while blank lines
>> in the middle of the file get caught by
>> 
>> out <- tryCatch(read.dcf(dfile, keep.white = .keep_white_description_fields), 
>>        error = function(e) stop(gettextf("file '%s' is not in valid DCF format", 
>>            dfile), domain = NA, call. = FALSE))
>> if (nrow(out) != 1) 
>>    stop("contains a blank line", call. = FALSE)
>> 
>> and produce the error. 
>> 
>> However, the following news item from [1] seems to suggest that it
>> should not fail in case of such incorrect blank lines.
>> 
>> R CMD check no longer fails with an error if a ?DESCRIPTION? file incorrectly contains a blank line. (Reported by Bill Dunlap.)
>> 
>> This has come up here [2], when github-specific information is appended
>> to a DESCRIPTION file that ends with a blank line.
>> 
>> Thank you very much in advance.
>> 
>> Best wishes,
>> 
>> Laurent
>> 
>> [1] http://cran.r-project.org/bin/windows/base/old/2.15.3/NEWS.R-2.15.3.html
>> [2] https://github.com/hadley/devtools/issues/383
>> 
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel


From wolfgang.kaisers at gmail.com  Wed Nov 27 18:36:44 2013
From: wolfgang.kaisers at gmail.com (wokai)
Date: Wed, 27 Nov 2013 09:36:44 -0800 (PST)
Subject: [Rd] Checking packages with address sanitizer
Message-ID: <1385573804289-4681279.post@n4.nabble.com>

I was recently challenged to correct my package source (rbamtools) because
there were issues reported by address sanitizer.
Therefore the problem of installing and running instrumented (R +) package
code arises.

Regrettably up to now, I found no way to use the address sanitizer, neither
for a small C-example nor for a new compiled version of R.
I get missing `__asan_report_store4' or `__asan_report_load4' messages.

I'm working on Ubuntu 13.10 and tried gcc (4.8.1) and clang (3.2-7ubuntu1,
based on LLVM 3.2).

Does anyone have experiance with address sanitizer (especially with a self
compiled R-version which is not in the standard location on the system)?

Thanks in advance
Wolfgang



--
View this message in context: http://r.789695.n4.nabble.com/Checking-packages-with-address-sanitizer-tp4681279.html
Sent from the R devel mailing list archive at Nabble.com.


From simon.urbanek at r-project.org  Wed Nov 27 19:45:46 2013
From: simon.urbanek at r-project.org (Simon Urbanek)
Date: Wed, 27 Nov 2013 13:45:46 -0500
Subject: [Rd] Checking packages with address sanitizer
In-Reply-To: <1385573804289-4681279.post@n4.nabble.com>
References: <1385573804289-4681279.post@n4.nabble.com>
Message-ID: <E078285E-D3B9-4732-BB27-203EBFFFD7DF@r-project.org>


On Nov 27, 2013, at 12:36 PM, wokai <wolfgang.kaisers at gmail.com> wrote:

> I was recently challenged to correct my package source (rbamtools) because
> there were issues reported by address sanitizer.
> Therefore the problem of installing and running instrumented (R +) package
> code arises.
> 
> Regrettably up to now, I found no way to use the address sanitizer, neither
> for a small C-example nor for a new compiled version of R.
> I get missing `__asan_report_store4' or `__asan_report_load4' messages.
> 
> I'm working on Ubuntu 13.10 and tried gcc (4.8.1) and clang (3.2-7ubuntu1,
> based on LLVM 3.2).
> 
> Does anyone have experiance with address sanitizer (especially with a self
> compiled R-version which is not in the standard location on the system)?
> 

You have to compile *both* R and the package using AS flags. In fact, if you setup SA for R it will automatically work for packages. The above seems like you're trying to use AS just for the package, but that cannot work, because it's missing all the AS runtime libraries which must be in the main executable -- i.e. R.

Cheers,
Simon




> Thanks in advance
> Wolfgang
> 
> 
> 
> --
> View this message in context: http://r.789695.n4.nabble.com/Checking-packages-with-address-sanitizer-tp4681279.html
> Sent from the R devel mailing list archive at Nabble.com.
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
> 


From ripley at stats.ox.ac.uk  Wed Nov 27 20:24:53 2013
From: ripley at stats.ox.ac.uk (Prof Brian Ripley)
Date: Wed, 27 Nov 2013 19:24:53 +0000
Subject: [Rd] Checking packages with address sanitizer
In-Reply-To: <E078285E-D3B9-4732-BB27-203EBFFFD7DF@r-project.org>
References: <1385573804289-4681279.post@n4.nabble.com>
	<E078285E-D3B9-4732-BB27-203EBFFFD7DF@r-project.org>
Message-ID: <52964705.8060400@stats.ox.ac.uk>

On 27/11/2013 18:45, Simon Urbanek wrote:
>
> On Nov 27, 2013, at 12:36 PM, wokai <wolfgang.kaisers at gmail.com> wrote:
>
>> I was recently challenged to correct my package source (rbamtools) because
>> there were issues reported by address sanitizer.
>> Therefore the problem of installing and running instrumented (R +) package
>> code arises.
>>
>> Regrettably up to now, I found no way to use the address sanitizer, neither
>> for a small C-example nor for a new compiled version of R.
>> I get missing `__asan_report_store4' or `__asan_report_load4' messages.
>>
>> I'm working on Ubuntu 13.10 and tried gcc (4.8.1) and clang (3.2-7ubuntu1,
>> based on LLVM 3.2).
>>
>> Does anyone have experiance with address sanitizer (especially with a self
>> compiled R-version which is not in the standard location on the system)?
>>
>
> You have to compile *both* R and the package using AS flags. In fact, if you setup SA for R it will automatically work for packages. The above seems like you're trying to use AS just for the package, but that cannot work, because it's missing all the AS runtime libraries which must be in the main executable -- i.e. R.

Actually, it may work (does in gcc 4.8.2 for example), if you *link* the 
package with -faddress=sanitize.

See the current 'Writing R Examples' manual.

> Cheers,
> Simon
>
>
>
>
>> Thanks in advance
>> Wolfgang

-- 
Brian D. Ripley,                  ripley at stats.ox.ac.uk
Professor of Applied Statistics,  http://www.stats.ox.ac.uk/~ripley/
University of Oxford,             Tel:  +44 1865 272861 (self)
1 South Parks Road,                     +44 1865 272866 (PA)
Oxford OX1 3TG, UK                Fax:  +44 1865 272595


From jefferis at mrc-lmb.cam.ac.uk  Thu Nov 28 00:49:54 2013
From: jefferis at mrc-lmb.cam.ac.uk (Dr Gregory Jefferis)
Date: Wed, 27 Nov 2013 23:49:54 +0000
Subject: [Rd] inflate zlib compressed data using base R or CRAN package?
Message-ID: <D6454779-E162-4A11-B4B2-F26CE35CE5C2@mrc-lmb.cam.ac.uk>

Hello,

I have a binary file type that includes a zlib compressed data block (ie 
not gzip). Is anyone aware of a way using base R or a CRAN package to 
decompress this kind of data (from disk or memory). So far I have found 
Rcompression::decompress on omegahat, but I would prefer to keep 
dependencies on CRAN (or bioconductor). I am also trying to avoid 
writing yet another C level interface to part of zlib.

Many thanks for any pointers,

Greg.

--
Gregory Jefferis, PhD
Division of Neurobiology
MRC Laboratory of Molecular Biology
Francis Crick Avenue
Cambridge Biomedical Campus
Cambridge, CB2 OQH, UK

http://www2.mrc-lmb.cam.ac.uk/group-leaders/h-to-m/g-jefferis
http://jefferislab.org
http://flybrain.stanford.edu


From edd at debian.org  Thu Nov 28 01:38:56 2013
From: edd at debian.org (Dirk Eddelbuettel)
Date: Wed, 27 Nov 2013 18:38:56 -0600
Subject: [Rd] inflate zlib compressed data using base R or CRAN package?
In-Reply-To: <D6454779-E162-4A11-B4B2-F26CE35CE5C2@mrc-lmb.cam.ac.uk>
References: <D6454779-E162-4A11-B4B2-F26CE35CE5C2@mrc-lmb.cam.ac.uk>
Message-ID: <21142.37024.430585.526787@max.nulle.part>


On 27 November 2013 at 23:49, Dr Gregory Jefferis wrote:
| I have a binary file type that includes a zlib compressed data block (ie 
| not gzip). Is anyone aware of a way using base R or a CRAN package to 
| decompress this kind of data (from disk or memory). So far I have found 
| Rcompression::decompress on omegahat, but I would prefer to keep 
| dependencies on CRAN (or bioconductor). I am also trying to avoid 
| writing yet another C level interface to part of zlib.

Unless I am missing something, this is in base R; see help(connections).

Here is a quick demo:

R> write.csv(trees, file="/tmp/trees.csv")    # data we all have
R> system("gzip -v /tmp/trees.csv")           # as I am lazy here
/tmp/trees.csv:	 50.5% -- replaced with /tmp/trees.csv.gz
R> read.csv(gzfile("/tmp/trees.csv.gz"))      # works out of the box
    X Girth Height Volume
1   1   8.3     70   10.3
2   2   8.6     65   10.3
3   3   8.8     63   10.2
4   4  10.5     72   16.4
5   5  10.7     81   18.8
6   6  10.8     83   19.7
7   7  11.0     66   15.6
8   8  11.0     75   18.2
9   9  11.1     80   22.6
10 10  11.2     75   19.9
11 11  11.3     79   24.2
12 12  11.4     76   21.0
13 13  11.4     76   21.4
14 14  11.7     69   21.3
15 15  12.0     75   19.1
16 16  12.9     74   22.2
17 17  12.9     85   33.8
18 18  13.3     86   27.4
19 19  13.7     71   25.7
20 20  13.8     64   24.9
21 21  14.0     78   34.5
22 22  14.2     80   31.7
23 23  14.5     74   36.3
24 24  16.0     72   38.3
25 25  16.3     77   42.6
26 26  17.3     81   55.4
27 27  17.5     82   55.7
28 28  17.9     80   58.3
29 29  18.0     80   51.5
30 30  18.0     80   51.0
31 31  20.6     87   77.0
R> 


Hope this helps, Dirk

-- 
Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com


From edd at debian.org  Thu Nov 28 02:22:11 2013
From: edd at debian.org (Dirk Eddelbuettel)
Date: Wed, 27 Nov 2013 19:22:11 -0600
Subject: [Rd] inflate zlib compressed data using base R or CRAN package?
In-Reply-To: <21142.37024.430585.526787@max.nulle.part>
References: <D6454779-E162-4A11-B4B2-F26CE35CE5C2@mrc-lmb.cam.ac.uk>
	<21142.37024.430585.526787@max.nulle.part>
Message-ID: <21142.39619.914919.157672@max.nulle.part>


On 27 November 2013 at 18:38, Dirk Eddelbuettel wrote:
| 
| On 27 November 2013 at 23:49, Dr Gregory Jefferis wrote:
| | I have a binary file type that includes a zlib compressed data block (ie 
| | not gzip). Is anyone aware of a way using base R or a CRAN package to 
| | decompress this kind of data (from disk or memory). So far I have found 
| | Rcompression::decompress on omegahat, but I would prefer to keep 
| | dependencies on CRAN (or bioconductor). I am also trying to avoid 
| | writing yet another C level interface to part of zlib.
| 
| Unless I am missing something, this is in base R; see help(connections).
| 
| Here is a quick demo:
| 
| R> write.csv(trees, file="/tmp/trees.csv")    # data we all have
| R> system("gzip -v /tmp/trees.csv")           # as I am lazy here
| /tmp/trees.csv:	 50.5% -- replaced with /tmp/trees.csv.gz
| R> read.csv(gzfile("/tmp/trees.csv.gz"))      # works out of the box

Oh, and in case you meant zip file containing a data file, that also works.

First converting what I did last

edd at max:/tmp$ gunzip trees.csv.gz 
edd at max:/tmp$ zip trees.zip trees.csv 
  adding: trees.csv (deflated 50%)
edd at max:/tmp$ 

Then reading the csv from inside the zip file:

R> read.csv(unz("/tmp/trees.zip", "trees.csv"))
    X Girth Height Volume
1   1   8.3     70   10.3
2   2   8.6     65   10.3
3   3   8.8     63   10.2
4   4  10.5     72   16.4
5   5  10.7     81   18.8
6   6  10.8     83   19.7
7   7  11.0     66   15.6
8   8  11.0     75   18.2
9   9  11.1     80   22.6
10 10  11.2     75   19.9
11 11  11.3     79   24.2
12 12  11.4     76   21.0
13 13  11.4     76   21.4
14 14  11.7     69   21.3
15 15  12.0     75   19.1
16 16  12.9     74   22.2
17 17  12.9     85   33.8
18 18  13.3     86   27.4
19 19  13.7     71   25.7
20 20  13.8     64   24.9
21 21  14.0     78   34.5
22 22  14.2     80   31.7
23 23  14.5     74   36.3
24 24  16.0     72   38.3
25 25  16.3     77   42.6
26 26  17.3     81   55.4
27 27  17.5     82   55.7
28 28  17.9     80   58.3
29 29  18.0     80   51.5
30 30  18.0     80   51.0
31 31  20.6     87   77.0
R> 

Regards, Dirk

-- 
Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com


From murray at stokely.org  Thu Nov 28 02:30:19 2013
From: murray at stokely.org (Murray Stokely)
Date: Wed, 27 Nov 2013 17:30:19 -0800
Subject: [Rd] inflate zlib compressed data using base R or CRAN package?
In-Reply-To: <21142.39619.914919.157672@max.nulle.part>
References: <D6454779-E162-4A11-B4B2-F26CE35CE5C2@mrc-lmb.cam.ac.uk>
	<21142.37024.430585.526787@max.nulle.part>
	<21142.39619.914919.157672@max.nulle.part>
Message-ID: <CAECWziJfZJUu1BWq9w5e1UghjmiCO90q7PKNor-U-1dLM0P5HQ@mail.gmail.com>

An embedded and charset-unspecified text was scrubbed...
Name: not available
URL: <https://stat.ethz.ch/pipermail/r-devel/attachments/20131127/281f2a94/attachment.pl>

From edd at debian.org  Thu Nov 28 02:57:00 2013
From: edd at debian.org (Dirk Eddelbuettel)
Date: Wed, 27 Nov 2013 19:57:00 -0600
Subject: [Rd] inflate zlib compressed data using base R or CRAN package?
In-Reply-To: <CAECWziJfZJUu1BWq9w5e1UghjmiCO90q7PKNor-U-1dLM0P5HQ@mail.gmail.com>
References: <D6454779-E162-4A11-B4B2-F26CE35CE5C2@mrc-lmb.cam.ac.uk>
	<21142.37024.430585.526787@max.nulle.part>
	<21142.39619.914919.157672@max.nulle.part>
	<CAECWziJfZJUu1BWq9w5e1UghjmiCO90q7PKNor-U-1dLM0P5HQ@mail.gmail.com>
Message-ID: <21142.41708.828123.572320@max.nulle.part>


On 27 November 2013 at 17:30, Murray Stokely wrote:
| I think none of these examples describe a zlib compressed data block inside a
| binary file that the OP asked about, as all of your examples are e.g.
| prepending gzip or zip headers.?

Yes I fear I have no real idea what Greg is/was talking about.

I can however confirm that I regularly read delimited text data from inside
zip files (as shipped by data vendors) without having to unzip them first,
and also regularly access files which are gzip compressed -- including binary
streams from internal capture/conversion.

Also, my RcppCNPy packages deal with that too in the context of NumPy files
and has examples of how to transparently switch between files which are, or
aren't, compressed by gzip.  

Sorry for wasting bandwidth. I was just trying to help.

Dirk

-- 
Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com


From jefferis at mrc-lmb.cam.ac.uk  Thu Nov 28 15:37:19 2013
From: jefferis at mrc-lmb.cam.ac.uk (Dr Gregory Jefferis)
Date: Thu, 28 Nov 2013 14:37:19 +0000
Subject: [Rd] inflate zlib compressed data using base R or CRAN package?
In-Reply-To: <CAECWziJfZJUu1BWq9w5e1UghjmiCO90q7PKNor-U-1dLM0P5HQ@mail.gmail.com>
References: <D6454779-E162-4A11-B4B2-F26CE35CE5C2@mrc-lmb.cam.ac.uk>
	<21142.37024.430585.526787@max.nulle.part>
	<21142.39619.914919.157672@max.nulle.part>
	<CAECWziJfZJUu1BWq9w5e1UghjmiCO90q7PKNor-U-1dLM0P5HQ@mail.gmail.com>
Message-ID: <A01330C2-3B2B-4A3E-8904-71FFCD9DD0E0@mrc-lmb.cam.ac.uk>

Dear Murray,

On 28 Nov 2013, at 1:30, Murray Stokely wrote:

> I think none of these examples describe a zlib compressed data block 
> inside
> a binary file that the OP asked about, as all of your examples are 
> e.g.
> prepending gzip or zip headers.
>
> Greg, is memDecompress what you are looking for?

Yes, so long as one explicitly specifies type='gzip' - even though it 
isn't! I'm not sure I would have guessed it from the help. Thank you!

Best,

Greg.

--
Gregory Jefferis, PhD                   Tel: 01223 267048
Division of Neurobiology
MRC Laboratory of Molecular Biology
Francis Crick Avenue
Cambridge Biomedical Campus
Cambridge, CB2 OQH, UK

http://www2.mrc-lmb.cam.ac.uk/group-leaders/h-to-m/g-jefferis
http://jefferislab.org
http://flybrain.stanford.edu


From simon.urbanek at r-project.org  Fri Nov 29 01:48:07 2013
From: simon.urbanek at r-project.org (Simon Urbanek)
Date: Thu, 28 Nov 2013 19:48:07 -0500
Subject: [Rd] inflate zlib compressed data using base R or CRAN package?
In-Reply-To: <CAECWziJfZJUu1BWq9w5e1UghjmiCO90q7PKNor-U-1dLM0P5HQ@mail.gmail.com>
References: <D6454779-E162-4A11-B4B2-F26CE35CE5C2@mrc-lmb.cam.ac.uk>
	<21142.37024.430585.526787@max.nulle.part>
	<21142.39619.914919.157672@max.nulle.part>
	<CAECWziJfZJUu1BWq9w5e1UghjmiCO90q7PKNor-U-1dLM0P5HQ@mail.gmail.com>
Message-ID: <86CF97EA-7D73-4E9C-807E-699E039D38DB@r-project.org>

On Nov 27, 2013, at 8:30 PM, Murray Stokely <murray at stokely.org> wrote:

> I think none of these examples describe a zlib compressed data block inside a binary file that the OP asked about, as all of your examples are e.g. prepending gzip or zip headers.
> 
> Greg, is memDecompress what you are looking for?
> 

I think so.

But this is interesting ? I think the documentation of memCompress/memDecompress is not quite correct and the parameters are misleading. Although it does mention the gzip headers, it is incorrect since zlib format is not a subset of the gzip format (albeit they use the same compression method), so you cannot extract gzip content using zlib decompression - you?ll get  internal error -3 in memDecompress(2) if you try it since it expects the zlib header which is different form the gzip one. So ?gzip? in type is a misnomer - it should say ?zlib? since it can neither read nor write the gzip format. Also the documentation should make it clear since it?s pointless to try to use this on gzip contents. The better alternative would be to support both gzip and zlib since R can deal with both ? the issue is that it will break code that used type=?gzip? explicitly to mean ?zlib? so I?m not sure there is a good way out.

Cheers,
Simon


> 
> On Wed, Nov 27, 2013 at 5:22 PM, Dirk Eddelbuettel <edd at debian.org> wrote:
> 
>> 
>> On 27 November 2013 at 18:38, Dirk Eddelbuettel wrote:
>> |
>> | On 27 November 2013 at 23:49, Dr Gregory Jefferis wrote:
>> | | I have a binary file type that includes a zlib compressed data block
>> (ie
>> | | not gzip). Is anyone aware of a way using base R or a CRAN package to
>> | | decompress this kind of data (from disk or memory). So far I have found
>> | | Rcompression::decompress on omegahat, but I would prefer to keep
>> | | dependencies on CRAN (or bioconductor). I am also trying to avoid
>> | | writing yet another C level interface to part of zlib.
>> |
>> | Unless I am missing something, this is in base R; see help(connections).
>> |
>> | Here is a quick demo:
>> |
>> | R> write.csv(trees, file="/tmp/trees.csv")    # data we all have
>> | R> system("gzip -v /tmp/trees.csv")           # as I am lazy here
>> | /tmp/trees.csv:        50.5% -- replaced with /tmp/trees.csv.gz
>> | R> read.csv(gzfile("/tmp/trees.csv.gz"))      # works out of the box
>> 
>> Oh, and in case you meant zip file containing a data file, that also works.
>> 
>> First converting what I did last
>> 
>> edd at max:/tmp$ gunzip trees.csv.gz
>> edd at max:/tmp$ zip trees.zip trees.csv
>>  adding: trees.csv (deflated 50%)
>> edd at max:/tmp$
>> 
>> Then reading the csv from inside the zip file:
>> 
>> R> read.csv(unz("/tmp/trees.zip", "trees.csv"))
>>    X Girth Height Volume
>> 1   1   8.3     70   10.3
>> 2   2   8.6     65   10.3
>> 3   3   8.8     63   10.2
>> 4   4  10.5     72   16.4
>> 5   5  10.7     81   18.8
>> 6   6  10.8     83   19.7
>> 7   7  11.0     66   15.6
>> 8   8  11.0     75   18.2
>> 9   9  11.1     80   22.6
>> 10 10  11.2     75   19.9
>> 11 11  11.3     79   24.2
>> 12 12  11.4     76   21.0
>> 13 13  11.4     76   21.4
>> 14 14  11.7     69   21.3
>> 15 15  12.0     75   19.1
>> 16 16  12.9     74   22.2
>> 17 17  12.9     85   33.8
>> 18 18  13.3     86   27.4
>> 19 19  13.7     71   25.7
>> 20 20  13.8     64   24.9
>> 21 21  14.0     78   34.5
>> 22 22  14.2     80   31.7
>> 23 23  14.5     74   36.3
>> 24 24  16.0     72   38.3
>> 25 25  16.3     77   42.6
>> 26 26  17.3     81   55.4
>> 27 27  17.5     82   55.7
>> 28 28  17.9     80   58.3
>> 29 29  18.0     80   51.5
>> 30 30  18.0     80   51.0
>> 31 31  20.6     87   77.0
>> R>
>> 
>> Regards, Dirk
>> 
>> --
>> Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com
>> 
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel
>> 
> 
> 	[[alternative HTML version deleted]]
> 
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel
> 


From hb at biostat.ucsf.edu  Fri Nov 29 10:37:20 2013
From: hb at biostat.ucsf.edu (Henrik Bengtsson)
Date: Fri, 29 Nov 2013 01:37:20 -0800
Subject: [Rd] inflate zlib compressed data using base R or CRAN package?
In-Reply-To: <86CF97EA-7D73-4E9C-807E-699E039D38DB@r-project.org>
References: <D6454779-E162-4A11-B4B2-F26CE35CE5C2@mrc-lmb.cam.ac.uk>
	<21142.37024.430585.526787@max.nulle.part>
	<21142.39619.914919.157672@max.nulle.part>
	<CAECWziJfZJUu1BWq9w5e1UghjmiCO90q7PKNor-U-1dLM0P5HQ@mail.gmail.com>
	<86CF97EA-7D73-4E9C-807E-699E039D38DB@r-project.org>
Message-ID: <CAFDcVCQ4eu4Uv5Ojp4bCqa_vZhnViHQ7uK_22Z3aCxb+0Dw1GA@mail.gmail.com>

On Thu, Nov 28, 2013 at 4:48 PM, Simon Urbanek
<simon.urbanek at r-project.org> wrote:
> On Nov 27, 2013, at 8:30 PM, Murray Stokely <murray at stokely.org> wrote:
>
>> I think none of these examples describe a zlib compressed data block inside a binary file that the OP asked about, as all of your examples are e.g. prepending gzip or zip headers.
>>
>> Greg, is memDecompress what you are looking for?
>>
>
> I think so.
>
> But this is interesting ? I think the documentation of memCompress/memDecompress is not quite correct and the parameters are misleading. Although it does mention the gzip headers, it is incorrect since zlib format is not a subset of the gzip format (albeit they use the same compression method), so you cannot extract gzip content using zlib decompression - you?ll get  internal error -3 in memDecompress(2) if you try it since it expects the zlib header which is different form the gzip one.

Interestingly.  Just to make sure: are you 100% certain about this?
>From the http://svn.r-project.org/R/trunk/src/main/connections.c:

    case 2: /* gzip */
    {
	uLong inlen = LENGTH(from), outlen = 3*inlen;
	int res;
	Bytef *buf, *p = (Bytef *)RAW(from);
	/* we check for a file header */
	if (p[0] == 0x1f && p[1] == 0x8b) { p += 2; inlen -= 2; }
	while(1) {
	    buf = (Bytef *) R_alloc(outlen, sizeof(Bytef));
	    res = uncompress(buf, &outlen, p, inlen);
	    if(res == Z_BUF_ERROR) { outlen *= 2; continue; }
	    if(res == Z_OK) break;
	    error("internal error %d in memDecompress(%d)", res, type);
	}
	ans = allocVector(RAWSXP, outlen);
	memcpy(RAW(ans), buf, outlen);
	break;
    }

That code looks for the 0x1F 0x8B magic number, which is the one for
gzip [http://www.gzip.org/zlib/rfc-gzip.html#header-trailer].  Or are
you saying that that if statement is incorrect?  (Disclaimer: I don't
know much about gzip/zlib, but I happens to recognize that gzip magic
number.)

/Henrik

> So ?gzip? in type is a misnomer - it should say ?zlib? since it can neither read nor write the gzip format. Also the documentation should make it clear since it?s pointless to try to use this on gzip contents. The better alternative would be to support both gzip and zlib since R can deal with both ? the issue is that it will break code that used type=?gzip? explicitly to mean ?zlib? so I?m not sure there is a good way out.
>
> Cheers,
> Simon
>
>
>>
>> On Wed, Nov 27, 2013 at 5:22 PM, Dirk Eddelbuettel <edd at debian.org> wrote:
>>
>>>
>>> On 27 November 2013 at 18:38, Dirk Eddelbuettel wrote:
>>> |
>>> | On 27 November 2013 at 23:49, Dr Gregory Jefferis wrote:
>>> | | I have a binary file type that includes a zlib compressed data block
>>> (ie
>>> | | not gzip). Is anyone aware of a way using base R or a CRAN package to
>>> | | decompress this kind of data (from disk or memory). So far I have found
>>> | | Rcompression::decompress on omegahat, but I would prefer to keep
>>> | | dependencies on CRAN (or bioconductor). I am also trying to avoid
>>> | | writing yet another C level interface to part of zlib.
>>> |
>>> | Unless I am missing something, this is in base R; see help(connections).
>>> |
>>> | Here is a quick demo:
>>> |
>>> | R> write.csv(trees, file="/tmp/trees.csv")    # data we all have
>>> | R> system("gzip -v /tmp/trees.csv")           # as I am lazy here
>>> | /tmp/trees.csv:        50.5% -- replaced with /tmp/trees.csv.gz
>>> | R> read.csv(gzfile("/tmp/trees.csv.gz"))      # works out of the box
>>>
>>> Oh, and in case you meant zip file containing a data file, that also works.
>>>
>>> First converting what I did last
>>>
>>> edd at max:/tmp$ gunzip trees.csv.gz
>>> edd at max:/tmp$ zip trees.zip trees.csv
>>>  adding: trees.csv (deflated 50%)
>>> edd at max:/tmp$
>>>
>>> Then reading the csv from inside the zip file:
>>>
>>> R> read.csv(unz("/tmp/trees.zip", "trees.csv"))
>>>    X Girth Height Volume
>>> 1   1   8.3     70   10.3
>>> 2   2   8.6     65   10.3
>>> 3   3   8.8     63   10.2
>>> 4   4  10.5     72   16.4
>>> 5   5  10.7     81   18.8
>>> 6   6  10.8     83   19.7
>>> 7   7  11.0     66   15.6
>>> 8   8  11.0     75   18.2
>>> 9   9  11.1     80   22.6
>>> 10 10  11.2     75   19.9
>>> 11 11  11.3     79   24.2
>>> 12 12  11.4     76   21.0
>>> 13 13  11.4     76   21.4
>>> 14 14  11.7     69   21.3
>>> 15 15  12.0     75   19.1
>>> 16 16  12.9     74   22.2
>>> 17 17  12.9     85   33.8
>>> 18 18  13.3     86   27.4
>>> 19 19  13.7     71   25.7
>>> 20 20  13.8     64   24.9
>>> 21 21  14.0     78   34.5
>>> 22 22  14.2     80   31.7
>>> 23 23  14.5     74   36.3
>>> 24 24  16.0     72   38.3
>>> 25 25  16.3     77   42.6
>>> 26 26  17.3     81   55.4
>>> 27 27  17.5     82   55.7
>>> 28 28  17.9     80   58.3
>>> 29 29  18.0     80   51.5
>>> 30 30  18.0     80   51.0
>>> 31 31  20.6     87   77.0
>>> R>
>>>
>>> Regards, Dirk
>>>
>>> --
>>> Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com
>>>
>>> ______________________________________________
>>> R-devel at r-project.org mailing list
>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>
>>
>>       [[alternative HTML version deleted]]
>>
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>
>
> ______________________________________________
> R-devel at r-project.org mailing list
> https://stat.ethz.ch/mailman/listinfo/r-devel


From karl.forner at gmail.com  Fri Nov 29 11:30:16 2013
From: karl.forner at gmail.com (Karl Forner)
Date: Fri, 29 Nov 2013 11:30:16 +0100
Subject: [Rd] How to catch warnings sent by arguments of s4 methods ?
Message-ID: <CAMd4_AfmWJ7bYS31QH1Gt+==QVXR=E-RQtgV8MsUUQ_iwsf9rw@mail.gmail.com>

Hello,

I apologized if this had already been addressed, and I also submitted
this problem on SO:
http://stackoverflow.com/questions/20268021/how-to-catch-warnings-sent-during-s4-method-selection

Example code:
setGeneric('my_method', function(x) standardGeneric('my_method') )
setMethod('my_method', 'ANY', function(x) invisible())

withCallingHandlers(my_method(warning('argh')), warning = function(w)
{ stop('got warning:', w) })
# this does not catch the warning

It seems that the warnings emitted during the evaluation of the
arguments of S4 methods can not get caught using
withCallingHandlers().

Is this expected ? Is there a work-around ?

Best,
Karl Forner


From simon.urbanek at r-project.org  Fri Nov 29 16:17:12 2013
From: simon.urbanek at r-project.org (Simon Urbanek)
Date: Fri, 29 Nov 2013 10:17:12 -0500
Subject: [Rd] inflate zlib compressed data using base R or CRAN package?
In-Reply-To: <CAFDcVCQ4eu4Uv5Ojp4bCqa_vZhnViHQ7uK_22Z3aCxb+0Dw1GA@mail.gmail.com>
References: <D6454779-E162-4A11-B4B2-F26CE35CE5C2@mrc-lmb.cam.ac.uk>
	<21142.37024.430585.526787@max.nulle.part>
	<21142.39619.914919.157672@max.nulle.part>
	<CAECWziJfZJUu1BWq9w5e1UghjmiCO90q7PKNor-U-1dLM0P5HQ@mail.gmail.com>
	<86CF97EA-7D73-4E9C-807E-699E039D38DB@r-project.org>
	<CAFDcVCQ4eu4Uv5Ojp4bCqa_vZhnViHQ7uK_22Z3aCxb+0Dw1GA@mail.gmail.com>
Message-ID: <5264FC12-96E2-459B-BC19-F4737F1C88F9@r-project.org>


On Nov 29, 2013, at 4:37 AM, Henrik Bengtsson <hb at biostat.ucsf.edu> wrote:

> On Thu, Nov 28, 2013 at 4:48 PM, Simon Urbanek
> <simon.urbanek at r-project.org> wrote:
>> On Nov 27, 2013, at 8:30 PM, Murray Stokely <murray at stokely.org> wrote:
>> 
>>> I think none of these examples describe a zlib compressed data block inside a binary file that the OP asked about, as all of your examples are e.g. prepending gzip or zip headers.
>>> 
>>> Greg, is memDecompress what you are looking for?
>>> 
>> 
>> I think so.
>> 
>> But this is interesting ? I think the documentation of memCompress/memDecompress is not quite correct and the parameters are misleading. Although it does mention the gzip headers, it is incorrect since zlib format is not a subset of the gzip format (albeit they use the same compression method), so you cannot extract gzip content using zlib decompression - you?ll get  internal error -3 in memDecompress(2) if you try it since it expects the zlib header which is different form the gzip one.
> 
> Interestingly.  Just to make sure: are you 100% certain about this?

Yes, see below.


>> From the http://svn.r-project.org/R/trunk/src/main/connections.c:
> 
>    case 2: /* gzip */
>    {
> 	uLong inlen = LENGTH(from), outlen = 3*inlen;
> 	int res;
> 	Bytef *buf, *p = (Bytef *)RAW(from);
> 	/* we check for a file header */
> 	if (p[0] == 0x1f && p[1] == 0x8b) { p += 2; inlen -= 2; }
> 	while(1) {
> 	    buf = (Bytef *) R_alloc(outlen, sizeof(Bytef));
> 	    res = uncompress(buf, &outlen, p, inlen);
> 	    if(res == Z_BUF_ERROR) { outlen *= 2; continue; }
> 	    if(res == Z_OK) break;
> 	    error("internal error %d in memDecompress(%d)", res, type);
> 	}
> 	ans = allocVector(RAWSXP, outlen);
> 	memcpy(RAW(ans), buf, outlen);
> 	break;
>    }
> 
> That code looks for the 0x1F 0x8B magic number, which is the one for
> gzip [http://www.gzip.org/zlib/rfc-gzip.html#header-trailer].  Or are
> you saying that that if statement is incorrect?  (Disclaimer: I don't
> know much about gzip/zlib, but I happens to recognize that gzip magic
> number.)
> 

The above assumes that zlib is a subset of gzip which is *not* true - that was the point I was making. zlibs has *different* headers than gzip, not just fewer bytes. gzip has lots of other things in the header and they even also use different CRC methods. 

To illustrate:

> writeBin(charToRaw("1234"), f<-gzfile("test.gz","wb"))
> close(f)
> readBin("test.gz",raw(),100)
 [1] 1f 8b 08 00 00 00 00 00 00 03 33 34 32 36 01
[16] 00 a3 e0 e3 9b 04 00 00 00
> memCompress("1234")
 [1] 78 9c 33 34 32 36 01 00 01 f8 00 cb

As you can see gzip uses a different header (it starts with 0x1f 0x8b but then has many other files like mod time etc.) - the compressed payload starts at byte 11 and the CRC is 64-bit wide. In contrast, zlib has no magic header but it also has just two-byte header followed by the payload (starting at byte 3) and 32-bit CRC. So the two are entirely incompatible - you cannot decompress gzip format with zlib parser and vice-versa. The payload is the same, but the headers and trailers are entirely different. That's why Greg was specifically asking about zlib which does *not* mean gzip.

Cheers,
Simon




> /Henrik
> 
>> So ?gzip? in type is a misnomer - it should say ?zlib? since it can neither read nor write the gzip format. Also the documentation should make it clear since it?s pointless to try to use this on gzip contents. The better alternative would be to support both gzip and zlib since R can deal with both ? the issue is that it will break code that used type=?gzip? explicitly to mean ?zlib? so I?m not sure there is a good way out.
>> 
>> Cheers,
>> Simon
>> 
>> 
>>> 
>>> On Wed, Nov 27, 2013 at 5:22 PM, Dirk Eddelbuettel <edd at debian.org> wrote:
>>> 
>>>> 
>>>> On 27 November 2013 at 18:38, Dirk Eddelbuettel wrote:
>>>> |
>>>> | On 27 November 2013 at 23:49, Dr Gregory Jefferis wrote:
>>>> | | I have a binary file type that includes a zlib compressed data block
>>>> (ie
>>>> | | not gzip). Is anyone aware of a way using base R or a CRAN package to
>>>> | | decompress this kind of data (from disk or memory). So far I have found
>>>> | | Rcompression::decompress on omegahat, but I would prefer to keep
>>>> | | dependencies on CRAN (or bioconductor). I am also trying to avoid
>>>> | | writing yet another C level interface to part of zlib.
>>>> |
>>>> | Unless I am missing something, this is in base R; see help(connections).
>>>> |
>>>> | Here is a quick demo:
>>>> |
>>>> | R> write.csv(trees, file="/tmp/trees.csv")    # data we all have
>>>> | R> system("gzip -v /tmp/trees.csv")           # as I am lazy here
>>>> | /tmp/trees.csv:        50.5% -- replaced with /tmp/trees.csv.gz
>>>> | R> read.csv(gzfile("/tmp/trees.csv.gz"))      # works out of the box
>>>> 
>>>> Oh, and in case you meant zip file containing a data file, that also works.
>>>> 
>>>> First converting what I did last
>>>> 
>>>> edd at max:/tmp$ gunzip trees.csv.gz
>>>> edd at max:/tmp$ zip trees.zip trees.csv
>>>> adding: trees.csv (deflated 50%)
>>>> edd at max:/tmp$
>>>> 
>>>> Then reading the csv from inside the zip file:
>>>> 
>>>> R> read.csv(unz("/tmp/trees.zip", "trees.csv"))
>>>>   X Girth Height Volume
>>>> 1   1   8.3     70   10.3
>>>> 2   2   8.6     65   10.3
>>>> 3   3   8.8     63   10.2
>>>> 4   4  10.5     72   16.4
>>>> 5   5  10.7     81   18.8
>>>> 6   6  10.8     83   19.7
>>>> 7   7  11.0     66   15.6
>>>> 8   8  11.0     75   18.2
>>>> 9   9  11.1     80   22.6
>>>> 10 10  11.2     75   19.9
>>>> 11 11  11.3     79   24.2
>>>> 12 12  11.4     76   21.0
>>>> 13 13  11.4     76   21.4
>>>> 14 14  11.7     69   21.3
>>>> 15 15  12.0     75   19.1
>>>> 16 16  12.9     74   22.2
>>>> 17 17  12.9     85   33.8
>>>> 18 18  13.3     86   27.4
>>>> 19 19  13.7     71   25.7
>>>> 20 20  13.8     64   24.9
>>>> 21 21  14.0     78   34.5
>>>> 22 22  14.2     80   31.7
>>>> 23 23  14.5     74   36.3
>>>> 24 24  16.0     72   38.3
>>>> 25 25  16.3     77   42.6
>>>> 26 26  17.3     81   55.4
>>>> 27 27  17.5     82   55.7
>>>> 28 28  17.9     80   58.3
>>>> 29 29  18.0     80   51.5
>>>> 30 30  18.0     80   51.0
>>>> 31 31  20.6     87   77.0
>>>> R>
>>>> 
>>>> Regards, Dirk
>>>> 
>>>> --
>>>> Dirk Eddelbuettel | edd at debian.org | http://dirk.eddelbuettel.com
>>>> 
>>>> ______________________________________________
>>>> R-devel at r-project.org mailing list
>>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>>> 
>>> 
>>>      [[alternative HTML version deleted]]
>>> 
>>> ______________________________________________
>>> R-devel at r-project.org mailing list
>>> https://stat.ethz.ch/mailman/listinfo/r-devel
>>> 
>> 
>> ______________________________________________
>> R-devel at r-project.org mailing list
>> https://stat.ethz.ch/mailman/listinfo/r-devel
> 


From murdoch.duncan at gmail.com  Sat Nov 30 21:09:29 2013
From: murdoch.duncan at gmail.com (Duncan Murdoch)
Date: Sun, 01 Dec 2013 05:09:29 +0900
Subject: [Rd] Setting locale to support UTF-8
Message-ID: <529A45F9.3090101@gmail.com>

In Sweave, if the locale is set to C, non-ASCII characters are not 
handled nicely even if I declare the encoding of the file to be "UTF-8". 
  I'm trying to find a workaround for this, because I'm using Sweave 
from within TeXShop.   TeXShop runs its typesetting engines in the C 
locale, and non-ascii characters are messed up.

Is there a way to declare that I am in a "generic" UTF-8 locale?  It is 
like the C locale in other respects, but it knows about UTF-8 characters.

Duncan Murdoch


